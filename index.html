<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3日間のお世話ゲーム（stage1）</title>
  <style>
    :root{
      --bg:#eef8ff;
      --card:rgba(255,255,255,.78);
      --card2:rgba(255,255,255,.62);
      --text:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.12);
      --btn:#2dd4bf;
      --btnText:#042f2e;
      --btn2:#60a5fa;
      --danger:#fb7185;
      --shadow: 0 16px 38px rgba(15,23,42,.12);
      --radius: 18px;

      /* 生まれてくる子のサイズ調整（ここだけ触ればOK） */
      --newborn-reveal-width: 120px;  /* マカロンから出てくる瞬間のサイズ */
      --pet-base-scale: 0.52;         /* お世話開始直後の小ささ */
      --pet-max-scale: 0.96;          /* 終盤の大きさ */
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Yu Gothic", "Meiryo", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(45,212,191,.26), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 900px at 45% 110%, rgba(167,243,208,.30), transparent 55%),
        linear-gradient(180deg, #f6fdff, #eef8ff 35%, #f7fbff);
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{ max-width:980px; margin:0 auto; padding:18px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background: var(--card2);
      border:1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .dot{
      width:12px; height:12px; border-radius:999px;
      background: linear-gradient(135deg, rgba(45,212,191,.95), rgba(96,165,250,.90));
      box-shadow: 0 0 18px rgba(45,212,191,.28);
    }
    .title{ font-weight:800; letter-spacing:.02em; font-size:14px; color:rgba(15,23,42,.92); }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      border:1px solid var(--line);
      font-size:12px;
      color: rgba(15,23,42,.85);
      user-select:none;
    }
    .pill small{ color:var(--muted); }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1.2fr .8fr;
      margin-top:14px;
    }
    @media (max-width: 880px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card .inner{ padding:14px; }
    .card h2{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      color:rgba(15,23,42,.92);
      font-weight:800;
    }
    .card p{
      margin:10px 0 0 0;
      font-size:13px;
      line-height:1.75;
      color: rgba(15,23,42,.80);
    }
    .muted{ color:var(--muted); }
    .tiny{ font-size:12px; color: rgba(15,23,42,.70); line-height:1.6; }
    .fade{ opacity:.92; }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{ border:0; background:none; color:inherit; font:inherit; cursor:pointer; }
    .btn{
      padding:10px 12px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(45,212,191,.95), rgba(45,212,191,.78));
      color: var(--btnText);
      font-weight:800;
      box-shadow: 0 12px 24px rgba(45,212,191,.14);
      border:1px solid rgba(15,23,42,.10);
      transition: transform .06s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:hover{ filter: brightness(1.02); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.secondary{
      background: rgba(255,255,255,.62);
      color: rgba(15,23,42,.86);
      box-shadow:none;
    }
    .btn.blue{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(96,165,250,.75));
      color: #031a35;
      box-shadow: 0 12px 24px rgba(96,165,250,.12);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(251,113,133,.92), rgba(251,113,133,.70));
      color: #3a0413;
      box-shadow: 0 12px 24px rgba(251,113,133,.12);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .stage{
      height: 320px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(280px 280px at 50% 60%, rgba(255,255,255,.78), rgba(255,255,255,0) 70%),
        radial-gradient(420px 320px at 50% 50%, rgba(45,212,191,.13), rgba(96,165,250,.10) 60%, rgba(255,255,255,0) 72%);
      border-bottom:1px solid var(--line);
      position:relative;
      overflow:hidden;
    }
    .charWrap{ position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }

    /* スタート画面のマカロン画像は不要 → ここは飾り画像でもOK */
    .charImg{ width: 210px; height:auto; filter: drop-shadow(0 18px 32px rgba(15,23,42,.18)); user-select:none; -webkit-user-drag:none; }
    .floaty{ animation: floaty 3.2s ease-in-out infinite; }
    @keyframes floaty{ 0%,100%{ transform: translateY(0px);} 50%{ transform: translateY(-8px);} }

    .formBlock{ margin-top:12px; padding:12px; border:1px solid var(--line); background: rgba(255,255,255,.62); border-radius:16px; }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      color: rgba(15,23,42,.9);
      outline:none;
      font-size:13px;
    }

    .choiceGrid{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px; }
    .choice{
      text-align:left;
      width:100%;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.62);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .choice:hover{ background: rgba(255,255,255,.78); }
    .choice:active{ transform: translateY(1px) scale(.995); }
    .choice.selected{ border-color: rgba(45,212,191,.55); box-shadow: 0 10px 22px rgba(45,212,191,.10); }
    .choice img{ width:54px; height:auto; }
    .ctext{ flex:1; }
    .cname{ font-weight:800; font-size:13px; }
    .cdesc{ font-size:12px; color: rgba(15,23,42,.70); margin-top:2px; }

    .stepRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .stepChip{ display:flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.60); border:1px solid var(--line); font-size:12px; color: rgba(15,23,42,.78); }
    .stepChip .num{ width:18px; height:18px; border-radius:999px; display:flex; align-items:center; justify-content:center; background: rgba(45,212,191,.22); color: rgba(4,47,46,.92); font-weight:800; }

    .mapGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:12px; }
    @media (max-width: 520px){ .mapGrid{ grid-template-columns: repeat(3, 1fr);} }
    .tile{
      height:72px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.62);
      position:relative;
      overflow:hidden;
      font-weight:700;
      color: rgba(15,23,42,.70);
    }
    .tile span{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    .tile .foundImg{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:0; transform: scale(.98); transition: opacity .2s ease, transform .2s ease; }
    .tile.revealed .foundImg{ opacity:.95; transform: scale(1); }
    .tile.found{ border-color: rgba(96,165,250,.55); box-shadow: 0 10px 22px rgba(96,165,250,.10); }

    .arrivalStage{ width:100%; height:100%; position:relative; display:flex; align-items:center; justify-content:center; }
    .revealBox{ position:relative; width:320px; height:280px; display:flex; align-items:center; justify-content:center; }
    .macaronBtn{ border:0; background:transparent; padding:0; cursor:pointer; }
    .macaronBtn:active{ transform: translateY(1px) scale(.995); }
    .macaronImg{ width: 230px; height:auto; filter: drop-shadow(0 18px 32px rgba(15,23,42,.18)); }

    /* 生まれてくる子は小さく */
    .petReveal{
      position:absolute;
      width: var(--newborn-reveal-width);
      height:auto;
      opacity:0;
      transform: translateY(12px) scale(.82);
      filter: drop-shadow(0 18px 32px rgba(15,23,42,.14));
      user-select:none;
      -webkit-user-drag:none;
    }

    .macaronImg.fading{ animation: macaronFade 2.6s ease forwards; }
    .petReveal.revealing{ animation: petReveal 2.6s ease forwards; }
    @keyframes macaronFade{
      0%{ opacity:1; transform: translateY(0) scale(1); filter: drop-shadow(0 18px 32px rgba(15,23,42,.18)); }
      65%{ opacity:.45; transform: translateY(-6px) scale(.995); }
      100%{ opacity:0; transform: translateY(-12px) scale(.99); filter: drop-shadow(0 18px 32px rgba(15,23,42,.04)); }
    }
    @keyframes petReveal{
      0%{ opacity:0; transform: translateY(14px) scale(.82); }
      35%{ opacity:.35; }
      100%{ opacity:1; transform: translateY(0px) scale(1); }
    }

    .orbit{
      position:absolute;
      width: 360px;
      height: 260px;
      animation: orbit 5.6s linear infinite;
      pointer-events:none;
    }
    .orbit .ghost{
      width: 120px;
      opacity:.33;
      filter: blur(.2px) drop-shadow(0 12px 22px rgba(15,23,42,.08));
      transform: translate(10px, 24px);
      animation: ghostBob 2.6s ease-in-out infinite;
    }
    @keyframes orbit{ from{ transform: rotate(0deg);} to{ transform: rotate(360deg);} }
    @keyframes ghostBob{ 0%,100%{ transform: translate(10px, 24px);} 50%{ transform: translate(10px, 16px);} }

    .hatchRow{ display:flex; gap:10px; align-items:center; margin-top:10px; }
    .hatchBar{ flex:1; height:10px; border-radius:999px; background: rgba(15,23,42,.08); border:1px solid var(--line); overflow:hidden; }
    .hatchFill{ height:100%; width:0%; border-radius:999px; background: linear-gradient(90deg, rgba(45,212,191,.85), rgba(96,165,250,.78)); transition: width .35s ease; }
    .hatchTime{ font-size:12px; color: rgba(15,23,42,.70); min-width: 92px; text-align:right; font-variant-numeric: tabular-nums; letter-spacing:.02em; }

    .hearts{ display:flex; gap:6px; align-items:center; }
    .heart{ width:18px; height:18px; transform: rotate(45deg); background: rgba(251,113,133,.28); border-radius: 4px; position:relative; }
    .heart::before, .heart::after{ content:""; width:18px; height:18px; position:absolute; background: inherit; border-radius: 999px; }
    .heart::before{ left:-9px; top:0; }
    .heart::after{ left:0; top:-9px; }
    .heart.on{ background: rgba(251,113,133,.88); }

    .toggle{ width:42px; height:22px; border-radius:999px; background: rgba(15,23,42,.08); border:1px solid var(--line); position:relative; flex:0 0 auto; }
    .toggle::after{ content:""; width:18px; height:18px; border-radius:999px; position:absolute; top:1px; left:1px; background: rgba(15,23,42,.45); transition: left .18s ease, background .18s ease; }
    .toggle.on{ background: rgba(45,212,191,.22); border-color: rgba(45,212,191,.28); }
    .toggle.on::after{ left:21px; background: rgba(45,212,191,.92); }

    .lifeRow{ margin-top:10px; padding:10px; border:1px solid var(--line); background: rgba(255,255,255,.62); border-radius:16px; }
    .lifeTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .lifeText{ font-size:12px; color: rgba(15,23,42,.76); font-variant-numeric: tabular-nums; }
    .lifeBar{ height:10px; border-radius:999px; background: rgba(15,23,42,.08); border:1px solid var(--line); overflow:hidden; margin-top:8px; }
    .lifeFill{ height:100%; width:0%; border-radius:999px; background: linear-gradient(90deg, rgba(96,165,250,.78), rgba(45,212,191,.75)); transition: width .35s ease; }

    /* お世話ステージ：2体表示（重ならない横並びに変更） */
    .pair{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding: 0 10%;
      gap: 18px;
    }
    .pair img{
      position:static;
      width: min(220px, 40vw);
      height:auto;
      filter: drop-shadow(0 18px 32px rgba(15,23,42,.18));
      user-select:none;
      -webkit-user-drag:none;
      transform-origin: 50% 90%;
    }
    @media (max-width: 480px){
      .pair{ padding: 0 6%; }
      .pair img{ width: min(190px, 44vw); }
    }
    .pair .avatar{
      animation: avatarBreath 3.6s ease-in-out infinite;
      opacity:.92;
    }
    .pair .pet{
      opacity:.98;
    }
    @keyframes avatarBreath{
      0%,100%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-6px) scale(1.01); }
    }

    .pet.happy{ animation: petHappy 1.8s ease-in-out infinite; }
    .pet.low{ animation: petLow 3.2s ease-in-out infinite; filter: drop-shadow(0 18px 32px rgba(15,23,42,.12)) saturate(.92); }
    .pet.cry{ animation: petCry .55s ease-in-out infinite; filter: drop-shadow(0 18px 32px rgba(15,23,42,.14)) saturate(.85); }
    @keyframes petHappy{ 0%,100%{ transform: translateY(0) scale(1); } 50%{ transform: translateY(-10px) scale(1.02); } }
    @keyframes petLow{ 0%,100%{ transform: translateY(4px) scale(1); } 50%{ transform: translateY(8px) scale(1); } }
    @keyframes petCry{ 0%,100%{ transform: translateX(0) translateY(4px) scale(1); } 50%{ transform: translateX(-2px) translateY(6px) scale(1); } }

    .overlay{ position:fixed; inset:0; background: rgba(15,23,42,.22); display:none; align-items:center; justify-content:center; padding:18px; z-index:50; }
    .overlay.on{ display:flex; }
    .modal{ width:min(720px, 96vw); background: rgba(255,255,255,.92); border:1px solid rgba(15,23,42,.12); border-radius: 18px; box-shadow: 0 28px 64px rgba(15,23,42,.22); overflow:hidden; }
    .mhead{ padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid rgba(15,23,42,.10); }
    .mtitle{ font-weight:900; letter-spacing:.02em; }
    .mbody{ padding:14px; }
    .mnote{ font-size:13px; color: rgba(15,23,42,.80); line-height:1.75; white-space:pre-wrap; }

    .thanks{ height: 68vh; display:flex; align-items:center; justify-content:center; text-align:center; }
    .word{ font-size: 34px; letter-spacing: .18em; font-weight: 900; color: rgba(15,23,42,.86); user-select:none; cursor: default; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title" id="ui_title">3日間のお世話ゲーム</div>
          <div class="sub" id="subline"> </div>
        </div>
      </div>
      <div class="pill" id="modePill">
        <span id="modeLabel"> </span>
        <small id="modeMeta"> </small>
      </div>
    </div>

    <!-- 0: スタート（文章なし） -->
    <div class="screen active" id="scr_start">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_start"> </h2>
            <div class="btnrow">
              <button class="btn" style="width:100%; padding:14px 14px; border-radius:16px; font-size:15px;" id="btn_go_menu">スタート</button>
              <button class="btn secondary" id="btn_reset_all">最初から</button>
            </div>
            <p class="tiny" id="p_start_hint" style="margin-top:10px;"> </p>
          </div>
        </div>
        <div class="card">
          <div class="stage">
            <div class="charWrap">
              <img id="startVisual" class="charImg floaty" alt="start visual" />
            </div>
          </div>
          <div class="inner">
            <h2 id="t_start_side"> </h2>
            <p class="muted" id="p_start_side"> </p>
          </div>
        </div>
      </div>
    </div>

    <!-- 1: 準備（研究/言語/時間設定） -->
    <div class="screen" id="scr_menu">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_menu">準備</h2>

            <div class="btnrow">
              <button class="btn secondary" id="btn_about">研究について</button>
              <button class="btn secondary" id="btn_lang">言語</button>
              <button class="btn" id="btn_menu_next">次へ</button>
            </div>

            <div class="formBlock">
              <div class="tiny" id="t_time_setting" style="margin-bottom:6px;">時間設定</div>

              <div class="tiny" id="t_life_setting" style="margin-top:6px;">3日間の長さ</div>
              <select id="lifePreset" aria-label="life preset">
                <option value="real3d">リアル3日</option>
                <option value="12h">12時間</option>
                <option value="3h">3時間</option>
                <option value="30m">30分</option>
                <option value="10m">10分</option>
                <option value="3m">3分</option>
              </select>

              <div class="tiny" id="t_hatch_setting" style="margin-top:10px;">マカロンが薄くなるまで</div>
              <select id="hatchPreset" aria-label="hatch preset">
                <option value="3m">3分</option>
                <option value="60s">60秒</option>
                <option value="30s">30秒</option>
                <option value="12s">12秒（テスト）</option>
              </select>

              <p class="tiny" id="p_menu_lock" style="margin-top:10px; display:none;">進行中は、時間設定を変更できません。</p>
            </div>

            <p class="tiny" id="p_menu_note" style="margin-top:10px;"> </p>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="charWrap">
              <img id="menuVisual" class="charImg floaty" alt="menu visual" />
            </div>
          </div>
          <div class="inner">
            <h2 id="t_menu_side"> </h2>
            <p class="muted" id="p_menu_side"> </p>
          </div>
        </div>
      </div>
    </div>

    <!-- 2: ユーザーの準備（名前とキャラ） -->
    <div class="screen" id="scr_profile">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_profile"> </h2>

            <div class="stepRow" aria-label="手順">
              <div class="stepChip"><span class="num">1</span><span id="s1">呼ばれたい名前</span></div>
              <div class="stepChip"><span class="num">2</span><span id="s2">自分のキャラ</span></div>
              <div class="stepChip"><span class="num">3</span><span id="s3">探しに行く</span></div>
            </div>

            <div class="formBlock">
              <div class="tiny" id="t_name" style="margin-bottom:6px;">呼ばれたい名前</div>
              <input id="playerName" placeholder="○○" autocomplete="nickname">
              <p class="tiny" id="profileNeed" style="margin-top:8px;"></p>
            </div>

            <div class="btnrow" style="margin-top:12px;">
              <button class="btn secondary" id="btn_profile_back">戻る</button>
              <button class="btn" id="btn_profile_next" disabled>探しに行く</button>
              <button class="btn secondary" id="btn_profile_reset" title="保存を消します">最初から</button>
            </div>

            <p class="tiny" id="p_profile_note" style="margin-top:10px;"> </p>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="charWrap">
              <img id="charPreview" class="charImg floaty" alt="character preview" />
            </div>
          </div>
          <div class="inner">
            <h2 id="t_buddy">自分のキャラ</h2>
            <p class="muted" id="p_buddy">クリックして選ぶ</p>
            <div class="choiceGrid" id="charChoices"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3: 探す -->
    <div class="screen" id="scr_search">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_search"> </h2>
            <p class="muted" id="p_search"> </p>
            <div class="mapGrid" id="mapGrid"></div>
            <div class="btnrow">
              <button class="btn secondary" id="btn_back_profile">設定へ戻る</button>
              <button class="btn" id="btn_hint">少しだけ目を慣らす</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="inner">
            <h2 id="t_presence"> </h2>
            <p class="muted" id="searchNote"> </p>
          </div>
        </div>
      </div>
    </div>

    <!-- 4: 到着（マカロン＋薄くなる演出） -->
    <div class="screen" id="scr_arrival">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_arrival"> </h2>
            <p class="muted" id="arrivalText"> </p>

            <div class="hatchRow" aria-label="誕生までの待ち時間">
              <div class="hatchBar"><div class="hatchFill" id="hatchFill"></div></div>
              <div class="hatchTime" id="hatchTime"> </div>
            </div>

            <p class="tiny" id="arrivalTouchHint" style="margin-top:10px;">マカロンに触れると、早まる</p>

            <div class="btnrow">
              <button class="btn secondary" id="btn_back_search">もう一度探す</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="arrivalStage">
              <div class="orbit" aria-hidden="true">
                <img id="orbitChar" class="ghost" alt="ghost" />
              </div>

              <div class="revealBox">
                <img id="petReveal" class="petReveal" alt="pet" />
                <button class="macaronBtn" id="btn_touch_macaron" aria-label="touch macaron">
                  <img id="arrivalMacaron" class="macaronImg floaty" alt="macaron" />
                </button>
              </div>
            </div>
          </div>
          <div class="inner">
            <h2 id="t_watch"> </h2>
            <p class="muted" id="p_watch"> </p>
          </div>
        </div>
      </div>
    </div>

    <!-- 5: お世話 -->
    <div class="screen" id="scr_care">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <h2 id="careTitle"> </h2>
              <div class="hearts" title="関係の雰囲気">
                <div class="heart" id="h1"></div>
                <div class="heart" id="h2"></div>
                <div class="heart" id="h3"></div>
                <div class="heart" id="h4"></div>
                <div class="heart" id="h5"></div>
              </div>
            </div>

            <div class="lifeRow" id="lifeRow">
              <div class="lifeTop">
                <div class="lifeText" id="lifeText"> </div>
                <div class="lifeText" id="lifeRemain"> </div>
              </div>
              <div class="lifeBar"><div class="lifeFill" id="lifeFill"></div></div>
            </div>

            <div class="btnrow" style="margin-top:10px;">
              <button class="btn" id="btn_food">食事</button>
              <button class="btn" id="btn_outing">お出かけ</button>
              <button class="btn" id="btn_mini">2択ミニゲーム</button>
              <button class="btn" id="btn_clean">排泄除去</button>
              <button class="btn blue" id="btn_drink">ドリンク</button>
              <button class="btn danger" id="btn_macaron">マカロン</button>
            </div>

            <div class="formBlock" style="margin-top:12px; display:flex; align-items:center; gap:10px;">
              <div class="tiny" id="t_sitter" style="min-width:52px;">シッター</div>
              <div class="toggle" id="toggle_sitter" role="switch" aria-checked="false" tabindex="0"></div>
              <div class="tiny" id="sitterNote" style="margin-left:auto;">時間は止まる</div>
            </div>

            <p class="tiny" id="endNote" style="margin-top:10px; display:none;"> </p>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="charWrap" id="charWrap">
              <div class="pair" id="pair">
                <img id="avatarImg" class="avatar" alt="avatar" />
                <img id="petImg" class="pet" alt="pet" />
              </div>
            </div>
          </div>
          <div class="inner">
            <h2 id="t_right"> </h2>
            <p class="muted" id="p_right"> </p>
          </div>
        </div>
      </div>
    </div>

    <!-- 6: エンディング（ありがとうだけ） -->
    <div class="screen" id="scr_end">
      <div class="card">
        <div class="thanks">
          <div class="word" id="word_thanks">ありがとう</div>
        </div>
      </div>
    </div>

  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="mhead">
        <div class="mtitle" id="modalTitle"> </div>
        <button class="btn secondary" id="btn_close_modal">閉じる</button>
      </div>
      <div class="mbody">
        <div class="mnote" id="modalNote"></div>
        <div class="btnrow" id="modalBtns" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const APP_KEY = "care3days_stage1_privateLogs_v4";

  /*
    ログ送信
    GitHub Pagesだけでメール送信やスプレッドシート保存をするには、受け口が必要です。
    いちばん簡単なのは Google Apps Script をWebアプリとして公開し、そこにPOSTする方法です。

    下の LOG_ENDPOINT に Apps Script のURLを入れると、ゲームのログが自動で送信されます。
    空文字のままだと送信しません（ローカルにだけ残ります）。
  */
  const LOG_ENDPOINT = ""; // 例: "https://script.google.com/macros/s/XXXXXXXX/exec"
  const LOG_PROJECT = "care-stage1";

  /*
    画像差し替えの意味
    ここに書いてある「ファイル名」と同じ名前の画像を置けば、その画像に変わります。
    置き場所が揺れても動くように、候補パスを複数用意しています。
    例: public/stag1/pink_closed.png でも stage1/pink_closed.png でもOK
  */
  const BASES = ["public/stag1/","public/stage1/","stag1/","stage1/"];

  function cand(file){ return BASES.map(b => b + file); }

  const ASSETS = {
    char: {
      green: { closed: cand("green_closed.png"), open: cand("green_open.png") },
      blue:  { closed: cand("blue_closed.png"),  open: cand("blue_open.png")  },
      pink:  { closed: cand("pink_closed.png"),  open: cand("pink_open.png")  },
      purple:{ closed: cand("purple_closed.png"),open: cand("purple_open.png") }
    },
    macaron: {
      green: cand("macaron_green.png"),
      blue:  cand("macaron_blue.png"),
      pink:  cand("macaron_pink.png"),
      purple:cand("macaron_purple.png")
    }
  };

  // スタート画面にマカロン画像を出さないための飾り
  const START_VISUAL_SVG = (() => {
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="360" height="360" viewBox="0 0 360 360">
  <defs>
    <radialGradient id="g1" cx="50%" cy="40%" r="60%">
      <stop offset="0%" stop-color="rgba(45,212,191,0.65)"/>
      <stop offset="60%" stop-color="rgba(96,165,250,0.25)"/>
      <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
    </radialGradient>
    <radialGradient id="g2" cx="40%" cy="60%" r="55%">
      <stop offset="0%" stop-color="rgba(251,113,133,0.25)"/>
      <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
    </radialGradient>
  </defs>
  <circle cx="180" cy="180" r="150" fill="url(#g1)"/>
  <circle cx="170" cy="200" r="120" fill="url(#g2)"/>
  <circle cx="120" cy="130" r="10" fill="rgba(255,255,255,0.65)"/>
  <circle cx="240" cy="115" r="8" fill="rgba(255,255,255,0.55)"/>
  <circle cx="250" cy="230" r="6" fill="rgba(255,255,255,0.50)"/>
</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  })();

  // 画像のフォールバック（候補を順に試す）
  function setImgWithFallback(imgEl, candidates){
    if(!imgEl) return;
    let i = 0;
    imgEl.onerror = () => {
      i++;
      if(i < candidates.length){
        imgEl.src = candidates[i];
      }
    };
    imgEl.src = candidates[0];
  }

  const url = new URL(location.href);
  const FAST = url.searchParams.get("fast") === "1";

  const $ = (id) => document.getElementById(id);
  const screens = {
    start: $("scr_start"),
    menu: $("scr_menu"),
    profile: $("scr_profile"),
    search: $("scr_search"),
    arrival: $("scr_arrival"),
    care: $("scr_care"),
    end: $("scr_end")
  };

  const overlay = $("overlay");
  const modalTitle = $("modalTitle");
  const modalNote = $("modalNote");
  const modalBtns = $("modalBtns");

  let save = null;
  let tickTimer = null;
  let uploadTimer = null;

  const I18N = {
    ja: {
      uiTitle: "3日間のお世話ゲーム",
      start: "スタート",
      reset: "最初から",
      menu: "準備",
      about: "研究について",
      lang: "言語",
      next: "次へ",
      back: "戻る",
      goSearch: "探しに行く",
      timeSetting: "時間設定",
      lifeSetting: "3日間の長さ",
      hatchSetting: "マカロンが薄くなるまで",
      profileSteps: { s1:"呼ばれたい名前", s2:"自分のキャラ", s3:"探しに行く" },
      nameLabel: "呼ばれたい名前",
      chooseAvatar: "自分のキャラ",
      searchTitle: "探す",
      arrivalTitle: "到着",
      arrivalText: "持ち帰ったマカロンは、しばらくして薄くなる。",
      touchHint: "マカロンに触れると、早まる",
      watch: "見守り",
      watchText: "あなたのキャラが、近くをうろうろしている。",
      careTitle: "いま",
      sitter: "シッター",
      sitterNote: "時間は止まる",
      remain: "残り",
      day: "Day",
      thanks: "ありがとう",
      aboutTitle: "研究に協力のお願い",
      aboutTabs: { ja:"日本語", en:"English", zh:"中文" },
      aboutText: {
        ja: "このゲームは研究目的で制作されています。\n\n記録されるのは、選択の回数、選んだ内容、ハートの推移、シッターの使用時間、アイテム使用などのゲーム内の痕跡です。\n\n入力は、呼ばれたい名前のみです。個人を特定できる情報は入力しないでください。\n\nログは製作者に送信され、製作者のみが閲覧します。\n途中でいつでもやめられます。",
        en: "This game is created for research purposes.\n\nIt records only in-game traces such as choices, counts, heart changes, sitter usage time, and item usage.\n\nOnly the name you want to be called is entered. Please do not enter identifying personal information.\n\nLogs are sent to the creator and are visible only to the creator.\nYou may stop at any time.",
        zh: "本游戏用于研究目的。\n\n仅记录游戏内的选择、次数、爱心变化、保姆使用时间、道具使用等痕迹。\n\n只输入希望被称呼的名字，请不要输入可识别个人身份的信息。\n\n日志会发送给制作者，仅制作者可查看。\n你可以随时停止。"
      },
      searchNote0: "どこかにある",
      searchNote1: "近いかもしれない",
      searchNote2: "見つけた",
      found: "見つけた",
      notYet: "まだ",
      openSoon: "薄くなるまで",
      hint: "少しだけ目を慣らす",
      searchAgain: "もう一度探す",
    },
    en: {
      uiTitle: "3-Day Care Game",
      start: "Start",
      reset: "Reset",
      menu: "Setup",
      about: "About the study",
      lang: "Language",
      next: "Next",
      back: "Back",
      goSearch: "Go search",
      timeSetting: "Time settings",
      lifeSetting: "Length of the 3 days",
      hatchSetting: "Time until it fades",
      profileSteps: { s1:"Your name", s2:"Your avatar", s3:"Go search" },
      nameLabel: "Name you want",
      chooseAvatar: "Your avatar",
      searchTitle: "Search",
      arrivalTitle: "Arrival",
      arrivalText: "The macaron you brought back will slowly fade.",
      touchHint: "Touching it makes it sooner",
      watch: "Watching",
      watchText: "Your avatar stays nearby.",
      careTitle: "Now",
      sitter: "Sitter",
      sitterNote: "Time stops",
      remain: "Remaining",
      day: "Day",
      thanks: "Thank you",
      aboutTitle: "Request for research cooperation",
      aboutTabs: { ja:"日本語", en:"English", zh:"中文" },
      aboutText: {
        ja: "このゲームは研究目的で制作されています。\n\n記録されるのは、選択の回数、選んだ内容、ハートの推移、シッターの使用時間、アイテム使用などのゲーム内の痕跡です。\n\n入力は、呼ばれたい名前のみです。個人を特定できる情報は入力しないでください。\n\nログは製作者に送信され、製作者のみが閲覧します。\n途中でいつでもやめられます。",
        en: "This game is created for research purposes.\n\nIt records only in-game traces such as choices, counts, heart changes, sitter usage time, and item usage.\n\nOnly the name you want to be called is entered. Please do not enter identifying personal information.\n\nLogs are sent to the creator and are visible only to the creator.\nYou may stop at any time.",
        zh: "本游戏用于研究目的。\n\n仅记录游戏内的选择、次数、爱心变化、保姆使用时间、道具使用等痕迹。\n\n只输入希望被称呼的名字，请不要输入可识别个人身份的信息。\n\n日志会发送给制作者，仅制作者可查看。\n你可以随时停止。"
      },
      searchNote0: "Somewhere",
      searchNote1: "Maybe close",
      searchNote2: "Found",
      found: "Found",
      notYet: "Not yet",
      openSoon: "Until it fades",
      hint: "Reveal one",
      searchAgain: "Search again",
    },
    zh: {
      uiTitle: "三天照护游戏",
      start: "开始",
      reset: "重置",
      menu: "准备",
      about: "关于研究",
      lang: "语言",
      next: "下一步",
      back: "返回",
      goSearch: "去寻找",
      timeSetting: "时间设置",
      lifeSetting: "三天的长度",
      hatchSetting: "变淡时间",
      profileSteps: { s1:"名字", s2:"你的角色", s3:"去寻找" },
      nameLabel: "希望被称呼的名字",
      chooseAvatar: "你的角色",
      searchTitle: "寻找",
      arrivalTitle: "到达",
      arrivalText: "带回来的马卡龙会慢慢变淡。",
      touchHint: "触碰会更快",
      watch: "守望",
      watchText: "你的角色在附近徘徊。",
      careTitle: "现在",
      sitter: "保姆",
      sitterNote: "时间停止",
      remain: "剩余",
      day: "Day",
      thanks: "谢谢",
      aboutTitle: "研究协助说明",
      aboutTabs: { ja:"日本語", en:"English", zh:"中文" },
      aboutText: {
        ja: "このゲームは研究目的で制作されています。\n\n記録されるのは、選択の回数、選んだ内容、ハートの推移、シッターの使用時間、アイテム使用などのゲーム内の痕跡です。\n\n入力は、呼ばれたい名前のみです。個人を特定できる情報は入力しないでください。\n\nログは製作者に送信され、製作者のみが閲覧します。\n途中でいつでもやめられます。",
        en: "This game is created for research purposes.\n\nIt records only in-game traces such as choices, counts, heart changes, sitter usage time, and item usage.\n\nOnly the name you want to be called is entered. Please do not enter identifying personal information.\n\nLogs are sent to the creator and are visible only to the creator.\nYou may stop at any time.",
        zh: "本游戏用于研究目的。\n\n仅记录游戏内的选择、次数、爱心变化、保姆使用时间、道具使用等痕迹。\n\n只输入希望被称呼的名字，请不要输入可识别个人身份的信息。\n\n日志会发送给制作者，仅制作者可查看。\n你可以随时停止。"
      },
      searchNote0: "在某处",
      searchNote1: "可能很近",
      searchNote2: "找到了",
      found: "找到了",
      notYet: "还没",
      openSoon: "变淡倒计时",
      hint: "揭示一个",
      searchAgain: "再找一次",
    }
  };

  function lang(){ return save?.settings?.lang || "ja"; }
  function tr(key){
    const d = I18N[lang()] || I18N.ja;
    return d[key] ?? (I18N.ja[key] ?? key);
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function nowMs(){ return Date.now(); }

  function showScreen(name){
    Object.values(screens).filter(Boolean).forEach(el => el.classList.remove("active"));
    (screens[name] || null) && screens[name].classList.add("active");
    save.flow.screen = name;
    persist();
  }

  function safeJSONParse(str, fallback){
    try{ return JSON.parse(str); }catch(e){ return fallback; }
  }

  function genId(){
    return "p" + Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
  }

  function emptyDay(d){
    return {
      day: d,
      heartStart: null,
      heartEnd: null,
      sitterMs: 0,
      careCounts: { food:0, outing:0, mini:0, clean:0, drink:0, macaron:0 },
      choices: { food:[], outing:[], mini:[], clean:[] }
    };
  }

  function lifeMsFromPreset(p){
    const DAY = 24*60*60*1000;
    if(p === "real3d") return 3*DAY;
    if(p === "12h") return 12*60*60*1000;
    if(p === "3h") return 3*60*60*1000;
    if(p === "30m") return 30*60*1000;
    if(p === "10m") return 10*60*1000;
    if(p === "3m") return 3*60*1000;
    return 3*DAY;
  }

  function hatchMsFromPreset(p){
    if(p === "3m") return 3*60*1000;
    if(p === "60s") return 60*1000;
    if(p === "30s") return 30*1000;
    if(p === "12s") return 12*1000;
    return 3*60*1000;
  }

  /*
    生まれてくる色のルール
    青ならピンク（固定）
    緑ならピンク or 紫（ランダムでバラエティ）
    ピンクなら青（固定）
    紫なら緑 or ピンク（少し揺らす）
  */
  function pickPetColor(avatarColor){
    if(avatarColor === "blue") return "pink";
    if(avatarColor === "green") return (Math.random() < 0.5) ? "pink" : "purple";
    if(avatarColor === "pink") return "blue";
    if(avatarColor === "purple") return (Math.random() < 0.5) ? "green" : "pink";
    return "pink";
  }

  function newSave(){
    const t0 = nowMs();
    const lifePreset = FAST ? "3m" : "real3d";
    const hatchPreset = FAST ? "12s" : "3m";
    return {
      v: 4,
      id: genId(),
      createdAt: t0,
      flow: { screen: "start" },
      settings: {
        lang: "ja",
        lifePreset,
        lifeMs: lifeMsFromPreset(lifePreset),
        hatchPreset,
        hatchMs: hatchMsFromPreset(hatchPreset)
      },
      player: {
        name: "",
        avatarColor: null
      },
      story: {
        petColor: null,
        macaronColor: null,
        foundAt: null,
        arrivalAt: null,
        hatchDueAt: null,
        hatchedAt: null,
        hatchedByTouch: false,
        targetTile: null,
        revealed: []
      },
      life: {
        bornAt: null,
        endAt: null,
        isEnded: false
      },
      stats: {
        hunger: 30,
        waste: 20,
        mood: 70,
        hearts: 55
      },
      sitter: {
        on: false,
        onSince: null,
        usedTotal: 0
      },
      items: {
        drink: 2,
        macaron: 1
      },
      logs: {
        day: { "1": emptyDay(1), "2": emptyDay(2), "3": emptyDay(3) },
        events: [],
        uploaded: []
      },
      _lastTick: t0,
      _prevDay: 0
    };
  }

  function persist(){
    localStorage.setItem(APP_KEY, JSON.stringify(save));
  }

  function load(){
    const raw = localStorage.getItem(APP_KEY);
    if(raw){
      const obj = safeJSONParse(raw, null);
      if(obj && obj.v >= 4) return obj;
    }
    return newSave();
  }

  function resetAll(){
    localStorage.removeItem(APP_KEY);
    save = newSave();
    applyLang();
    hydrate();
    showScreen("start");
  }

  function openModal(title, text, buttons=[]){
    modalTitle.textContent = title;
    modalNote.textContent = text;
    modalBtns.innerHTML = "";
    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = "btn" + (b.kind ? " " + b.kind : " secondary");
      btn.textContent = b.label;
      btn.onclick = () => { try{ b.onClick && b.onClick(); } finally { closeModal(); } };
      modalBtns.appendChild(btn);
    });
    overlay.classList.add("on");
  }
  function closeModal(){ overlay.classList.remove("on"); }

  function fmtMMSS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s%60;
    return String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
  }

  function recordEvent(type, data={}){
    const e = { t: nowMs(), type, data };
    save.logs.events.push(e);
    if(save.logs.events.length > 1200) save.logs.events.splice(0, save.logs.events.length - 1200);
    persist();
    scheduleUpload("event");
  }

  function dayIndex(effectiveNow){
    if(!save.life.bornAt) return 0;
    const elapsed = Math.max(0, effectiveNow - save.life.bornAt);
    const one = save.settings.lifeMs / 3;
    return clamp(Math.floor(elapsed / one) + 1, 1, 3);
  }

  function effectiveNow(){
    if(save.sitter.on && save.sitter.onSince) return save.sitter.onSince;
    return nowMs();
  }

  function applyLang(){
    $("ui_title").textContent = tr("uiTitle");
    $("modeLabel").textContent = "";
    $("modeMeta").textContent = "";

    $("btn_go_menu").textContent = tr("start");
    $("btn_reset_all").textContent = tr("reset");

    $("t_menu").textContent = tr("menu");
    $("btn_about").textContent = tr("about");
    $("btn_lang").textContent = tr("lang");
    $("btn_menu_next").textContent = tr("next");
    $("t_time_setting").textContent = tr("timeSetting");
    $("t_life_setting").textContent = tr("lifeSetting");
    $("t_hatch_setting").textContent = tr("hatchSetting");

    $("s1").textContent = tr("profileSteps").s1;
    $("s2").textContent = tr("profileSteps").s2;
    $("s3").textContent = tr("profileSteps").s3;
    $("t_name").textContent = tr("nameLabel");
    $("t_buddy").textContent = tr("chooseAvatar");

    $("btn_profile_back").textContent = tr("back");
    $("btn_profile_next").textContent = tr("goSearch");
    $("btn_profile_reset").textContent = tr("reset");

    $("btn_back_profile").textContent = tr("back");
    $("btn_hint").textContent = tr("hint");
    $("btn_back_search").textContent = tr("searchAgain");

    $("arrivalTouchHint").textContent = tr("touchHint");

    $("careTitle").textContent = tr("careTitle");
    $("t_sitter").textContent = tr("sitter");
    $("sitterNote").textContent = tr("sitterNote");

    $("word_thanks").textContent = tr("thanks");
  }

  function hydrate(){
    // スタート画面はマカロンじゃなくて飾りにする
    $("startVisual").src = START_VISUAL_SVG;
    $("menuVisual").src = START_VISUAL_SVG;

    $("lifePreset").value = save.settings.lifePreset;
    $("hatchPreset").value = save.settings.hatchPreset;

    $("playerName").value = save.player.name || "";

    buildCharChoices();
    updateProfileState();

    const inProgress = !!save.life.bornAt && !save.life.isEnded;
    $("p_menu_lock").style.display = inProgress ? "block" : "none";
    $("lifePreset").disabled = inProgress;
    $("hatchPreset").disabled = inProgress;

    updateTopSubline();

    showScreen(save.flow.screen || "start");
  }

  function updateTopSubline(){
    const nm = (save.player.name || "").trim();
    $("subline").textContent = nm ? (nm + " の記録") : " ";
  }

  function buildCharChoices(){
    const holder = $("charChoices");
    holder.innerHTML = "";
    const list = [
      { key:"pink", label:"Pink" },
      { key:"blue", label:"Blue" },
      { key:"green", label:"Green" },
      { key:"purple", label:"Purple" }
    ];

    list.forEach(item => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.type = "button";
      btn.dataset.key = item.key;

      const img = document.createElement("img");
      setImgWithFallback(img, ASSETS.char[item.key].closed);
      img.alt = item.key;

      const tx = document.createElement("div");
      tx.className = "ctext";
      const nm = document.createElement("div");
      nm.className = "cname";
      nm.textContent = item.label;
      const ds = document.createElement("div");
      ds.className = "cdesc";
      ds.textContent = " ";

      tx.appendChild(nm);
      tx.appendChild(ds);

      btn.appendChild(img);
      btn.appendChild(tx);

      btn.onclick = () => {
        save.player.avatarColor = item.key;

        // 生まれてくる色のルールを適用
        const pet = pickPetColor(item.key);
        save.story.petColor = pet;
        save.story.macaronColor = pet;

        recordEvent("choose_avatar", { avatar: save.player.avatarColor, pet: save.story.petColor });
        persist();
        buildCharChoices();
        updateProfileState();
      };

      if(save.player.avatarColor === item.key) btn.classList.add("selected");
      holder.appendChild(btn);
    });

    // プレビュー
    const pv = $("charPreview");
    const c = save.player.avatarColor || "pink";
    setImgWithFallback(pv, ASSETS.char[c].closed);
  }

  function updateProfileState(){
    const nameOk = (save.player.name || "").trim().length > 0;
    const colorOk = !!save.player.avatarColor;
    $("btn_profile_next").disabled = !(nameOk && colorOk);
    $("profileNeed").textContent = "";
    updateTopSubline();
  }

  function buildSearchMap(){
    const grid = $("mapGrid");
    grid.innerHTML = "";

    const total = 16;
    const target = save.story.targetTile ?? Math.floor(Math.random() * total);
    save.story.targetTile = target;

    for(let i=0;i<total;i++){
      const btn = document.createElement("button");
      btn.className = "tile";
      btn.type = "button";
      btn.dataset.i = String(i);

      const span = document.createElement("span");
      span.textContent = " ";

      const img = document.createElement("img");
      img.className = "foundImg";
      img.alt = "macaron";
      const macCol = save.story.macaronColor || pickPetColor(save.player.avatarColor || "pink");
      setImgWithFallback(img, ASSETS.macaron[macCol]);

      btn.appendChild(img);
      btn.appendChild(span);

      if(save.story.revealed.includes(i)) btn.classList.add("revealed");

      btn.onclick = () => {
        if(save.story.foundAt) return;
        save.story.revealed.push(i);
        if(i === target){
          save.story.foundAt = nowMs();
          btn.classList.add("found");
          recordEvent("found_macaron", { tile: i, macaronColor: save.story.macaronColor });
          persist();
          goArrival();
        }else{
          btn.classList.add("revealed");
          recordEvent("search_miss", { tile: i });
          persist();
          buildSearchMap();
          updateSearchNote();
        }
      };

      grid.appendChild(btn);
    }

    persist();
    updateSearchNote();
  }

  function updateSearchNote(){
    const n = save.story.revealed.length;
    const d = I18N[lang()] || I18N.ja;
    let text = d.searchNote0;
    if(save.story.foundAt) text = d.searchNote2;
    else if(n >= 4) text = d.searchNote1;
    $("searchNote").textContent = text;
  }

  function goArrival(){
    save.story.arrivalAt = nowMs();
    const due = save.story.arrivalAt + save.settings.hatchMs;
    save.story.hatchDueAt = due;
    persist();

    $("t_arrival").textContent = tr("arrivalTitle");
    $("arrivalText").textContent = tr("arrivalText");
    $("t_watch").textContent = tr("watch");
    $("p_watch").textContent = tr("watchText");

    const avatarColor = save.player.avatarColor || "pink";
    const petColor = save.story.petColor || pickPetColor(avatarColor);
    const macaronColor = save.story.macaronColor || petColor;

    setImgWithFallback($("orbitChar"), ASSETS.char[avatarColor].closed);
    setImgWithFallback($("arrivalMacaron"), ASSETS.macaron[macaronColor]);
    setImgWithFallback($("petReveal"), ASSETS.char[petColor].closed);

    $("petReveal").classList.remove("revealing");
    $("arrivalMacaron").classList.remove("fading");

    showScreen("arrival");
  }

  function hatch(byTouch){
    if(save.story.hatchedAt) return;
    save.story.hatchedAt = nowMs();
    save.story.hatchedByTouch = !!byTouch;

    save.life.bornAt = effectiveNow();
    save.life.endAt = save.life.bornAt + save.settings.lifeMs;

    $("arrivalMacaron").classList.add("fading");
    $("petReveal").classList.add("revealing");

    recordEvent("hatch", { byTouch: !!byTouch, pet: save.story.petColor });
    persist();

    setTimeout(() => {
      showScreen("care");
      setupCareVisual();
      scheduleUpload("hatch");
    }, 2600);
  }

  function setupCareVisual(){
    const avatarColor = save.player.avatarColor || "pink";
    const petColor = save.story.petColor || pickPetColor(avatarColor);

    setImgWithFallback($("avatarImg"), ASSETS.char[avatarColor].closed);
    setImgWithFallback($("petImg"), ASSETS.char[petColor].closed);

    updateCareUI();
  }

  function petStateClass(){
    const h = save.stats.hunger;
    const w = save.stats.waste;
    const m = save.stats.mood;

    if(w > 82 || h > 85 || m < 22) return "cry";
    if(w > 62 || h > 65 || m < 42) return "low";
    return "happy";
  }

  function updateCareUI(){
    const hearts = clamp(Math.round(save.stats.hearts / 20), 0, 5);
    for(let i=1;i<=5;i++){
      $("h"+i).classList.toggle("on", i <= hearts);
    }

    const nowE = effectiveNow();
    const total = save.settings.lifeMs;
    const elapsed = Math.max(0, nowE - save.life.bornAt);
    const remain = Math.max(0, save.life.endAt - nowE);

    const day = dayIndex(nowE);
    $("lifeText").textContent = tr("day") + " " + day + "/3";
    $("lifeRemain").textContent = tr("remain") + " " + fmtMMSS(remain);

    const pct = clamp(elapsed / total, 0, 1);
    $("lifeFill").style.width = (pct*100).toFixed(1) + "%";

    // 生まれてくる子は小さく、徐々に大きく
    const avatarScale = 1.03;
    const base = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--pet-base-scale")) || 0.52;
    const max  = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--pet-max-scale"))  || 0.96;
    const petScale = base + (max - base) * pct;

    $("avatarImg").style.transform = `scale(${avatarScale})`;
    $("petImg").style.transform = `scale(${petScale})`;

    const avatarColor = save.player.avatarColor || "pink";
    const petColor = save.story.petColor || pickPetColor(avatarColor);

    const cls = petStateClass();
    $("petImg").classList.remove("happy","low","cry");
    $("petImg").classList.add(cls);

    const open = (cls === "happy");
    setImgWithFallback($("petImg"), open ? ASSETS.char[petColor].open : ASSETS.char[petColor].closed);

    $("toggle_sitter").classList.toggle("on", save.sitter.on);
    $("toggle_sitter").setAttribute("aria-checked", save.sitter.on ? "true" : "false");

    if(!save.life.isEnded && nowE >= save.life.endAt){
      endGame();
    }
  }

  function tick(){
    if(!save) return;

    if(save.flow.screen === "arrival" && !save.story.hatchedAt){
      const remain = Math.max(0, save.story.hatchDueAt - nowMs());
      $("hatchTime").textContent = tr("openSoon") + " " + fmtMMSS(remain);
      const pct = 1 - clamp(remain / save.settings.hatchMs, 0, 1);
      $("hatchFill").style.width = (pct*100).toFixed(1) + "%";
      if(remain <= 0){
        hatch(false);
      }
    }

    if(save.life.bornAt && !save.life.isEnded){
      const t = effectiveNow();
      const dt = Math.max(0, t - save._lastTick);
      save._lastTick = t;

      const perMin = dt / (60*1000);
      if(perMin > 0){
        save.stats.hunger = clamp(save.stats.hunger + 3.2*perMin, 0, 100);
        save.stats.waste  = clamp(save.stats.waste  + 2.6*perMin, 0, 100);
        save.stats.mood   = clamp(save.stats.mood   - 1.6*perMin, 0, 100);

        const pressure = (save.stats.hunger + save.stats.waste) / 2;
        save.stats.hearts = clamp(save.stats.hearts + (pressure < 45 ? 0.15*perMin : -0.25*perMin), 0, 100);
      }

      const d = dayIndex(t);
      if(d && d !== save._prevDay){
        save._prevDay = d;
        recordEvent("day_change", { day: d });
        scheduleUpload("day_change");
      }

      persist();

      if(save.flow.screen === "care"){
        updateCareUI();
      }
    }
  }

  function endGame(){
    save.life.isEnded = true;
    recordEvent("end", { endedAt: nowMs() });
    persist();
    scheduleUpload("end", true);
    showScreen("end");
  }

  function applyChoice(kind, options){
    const picked = options[Math.floor(Math.random()*options.length)];

    if(kind === "food"){
      save.stats.hunger = clamp(save.stats.hunger - picked.h, 0, 100);
      save.stats.mood = clamp(save.stats.mood + picked.m, 0, 100);
    }
    if(kind === "outing"){
      save.stats.mood = clamp(save.stats.mood + picked.m, 0, 100);
      save.stats.waste = clamp(save.stats.waste + picked.w, 0, 100);
    }
    if(kind === "mini"){
      save.stats.mood = clamp(save.stats.mood + picked.m, 0, 100);
      save.stats.hunger = clamp(save.stats.hunger + picked.h, 0, 100);
    }
    if(kind === "clean"){
      save.stats.waste = clamp(save.stats.waste - picked.w, 0, 100);
      save.stats.mood = clamp(save.stats.mood + picked.m, 0, 100);
    }

    save.stats.hearts = clamp(save.stats.hearts + picked.heart, 0, 100);

    recordEvent("care", { kind, pick: picked.id });
    persist();
    updateCareUI();
  }

  function doDrink(){
    if(save.items.drink <= 0) return;
    save.items.drink -= 1;
    save.stats.mood = clamp(save.stats.mood + 12, 0, 100);
    save.stats.hunger = clamp(save.stats.hunger - 10, 0, 100);
    save.stats.waste = clamp(save.stats.waste - 6, 0, 100);

    if(save.life.bornAt && save.life.endAt){
      save.life.endAt += 60*1000;
    }

    recordEvent("drink", {});
    persist();
    updateCareUI();
  }

  function doMacaron(){
    if(save.items.macaron <= 0) return;
    save.items.macaron -= 1;
    save.stats.mood = clamp(save.stats.mood + 8, 0, 100);
    save.stats.hearts = clamp(save.stats.hearts - 2, 0, 100);
    recordEvent("macaron", {});
    persist();
    updateCareUI();
  }

  function toggleSitter(){
    if(!save.life.bornAt || save.life.isEnded) return;

    if(!save.sitter.on){
      save.sitter.on = true;
      save.sitter.onSince = nowMs();
      recordEvent("sitter_on", {});
    }else{
      save.sitter.on = false;
      const used = Math.max(0, nowMs() - (save.sitter.onSince || nowMs()));
      save.sitter.usedTotal += used;
      save.sitter.onSince = null;
      recordEvent("sitter_off", { usedMs: used });
    }
    persist();
    updateCareUI();
    scheduleUpload("sitter");
  }

  function scheduleUpload(reason, immediate=false){
    if(!LOG_ENDPOINT) return;
    if(immediate){
      uploadNow(reason);
      return;
    }
    if(uploadTimer) return;
    uploadTimer = setTimeout(() => {
      uploadTimer = null;
      uploadNow(reason);
    }, 8000);
  }

  async function uploadNow(reason){
    if(!LOG_ENDPOINT) return;

    const payload = {
      project: LOG_PROJECT,
      reason,
      sentAt: nowMs(),
      playerId: save.id,
      lang: save.settings.lang,
      name: save.player.name,
      avatar: save.player.avatarColor,
      pet: save.story.petColor,
      settings: {
        lifePreset: save.settings.lifePreset,
        hatchPreset: save.settings.hatchPreset,
        lifeMs: save.settings.lifeMs,
        hatchMs: save.settings.hatchMs
      },
      timeline: {
        createdAt: save.createdAt,
        foundAt: save.story.foundAt,
        arrivalAt: save.story.arrivalAt,
        hatchedAt: save.story.hatchedAt,
        bornAt: save.life.bornAt,
        endAt: save.life.endAt,
        isEnded: save.life.isEnded
      },
      stats: save.stats,
      items: save.items,
      sitter: save.sitter,
      events: save.logs.events
    };

    try{
      await fetch(LOG_ENDPOINT, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      save.logs.uploaded.push({ t: nowMs(), reason });
      if(save.logs.uploaded.length > 50) save.logs.uploaded.shift();
      persist();
    }catch(e){
      save.logs.uploaded.push({ t: nowMs(), reason: "failed:" + reason });
      if(save.logs.uploaded.length > 50) save.logs.uploaded.shift();
      persist();
    }
  }

  // --- クリックイベント ---
  $("btn_close_modal").onclick = closeModal;
  overlay.addEventListener("click", (e) => { if(e.target === overlay) closeModal(); });

  $("btn_reset_all").onclick = () => {
    openModal(tr("reset"), "保存を消して最初からにします", [
      { label: tr("reset"), kind: "danger", onClick: resetAll },
      { label: tr("back"), kind: "secondary", onClick: () => {} }
    ]);
  };

  $("btn_go_menu").onclick = () => showScreen("menu");

  $("btn_about").onclick = () => {
    const d = I18N[lang()] || I18N.ja;
    const tabs = d.aboutTabs;
    const body = d.aboutText;

    const container = document.createElement("div");
    const tabRow = document.createElement("div");
    tabRow.style.display = "flex";
    tabRow.style.gap = "8px";
    tabRow.style.flexWrap = "wrap";
    tabRow.style.marginBottom = "10px";

    const note = document.createElement("div");
    note.className = "mnote";

    function setTab(k){
      note.textContent = body[k];
      [...tabRow.children].forEach(ch => ch.classList.remove("blue"));
      tabRow.querySelector(`[data-k='${k}']`)?.classList.add("blue");
    }

    ["ja","en","zh"].forEach(k => {
      const b = document.createElement("button");
      b.className = "btn secondary";
      b.dataset.k = k;
      b.textContent = tabs[k];
      b.onclick = () => setTab(k);
      tabRow.appendChild(b);
    });

    container.appendChild(tabRow);
    container.appendChild(note);

    modalTitle.textContent = tr("aboutTitle");
    modalNote.innerHTML = "";
    modalNote.appendChild(container);
    modalBtns.innerHTML = "";
    overlay.classList.add("on");

    setTab(lang());
  };

  $("btn_lang").onclick = () => {
    openModal(tr("lang"), "日本語 / English / 中文", [
      { label: "日本語", kind:"secondary", onClick: () => { save.settings.lang = "ja"; persist(); applyLang(); } },
      { label: "English", kind:"secondary", onClick: () => { save.settings.lang = "en"; persist(); applyLang(); } },
      { label: "中文", kind:"secondary", onClick: () => { save.settings.lang = "zh"; persist(); applyLang(); } },
    ]);
  };

  $("lifePreset").onchange = (e) => {
    if($("lifePreset").disabled) return;
    save.settings.lifePreset = e.target.value;
    save.settings.lifeMs = lifeMsFromPreset(save.settings.lifePreset);
    recordEvent("set_life", { preset: save.settings.lifePreset });
    persist();
  };

  $("hatchPreset").onchange = (e) => {
    if($("hatchPreset").disabled) return;
    save.settings.hatchPreset = e.target.value;
    save.settings.hatchMs = hatchMsFromPreset(save.settings.hatchPreset);
    recordEvent("set_hatch", { preset: save.settings.hatchPreset });
    persist();
  };

  $("btn_menu_next").onclick = () => showScreen("profile");

  $("playerName").addEventListener("input", (e) => {
    save.player.name = e.target.value.slice(0, 24);
    persist();
    updateProfileState();
  });

  $("btn_profile_back").onclick = () => showScreen("menu");
  $("btn_profile_reset").onclick = () => $("btn_reset_all").click();

  $("btn_profile_next").onclick = () => {
    if(!save.story.petColor && save.player.avatarColor){
      const pet = pickPetColor(save.player.avatarColor);
      save.story.petColor = pet;
      save.story.macaronColor = pet;
    }

    save.story.foundAt = null;
    save.story.arrivalAt = null;
    save.story.hatchDueAt = null;
    save.story.hatchedAt = null;
    save.story.hatchedByTouch = false;
    save.story.targetTile = null;
    save.story.revealed = [];
    persist();

    $("t_search").textContent = tr("searchTitle");
    $("p_search").textContent = " ";
    $("t_presence").textContent = " ";

    buildSearchMap();
    showScreen("search");
  };

  $("btn_back_profile").onclick = () => showScreen("profile");
  $("btn_hint").onclick = () => {
    if(save.story.foundAt) return;
    const total = 16;
    const i = Math.floor(Math.random()*total);
    if(!save.story.revealed.includes(i)) save.story.revealed.push(i);
    recordEvent("hint", { tile: i });
    persist();
    buildSearchMap();
  };

  $("btn_back_search").onclick = () => {
    save.story.foundAt = null;
    save.story.arrivalAt = null;
    save.story.hatchDueAt = null;
    save.story.hatchedAt = null;
    save.story.hatchedByTouch = false;
    persist();
    buildSearchMap();
    showScreen("search");
  };

  $("btn_touch_macaron").onclick = () => {
    if(save.flow.screen !== "arrival") return;
    hatch(true);
  };

  $("btn_food").onclick = () => applyChoice("food", [
    { id:"light", h:18, m:4, heart: 1 },
    { id:"full",  h:26, m:2, heart: 0 }
  ]);
  $("btn_outing").onclick = () => applyChoice("outing", [
    { id:"go",   m:10, w:4, heart: 1 },
    { id:"stay", m:5,  w:1, heart: 0 }
  ]);
  $("btn_mini").onclick = () => applyChoice("mini", [
    { id:"a", m:8, h:2, heart: 0 },
    { id:"b", m:6, h:1, heart: 1 }
  ]);
  $("btn_clean").onclick = () => applyChoice("clean", [
    { id:"quick", w:18, m:4, heart: 1 },
    { id:"deep",  w:26, m:2, heart: 0 }
  ]);
  $("btn_drink").onclick = doDrink;
  $("btn_macaron").onclick = doMacaron;

  $("toggle_sitter").onclick = toggleSitter;
  $("toggle_sitter").addEventListener("keydown", (e) => {
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      toggleSitter();
    }
  });

  window.addEventListener("online", () => scheduleUpload("online", true));

  // 初期化
  save = load();
  applyLang();
  hydrate();

  clearInterval(tickTimer);
  tickTimer = setInterval(tick, 250);

  if(save.life.bornAt && !save.life.isEnded && save.flow.screen === "care"){
    setupCareVisual();
  }

})();
</script>
</body>
</html>
