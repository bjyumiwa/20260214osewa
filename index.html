<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3æ—¥é–“ã®ãŠä¸–è©±ã‚²ãƒ¼ãƒ ï¼ˆ2Dï¼‰</title>
  <style>
    :root{
      --bg0:#050816;
      --bg1:#0b1028;
      --card:rgba(255,255,255,.08);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.72);
      --line:rgba(255,255,255,.14);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background:
        linear-gradient(180deg, rgba(5,8,22,.55), rgba(11,16,40,.70)),
        url("public/char/space_background.png") center/cover no-repeat fixed;
      min-height:100vh;
      overflow-x:hidden;
    }

    .wrap{max-width: 1100px; margin:0 auto; padding: 18px 14px 40px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 10px;
      backdrop-filter: blur(10px);
      z-index: 20;
      flex-wrap: wrap;
    }
    .brand{display:flex; gap:10px; align-items:center;}
    .brand .dot{
      width:12px;height:12px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.1)),
                  linear-gradient(180deg, #c4b5fd, #93c5fd);
      box-shadow: 0 0 18px rgba(196,181,253,.35);
    }
    .brand .title{font-weight: 750; letter-spacing:.02em; font-size: 14px; line-height: 1.2;}
    .brand .sub{font-size: 12px; color: var(--muted); margin-top: 2px;}
    .statusRow{display:flex; gap: 10px; align-items:center; justify-content:flex-end; flex: 1; flex-wrap: wrap;}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      min-height: 34px;
      position: relative;
    }
    .pill small{color: var(--muted);}

    .heartIcon{
      width:16px;height:16px; display:inline-block;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.1)),
                  linear-gradient(180deg, rgba(251,113,133,.95), rgba(196,181,253,.85));
      clip-path: path("M8 14s6-3.3 6-7.2C14 4.6 12.8 3 10.8 3 9.6 3 8.7 3.7 8 4.6 7.3 3.7 6.4 3 5.2 3 3.2 3 2 4.6 2 6.8 2 10.7 8 14 8 14Z");
      opacity:.95;
    }
    .hearts{
      width: 140px; height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      overflow:hidden;
    }
    .hearts > i{
      display:block; height:100%; width:50%;
      background: linear-gradient(90deg, rgba(196,181,253,.95), rgba(147,197,253,.95));
      box-shadow: 0 0 14px rgba(147,197,253,.25);
    }

    .langSel{
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(238,242,255,.92);
      border-radius: 12px;
      padding: 8px 28px 8px 10px;
      font-weight: 700;
      cursor: pointer;
      outline: none;
      line-height: 1;
    }
    .langSel option{background:#0b1028; color:#eef2ff;}
    .pill[title="Language"]::after{
      content:"â–¾";
      position:absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(238,242,255,.72);
      pointer-events:none;
      font-size: 12px;
    }

    .toggle{display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;}
    .switch{
      width:42px;height:24px;border-radius:999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      position: relative;
      transition: .18s ease;
    }
    .switch::after{
      content:"";
      width:18px;height:18px;border-radius:999px;
      position:absolute; top:2px; left:2px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 8px 14px rgba(0,0,0,.25);
      transition: .18s ease;
    }
    .toggle[data-on="true"] .switch{
      background: rgba(154,230,180,.18);
      border-color: rgba(154,230,180,.28);
    }
    .toggle[data-on="true"] .switch::after{
      left: 20px;
      background: rgba(154,230,180,.95);
    }

    .main{margin-top: 14px; display:grid; grid-template-columns: 1.5fr 1fr; gap: 14px; align-items:start;}
    .card{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      flex-wrap: wrap;
    }
    .cardHeader .h{font-weight: 800; font-size: 14px;}
    .cardHeader .hint{font-size:12px;color:var(--muted); margin-top: 2px;}
    .btnRow{display:flex; gap: 10px; flex-wrap: wrap;}

    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 10px;
      cursor:pointer;
      font-weight: 650;
      letter-spacing:.01em;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      transition: transform .08s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22);}
    button:active{transform: translateY(0px) scale(.99);}
    button[disabled]{opacity:.45; cursor:not-allowed; transform:none;}
    .btnGhost{background: rgba(255,255,255,.03); padding: 10px 10px;}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap: 10px;}

    .stage{
      position: relative;
      min-height: 520px;
      padding: 14px;
    }
    .sky{position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 60% 10%, rgba(196,181,253,.10), transparent 60%),
        radial-gradient(900px 600px at 15% 80%, rgba(147,197,253,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0));
    }
    .stars{
      position:absolute; inset:0; pointer-events:none; opacity:.55;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.8) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 30%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 85% 75%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 25% 50%, rgba(255,255,255,.55) 0 1px, transparent 2px);
      background-size: 420px 260px;
      filter: blur(.2px);
      animation: drift 18s linear infinite;
    }
    @keyframes drift{
      0%{transform: translate3d(0,0,0);}
      100%{transform: translate3d(-80px, 50px, 0);}
    }
    .center{
      position:absolute;
      left:50%;
      top: 55%;
      transform: translate(-50%,-50%);
      width: 100%;
      max-width: 560px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      padding: 12px;
    }
    .entity{
      width: 280px;
      height: 280px;
      display:grid;
      place-items:center;
      position: relative;
    }
    .floaty{animation: floaty 2.6s ease-in-out infinite;}
    @keyframes floaty{
      0%,100%{transform: translateY(0);}
      50%{transform: translateY(-10px);}
    }

    .macaronWrap{width: 260px; height: 260px; display:grid; place-items:center; position: relative;}
    .macaronImg{
      width: 210px; height: 210px; object-fit: contain;
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.35));
      opacity: .98;
    }
    .hatchLift{animation: hatchLift 1.6s ease-in-out 1 forwards;}
    @keyframes hatchLift{
      0%{transform: translateY(0) scale(1); opacity: 1;}
      60%{transform: translateY(-26px) scale(1.02); opacity: 1;}
      100%{transform: translateY(-60px) scale(.95); opacity: 0;}
    }

    .charWrap{
      width: 260px; height: 260px;
      display:grid; place-items:center;
      position: relative;
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.35));
    }
    .charScaleBox{
      width: 100%;
      height: 100%;
      display:grid;
      place-items:center;
      transform-origin: 50% 55%;
      transition: transform .25s ease;
    }
    .charImg{
      width: 230px; height: 230px; object-fit: contain; opacity: .98; transition: .18s ease;
    }
    .charWrap.lively{animation: livelyBounce 1.4s ease-in-out infinite;}
    @keyframes livelyBounce{
      0%,100%{transform: translateY(0) rotate(0deg);}
      50%{transform: translateY(-7px) rotate(.6deg);}
    }
    .charWrap.low .charImg{filter: saturate(.75) brightness(.95); transform: translateY(2px);}
    .charWrap.cry .charImg{filter: saturate(.65) brightness(.9); animation: cryShake .18s steps(2) infinite;}
    @keyframes cryShake{
      0%{transform: translate(0,0);}
      50%{transform: translate(2px,-1px);}
      100%{transform: translate(-1px,1px);}
    }

    .charWrap.sleep{animation: sleepBreath 2.8s ease-in-out infinite;}
    .charWrap.sleep .charImg{filter: saturate(.9) brightness(.96); transform: translateY(3px);}
    @keyframes sleepBreath{
      0%,100%{transform: translateY(2px);}
      50%{transform: translateY(-4px);}
    }

    .tears{position:absolute; inset:0; pointer-events:none; opacity:0; transition:.18s ease;}
    .charWrap.cry .tears{opacity:1;}
    .tear{
      position:absolute;
      width: 10px; height: 18px;
      border-radius: 999px;
      background: rgba(147,197,253,.72);
      left: 92px; top: 130px;
      transform: rotate(10deg);
      animation: tearDrop 1.2s ease-in-out infinite;
      filter: blur(.1px);
    }
    .tear:nth-child(2){
      left: 150px; top: 132px;
      transform: rotate(-8deg);
      animation-delay: .22s;
      opacity:.9;
    }
    @keyframes tearDrop{
      0%{transform: translateY(0) scale(1) rotate(10deg); opacity:.0;}
      35%{opacity:.75;}
      100%{transform: translateY(26px) scale(.95) rotate(10deg); opacity:0;}
    }

    /* ğŸ’©è¡¨ç¤ºï¼šæœ€å¤§10 */
    .poops{
      position:absolute;
      left: 18px;
      bottom: 18px;
      display:flex;
      gap: 6px;
      align-items:center;
      opacity:.95;
      flex-wrap: wrap;
      max-width: 240px;
    }
    .poop{
      width: 14px; height: 14px;
      border-radius: 5px;
      background: linear-gradient(180deg, rgba(251,146,60,.92), rgba(234,179,8,.82));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 16px rgba(0,0,0,.25);
      transform: rotate(-8deg);
      opacity:.08;
      transition: .18s ease;
    }
    .poop.on{opacity:.95;}
    .poop:nth-child(2n){transform: rotate(8deg) translateY(-1px);}
    .poop:nth-child(3n){transform: rotate(-4deg) translateY(1px);}

    .stageNote{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      opacity:.95;
      line-height: 1.6;
      white-space: pre-wrap;
      min-height: 42px;
    }

    .rightPane{display:flex; flex-direction:column; gap: 14px;}
    .actions{padding: 12px; display:flex; flex-direction:column; gap: 10px;}
    .logPane{padding: 12px;}
    .mini{font-size: 12px; color: var(--muted); line-height: 1.6;}
    .logList{margin-top: 10px; display:flex; flex-direction:column; gap: 8px; max-height: 290px; overflow:auto; padding-right: 6px;}
    .logItem{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 12px;
      line-height: 1.5;
    }
    .logItem b{font-size:12px;}
    .logItem .t{color: var(--muted); margin-top: 2px; font-size: 11px;}

    .centerOverlay{
      position:absolute; inset:0;
      display:none; place-items:center;
      z-index: 10;
      pointer-events:none;
    }
    .centerOverlay.show{display:grid;}
    .thanks{font-weight: 900; font-size: 44px; letter-spacing: .06em; text-shadow: 0 18px 48px rgba(0,0,0,.45); opacity:.98;}

    .screen{display:none;}
    .screen.show{display:block;}

    .modalBack{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; place-items:center;
      z-index: 99; padding: 18px;
    }
    .modalBack.show{display:grid;}
    .modal{
      width: min(560px, 96vw);
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(16,18,34,.88);
      border-radius: 18px;
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modalHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .modalHead .h{font-weight: 850; font-size: 14px; letter-spacing:.02em;}
    .modalBody{padding: 12px;}
    .modalFoot{
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex; gap: 10px; justify-content:flex-end; flex-wrap: wrap;
    }
    .two{display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;}
    .choice{
      text-align:left;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: .18s ease;
      min-height: 96px;
      display:flex; flex-direction:column; gap: 6px; justify-content:center;
    }
    .choice:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.22); transform: translateY(-1px);}
    .choice .cTitle{font-weight: 800; font-size: 13px; display:flex; align-items:center; gap: 8px;}
    .choice .cSub{font-size: 12px; color: var(--muted); line-height:1.5;}
    .cIcon{
      width: 26px; height: 26px;
      border-radius: 10px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      font-size: 16px;
      line-height: 1;
      flex: 0 0 auto;
    }

    .observeWrap{padding: 12px;}
    .observeHeader{display:flex; gap: 10px; align-items:flex-start; justify-content:space-between; flex-wrap: wrap;}
    .observeHeader .h{font-weight: 900; font-size: 16px; letter-spacing:.02em;}
    .observeHeader .p{margin-top: 4px; font-size: 12px; color: var(--muted); line-height:1.6;}
    .chartBox{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px;
    }
    canvas{width:100%; height:160px; display:block;}
    .days{margin-top: 12px; display:flex; flex-direction:column; gap: 10px;}
    .dayCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px;
    }
    .dayCard .dh{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom: 8px;}
    .dayCard .dh b{font-size: 13px;}
    .dayCard .dh small{color: var(--muted);}
    .kvs{display:grid; grid-template-columns: 1fr 1fr; gap: 8px 10px; font-size: 12px; color: rgba(238,242,255,.88); line-height:1.6;}
    .kvs span{color: var(--muted);}
    .choices{
      margin-top: 8px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 8px;
      font-size: 12px;
      color: rgba(238,242,255,.88);
      line-height:1.7;
      white-space: pre-wrap;
    }

    .letterSlot{display:none;}
    .letterSlot.show{
      display:block;
      animation: letterAppear .9s ease-out both;
    }
    @keyframes letterAppear{
      0%{opacity:0; transform: translateY(8px) scale(.98); filter: blur(10px);}
      100%{opacity:1; transform: translateY(0) scale(1); filter: blur(0);}
    }
    .letterBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      animation: letterFloat 3.4s ease-in-out infinite;
    }
    @keyframes letterFloat{
      0%,100%{transform: translateY(0);}
      50%{transform: translateY(-3px);}
    }
    .letterIcon{font-size: 18px; line-height: 1; opacity:.95;}
    .letterHint{font-size: 12px; color: rgba(238,242,255,.86); letter-spacing: .02em;}

    .letterModal{
      position: fixed;
      inset: 0;
      display:none;
      place-items:center;
      padding: 18px;
      background: rgba(0,0,0,.40);
      z-index: 120;
    }
    .letterModal.open{display:grid; animation: modalIn .25s ease-out both;}
    .letterModal.closing{display:grid; animation: modalOut .22s ease-in both;}
    @keyframes modalIn{from{opacity:0;}to{opacity:1;}}
    @keyframes modalOut{from{opacity:1;}to{opacity:0;}}
    .letterPaper{
      width: min(560px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(16,18,34,.88);
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position: relative;
    }
    .letterHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .letterHead b{font-size: 14px; letter-spacing:.02em;}
    .letterBody{padding: 12px;}
    .letterText{
      font-size: 13px;
      line-height: 1.85;
      color: rgba(238,242,255,.92);
      white-space: pre-wrap;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .letterFoot{
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:flex-end;
      gap: 10px;
    }

    /* ğŸ’©ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ï¼ˆç”»é¢åˆ‡ã‚Šæ›¿ãˆï¼‰ */
    .cleanWrap{padding: 12px;}
    .cleanHUD{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .cleanCounter{
      display:flex; align-items:center; gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: rgba(238,242,255,.88);
    }
    .cleanCounter b{font-size: 12px;}
    .cleanTime{
      flex: 1;
      min-width: 180px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .cleanTime > i{
      display:block; height:100%; width:100%;
      background: linear-gradient(90deg, rgba(196,181,253,.95), rgba(147,197,253,.95));
      transform-origin: 0 50%;
      transform: scaleX(1);
      box-shadow: 0 0 14px rgba(147,197,253,.18);
    }
    .cleanStage{
      margin-top: 12px;
      position: relative;
      height: 420px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 420px at 30% 25%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(700px 380px at 80% 60%, rgba(196,181,253,.06), transparent 65%),
        rgba(255,255,255,.03);
      overflow:hidden;
      user-select:none;
      touch-action: manipulation;
    }
    .floatPoop{
      position:absolute;
      left: 50%;
      bottom: -70px;
      width: 64px;
      height: 64px;
      display:grid;
      place-items:center;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.25));
      animation: poopUp linear forwards;
      will-change: transform, opacity;
    }
    .floatPoop .inner{
      width: 64px; height: 64px;
      display:grid; place-items:center;
      font-size: 44px;
      line-height: 1;
      animation: poopSway ease-in-out infinite;
      will-change: transform;
      cursor: pointer;
    }
    @keyframes poopUp{
      0%{transform: translateY(0); opacity:0;}
      12%{opacity:1;}
      100%{transform: translateY(-520px); opacity:0;}
    }
    @keyframes poopSway{
      0%{transform: translateX(-10px) rotate(-7deg) scale(1);}
      50%{transform: translateX(12px) rotate(7deg) scale(1.03);}
      100%{transform: translateX(-10px) rotate(-7deg) scale(1);}
    }
    .floatPoop.popped{
      pointer-events:none;
      animation: none !important;
      opacity:0;
      transform: scale(.7) rotate(12deg);
      filter: blur(1px);
      transition: .18s ease;
    }
    .popSpark{
      position:absolute;
      width: 18px; height: 18px;
      border-radius: 999px;
      background: rgba(196,181,253,.85);
      box-shadow: 0 0 18px rgba(196,181,253,.35);
      animation: sparkOut .45s ease-out both;
      pointer-events:none;
    }
    @keyframes sparkOut{
      0%{opacity:0; transform: scale(.6);}
      25%{opacity:.9; transform: scale(1);}
      100%{opacity:0; transform: scale(1.7) translateY(-12px);}
    }
    .cleanBottomNote{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(238,242,255,.70);
      line-height: 1.7;
      white-space: pre-wrap;
    }

    @media (max-width: 860px){
      .main{grid-template-columns: 1fr;}
      .hearts{width: 120px;}
      .cleanStage{height: 360px;}
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title" id="txtGameTitle">3æ—¥é–“ã®ãŠä¸–è©±ã‚²ãƒ¼ãƒ ï¼ˆ2Dï¼‰</div>
          <div class="sub" id="subline">ãƒ­ã‚°è¨˜éŒ²</div>
        </div>
      </div>

      <div class="statusRow">
        <div class="pill" title="é–¢ä¿‚æ€§ã®æŒ‡æ¨™">
          <span class="heartIcon" aria-hidden="true"></span>
          <div class="hearts" aria-hidden="true"><i id="heartFill"></i></div>
          <small id="heartLabel"></small>
        </div>

        <div class="pill" title="Language">
          <small id="txtLangLabel">è¨€èª</small>
          <select id="langSel" class="langSel" aria-label="Language">
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="en">English</option>
            <option value="zh">ä¸­æ–‡</option>
          </select>
        </div>

        <div class="pill toggle" id="sitterToggle" data-on="false" title="ã‚·ãƒƒã‚¿ãƒ¼ONã§æ™‚é–“ãŒæ­¢ã¾ã‚Šã¾ã™ï¼ˆå¯¿å‘½ãƒ»ç©ºè…¹ãƒ»æ’æ³„ãƒ»çŠ¶æ…‹å¤‰åŒ–ã™ã¹ã¦åœæ­¢ï¼‰">
          <small id="txtSitter">ã‚·ãƒƒã‚¿ãƒ¼</small>
          <div class="switch" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="screenGame" class="screen show">
      <div class="main">
        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="h" id="txtStageHeader">ã‚¹ãƒ†ãƒ¼ã‚¸</div>
              <div class="hint" id="stageHint"></div>
            </div>
            <div class="btnRow">
              <button class="btnGhost" id="btnShare">è¦³å¯Ÿç”¨URL</button>
              <button class="btnGhost" id="btnLogs">ãƒ­ã‚°</button>
              <button class="btnGhost" id="btnName">åå‰</button>
              <button class="btnGhost" id="btnReset">ã¯ã˜ã‚ã‹ã‚‰</button>
            </div>
          </div>

          <div class="stage">
            <div class="sky"></div>
            <div class="stars"></div>

            <div class="center">
              <div class="entity">
                <div id="macaronArea" class="macaronWrap floaty" style="display:none;">
                  <img id="macaronImg" class="macaronImg" alt="" src="" />
                </div>

                <div id="charArea" class="charWrap floaty" style="display:none;">
                  <div id="charScaleBox" class="charScaleBox">
                    <img id="charImg" class="charImg" alt="" src="" />
                  </div>
                  <div class="tears" aria-hidden="true">
                    <div class="tear"></div>
                    <div class="tear"></div>
                  </div>
                </div>
              </div>

              <!-- ğŸ’©æœ€å¤§10 -->
              <div class="poops" aria-hidden="true" id="poopRow">
                <div class="poop"></div><div class="poop"></div><div class="poop"></div><div class="poop"></div><div class="poop"></div>
                <div class="poop"></div><div class="poop"></div><div class="poop"></div><div class="poop"></div><div class="poop"></div>
              </div>

              <div class="stageNote" id="stageNote"></div>
            </div>

            <div class="centerOverlay" id="thanksOverlay" aria-hidden="true">
              <div class="thanks" id="txtThanks">ã‚ã‚ŠãŒã¨ã†</div>
            </div>
          </div>
        </div>

        <div class="rightPane">
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="h" id="txtCareHeader">ãŠä¸–è©±</div>
                <div class="hint" id="txtCareHint">å¥½ããªæ–¹ã‚’é¸ã‚“ã§ãã ã•ã„</div>
              </div>
            </div>

            <div class="actions">
              <div id="letterSlot" class="letterSlot" aria-label="ãŠæ‰‹ç´™">
                <button id="letterBtn" class="letterBtn" type="button" aria-label="ãŠæ‰‹ç´™ã‚’èª­ã‚€">
                  <span class="letterIcon">âœ‰</span>
                  <span class="letterHint" id="txtLetterBtn">ãŠæ‰‹ç´™</span>
                </button>
              </div>

              <div class="grid">
                <button id="btnFood">ğŸ½ é£Ÿäº‹</button>
                <button id="btnOut">ğŸš€ ãŠã§ã‹ã‘</button>
                <button id="btnStyle">âœ¨ ãŠã—ã‚ƒã‚Œ</button>
                <button id="btnClean">ğŸ§¼ æ’æ³„é™¤å»</button>
              </div>
              <div class="grid">
                <button id="btnDrink">ğŸ¥¤ ãƒ‰ãƒªãƒ³ã‚¯</button>
                <button id="btnMacaron" disabled>ğŸ¬ ãƒã‚«ãƒ­ãƒ³</button>
              </div>
              <div class="mini" id="assetHint"></div>
              <div class="mini" id="assetWarn" style="display:none;color:rgba(255,200,200,.9)"></div>
            </div>
          </div>

          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="h" id="txtLogHeader">ãƒ­ã‚°</div>
                <div class="hint" id="txtLogHint">CSVã§ä¿å­˜ã§ãã¾ã™</div>
              </div>
              <div class="btnRow">
                <button id="btnCsv" class="btnGhost">CSV</button>
              </div>
            </div>
            <div class="logPane">
              <div class="mini" id="txtMiniInfo">è¡¨æƒ…ã‚„å‹•ãã ã‘ã§çŠ¶æ…‹ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</div>
              <div class="logList" id="liveLog"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è¦³å¯Ÿç”¨ãƒ­ã‚°ç”»é¢ -->
    <div id="screenObserve" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="h" id="txtObserveHeader">è¦³å¯Ÿç”¨ãƒ­ã‚°</div>
            <div class="hint" id="txtObserveHint">æ“ä½œã¯ã§ãã¾ã›ã‚“ï¼ˆãƒ­ã‚°ã¨ãƒãƒ¼ãƒˆæ¨ç§»ã®ã¿ï¼‰</div>
          </div>
          <div class="btnRow">
            <button id="btnBackToGame" class="btnGhost">æˆ»ã‚‹</button>
          </div>
        </div>

        <div class="observeWrap">
          <div class="observeHeader">
            <div>
              <div class="h" id="obsTitle"></div>
              <div class="p" id="obsSub"></div>
            </div>
          </div>

          <div class="chartBox">
            <canvas id="heartChart" width="900" height="220"></canvas>
          </div>

          <div class="days" id="obsDays"></div>
        </div>
      </div>
    </div>

    <!-- ğŸ’©ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="screenClean" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="h" id="txtCleanHeader">æ’æ³„é™¤å»</div>
            <div class="hint" id="txtCleanHint">æµ®ã‹ã‚“ã§ãã‚‹ğŸ’©ã‚’ã‚¿ãƒƒãƒã—ã¦æ¶ˆã—ã¾ã™</div>
          </div>
          <div class="btnRow">
            <button id="btnCleanExit" class="btnGhost">æˆ»ã‚‹</button>
            <button id="btnCleanFinish" class="btnGhost">ãŠã‚ã‚‹</button>
          </div>
        </div>

        <div class="cleanWrap">
          <div class="cleanHUD">
            <div class="cleanCounter">
              <span aria-hidden="true">ğŸ’©</span>
              <div>
                <div style="font-size:11px;color:rgba(238,242,255,.66)" id="cleanCounterLabel">æ¶ˆã—ãŸæ•°</div>
                <b id="cleanCounterNum">0 / 0</b>
              </div>
            </div>
            <div class="cleanTime" aria-hidden="true"><i id="cleanTimeFill"></i></div>
          </div>

          <div class="cleanStage" id="cleanStage" aria-label="cleaning field"></div>

          <div class="cleanBottomNote" id="cleanNote">é€”ä¸­ã§ã‚„ã‚ã¦ã‚‚OKã€‚ç‰‡ã¥ã‘ãŸåˆ†ã ã‘ã€å°‘ã—ã ã‘å¤‰ã‚ã‚Šã¾ã™ã€‚</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="h" id="modalTitle"></div>
          <div class="hint" id="modalHint"></div>
        </div>
        <button id="modalX" class="btnGhost" style="padding:8px 10px;">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

  <!-- æ‰‹ç´™ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="letterModal" id="letterModal" aria-hidden="true" inert>
    <div class="letterPaper" role="dialog" aria-modal="true">
      <div class="letterHead">
        <b id="txtLetterTitle">ãŠæ‰‹ç´™</b>
        <button id="letterX" class="btnGhost" style="padding:8px 10px;">é–‰ã˜ã‚‹</button>
      </div>
      <div class="letterBody">
        <div class="letterText" id="letterText"></div>
      </div>
      <div class="letterFoot">
        <button id="letterClose" class="btnGhost">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const ASSET_BASE = "public/char/";
  const url = new URL(location.href);
  const FAST = url.searchParams.get("fast") === "1";

  const SAVE_KEY = "osewa_save_2d_char_v5";
  const ARCHIVE_KEY = "osewa_archives_2d_char_v5";
  const LANG_KEY = "osewa_lang_v5";

  const DAY_MS  = 24 * 60 * 60 * 1000;
  const LIFE_MS = 3 * DAY_MS;

  const HATCH_MS = FAST ? 12 * 1000 : 3 * 60 * 1000;
  const LETTER_DELAY_MS = FAST ? 2500 : 30 * 1000;

  const MACARON_REVIVE_MS = FAST ? 18 * 1000 : 10 * 60 * 1000;
  const DRINK_EXTEND_MS   = FAST ? 20 * 1000 : 60 * 60 * 1000;
  const DRINK_BACK_MS     = FAST ?  8 * 1000 : 30 * 60 * 1000;

  // çœ ã‚Šï¼šãƒ©ãƒ³ãƒ€ãƒ ã ã‘ã ã¨å‡ºãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã€ã‚¢ã‚¤ãƒ‰ãƒ«ã§ã‚‚å¿…ãšå…¥ã‚‹
  const SLEEP_MS = FAST ? 10 * 1000 : 2 * 60 * 1000;
  const IDLE_SLEEP_AFTER_MS = FAST ? 11 * 1000 : 70 * 1000;

  // ğŸ’©æœ€å¤§10ï¼ˆã“ã“ãŒè¦æœ›ã®ãƒã‚¤ãƒ³ãƒˆï¼‰
  const POOP_MAX = 10;

  const HUNGER_PER_MIN = 0.25;
  const DIRT_PER_MIN   = 0.18;

  const COLORS = ["blue","green","pink","purple"];

  // ç”»åƒãƒ‘ã‚¹ï¼ˆæŒ‡å®šã©ãŠã‚Šï¼‰
  const FILES = {
    macaron: {
      blue:   "macaron_blue.png",
      green:  "macaron_green.png",
      pink:   "macaron_pink.png",
      purple: "macaron_purple.png",
    },
    char: {
      blue:   { closed:"blue_closed.png",   open:"blue_open.png",   sleep:"blue/sleep.png" },
      green:  { closed:"green_closed.png",  open:"green_open.png",  sleep:"green/sleep.png" },
      purple: { closed:"purple_closed.png", open:"purple_open.png", sleep:"purple/sleep.png" },
      pink:   { closed:"pink_closed.png",   open:"pink_open.png",   sleep:"pick/sleep.png" },
    }
  };

  function getLang(){
    const v = localStorage.getItem(LANG_KEY);
    return (v === "en" || v === "zh" || v === "ja") ? v : "ja";
  }
  let LANG = getLang();

  const I18N = {
    ja: {
      docTitle: "3æ—¥é–“ã®ãŠä¸–è©±ã‚²ãƒ¼ãƒ ï¼ˆ2Dï¼‰",
      gameTitle: "3æ—¥é–“ã®ãŠä¸–è©±ã‚²ãƒ¼ãƒ ï¼ˆ2Dï¼‰",
      langLabel: "è¨€èª",
      sitter: "ã‚·ãƒƒã‚¿ãƒ¼",
      stageHeader: "ã‚¹ãƒ†ãƒ¼ã‚¸",
      careHeader: "ãŠä¸–è©±",
      careHint: "å¥½ããªæ–¹ã‚’é¸ã‚“ã§ãã ã•ã„",
      letter: "ãŠæ‰‹ç´™",
      observeHeader: "è¦³å¯Ÿç”¨ãƒ­ã‚°",
      observeHint: "æ“ä½œã¯ã§ãã¾ã›ã‚“ï¼ˆãƒ­ã‚°ã¨ãƒãƒ¼ãƒˆæ¨ç§»ã®ã¿ï¼‰",
      btnShare: "è¦³å¯Ÿç”¨URL",
      btnLogs: "ãƒ­ã‚°",
      btnName: "åå‰",
      btnReset: "ã¯ã˜ã‚ã‹ã‚‰",
      btnBack: "æˆ»ã‚‹",
      btnClose: "é–‰ã˜ã‚‹",
      btnCancel: "ã‚„ã‚ã‚‹",
      btnCopy: "ã‚³ãƒ”ãƒ¼",
      btnLater: "ã‚ã¨ã§",
      btnDecide: "æ±ºå®š",
      btnFood: "é£Ÿäº‹",
      btnOut: "ãŠã§ã‹ã‘",
      btnStyle: "ãŠã—ã‚ƒã‚Œ",
      btnClean: "æ’æ³„é™¤å»",
      btnDrink: "ãƒ‰ãƒªãƒ³ã‚¯",
      btnMacaron: "ãƒã‚«ãƒ­ãƒ³",
      twoChoice: "2æŠ",
      timeStopped: "æ™‚é–“ãŒæ­¢ã¾ã£ã¦ã„ã‚‹ã€‚",
      waitNote: "ã©ã‚“ãªå­ã‹ãªï¼Ÿã¡ã‚‡ã£ã¨å¾…ã£ã¦ã­",
      sleepNote: "ã™ã‚„ã™ã‚„â€¦",
      subRunning: "ãƒ­ã‚°è¨˜éŒ²",
      subEnded: "æ“ä½œã¯åœæ­¢ã—ã¾ã™",
      thanks: "ã‚ã‚ŠãŒã¨ã†",
      miniInfo: "è¡¨æƒ…ã‚„å‹•ãã ã‘ã§çŠ¶æ…‹ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚",
      assetHint: "ç”»åƒãƒ‘ã‚¹",
      shareTitle: "è¦³å¯Ÿç”¨URL",
      shareHint: "å…±æœ‰ã™ã‚‹ã¨ãƒ­ã‚°ã ã‘è¦‹ã‚‰ã‚Œã¾ã™",
      shareText: "ã“ã®URLã‚’å…±æœ‰ã™ã‚‹ã¨ã€ç¬¬ä¸‰è€…ã¯ã€Œè¦³å¯Ÿç”¨ãƒ­ã‚°ç”»é¢ã€ã ã‘ã‚’é–²è¦§ã§ãã¾ã™ã€‚\næ“ä½œã¯ã§ãã¾ã›ã‚“ã€‚è¦‹ãˆã‚‹ã®ã¯ãƒ­ã‚°ã¨ãƒãƒ¼ãƒˆæ¨ç§»ã®ã¿ã§ã™ã€‚",
      shareCopied: "URLã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã€‚",
      letterLines: [
        "ã‚ãªãŸã¯ã€å¤œç©ºã‹ã‚‰ã“ã¼ã‚Œè½ã¡ãŸã€Œãƒã‚«ãƒ­ãƒ³æ˜Ÿã®ãŸã¾ã”ã€ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚",
        "æ®»ã®ä¸­ã§ã¯ã€ç”˜ã„ã²ã‹ã‚ŠãŒã“ã‚ã“ã‚æºã‚Œã¦ã„ã¾ã™ã€‚",
        "ã“ã®å­ã¯ã€ãŸã£ãŸï¼“æ—¥ã ã‘ã€ã‚ãªãŸã®ãã°ã«ã„ã‚‰ã‚Œã¾ã™ã€‚",
        "ï¼“æ—¥ãŸã£ãŸã‚‰ã€ãƒã‚«ãƒ­ãƒ³æ˜Ÿã¸å¸°ã£ã¦ã—ã¾ã„ã¾ã™ã€‚",
        "ã§ã‚‚ã€ã¨ãã©ãã“ã“ã§é™ã‹ã«çœ ã£ã¦ã—ã¾ã†ã“ã¨ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
        "ã ã‹ã‚‰ã“ãã€ã„ã¾ã ã‘ã¯ã€‚ã‚„ã•ã—ãè‚²ã¦ã¦ã­ã€‚"
      ],
      psName: "è¿½ä¼¸ï¼šã‚ˆã‹ã£ãŸã‚‰ã€ã“ã®å­ã«åå‰ã‚’ã¤ã‘ã¦ã‚ã’ã¦ãã ã•ã„ã€‚",
      nameTitle: "åå‰",
      nameHintInit: "ã“ã®å­ã«åå‰ã‚’ã¤ã‘ã¦ã­",
      nameHintEdit: " ",
      nameStoryEdit: "ã“ã®å­ã®åå‰ã‚’ã€ãã£ã¨å¤‰ãˆã¦ã¿ã‚‹ï¼Ÿ",
      namePlaceholder: "åå‰ï¼ˆ12æ–‡å­—ã¾ã§ï¼‰",
      nameNote: "ã‚ã¨ã§ã€Œåå‰ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚",
      resetTitle: "ã¯ã˜ã‚ã‹ã‚‰",
      resetText: "ã¯ã˜ã‚ã‹ã‚‰éŠã¹ã¾ã™ã€‚\nãƒ­ã‚°ã¯ç—•è·¡ã¨ã—ã¦æ®‹ã™ã‹ã€æ¶ˆã™ã‹é¸ã¹ã¾ã™ã€‚",
      resetKeep: "ãƒ­ã‚°ã‚’æ®‹ã—ã¦ã¯ã˜ã‚ã‚‹",
      resetKeepSub: "éå»ã®ç—•è·¡ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¸ã€‚",
      resetWipe: "ãƒ­ã‚°ã‚’æ¶ˆã—ã¦ã¯ã˜ã‚ã‚‹",
      resetWipeSub: "ã“ã®ç«¯æœ«ã®è¨˜éŒ²ã‚’æ¶ˆã—ã¾ã™ã€‚",
      logArrived: "åˆ°ç€ã—ãŸã€‚",
      logHatched: "æµ®ã‹ã³ä¸ŠãŒã£ã¦ã€èª•ç”Ÿã—ãŸã€‚",
      logDayChanged: "æ—¥ãŒå¤‰ã‚ã£ãŸã€‚",
      logQuiet: "é™ã‹ã«ãªã£ãŸã€‚",
      logGone: "ã„ãªããªã£ãŸã€‚",
      logOff: "ã©ã“ã‹ã‚ºãƒ¬ãŸã¾ã¾ã€ã¾ãŸé™ã‹ã«ãªã£ãŸã€‚",
      logReadLetter: "æ‰‹ç´™ã‚’èª­ã‚“ã ã€‚",
      logNamed: "åå‰ã‚’ã¤ã‘ãŸï¼š",
      logSitterOn: "é ã‘ãŸã€‚",
      logSitterOff: "æˆ»ã£ãŸã€‚",
      cleaned: "ãã‚Œã„ã«ã—ãŸã€‚",
      usedDrink: "ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½¿ã£ãŸã€‚",
      returned: "æˆ»ã£ã¦ããŸã€‚",
      grown: "å°‘ã—å¤§ãããªã£ãŸã€‚",
      cleanHeader: "æ’æ³„é™¤å»",
      cleanHint: "æµ®ã‹ã‚“ã§ãã‚‹ğŸ’©ã‚’ã‚¿ãƒƒãƒã—ã¦æ¶ˆã—ã¾ã™",
      cleanCounterLabel: "æ¶ˆã—ãŸæ•°",
      cleanNote: "é€”ä¸­ã§ã‚„ã‚ã¦ã‚‚OKã€‚\nç‰‡ã¥ã‘ãŸåˆ†ã ã‘ã€å°‘ã—ã ã‘å¤‰ã‚ã‚Šã¾ã™ã€‚"
    },
    en: {
      docTitle: "3-Day Care Game (2D)",
      gameTitle: "3-Day Care Game (2D)",
      langLabel: "Language",
      sitter: "Sitter",
      stageHeader: "Stage",
      careHeader: "Care",
      careHint: "Choose whichever you like",
      letter: "Letter",
      observeHeader: "Observer Log",
      observeHint: "No controls (logs and heart trend only)",
      btnShare: "Observer URL",
      btnLogs: "Logs",
      btnName: "Name",
      btnReset: "Restart",
      btnBack: "Back",
      btnClose: "Close",
      btnCancel: "Cancel",
      btnCopy: "Copy",
      btnLater: "Later",
      btnDecide: "OK",
      btnFood: "Food",
      btnOut: "Go out",
      btnStyle: "Style",
      btnClean: "Clean",
      btnDrink: "Drink",
      btnMacaron: "Macaron",
      twoChoice: "Two choices",
      timeStopped: "Time is paused.",
      waitNote: "What kind of child will it be? Please wait a moment.",
      sleepNote: "Zzzâ€¦",
      subRunning: "Logging",
      subEnded: "Controls disabled",
      thanks: "Thanks",
      miniInfo: "Status changes from expressions and motion.",
      assetHint: "Asset path",
      shareTitle: "Observer URL",
      shareHint: "Shareable (log only)",
      shareText: "Sharing this URL lets others view only the observer log screen.\nThey cannot play. Only logs and heart trend are visible.",
      shareCopied: "URL copied.",
      letterLines: [
        "You found a â€˜macaron-star eggâ€™ that slipped from the night sky.",
        "Inside the shell, a sweet light gently rolls around.",
        "This child can stay with you for only three days.",
        "After three days, it will return to the macaron star.",
        "Sometimes, it may quietly fall asleep here as well.",
        "Thatâ€™s whyâ€”just for nowâ€”please care for it gently."
      ],
      psName: "P.S. If youâ€™d like, please give this child a name.",
      nameTitle: "Name",
      nameHintInit: "Please name this child",
      nameHintEdit: " ",
      nameStoryEdit: "Want to quietly change the name?",
      namePlaceholder: "Name (up to 12 chars)",
      nameNote: "You can change it later with the Name button.",
      resetTitle: "Restart",
      resetText: "You can start over.\nChoose whether to keep traces (archive) or erase them.",
      resetKeep: "Restart (keep logs)",
      resetKeepSub: "Past traces go to archive.",
      resetWipe: "Restart (erase logs)",
      resetWipeSub: "Erase records on this device.",
      logArrived: "Arrived.",
      logHatched: "It rose and was born.",
      logDayChanged: "A new day began.",
      logQuiet: "It became quiet.",
      logGone: "It is gone.",
      logOff: "It returnedâ€¦ but slightly off, and became quiet again.",
      logReadLetter: "Read the letter.",
      logNamed: "Named: ",
      logSitterOn: "Paused (sitter).",
      logSitterOff: "Resumed.",
      cleaned: "Cleaned.",
      usedDrink: "Used a drink.",
      returned: "It came back.",
      grown: "It grew a little.",
      cleanHeader: "Clean",
      cleanHint: "Tap floating ğŸ’© to remove",
      cleanCounterLabel: "Removed",
      cleanNote: "Itâ€™s okay to stop halfway.\nOnly traces will remain."
    },
    zh: {
      docTitle: "ä¸‰å¤©ç…§æŠ¤æ¸¸æˆï¼ˆ2Dï¼‰",
      gameTitle: "ä¸‰å¤©ç…§æŠ¤æ¸¸æˆï¼ˆ2Dï¼‰",
      langLabel: "è¯­è¨€",
      sitter: "æ‰˜ç®¡",
      stageHeader: "èˆå°",
      careHeader: "ç…§æŠ¤",
      careHint: "è¯·é€‰æ‹©ä½ å–œæ¬¢çš„ä¸€ä¸ª",
      letter: "ä¿¡",
      observeHeader: "è§‚å¯Ÿè®°å½•",
      observeHint: "æ— æ³•æ“ä½œï¼ˆä»…æ˜¾ç¤ºè®°å½•ä¸å¿ƒå€¼è¶‹åŠ¿ï¼‰",
      btnShare: "è§‚å¯Ÿé“¾æ¥",
      btnLogs: "è®°å½•",
      btnName: "åå­—",
      btnReset: "é‡æ–°å¼€å§‹",
      btnBack: "è¿”å›",
      btnClose: "å…³é—­",
      btnCancel: "å–æ¶ˆ",
      btnCopy: "å¤åˆ¶",
      btnLater: "ç¨å",
      btnDecide: "ç¡®å®š",
      btnFood: "åƒé¥­",
      btnOut: "å¤–å‡º",
      btnStyle: "æ‰“æ‰®",
      btnClean: "æ¸…ç†",
      btnDrink: "é¥®æ–™",
      btnMacaron: "é©¬å¡é¾™",
      twoChoice: "äºŒé€‰ä¸€",
      timeStopped: "æ—¶é—´å·²æš‚åœã€‚",
      waitNote: "ä¼šæ˜¯ä»€ä¹ˆæ ·çš„å­©å­å‘¢ï¼Ÿç¨ç­‰ä¸€ä¸‹å“¦ã€‚",
      sleepNote: "å‘¼å™œâ€¦",
      subRunning: "è®°å½•ä¸­",
      subEnded: "å·²åœæ­¢æ“ä½œ",
      thanks: "è°¢è°¢",
      miniInfo: "è¡¨æƒ…ä¸åŠ¨ä½œä¼šå½±å“çŠ¶æ€ã€‚",
      assetHint: "èµ„æºè·¯å¾„",
      shareTitle: "è§‚å¯Ÿé“¾æ¥",
      shareHint: "åˆ†äº«åä»…å¯çœ‹è®°å½•",
      shareText: "åˆ†äº«æ­¤é“¾æ¥åï¼Œåˆ«äººåªèƒ½æŸ¥çœ‹â€œè§‚å¯Ÿè®°å½•â€ç”»é¢ã€‚\nä¸èƒ½è¿›è¡Œæ¸¸æˆæ“ä½œï¼Œåªèƒ½çœ‹åˆ°è®°å½•ä¸å¿ƒå€¼è¶‹åŠ¿ã€‚",
      shareCopied: "å·²å¤åˆ¶é“¾æ¥ã€‚",
      letterLines: [
        "ä½ æ¡åˆ°äº†ä¸€æšä»å¤œç©ºä¸­è½ä¸‹çš„â€œé©¬å¡é¾™æ˜Ÿä¹‹è›‹â€ã€‚",
        "è›‹å£³é‡Œï¼Œç”œç”œçš„å…‰åœ¨è½»è½»æ»šåŠ¨ã€‚",
        "è¿™ä¸ªå­©å­åªèƒ½é™ªä½ ä¸‰å¤©ã€‚",
        "ä¸‰å¤©åï¼Œå®ƒä¼šå›åˆ°é©¬å¡é¾™æ˜Ÿã€‚",
        "ä¸è¿‡ï¼Œæœ‰æ—¶å®ƒä¹Ÿå¯èƒ½åœ¨è¿™é‡Œé™é™ç¡å»ã€‚",
        "æ‰€ä»¥â€”â€”å°±åœ¨æ­¤åˆ»â€”â€”è¯·æ¸©æŸ”åœ°ç…§é¡¾å®ƒã€‚"
      ],
      psName: "é™„è¨€ï¼šå¦‚æœæ„¿æ„ï¼Œè¯·ç»™è¿™ä¸ªå­©å­å–ä¸ªåå­—ã€‚",
      nameTitle: "åå­—",
      nameHintInit: "è¯·ç»™å®ƒå–ä¸ªåå­—",
      nameHintEdit: " ",
      nameStoryEdit: "æƒ³æ‚„æ‚„æ”¹ä¸€ä¸‹åå­—å—ï¼Ÿ",
      namePlaceholder: "åå­—ï¼ˆæœ€å¤š12å­—ï¼‰",
      nameNote: "ä¹‹åä¹Ÿå¯ä»¥ç”¨â€œåå­—â€æŒ‰é’®ä¿®æ”¹ã€‚",
      resetTitle: "é‡æ–°å¼€å§‹",
      resetText: "å¯ä»¥ä»å¤´å¼€å§‹ã€‚\nè¯·é€‰æ‹©ä¿ç•™ç—•è¿¹ï¼ˆå½’æ¡£ï¼‰æˆ–æ¸…é™¤è®°å½•ã€‚",
      resetKeep: "ä¿ç•™è®°å½•é‡æ–°å¼€å§‹",
      resetKeepSub: "è¿‡å»ç—•è¿¹ä¼šå½’æ¡£ã€‚",
      resetWipe: "æ¸…é™¤è®°å½•é‡æ–°å¼€å§‹",
      resetWipeSub: "æ¸…é™¤æœ¬è®¾å¤‡è®°å½•ã€‚",
      logArrived: "å·²åˆ°è¾¾ã€‚",
      logHatched: "å®ƒæµ®èµ·å¹¶è¯ç”Ÿäº†ã€‚",
      logDayChanged: "æ–°çš„ä¸€å¤©å¼€å§‹äº†ã€‚",
      logQuiet: "å®ƒå®‰é™ä¸‹æ¥äº†ã€‚",
      logGone: "å®ƒç¦»å¼€äº†ã€‚",
      logOff: "å®ƒå›æ¥äº†â€¦ä½†æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œåˆå®‰é™äº†ã€‚",
      logReadLetter: "è¯»äº†ä¿¡ã€‚",
      logNamed: "å–åï¼š",
      logSitterOn: "å·²æ‰˜ç®¡ï¼ˆæš‚åœï¼‰ã€‚",
      logSitterOff: "å·²æ¢å¤ã€‚",
      cleaned: "å·²æ¸…ç†ã€‚",
      usedDrink: "ä½¿ç”¨äº†é¥®æ–™ã€‚",
      returned: "å®ƒå›æ¥äº†ã€‚",
      grown: "å®ƒç¨å¾®å˜å¤§äº†ã€‚",
      cleanHeader: "æ¸…ç†",
      cleanHint: "ç‚¹å‡»æ¼‚æµ®çš„ğŸ’©æ¥æ¸…ç†",
      cleanCounterLabel: "å·²æ¸…ç†",
      cleanNote: "ä¸­é€”ç»“æŸä¹Ÿå¯ä»¥ã€‚\nåªä¼šç•™ä¸‹ç—•è¿¹ã€‚"
    }
  };

  function t(key){
    return (I18N[LANG] && I18N[LANG][key]) || I18N.ja[key] || key;
  }

  function getLetterBody(){
    const lines = t("letterLines");
    const arr = Array.isArray(lines) ? lines : I18N.ja.letterLines;
    return arr.join("\n") + "\n\n" + t("psName");
  }
  function getIntroText(){
    const lines = t("letterLines");
    const arr = Array.isArray(lines) ? lines : I18N.ja.letterLines;
    return arr.join("\n");
  }

  function setLang(lang){
    LANG = (lang === "en" || lang === "zh" || lang === "ja") ? lang : "ja";
    localStorage.setItem(LANG_KEY, LANG);
    applyLangToUI();
    ui.letterText.textContent = getLetterBody();
    if(ui.langSel) ui.langSel.value = LANG;

    ui.txtCleanHeader.textContent = t("cleanHeader");
    ui.txtCleanHint.textContent = t("cleanHint");
    ui.cleanCounterLabel.textContent = t("cleanCounterLabel");
    ui.cleanNote.textContent = t("cleanNote");
  }

  function makeOpt(icon, title, sub, extra){
    return Object.assign({ icon, t:title, sub }, extra || {});
  }
  function makePrompt(q, a, b){
    return { q, a, b };
  }

  const TWOCHOICE = {
    ja: {
      food: [
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸ™","ãŠã«ãã‚Š","ãã‚…ã£ã¨ã€‚"), makeOpt("ğŸ¥","ã±ã‚“","ãµã‚ã£ã¨ã€‚")),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸ¥¤","ã‚¸ãƒ¥ãƒ¼ã‚¹","æ˜ã‚‹ã„ç”˜ã•ã€‚"), makeOpt("ğŸ¶","ãŠã•ã‘","é™ã‹ãªç†±ã€‚")),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸœ","ãƒ©ãƒ¼ãƒ¡ãƒ³","ã‚ã£ãŸã‹ã„ã€‚"), makeOpt("ğŸ¥—","ã‚µãƒ©ãƒ€","ã•ã£ã±ã‚Šã€‚")),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸª","ã‚¯ãƒƒã‚­ãƒ¼","ã»ã‚ã»ã‚ã€‚"), makeOpt("ğŸ«","ãƒãƒ§ã‚³","ã—ã£ã¨ã‚Šã€‚"))
      ],
      out: [
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸŒ³","ã“ã†ãˆã‚“","é¢¨ãŒã‚ã‚‹ã€‚",{ wild:true }), makeOpt("ğŸ¬","ãˆã„ãŒ","æš—ãã¦å®‰å¿ƒã€‚",{ wild:false })),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸŒŠ","ã†ã¿","å¢ƒç•ŒãŒã‚†ã‚Œã‚‹ã€‚",{ wild:true }), makeOpt("ğŸ”ï¸","ã‚„ã¾","å¢ƒç•ŒãŒå›ºã„ã€‚",{ wild:true })),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸšƒ","ã§ã‚“ã—ã‚ƒ","æ™¯è‰²ãŒæµã‚Œã‚‹ã€‚",{ wild:false }), makeOpt("ğŸš¶","ã•ã‚“ã½","è€ƒãˆãŒä¸¦ã¶ã€‚",{ wild:true })),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸ§¸","ã¬ã„ãã‚‹ã¿å±‹","æŠ±ãã‚„ã™ã„ã€‚",{ wild:false }), makeOpt("ğŸ“š","ã»ã‚“ã‚„","èƒŒè¡¨ç´™ã®æ£®ã€‚",{ wild:false }))
      ],
      style: [
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("âœ¨","ãã‚‰ãã‚‰","ç›®ãŒè¿½ã†ã€‚"), makeOpt("ğŸª¨","ã—ã¶ã„","å¾Œã‹ã‚‰åŠ¹ãã€‚")),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸ€","ã‚Šã¼ã‚“","çµã³ç›®ãŒæ®‹ã‚‹ã€‚"), makeOpt("ğŸ©","ã¼ã†ã—","å½±ãŒå¢—ãˆã‚‹ã€‚")),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸ•¶ï¸","ã‚µãƒ³ã‚°ãƒ©ã‚¹","å¼·ãè¦‹ãˆã‚‹ã€‚"), makeOpt("ğŸ‘“","ã‚ãŒã­","è³¢ãè¦‹ãˆã‚‹ã€‚")),
        makePrompt("ã©ã£ã¡ã«ã™ã‚‹ï¼Ÿ", makeOpt("ğŸ‘Ÿ","ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼","è»½ã„éŸ³ã€‚"), makeOpt("ğŸ‘¢","ãƒ–ãƒ¼ãƒ„","é‡ã„éŸ³ã€‚"))
      ]
    },
    en: {
      food: [
        makePrompt("Pick one?", makeOpt("ğŸ™","Rice ball","Tight and warm."), makeOpt("ğŸ¥","Bread","Soft and fluffy.")),
        makePrompt("Pick one?", makeOpt("ğŸ¥¤","Juice","Bright sweetness."), makeOpt("ğŸ¶","Sake","Quiet warmth.")),
        makePrompt("Pick one?", makeOpt("ğŸœ","Ramen","Nice and hot."), makeOpt("ğŸ¥—","Salad","Fresh and light.")),
        makePrompt("Pick one?", makeOpt("ğŸª","Cookie","Crumbly."), makeOpt("ğŸ«","Chocolate","Rich."))
      ],
      out: [
        makePrompt("Pick one?", makeOpt("ğŸŒ³","Park","With wind.",{ wild:true }), makeOpt("ğŸ¬","Cinema","Safe in the dark.",{ wild:false })),
        makePrompt("Pick one?", makeOpt("ğŸŒŠ","Sea","Borders wobble.",{ wild:true }), makeOpt("ğŸ”ï¸","Mountain","Borders feel solid.",{ wild:true })),
        makePrompt("Pick one?", makeOpt("ğŸšƒ","Train","Scenery flows.",{ wild:false }), makeOpt("ğŸš¶","Walk","Thoughts align.",{ wild:true })),
        makePrompt("Pick one?", makeOpt("ğŸ§¸","Plush shop","Easy to hug.",{ wild:false }), makeOpt("ğŸ“š","Bookstore","A forest of spines.",{ wild:false }))
      ],
      style: [
        makePrompt("Pick one?", makeOpt("âœ¨","Sparkly","Eyes will follow."), makeOpt("ğŸª¨","Muted","Hits later.")),
        makePrompt("Pick one?", makeOpt("ğŸ€","Ribbon","A knot remains."), makeOpt("ğŸ©","Hat","More shadow.")),
        makePrompt("Pick one?", makeOpt("ğŸ•¶ï¸","Sunglasses","Looks strong."), makeOpt("ğŸ‘“","Glasses","Looks smart.")),
        makePrompt("Pick one?", makeOpt("ğŸ‘Ÿ","Sneakers","Light sounds."), makeOpt("ğŸ‘¢","Boots","Heavy sounds."))
      ]
    },
    zh: {
      food: [
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸ™","é¥­å›¢","æš–æš–çš„ã€‚"), makeOpt("ğŸ¥","é¢åŒ…","è½¯è½¯çš„ã€‚")),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸ¥¤","æœæ±","ç”œç”œçš„ã€‚"), makeOpt("ğŸ¶","é…’","é™é™çš„çƒ­ã€‚")),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸœ","æ‹‰é¢","çƒ­ä¹ä¹ã€‚"), makeOpt("ğŸ¥—","æ²™æ‹‰","æ¸…çˆ½ã€‚")),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸª","é¥¼å¹²","é…¥é…¥çš„ã€‚"), makeOpt("ğŸ«","å·§å…‹åŠ›","æµ“æµ“çš„ã€‚"))
      ],
      out: [
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸŒ³","å…¬å›­","æœ‰é£ã€‚",{ wild:true }), makeOpt("ğŸ¬","ç”µå½±é™¢","é»‘æš—ä¹Ÿå®‰å¿ƒã€‚",{ wild:false })),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸŒŠ","æµ·è¾¹","è¾¹ç•Œæ‘‡æ™ƒã€‚",{ wild:true }), makeOpt("ğŸ”ï¸","å±±é‡Œ","è¾¹ç•Œåšå›ºã€‚",{ wild:true })),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸšƒ","ç”µè½¦","æ™¯è‰²æµåŠ¨ã€‚",{ wild:false }), makeOpt("ğŸš¶","æ•£æ­¥","æƒ³æ³•å¹¶æ’èµ°ã€‚",{ wild:true })),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸ§¸","ç©å¶åº—","å¾ˆå¥½æŠ±ã€‚",{ wild:false }), makeOpt("ğŸ“š","ä¹¦åº—","ä¹¦è„Šåƒæ£®æ—ã€‚",{ wild:false }))
      ],
      style: [
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("âœ¨","é—ªé—ª","çœ¼ç›ä¼šè¿½ã€‚"), makeOpt("ğŸª¨","ä½è°ƒ","ååŠ²æ›´å¼ºã€‚")),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸ€","è´è¶ç»“","ç»“ä¼šç•™ä¸‹ã€‚"), makeOpt("ğŸ©","å¸½å­","å½±å­æ›´å¤šã€‚")),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸ•¶ï¸","å¢¨é•œ","çœ‹èµ·æ¥æ›´å¼ºã€‚"), makeOpt("ğŸ‘“","çœ¼é•œ","çœ‹èµ·æ¥æ›´èªæ˜ã€‚")),
        makePrompt("é€‰å“ªä¸ªï¼Ÿ", makeOpt("ğŸ‘Ÿ","è¿åŠ¨é‹","å£°éŸ³è½»ã€‚"), makeOpt("ğŸ‘¢","é´å­","å£°éŸ³é‡ã€‚"))
      ]
    }
  };

  const el = (id) => document.getElementById(id);

  const ui = {
    subline: el("subline"),
    heartFill: el("heartFill"),
    heartLabel: el("heartLabel"),
    sitterToggle: el("sitterToggle"),
    txtSitter: el("txtSitter"),
    stageHint: el("stageHint"),
    stageNote: el("stageNote"),
    macaronArea: el("macaronArea"),
    macaronImg: el("macaronImg"),
    charArea: el("charArea"),
    charScaleBox: el("charScaleBox"),
    charImg: el("charImg"),
    thanksOverlay: el("thanksOverlay"),
    txtThanks: el("txtThanks"),
    poopEls: Array.from(document.querySelectorAll("#poopRow .poop")),
    btnFood: el("btnFood"),
    btnOut: el("btnOut"),
    btnStyle: el("btnStyle"),
    btnClean: el("btnClean"),
    btnDrink: el("btnDrink"),
    btnMacaron: el("btnMacaron"),
    btnShare: el("btnShare"),
    btnLogs: el("btnLogs"),
    btnName: el("btnName"),
    btnReset: el("btnReset"),
    btnCsv: el("btnCsv"),
    assetHint: el("assetHint"),
    assetWarn: el("assetWarn"),
    txtMiniInfo: el("txtMiniInfo"),
    liveLog: el("liveLog"),
    modalBack: el("modalBack"),
    modalTitle: el("modalTitle"),
    modalHint: el("modalHint"),
    modalBody: el("modalBody"),
    modalFoot: el("modalFoot"),
    modalX: el("modalX"),
    screenGame: el("screenGame"),
    screenObserve: el("screenObserve"),
    screenClean: el("screenClean"),
    obsTitle: el("obsTitle"),
    obsSub: el("obsSub"),
    obsDays: el("obsDays"),
    btnBackToGame: el("btnBackToGame"),
    heartChart: el("heartChart"),
    letterSlot: el("letterSlot"),
    letterBtn: el("letterBtn"),
    letterModal: el("letterModal"),
    letterText: el("letterText"),
    letterClose: el("letterClose"),
    letterX: el("letterX"),
    langSel: el("langSel"),
    txtLangLabel: el("txtLangLabel"),
    txtGameTitle: el("txtGameTitle"),
    txtStageHeader: el("txtStageHeader"),
    txtCareHeader: el("txtCareHeader"),
    txtCareHint: el("txtCareHint"),
    txtLetterBtn: el("txtLetterBtn"),
    txtLetterTitle: el("txtLetterTitle"),
    txtObserveHeader: el("txtObserveHeader"),
    txtObserveHint: el("txtObserveHint"),
    txtLogHeader: el("txtLogHeader"),
    txtLogHint: el("txtLogHint"),
    txtCleanHeader: el("txtCleanHeader"),
    txtCleanHint: el("txtCleanHint"),
    btnCleanExit: el("btnCleanExit"),
    btnCleanFinish: el("btnCleanFinish"),
    cleanStage: el("cleanStage"),
    cleanTimeFill: el("cleanTimeFill"),
    cleanCounterLabel: el("cleanCounterLabel"),
    cleanCounterNum: el("cleanCounterNum"),
    cleanNote: el("cleanNote"),
  };

  function applyLangToUI(){
    document.documentElement.lang = LANG;
    document.title = t("docTitle");

    ui.txtGameTitle.textContent = t("gameTitle");
    ui.txtLangLabel.textContent = t("langLabel");
    ui.txtSitter.textContent = t("sitter");

    ui.txtStageHeader.textContent = t("stageHeader");
    ui.txtCareHeader.textContent = t("careHeader");
    ui.txtCareHint.textContent = t("careHint");

    ui.txtLetterBtn.textContent = t("letter");
    ui.txtLetterTitle.textContent = t("letter");

    ui.txtObserveHeader.textContent = t("observeHeader");
    ui.txtObserveHint.textContent = t("observeHint");

    ui.btnShare.textContent = t("btnShare");
    ui.btnLogs.textContent = t("btnLogs");
    ui.btnName.textContent = t("btnName");
    ui.btnReset.textContent = t("btnReset");

    ui.btnFood.textContent = `ğŸ½ ${t("btnFood")}`;
    ui.btnOut.textContent  = `ğŸš€ ${t("btnOut")}`;
    ui.btnStyle.textContent= `âœ¨ ${t("btnStyle")}`;
    ui.btnClean.textContent= `ğŸ§¼ ${t("btnClean")}`;
    ui.btnDrink.textContent= `ğŸ¥¤ ${t("btnDrink")}`;
    ui.btnMacaron.textContent = `ğŸ¬ ${t("btnMacaron")}`;

    ui.modalX.textContent = t("btnClose");
    ui.letterX.textContent = t("btnClose");
    ui.letterClose.textContent = t("btnClose");

    ui.txtThanks.textContent = t("thanks");
    ui.txtMiniInfo.textContent = t("miniInfo");

    ui.assetHint.textContent =
      `${t("assetHint")}: ${ASSET_BASE}ï¼ˆsleep: ${ASSET_BASE}blue/sleep.png / ${ASSET_BASE}pick/sleep.pngï¼‰`;

    ui.txtLogHeader.textContent = t("btnLogs");
    ui.txtLogHint.textContent = (LANG==="en") ? "Download as CSV" : (LANG==="zh" ? "å¯ä¸‹è½½CSV" : "CSVã§ä¿å­˜ã§ãã¾ã™");
    ui.btnCsv.textContent = "CSV";

    ui.letterText.textContent = getLetterBody();

    ui.txtCleanHeader.textContent = t("cleanHeader");
    ui.txtCleanHint.textContent = t("cleanHint");
    ui.cleanCounterLabel.textContent = t("cleanCounterLabel");
    ui.cleanNote.textContent = t("cleanNote");
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function now(){ return Date.now(); }
  function safeJsonParse(s){ try{ return JSON.parse(s); }catch(_){ return null; } }

  function uid(){
    try{
      const a = new Uint32Array(4);
      crypto.getRandomValues(a);
      return [...a].map(x => x.toString(16).padStart(8,"0")).join("");
    }catch(_){
      return "id_" + Math.random().toString(16).slice(2) + "_" + now().toString(16);
    }
  }

  function normalizeName(s){
    const tt = String(s || "").trim();
    if(!tt) return "";
    return tt.replace(/[\r\n\t]/g, "").slice(0, 12);
  }

  function loadSave(){
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return null;
    const obj = safeJsonParse(raw);
    if(!obj || obj.version !== 1) return null;
    normalizeSave(obj);
    return obj;
  }
  function saveSave(obj){ localStorage.setItem(SAVE_KEY, JSON.stringify(obj)); }

  function loadArchives(){
    const raw = localStorage.getItem(ARCHIVE_KEY);
    const arr = raw ? safeJsonParse(raw) : null;
    return Array.isArray(arr) ? arr : [];
  }
  function saveArchives(arr){ localStorage.setItem(ARCHIVE_KEY, JSON.stringify(arr)); }

  function assetPath(file){ return ASSET_BASE + file; }

  // ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„æ™‚ã ã‘ã€å³ä¸‹ã«ãã£ã¨å‡ºã™
  const missingAssets = new Set();
  function noteMissingAsset(src){
    if(!src) return;
    missingAssets.add(src);
    const list = Array.from(missingAssets).slice(0, 3);
    ui.assetWarn.style.display = list.length ? "block" : "none";
    ui.assetWarn.textContent =
      (LANG==="en") ? `Missing image? ${list.join(" / ")}`
      : (LANG==="zh") ? `å›¾ç‰‡å¯èƒ½ç¼ºå¤±ï¼š${list.join(" / ")}`
      : `ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã‚‚ï¼š${list.join(" / ")}`;
  }
  ui.charImg.addEventListener("error", () => noteMissingAsset(ui.charImg.src));
  ui.macaronImg.addEventListener("error", () => noteMissingAsset(ui.macaronImg.src));

  function calcElapsedMs(save, tNow){
    const baseNow = save.pausedSince ? save.pausedSince : tNow;
    return Math.max(0, baseNow - save.startedAt - save.totalPausedMs);
  }

  function dayIndex(elapsed){
    return clamp(Math.floor(elapsed / DAY_MS) + 1, 1, 3);
  }

  function ensureDay(save, d){
    if(!save.days) save.days = {};
    if(!save.days[d]){
      save.days[d] = {
        day: d,
        careCounts: { food:0, out:0, style:0, clean:0 },
        choices: [],
        heartChange: 0,
        sitterMs: 0,
        items: { drink:0, macaron:0 },
        heartStart: save.heart,
        heartEnd: save.heart
      };
    }else{
      const dd = save.days[d];
      if(!dd.careCounts) dd.careCounts = { food:0, out:0, style:0, clean:0 };
      dd.careCounts.food = dd.careCounts.food ?? 0;
      dd.careCounts.out = dd.careCounts.out ?? 0;
      dd.careCounts.clean = dd.careCounts.clean ?? 0;
      dd.careCounts.style = dd.careCounts.style ?? 0;
      if(!Array.isArray(dd.choices)) dd.choices = [];
      if(!dd.items) dd.items = { drink:0, macaron:0 };
      dd.items.drink = dd.items.drink ?? 0;
      dd.items.macaron = dd.items.macaron ?? 0;
      dd.heartChange = dd.heartChange ?? 0;
      dd.sitterMs = dd.sitterMs ?? 0;
      dd.heartStart = dd.heartStart ?? save.heart;
      dd.heartEnd = dd.heartEnd ?? save.heart;
    }
    return save.days[d];
  }

  function normalizeSave(save){
    save.totalPausedMs = save.totalPausedMs ?? 0;
    save.pausedSince = save.pausedSince ?? null;

    save.lifeExtensionMs = save.lifeExtensionMs ?? 0;
    save.petName = save.petName ?? "";

    save.heart = clamp(save.heart ?? 50, 0, 100);
    save.hunger = clamp(save.hunger ?? 20, 0, 100);
    save.dirt = clamp(save.dirt ?? 10, 0, 100);
    save.mood = clamp(save.mood ?? 70, 0, 100);
    save.poop = clamp(save.poop ?? 0, 0, POOP_MAX);

    save.lastSimElapsed = save.lastSimElapsed ?? 0;
    save.currentDay = save.currentDay ?? 1;

    save.sleepUntilElapsed = save.sleepUntilElapsed ?? null;
    save.lastSleepAtElapsed = save.lastSleepAtElapsed ?? 0;
    save.lastActionElapsed = save.lastActionElapsed ?? 0;

    save.letterShown = save.letterShown ?? false;

    save.pickCount = save.pickCount ?? 0;
    save.growLevel = save.growLevel ?? 0;

    save.hatched = !!save.hatched;
    save.hatchAnim = !!save.hatchAnim;

    save.ended = !!save.ended;
    save.endedAt = save.endedAt ?? null;

    save.macaronActive = !!save.macaronActive;
    save.macaronEndsAtElapsed = save.macaronEndsAtElapsed ?? null;

    if(!Array.isArray(save.live)) save.live = [];
    if(!Array.isArray(save.events)) save.events = [];
    if(!save.days) save.days = {};
    ensureDay(save, 1);

    save.bags = save.bags ?? { food:[], out:[], style:[] };
    save.bags.food = Array.isArray(save.bags.food) ? save.bags.food : [];
    save.bags.out = Array.isArray(save.bags.out) ? save.bags.out : [];
    save.bags.style = Array.isArray(save.bags.style) ? save.bags.style : [];
  }

  function pushEvent(save, type, text, extra){
    const stamp = now();
    save.events.push(Object.assign({
      t: stamp,
      type,
      text,
      day: save.currentDay || 1,
      heart: save.heart,
      hunger: save.hunger,
      dirt: save.dirt,
      mood: save.mood,
      poop: save.poop,
      elapsed: calcElapsedMs(save, stamp)
    }, extra || {}));
    if(save.events.length > 4000) save.events.splice(0, save.events.length - 4000);
  }

  function pushLiveLog(save, text){
    const stamp = now();
    save.live.unshift({ t: stamp, text });
    if(save.live.length > 30) save.live.length = 30;
    pushEvent(save, "event", text);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function addChoice(save, category, choiceLabel){
    const d = ensureDay(save, save.currentDay);
    const row = { t: now(), category, choice: choiceLabel };
    d.choices.push(row);
    pushEvent(save, "choice", `${category}: ${choiceLabel}`, { category, choice: choiceLabel });
  }

  function applyHeart(save, delta){
    const d = ensureDay(save, save.currentDay);
    const before = save.heart;
    save.heart = clamp(save.heart + delta, 0, 100);
    const realDelta = save.heart - before;
    d.heartChange += realDelta;
    d.heartEnd = save.heart;
  }

  function heartDeltaRandom(){
    const r = Math.random();
    if(r < 0.15) return -2;
    if(r < 0.50) return 0;
    if(r < 0.85) return 2;
    return 3;
  }

  function createNewSave(){
    const t0 = now();
    const playerId = uid();
    const macaronColor = COLORS[Math.floor(Math.random() * COLORS.length)];
    const charColor = macaronColor;

    const s = {
      version: 1,
      playerId,
      startedAt: t0,
      totalPausedMs: 0,
      pausedSince: null,

      macaronColor,
      charColor,

      petName: "",

      hatched: false,
      hatchAnim: false,

      ended: false,
      endedAt: null,

      macaronActive: false,
      macaronEndsAtElapsed: null,

      lifeExtensionMs: 0,

      heart: 50,
      hunger: 20,
      dirt: 10,
      mood: 70,
      poop: 0,

      sleepUntilElapsed: null,
      lastSleepAtElapsed: 0,
      lastActionElapsed: 0,

      lastSimElapsed: 0,
      currentDay: 1,

      letterShown: false,

      pickCount: 0,
      growLevel: 0,

      bags: { food:[], out:[], style:[] },

      days: {},
      live: [],
      events: []
    };

    ensureDay(s, 1);
    pushLiveLog(s, t("logArrived"));
    return s;
  }

  function isAlive(save, elapsed){
    const deadline = LIFE_MS + (save.lifeExtensionMs || 0);
    if(save.macaronActive) return true;
    return (elapsed < deadline) && !save.ended;
  }

  function canInteract(save, elapsed){
    if(save.pausedSince) return true;
    if(save.macaronActive) return true;
    if(save.ended) return false;
    if(!save.hatched) return false;
    return isAlive(save, elapsed);
  }

  // dirtã‹ã‚‰poopã‚’å¢—ã‚„ã™ï¼ˆæœ€å¤§10ï¼‰
  function updatePoop(save){
    const desired = clamp(Math.floor((save.dirt - 35) / 6), 0, POOP_MAX);
    save.poop = Math.max(save.poop, desired);
  }

  function isSleeping(save, elapsed){
    if(save.sleepUntilElapsed == null) return false;
    return elapsed < save.sleepUntilElapsed;
  }

  function startSleep(save, elapsed, reasonText){
    if(isSleeping(save, elapsed)) return;
    const since = elapsed - (save.lastSleepAtElapsed || 0);
    const cool = FAST ? 5 * 1000 : 2 * 60 * 1000;
    if(since < cool) return;

    save.sleepUntilElapsed = elapsed + SLEEP_MS;
    save.lastSleepAtElapsed = elapsed;
    pushLiveLog(save, reasonText || t("logQuiet"));
  }

  function touchAction(save){
    const e = calcElapsedMs(save, now());
    save.lastActionElapsed = e;
  }

  function applyTimeSimulation(save, elapsed){
    const prev = save.lastSimElapsed || 0;
    const deltaMs = Math.max(0, elapsed - prev);
    if(deltaMs <= 0) return;

    const minutes = deltaMs / 60000;

    save.hunger = clamp(save.hunger + minutes * HUNGER_PER_MIN, 0, 100);
    save.dirt   = clamp(save.dirt   + minutes * DIRT_PER_MIN,   0, 100);

    updatePoop(save);

    let moodDelta = 0;
    const stress =
      (save.hunger > 70 ? (save.hunger - 70) / 30 : 0) +
      (save.dirt   > 70 ? (save.dirt   - 70) / 30 : 0);

    moodDelta -= minutes * 0.35 * stress;

    if(save.poop > 0) moodDelta -= minutes * 0.035 * save.poop;

    if(save.hunger < 35 && save.dirt < 35 && save.poop === 0){
      moodDelta += minutes * 0.10;
    }
    if(isSleeping(save, elapsed)){
      moodDelta += minutes * 0.12;
    }

    save.mood = clamp(save.mood + moodDelta, 0, 100);

    const calm = (save.mood > 72 && save.hunger < 55 && save.dirt < 55 && save.poop <= 1);
    if(calm && !isSleeping(save, elapsed)){
      const p = minutes * (FAST ? 0.22 : 0.08);
      if(Math.random() < p){
        startSleep(save, elapsed, t("logQuiet"));
      }
    }
  }

  function updateDayBoundary(save, elapsed){
    const d = dayIndex(elapsed);
    if(!save.currentDay) save.currentDay = d;

    if(d !== save.currentDay){
      const prev = ensureDay(save, save.currentDay);
      prev.heartEnd = save.heart;
      save.currentDay = d;
      const next = ensureDay(save, d);
      next.heartStart = save.heart;
      pushLiveLog(save, t("logDayChanged"));
    }
    ensureDay(save, save.currentDay);
  }

  function maybeHatch(save, elapsed){
    if(save.hatched) return;
    if(elapsed >= HATCH_MS){
      save.hatchAnim = true;
      setTimeout(() => {
        const s = loadSave();
        if(!s || s.hatched) return;
        s.hatched = true;
        s.hatchAnim = false;
        pushLiveLog(s, t("logHatched"));
        s.lastActionElapsed = calcElapsedMs(s, now());
        saveSave(s);
        openNameModal(true);
      }, 700);
    }
  }

  function archiveRun(save){
    const arr = loadArchives();
    const exp = exportObservationData(save);
    const exist = arr.some(x => x && x.playerId === exp.playerId && x.startedAt === exp.startedAt);
    if(exist) return;
    arr.unshift(exp);
    if(arr.length > 20) arr.length = 20;
    saveArchives(arr);
  }

  function maybeEnd(save, elapsed){
    if(save.macaronActive) return;
    const deadline = LIFE_MS + (save.lifeExtensionMs || 0);
    if(!save.ended && elapsed >= deadline){
      save.ended = true;
      save.endedAt = now();
      pushLiveLog(save, t("logGone"));
      archiveRun(save);
    }
  }

  function updateMacaronTimer(save, elapsed){
    if(!save.macaronActive) return;
    if(save.macaronEndsAtElapsed == null) return;
    if(elapsed >= save.macaronEndsAtElapsed){
      save.macaronActive = false;
      save.macaronEndsAtElapsed = null;
      save.ended = true;
      save.endedAt = now();
      pushLiveLog(save, t("logOff"));
      archiveRun(save);
    }
  }

  function stateClass(save){
    if(save.mood < 25 || save.hunger > 85 || save.dirt > 85 || save.poop >= 8) return "cry";
    if(save.mood < 45 || save.hunger > 70 || save.dirt > 70 || save.poop >= 5) return "low";
    if(save.mood > 70 && save.hunger < 55 && save.dirt < 55 && save.poop <= 1) return "lively";
    return "";
  }

  function setInteractable(enabled){
    [ui.btnFood, ui.btnOut, ui.btnStyle, ui.btnClean, ui.btnDrink].forEach(b => b.disabled = !enabled);
  }

  function applyVisualImages(save){
    const mc = FILES.macaron[save.macaronColor] ? save.macaronColor : "blue";
    ui.macaronImg.src = assetPath(FILES.macaron[mc]);

    const cc = FILES.char[save.charColor] ? save.charColor : "blue";
    const elapsed = calcElapsedMs(save, now());
    const sleeping = isSleeping(save, elapsed);

    let charFile = FILES.char[cc].closed;
    if(sleeping){
      charFile = FILES.char[cc].sleep;
    }else{
      const sc = stateClass(save);
      const wantOpen = (sc === "lively");
      charFile = wantOpen ? FILES.char[cc].open : FILES.char[cc].closed;
    }
    ui.charImg.src = assetPath(charFile);
  }

  function applyGrowthScale(save){
    const base = 1.00;
    const step = 0.035;
    const max = 1.35;
    const sc = Math.min(max, base + (save.growLevel || 0) * step);
    ui.charScaleBox.style.transform = `scale(${sc.toFixed(3)})`;
  }

  function updatePoopUI(save){
    const n = clamp(Math.round(save.poop), 0, POOP_MAX);
    ui.poopEls.forEach((p, i) => p.classList.toggle("on", i < n));
  }

  function updateHeartUI(save){
    ui.heartFill.style.width = `${clamp(save.heart,0,100)}%`;
    ui.heartLabel.textContent = `${Math.round(save.heart)}%`;
  }

  function showLetterSlot(){
    if(!ui.letterSlot.classList.contains("show")){
      ui.letterSlot.classList.add("show");
    }
  }

  function renderLiveLog(save){
    ui.liveLog.innerHTML = "";
    const items = save.live || [];
    for(const it of items){
      const d = new Date(it.t);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<b>${escapeHtml(it.text)}</b><div class="t">${hh}:${mm}</div>`;
      ui.liveLog.appendChild(div);
    }
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«
  function openModal(title, hint, bodyNode, footButtons){
    ui.modalTitle.textContent = title || "";
    ui.modalHint.textContent = hint || "";
    ui.modalBody.innerHTML = "";
    ui.modalBody.appendChild(bodyNode);

    ui.modalFoot.innerHTML = "";
    footButtons.forEach(btn => ui.modalFoot.appendChild(btn));

    ui.modalBack.classList.add("show");
    ui.modalBack.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    ui.modalBack.classList.remove("show");
    ui.modalBack.setAttribute("aria-hidden","true");
  }
  ui.modalX.addEventListener("click", closeModal);
  ui.modalBack.addEventListener("click", (e) => { if(e.target === ui.modalBack) closeModal(); });
  window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });

  function mkBtn(text, cls, onClick){
    const b = document.createElement("button");
    b.textContent = text;
    if(cls) b.className = cls;
    b.addEventListener("click", onClick);
    return b;
  }

  function mkChoice(icon, title, sub, onPick){
    const div = document.createElement("div");
    div.className = "choice";
    div.innerHTML = `
      <div class="cTitle"><span class="cIcon">${escapeHtml(icon || "â“")}</span>${escapeHtml(title)}</div>
      <div class="cSub">${escapeHtml(sub)}</div>
    `;
    div.addEventListener("click", onPick);
    return div;
  }

  function shuffleInPlace(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function listForLang(key){
    const pack = TWOCHOICE[LANG] || TWOCHOICE.ja;
    const list = pack[key] || (TWOCHOICE.ja[key] || []);
    return list;
  }

  function pickFromBag(save, key){
    const list = listForLang(key);
    if(!list || !list.length) return null;

    if(!save.bags) save.bags = { food:[], out:[], style:[] };
    if(!Array.isArray(save.bags[key])) save.bags[key] = [];
    if(save.bags[key].some(i => i >= list.length)) save.bags[key] = [];

    if(save.bags[key].length === 0){
      save.bags[key] = shuffleInPlace([...Array(list.length)].map((_,i)=>i));
    }
    const idx = save.bags[key].pop();
    return list[idx];
  }

  function applyAfterChoiceMaybeSleep(save){
    const elapsed = calcElapsedMs(save, now());
    const p = FAST ? 0.20 : 0.10;
    if(Math.random() < p){
      startSleep(save, elapsed, t("logQuiet"));
    }
  }

  function bumpPickAndGrowth(save){
    save.pickCount = (save.pickCount || 0) + 1;
    if(save.pickCount % 20 === 0){
      save.growLevel = (save.growLevel || 0) + 1;
      pushLiveLog(save, t("grown"));
    }
  }

  function openNameModal(initial){
    const save = loadSave(); if(!save) return;

    const body = document.createElement("div");

    const story = document.createElement("div");
    story.style.fontSize = "12px";
    story.style.color = "rgba(238,242,255,.78)";
    story.style.lineHeight = "1.85";
    story.style.whiteSpace = "pre-wrap";
    story.style.marginBottom = "10px";
    story.textContent = initial ? getIntroText() : t("nameStoryEdit");

    const input = document.createElement("input");
    input.type = "text";
    input.maxLength = 12;
    input.placeholder = t("namePlaceholder");
    input.value = save.petName || "";
    input.style.width = "100%";
    input.style.padding = "12px 12px";
    input.style.borderRadius = "14px";
    input.style.border = "1px solid rgba(255,255,255,.16)";
    input.style.background = "rgba(255,255,255,.06)";
    input.style.color = "rgba(238,242,255,.95)";
    input.style.outline = "none";

    const note = document.createElement("div");
    note.style.fontSize = "11px";
    note.style.color = "rgba(238,242,255,.62)";
    note.style.lineHeight = "1.7";
    note.style.marginTop = "8px";
    note.textContent = t("nameNote");

    body.appendChild(story);
    body.appendChild(input);
    body.appendChild(note);

    const commit = () => {
      const s = loadSave(); if(!s) return;
      const name = normalizeName(input.value);
      s.petName = name || "ï¼Ÿï¼Ÿï¼Ÿ";
      touchAction(s);
      addChoice(s, "Name", s.petName);
      pushLiveLog(s, `${t("logNamed")}${s.petName}`);
      saveSave(s);
      closeModal();
    };

    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        commit();
      }
    });

    openModal(
      t("nameTitle"),
      initial ? t("nameHintInit") : t("nameHintEdit"),
      body,
      [
        mkBtn(t("btnLater"), "btnGhost", closeModal),
        mkBtn(t("btnDecide"), "", commit)
      ]
    );

    setTimeout(() => input.focus(), 0);
  }

  function actTwoPick(kindKey, kindLabel){
    const save = loadSave(); if(!save) return;
    const elapsed = calcElapsedMs(save, now());
    if(!canInteract(save, elapsed)) return;

    const p = pickFromBag(save, kindKey);
    if(!p) return;
    saveSave(save);

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7">${escapeHtml(p.q)}</div>`;
    const two = document.createElement("div");
    two.className = "two";

    const pick = (opt) => {
      const s = loadSave(); if(!s) return;
      const e = calcElapsedMs(s, now());
      if(!canInteract(s, e)) return;

      touchAction(s);

      const d = ensureDay(s, s.currentDay);
      if(kindKey === "food") d.careCounts.food++;
      if(kindKey === "out") d.careCounts.out++;
      if(kindKey === "style") d.careCounts.style++;

      const label = `${opt.icon} ${opt.t}`;
      addChoice(s, kindLabel, label);

      if(kindKey === "food"){
        s.hunger = clamp(s.hunger - 21 + (Math.random()*6 - 3), 0, 100);
        s.mood   = clamp(s.mood   +  4 + (Math.random()*6 - 3), 0, 100);
      }
      if(kindKey === "out"){
        const wild = !!opt.wild;
        s.mood = clamp(s.mood + (wild ? 10 : 7) + (Math.random()*6 - 3), 0, 100);
        s.dirt = clamp(s.dirt + (wild ?  7 : 4) + (Math.random()*4 - 2), 0, 100);
      }
      if(kindKey === "style"){
        s.mood = clamp(s.mood + 8 + (Math.random()*8 - 4), 0, 100);
        s.dirt = clamp(s.dirt + (Math.random()*8 - 4), 0, 100);
      }

      bumpPickAndGrowth(s);

      applyHeart(s, heartDeltaRandom());
      pushLiveLog(s, label);

      applyAfterChoiceMaybeSleep(s);

      saveSave(s);
      closeModal();
    };

    two.appendChild(mkChoice(p.a.icon, p.a.t, p.a.sub, () => pick(p.a)));
    two.appendChild(mkChoice(p.b.icon, p.b.t, p.b.sub, () => pick(p.b)));
    body.appendChild(two);

    openModal(kindLabel, t("twoChoice"), body, [ mkBtn(t("btnCancel"), "btnGhost", closeModal) ]);
  }

  function actFood(){ actTwoPick("food", t("btnFood")); }
  function actOut(){ actTwoPick("out", t("btnOut")); }
  function actStyle(){ actTwoPick("style", t("btnStyle")); }

  // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
  function showGameScreen(){
    ui.screenObserve.classList.remove("show");
    ui.screenClean.classList.remove("show");
    ui.screenGame.classList.add("show");
  }
  function showObserveScreen(){
    ui.screenGame.classList.remove("show");
    ui.screenClean.classList.remove("show");
    ui.screenObserve.classList.add("show");
  }
  function showCleanScreen(){
    ui.screenGame.classList.remove("show");
    ui.screenObserve.classList.remove("show");
    ui.screenClean.classList.add("show");
  }

  // ğŸ’©ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ï¼ˆpoop=10ã§ã‚‚éŠã¹ã‚‹ï¼‰
  let cleanSession = null;

  function sparkAt(stageEl, x, y){
    const sp = document.createElement("div");
    sp.className = "popSpark";
    sp.style.left = `${x - 9}px`;
    sp.style.top = `${y - 9}px`;
    stageEl.appendChild(sp);
    setTimeout(() => sp.remove(), 520);
  }

  function buildOneFloatingPoop(stageEl, onPop){
    const p = document.createElement("div");
    p.className = "floatPoop";

    const inner = document.createElement("div");
    inner.className = "inner";
    inner.textContent = "ğŸ’©";

    const x = 8 + Math.random()*84;
    const upDur = (FAST ? 2.7 : 4.0) + Math.random() * (FAST ? 1.6 : 2.8);
    const swayDur = (FAST ? 1.0 : 1.6) + Math.random() * (FAST ? 0.7 : 1.1);

    p.style.left = `${x.toFixed(2)}%`;
    p.style.animationDuration = `${upDur.toFixed(2)}s`;
    inner.style.animationDuration = `${swayDur.toFixed(2)}s`;

    p.appendChild(inner);

    const pop = (ev) => {
      if(p.classList.contains("popped")) return;
      p.classList.add("popped");

      const rect = stageEl.getBoundingClientRect();
      const cx = (ev && ev.clientX != null) ? (ev.clientX - rect.left) : (rect.width * x / 100);
      const cy = (ev && ev.clientY != null) ? (ev.clientY - rect.top) : (rect.height * 0.6);
      sparkAt(stageEl, cx, cy);

      setTimeout(() => p.remove(), 180);
      onPop();
    };

    inner.addEventListener("pointerdown", (ev) => { ev.preventDefault(); pop(ev); }, { passive:false });
    inner.addEventListener("click", (ev) => { ev.preventDefault(); pop(ev); });

    p.addEventListener("animationend", () => {
      if(p.classList.contains("popped")) return;
      p.remove();
      if(cleanSession && cleanSession.active){
        buildOneFloatingPoop(stageEl, onPop);
      }
    });

    stageEl.appendChild(p);
  }

  function updateCleanHUD(){
    if(!cleanSession) return;
    ui.cleanCounterNum.textContent = `${cleanSession.cleared} / ${cleanSession.target}`;
    const remain = clamp((cleanSession.endsAt - now()) / Math.max(1, cleanSession.totalMs), 0, 1);
    ui.cleanTimeFill.style.transform = `scaleX(${remain.toFixed(4)})`;
  }

  function endCleanGameAndApply(){
    if(!cleanSession || !cleanSession.active) return;
    cleanSession.active = false;

    const s = loadSave();
    if(!s){
      cleanSession = null;
      showGameScreen();
      return;
    }
    const e = calcElapsedMs(s, now());
    if(!canInteract(s, e)){
      cleanSession = null;
      showGameScreen();
      return;
    }

    touchAction(s);

    const beforePoop = clamp(s.poop, 0, POOP_MAX);
    const ratio = cleanSession.target > 0 ? (cleanSession.cleared / cleanSession.target) : 0;

    // poop=10ã§ã‚‚æˆç«‹ã™ã‚‹ã‚ˆã†ã«ã€Œå‰²åˆã§æ¸›ã‚‰ã™ã€
    let reduce = Math.floor(ratio * beforePoop + 1e-9);
    if(beforePoop > 0 && cleanSession.cleared > 0) reduce = Math.max(reduce, 1);
    reduce = clamp(reduce, 0, beforePoop);

    s.poop = clamp(beforePoop - reduce, 0, POOP_MAX);

    s.dirt = clamp(s.dirt - (8 + Math.round(26 * ratio) + (Math.random()*4 - 2)), 0, 100);
    s.mood = clamp(s.mood + (4 + Math.round(14 * ratio) + (Math.random()*4 - 2)), 0, 100);

    const d = ensureDay(s, s.currentDay);
    d.careCounts.clean++;

    addChoice(s, t("btnClean"), `ğŸ’© ${cleanSession.cleared}/${cleanSession.target}`);
    applyHeart(s, heartDeltaRandom() + (ratio >= 0.95 ? 1 : 0));
    pushLiveLog(s, t("cleaned"));

    applyAfterChoiceMaybeSleep(s);

    saveSave(s);

    ui.cleanStage.innerHTML = "";
    cleanSession = null;
    showGameScreen();
  }

  function startCleanGame(){
    const save = loadSave(); if(!save) return;
    const elapsed = calcElapsedMs(save, now());
    if(!canInteract(save, elapsed)) return;

    touchAction(save);

    if(save.poop <= 0){
      const s = loadSave(); if(!s) return;
      touchAction(s);
      s.dirt = clamp(s.dirt - 10, 0, 100);
      applyHeart(s, heartDeltaRandom());
      pushLiveLog(s, t("cleaned"));
      saveSave(s);
      return;
    }

    // poop=10ã§ã‚‚éŠã¹ã‚‹è¨­å®š
    const target = clamp(8 + save.poop * 2, 10, 40);     // poop10 -> 28
    const totalMs = clamp((FAST ? 9000 : 15000) + save.poop * (FAST ? 260 : 700), 9000, 24000);

    cleanSession = {
      active: true,
      target,
      cleared: 0,
      totalMs,
      startedAt: now(),
      endsAt: now() + totalMs,
    };

    ui.cleanStage.innerHTML = "";
    showCleanScreen();
    updateCleanHUD();

    const onPop = () => {
      if(!cleanSession || !cleanSession.active) return;
      cleanSession.cleared++;
      updateCleanHUD();
      if(cleanSession.cleared >= cleanSession.target){
        setTimeout(() => endCleanGameAndApply(), 240);
      }
    };

    const initial = Math.min(12, target);
    for(let i=0;i<initial;i++){
      buildOneFloatingPoop(ui.cleanStage, onPop);
    }

    let spawned = initial;
    const spawnTick = () => {
      if(!cleanSession || !cleanSession.active) return;

      if(spawned < target){
        const add = Math.min(2, target - spawned);
        for(let k=0;k<add;k++){
          buildOneFloatingPoop(ui.cleanStage, onPop);
          spawned++;
        }
      }

      updateCleanHUD();

      if(now() >= cleanSession.endsAt){
        endCleanGameAndApply();
        return;
      }
      requestAnimationFrame(spawnTick);
    };
    requestAnimationFrame(spawnTick);
  }

  // ãƒ‰ãƒªãƒ³ã‚¯ãƒ»ãƒã‚«ãƒ­ãƒ³
  function actDrink(){
    const save = loadSave(); if(!save) return;
    if(!save.hatched) return;
    if(save.ended || save.macaronActive) return;

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml((LANG==="en") ? "Use a drink?\nIt may slightly restore/extend time or status.\nYour choice will be logged."
: (LANG==="zh") ? "è¦ä½¿ç”¨é¥®æ–™å—ï¼Ÿ\nå¯èƒ½ä¼šç¨å¾®æ¢å¤/å»¶é•¿æ—¶é—´æˆ–çŠ¶æ€ã€‚\nä½ çš„é€‰æ‹©ä¼šè¢«è®°å½•ã€‚"
: "ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½¿ã†ï¼Ÿ\nå°‘ã—ã ã‘æ™‚é–“ã‚„çŠ¶æ…‹ãŒæˆ»ã‚‹ï¼å»¶ã³ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚\nä½¿ç”¨ã¯ãƒ­ã‚°ã«æ®‹ã‚Šã¾ã™ã€‚")}
    </div>`;

    const two = document.createElement("div");
    two.className = "two";

    const use = () => {
      const s = loadSave(); if(!s) return;
      if(s.ended || s.macaronActive) return;

      touchAction(s);

      const d = ensureDay(s, s.currentDay);
      d.items.drink = (d.items.drink ?? 0) + 1;
      addChoice(s, t("btnDrink"), "ğŸ¥¤ Use");

      s.hunger = clamp(s.hunger - 12 + (Math.random()*4 - 2), 0, 100);
      s.dirt   = clamp(s.dirt   - 10 + (Math.random()*4 - 2), 0, 100);
      s.mood   = clamp(s.mood   +  8 + (Math.random()*4 - 2), 0, 100);

      s.lifeExtensionMs = (s.lifeExtensionMs || 0) + DRINK_EXTEND_MS;
      s.startedAt += DRINK_BACK_MS;

      pushLiveLog(s, t("usedDrink"));
      applyAfterChoiceMaybeSleep(s);

      saveSave(s);
      closeModal();
    };

    two.appendChild(mkChoice("ğŸ¥¤", (LANG==="en"?"Use":(LANG==="zh"?"ä½¿ç”¨":"ä½¿ã†")), (LANG==="en"?"Just a little.":(LANG==="zh"?"åªæ˜¯ä¸€ç‚¹ç‚¹ã€‚":"ã»ã‚“ã®å°‘ã—ã€‚")), use));
    two.appendChild(mkChoice("ğŸ¤²", (LANG==="en"?"Not now":(LANG==="zh"?"æš‚ä¸":"ä½¿ã‚ãªã„")), (LANG==="en"?"Maybe later.":(LANG==="zh"?"ä»¥åå†è¯´ã€‚":"ä»Šå›ã¯è¦‹é€ã‚‹ã€‚")), closeModal));
    body.appendChild(two);

    openModal(t("btnDrink"), "", body, [ mkBtn(t("btnClose"), "btnGhost", closeModal) ]);
  }

  function actMacaron(){
    const save = loadSave(); if(!save) return;
    if(!save.ended || save.macaronActive) return;

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml((LANG==="en") ? "Use a macaron?\nIt may bring it back briefly, but not perfectly.\nYour choice will be logged."
: (LANG==="zh") ? "è¦ä½¿ç”¨é©¬å¡é¾™å—ï¼Ÿ\nå¯èƒ½ä¼šçŸ­æš‚å›æ¥ï¼Œä½†ä¸ä¼šå®Œç¾ã€‚\nä½ çš„é€‰æ‹©ä¼šè¢«è®°å½•ã€‚"
: "ãƒã‚«ãƒ­ãƒ³ã‚’ä½¿ã†ï¼Ÿ\nä¸€æ™‚çš„ã«æˆ»ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€å®Œå…¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nä½¿ç”¨ã¯ãƒ­ã‚°ã«æ®‹ã‚Šã¾ã™ã€‚")}
    </div>`;

    const two = document.createElement("div");
    two.className = "two";

    const use = () => {
      const s = loadSave(); if(!s) return;
      if(!s.ended || s.macaronActive) return;

      touchAction(s);

      const e = calcElapsedMs(s, now());
      const d = ensureDay(s, s.currentDay);
      d.items.macaron = (d.items.macaron ?? 0) + 1;

      addChoice(s, t("btnMacaron"), "ğŸ¬ Use");

      s.macaronActive = true;
      s.macaronEndsAtElapsed = e + MACARON_REVIVE_MS;

      s.hunger = clamp(s.hunger - 8, 0, 100);
      s.dirt   = clamp(s.dirt - 6, 0, 100);
      s.mood   = clamp(s.mood + 10, 0, 100);
      s.heart  = clamp(s.heart + 4, 0, 100);

      pushLiveLog(s, t("returned"));
      saveSave(s);
      closeModal();
    };

    two.appendChild(mkChoice("ğŸ¬", (LANG==="en"?"Use":(LANG==="zh"?"ä½¿ç”¨":"ä½¿ã†")), (LANG==="en"?"Briefly.":(LANG==="zh"?"çŸ­æš‚ã€‚":"å°‘ã—ã ã‘ã€‚")), use));
    two.appendChild(mkChoice("ğŸ¤²", (LANG==="en"?"Not now":(LANG==="zh"?"æš‚ä¸":"ä½¿ã‚ãªã„")), (LANG==="en"?"Maybe later.":(LANG==="zh"?"ä»¥åå†è¯´ã€‚":"ä»Šå›ã¯è¦‹é€ã‚‹ã€‚")), closeModal));
    body.appendChild(two);

    openModal(t("btnMacaron"), "", body, [ mkBtn(t("btnClose"), "btnGhost", closeModal) ]);
  }

  // è¦³å¯Ÿç”¨
  function exportObservationData(save){
    const elapsed = calcElapsedMs(save, now());
    return {
      version: 1,
      playerId: save.playerId,
      startedAt: save.startedAt,
      endedAt: save.endedAt,
      elapsedMs: elapsed,
      petName: save.petName,
      macaronColor: save.macaronColor,
      charColor: save.charColor,
      growLevel: save.growLevel || 0,
      pickCount: save.pickCount || 0,
      days: save.days || {},
      events: save.events || [],
      heart: save.heart
    };
  }

  function encodeObs(obj){
    const json = JSON.stringify(obj);
    const b64 = btoa(unescape(encodeURIComponent(json)));
    return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }

  function decodeObs(s){
    try{
      const b64 = s.replace(/-/g,"+").replace(/_/g,"/");
      const pad = "=".repeat((4 - (b64.length % 4)) % 4);
      const json = decodeURIComponent(escape(atob(b64 + pad)));
      return JSON.parse(json);
    }catch(_){
      return null;
    }
  }

  function drawHeartChartFromEvents(canvas, events){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    const pts = (events || [])
      .filter(e => typeof e.heart === "number" && typeof e.elapsed === "number")
      .sort((a,b)=>a.elapsed-b.elapsed);

    if(pts.length < 2){
      ctx.globalAlpha = 0.75;
      ctx.font = "14px system-ui";
      ctx.fillText("No data", 12, 24);
      return;
    }

    const minX = pts[0].elapsed;
    const maxX = pts[pts.length-1].elapsed;

    function xOf(x){
      const tt = (x - minX) / Math.max(1, (maxX - minX));
      return 20 + tt * (w - 40);
    }
    function yOf(y){
      const tt = y / 100;
      return (h - 18) - tt * (h - 36);
    }

    ctx.globalAlpha = 0.35;
    ctx.beginPath();
    ctx.moveTo(20, yOf(50));
    ctx.lineTo(w-20, yOf(50));
    ctx.stroke();

    ctx.globalAlpha = 0.95;
    ctx.beginPath();
    ctx.moveTo(xOf(pts[0].elapsed), yOf(pts[0].heart));
    for(const p of pts){
      ctx.lineTo(xOf(p.elapsed), yOf(p.heart));
    }
    ctx.stroke();

    ctx.globalAlpha = 0.65;
    ctx.font = "12px system-ui";
    ctx.fillText("0", 6, h-18);
    ctx.fillText("100", 0, 16);
  }

  function showObserveFromData(data){
    showObserveScreen();

    const name = data.petName ? `ã€Œ${data.petName}ã€` : "";
    ui.obsTitle.textContent = (LANG==="en") ? `Observer Log ${name}` : (LANG==="zh" ? `è§‚å¯Ÿè®°å½• ${name}` : `è¦³å¯Ÿç”¨ãƒ­ã‚° ${name}`);

    const started = new Date(data.startedAt);
    ui.obsSub.textContent =
      (LANG==="en") ? `Started: ${started.toLocaleString()}`
      : (LANG==="zh") ? `å¼€å§‹ï¼š${started.toLocaleString()}`
      : `é–‹å§‹ï¼š${started.toLocaleString()}`;

    drawHeartChartFromEvents(ui.heartChart, data.events || []);

    ui.obsDays.innerHTML = "";
    const days = data.days || {};
    for(let d=1; d<=3; d++){
      const one = days[d];
      const card = document.createElement("div");
      card.className = "dayCard";

      if(!one){
        card.innerHTML = `<div class="dh"><b>Day ${d}</b><small> </small></div>
          <div class="mini">${escapeHtml((LANG==="en")?"No data.":(LANG==="zh"?"æ— æ•°æ®ã€‚":"ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚"))}</div>`;
        ui.obsDays.appendChild(card);
        continue;
      }

      const cc = one.careCounts || {};
      const items = one.items || {};
      const choiceLines = (one.choices || []).map(c => {
        const dt = new Date(c.t);
        const hm = `${String(dt.getHours()).padStart(2,"0")}:${String(dt.getMinutes()).padStart(2,"0")}`;
        return `${hm}  ${c.category}  ${c.choice}`;
      });

      card.innerHTML = `
        <div class="dh"><b>Day ${d}</b><small>heart ${Math.round(one.heartEnd ?? 0)}%</small></div>
        <div class="kvs">
          <div><span>Food</span> ${cc.food ?? 0}</div>
          <div><span>Out</span> ${cc.out ?? 0}</div>
          <div><span>Style</span> ${cc.style ?? 0}</div>
          <div><span>Clean</span> ${cc.clean ?? 0}</div>
          <div><span>Drink</span> ${items.drink ?? 0}</div>
          <div><span>Macaron</span> ${items.macaron ?? 0}</div>
        </div>
        <div class="choices">${escapeHtml(choiceLines.join("\n"))}</div>
      `;
      ui.obsDays.appendChild(card);
    }
  }

  function downloadCSV(save){
    const rows = [];
    rows.push([
      "timestamp_iso","type","day","category","detail",
      "heart","hunger","dirt","mood","poop","elapsed_ms",
      "player_id","pet_name","macaron_color","char_color","grow_level","pick_count"
    ]);

    const events = (save.events || []).slice().sort((a,b)=>a.t-b.t);
    for(const e of events){
      const iso = new Date(e.t).toISOString();
      rows.push([
        iso,
        e.type || "",
        String(e.day ?? ""),
        String(e.category ?? ""),
        String(e.choice ?? e.text ?? ""),
        String(e.heart ?? ""),
        String(e.hunger ?? ""),
        String(e.dirt ?? ""),
        String(e.mood ?? ""),
        String(e.poop ?? ""),
        String(e.elapsed ?? ""),
        save.playerId || "",
        save.petName || "",
        save.macaronColor || "",
        save.charColor || "",
        String(save.growLevel ?? 0),
        String(save.pickCount ?? 0),
      ]);
    }

    function csvEscape(v){
      const s = String(v ?? "");
      if(/[,"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    const stamp = new Date().toISOString().replace(/[:.]/g,"-");
    a.href = URL.createObjectURL(blob);
    a.download = `osewa_log_${stamp}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  function openLogsModal(){
    const save = loadSave(); if(!save) return;

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml((LANG==="en") ? "You can download logs as CSV.\nThis is saved locally."
: (LANG==="zh") ? "å¯ä»¥ä¸‹è½½CSVã€‚\nä¿å­˜åœ¨æœ¬åœ°ã€‚"
: "CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚\nãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã§ã™ã€‚")}
    </div>`;

    const list = document.createElement("div");
    list.style.marginTop = "10px";
    list.style.display = "flex";
    list.style.flexDirection = "column";
    list.style.gap = "8px";
    list.style.maxHeight = "320px";
    list.style.overflow = "auto";

    const recent = (save.events || []).slice(-60).reverse();
    for(const e of recent){
      const dt = new Date(e.t);
      const hm = `${String(dt.getHours()).padStart(2,"0")}:${String(dt.getMinutes()).padStart(2,"0")}`;
      const item = document.createElement("div");
      item.className = "logItem";
      const text = (e.type === "choice" && e.category)
        ? `${e.category}  ${e.choice || ""}`
        : (e.text || "");
      item.innerHTML = `<b>${escapeHtml(text)}</b><div class="t">${hm} / day ${e.day ?? ""}</div>`;
      list.appendChild(item);
    }
    body.appendChild(list);

    openModal(
      t("btnLogs"),
      "",
      body,
      [
        mkBtn("CSV", "", () => { const s = loadSave(); if(s) downloadCSV(s); }),
        mkBtn(t("btnClose"), "btnGhost", closeModal)
      ]
    );
  }

  function openResetModal(){
    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml(t("resetText"))}
    </div>`;

    const two = document.createElement("div");
    two.className = "two";

    const keep = () => {
      const s = loadSave();
      if(s) archiveRun(s);
      const ns = createNewSave();
      saveSave(ns);
      closeModal();
    };
    const wipe = () => {
      localStorage.removeItem(SAVE_KEY);
      const ns = createNewSave();
      saveSave(ns);
      closeModal();
    };

    two.appendChild(mkChoice("ğŸ§·", t("resetKeep"), t("resetKeepSub"), keep));
    two.appendChild(mkChoice("ğŸ§¼", t("resetWipe"), t("resetWipeSub"), wipe));
    body.appendChild(two);

    openModal(t("resetTitle"), "", body, [ mkBtn(t("btnClose"), "btnGhost", closeModal) ]);
  }

  function openShareModal(){
    const save = loadSave(); if(!save) return;
    const data = exportObservationData(save);
    const token = encodeObs(data);
    const u = new URL(location.href);
    u.searchParams.set("observe","1");
    u.hash = "obs=" + token;

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml(t("shareText"))}

${escapeHtml(u.toString())}
    </div>`;

    const copy = async () => {
      try{
        await navigator.clipboard.writeText(u.toString());
        const s = loadSave(); if(s) { pushLiveLog(s, t("shareCopied")); saveSave(s); }
      }catch(_){}
      closeModal();
    };

    openModal(
      t("shareTitle"),
      t("shareHint"),
      body,
      [
        mkBtn(t("btnCopy"), "", copy),
        mkBtn(t("btnClose"), "btnGhost", closeModal)
      ]
    );
  }

  // æ‰‹ç´™ãƒ¢ãƒ¼ãƒ€ãƒ«
  let lastFocusEl = null;

  function openLetter(){
    lastFocusEl = document.activeElement;

    ui.letterModal.classList.remove("closing");
    ui.letterModal.classList.add("open");
    ui.letterModal.removeAttribute("aria-hidden");
    ui.letterModal.removeAttribute("inert");

    setTimeout(() => {
      (ui.letterClose || ui.letterX || ui.letterBtn).focus?.();
    }, 0);

    const s = loadSave();
    if(s){
      touchAction(s);
      addChoice(s, "Letter", "Read");
      pushLiveLog(s, t("logReadLetter"));
      saveSave(s);
    }
  }

  function closeLetter(){
    if(!ui.letterModal.classList.contains("open")) return;

    const target = (lastFocusEl && typeof lastFocusEl.focus === "function")
      ? lastFocusEl
      : ui.letterBtn;
    target?.focus?.();

    ui.letterModal.classList.add("closing");
    ui.letterModal.setAttribute("inert","");

    setTimeout(() => {
      ui.letterModal.classList.remove("open","closing");
      ui.letterModal.setAttribute("aria-hidden","true");
    }, 240);
  }

  function setStageText(save){
    const elapsed = calcElapsedMs(save, now());
    const remaining = Math.max(0, (LIFE_MS + (save.lifeExtensionMs||0)) - elapsed);
    const mm = Math.floor(remaining/60000);
    const ss = Math.floor((remaining%60000)/1000);
    const remTxt = `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;

    if(save.pausedSince){
      ui.stageHint.textContent = t("timeStopped");
    }else if(!save.hatched){
      const left = Math.max(0, HATCH_MS - elapsed);
      const s = Math.ceil(left/1000);
      ui.stageHint.textContent = (LANG==="en") ? `Hatching in ~${s}s` : (LANG==="zh" ? `çº¦${s}ç§’åå‡ºç°` : `ã‚ã¨${s}ç§’ãã‚‰ã„â€¦`);
    }else if(save.ended && !save.macaronActive){
      ui.stageHint.textContent = (LANG==="en") ? "Ended" : (LANG==="zh" ? "ç»“æŸ" : "çµ‚äº†");
    }else{
      ui.stageHint.textContent = (LANG==="en") ? `Time left ~${remTxt}` : (LANG==="zh" ? `å‰©ä½™ ~${remTxt}` : `æ®‹ã‚Š ~${remTxt}`);
    }

    if(!save.hatched){
      ui.stageNote.textContent = t("waitNote");
      return;
    }

    if(isSleeping(save, elapsed)){
      ui.stageNote.textContent = t("sleepNote");
      return;
    }

    const name = save.petName ? `ã€Œ${save.petName}ã€` : "";
    const mood = stateClass(save);
    const face =
      mood==="cry" ? (LANG==="en"?"Crying":(LANG==="zh"?"åœ¨å“­":"æ³£ã„ã¦ã‚‹")) :
      mood==="low" ? (LANG==="en"?"Low":(LANG==="zh"?"æ²¡ç²¾ç¥":"å…ƒæ°—ãŒãªã„")) :
      mood==="lively" ? (LANG==="en"?"Lively":(LANG==="zh"?"å¾ˆç²¾ç¥":"ã”ãã’ã‚“")) :
      (LANG==="en"?"Normal":(LANG==="zh"?"æ™®é€š":"ãµã¤ã†"));

    const poop = save.poop>0 ? (LANG==="en"?"Needs clean":(LANG==="zh"?"éœ€è¦æ¸…ç†":"æƒé™¤ã—ãŸã„")) : (LANG==="en"?"Clean":(LANG==="zh"?"å¹²å‡€":"ãã‚Œã„"));
    ui.stageNote.textContent =
      (LANG==="en") ? `${name}  ${face}\nHunger ${Math.round(save.hunger)} / Dirt ${Math.round(save.dirt)} / ${poop}\nPicks ${save.pickCount || 0} (grow ${save.growLevel || 0})`
      : (LANG==="zh") ? `${name}  ${face}\né¥¥é¥¿ ${Math.round(save.hunger)} / è„ ${Math.round(save.dirt)} / ${poop}\né€‰æ‹© ${save.pickCount || 0}ï¼ˆæˆé•¿ ${save.growLevel || 0}ï¼‰`
      : `${name}  ${face}\nç©ºè…¹ ${Math.round(save.hunger)} / æ±šã‚Œ ${Math.round(save.dirt)} / ${poop}\né¸æŠ ${save.pickCount || 0}ï¼ˆæˆé•· ${save.growLevel || 0}ï¼‰`;
  }

  function render(save){
    const elapsed = calcElapsedMs(save, now());

    ui.macaronArea.style.display = save.hatched ? "none" : "grid";
    ui.charArea.style.display = save.hatched ? "grid" : "none";

    ui.thanksOverlay.classList.toggle("show", save.ended && !save.macaronActive);
    ui.macaronImg.classList.toggle("hatchLift", !!save.hatchAnim);

    const st = stateClass(save);
    ui.charArea.classList.remove("low","cry","lively","sleep");
    if(st) ui.charArea.classList.add(st);
    if(save.hatched && isSleeping(save, elapsed)) ui.charArea.classList.add("sleep");

    applyVisualImages(save);
    applyGrowthScale(save);

    updateHeartUI(save);
    updatePoopUI(save);
    setStageText(save);

    const inter = canInteract(save, elapsed);
    setInteractable(inter);

    ui.btnMacaron.disabled = !(save.ended && !save.macaronActive);

    if(!save.letterShown && elapsed >= LETTER_DELAY_MS){
      save.letterShown = true;
      saveSave(save);
    }
    if(save.letterShown) showLetterSlot();

    renderLiveLog(save);
    ui.subline.textContent = save.ended && !save.macaronActive ? t("subEnded") : t("subRunning");
  }

  function toggleSitter(){
    const s = loadSave(); if(!s) return;

    touchAction(s);

    if(!s.pausedSince){
      s.pausedSince = now();
      pushLiveLog(s, t("logSitterOn"));
      ui.sitterToggle.dataset.on = "true";
    }else{
      const paused = now() - s.pausedSince;
      s.totalPausedMs += paused;
      ensureDay(s, s.currentDay).sitterMs += paused;
      s.pausedSince = null;
      pushLiveLog(s, t("logSitterOff"));
      ui.sitterToggle.dataset.on = "false";
    }
    saveSave(s);
  }

  function initObserveMode(){
    const observe = url.searchParams.get("observe") === "1" || location.hash.startsWith("#obs=");
    if(!observe) return false;

    const hash = location.hash || "";
    const m = hash.match(/obs=([A-Za-z0-9\-_]+)/);
    const token = m ? m[1] : "";
    const data = token ? decodeObs(token) : null;

    if(data){
      setLang(getLang());
      applyLangToUI();
      showObserveFromData(data);
      return true;
    }
    return false;
  }

  // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
  function tick(){
    const save = loadSave();
    if(!save) return;

    const tNow = now();
    const elapsed = calcElapsedMs(save, tNow);

    // ã‚·ãƒƒã‚¿ãƒ¼ä¸­ã¯æ™‚é–“åœæ­¢ï¼ˆå¯¿å‘½ãƒ»ç©ºè…¹ãƒ»æ’æ³„ãƒ»çŠ¶æ…‹å¤‰åŒ–ã™ã¹ã¦æ­¢ã‚ã‚‹ï¼‰
    if(!save.pausedSince && !save.ended){
      applyTimeSimulation(save, elapsed);
      updateDayBoundary(save, elapsed);
      maybeHatch(save, elapsed);
      maybeEnd(save, elapsed);

      // è§¦ã‚‰ãªã„æ™‚é–“ãŒç¶šã„ãŸã‚‰å¿…ãšsleepï¼ˆå¯ç”»åƒã‚’ç¢ºå®Ÿã«è¦‹ã›ã‚‹ï¼‰
      if(save.hatched && !isSleeping(save, elapsed)){
        const idle = elapsed - (save.lastActionElapsed || 0);
        if(idle >= IDLE_SLEEP_AFTER_MS){
          startSleep(save, elapsed, t("logQuiet"));
          save.lastActionElapsed = elapsed;
        }
      }
    }

    updateMacaronTimer(save, elapsed);

    save.lastSimElapsed = elapsed;
    saveSave(save);

    render(save);

    requestAnimationFrame(tick);
  }

  // èµ·å‹•
  setLang(getLang());
  applyLangToUI();

  if(initObserveMode()){
    return;
  }

  let save = loadSave();
  if(!save){
    save = createNewSave();
    saveSave(save);
  }

  ui.sitterToggle.dataset.on = save.pausedSince ? "true" : "false";
  ui.letterText.textContent = getLetterBody();
  render(save);

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  ui.langSel.addEventListener("change", () => setLang(ui.langSel.value));
  ui.sitterToggle.addEventListener("click", toggleSitter);

  ui.btnFood.addEventListener("click", actFood);
  ui.btnOut.addEventListener("click", actOut);
  ui.btnStyle.addEventListener("click", actStyle);

  ui.btnClean.addEventListener("click", startCleanGame);

  ui.btnDrink.addEventListener("click", actDrink);
  ui.btnMacaron.addEventListener("click", actMacaron);

  ui.btnName.addEventListener("click", () => openNameModal(false));
  ui.btnReset.addEventListener("click", openResetModal);
  ui.btnShare.addEventListener("click", openShareModal);
  ui.btnLogs.addEventListener("click", openLogsModal);
  ui.btnCsv.addEventListener("click", () => { const s = loadSave(); if(s) downloadCSV(s); });

  ui.btnCleanExit.addEventListener("click", () => endCleanGameAndApply());
  ui.btnCleanFinish.addEventListener("click", () => endCleanGameAndApply());

  ui.letterBtn.addEventListener("click", openLetter);
  ui.letterX.addEventListener("click", closeLetter);
  ui.letterClose.addEventListener("click", closeLetter);
  ui.letterModal.addEventListener("click", (e) => { if(e.target === ui.letterModal) closeLetter(); });
  window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeLetter(); });

  ui.btnBackToGame.addEventListener("click", () => {
    const u = new URL(location.href);
    u.searchParams.delete("observe");
    u.hash = "";
    history.replaceState({}, "", u.toString());
    showGameScreen();
  });

  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
