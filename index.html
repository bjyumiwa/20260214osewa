<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3æ—¥é–“ã®ãŠä¸–è©±ã‚²ãƒ¼ãƒ </title>
  <style>
    :root{
      --bg0:#050816;
      --bg1:#0b1028;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.14);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.72);
      --shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 900px at 50% 20%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    main{max-width:980px;margin:0 auto;padding:18px 18px 32px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .title{font-weight:900;letter-spacing:.02em}
    .sub{color:var(--muted);font-size:12px;line-height:1.6}

    .pill{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);background:var(--card);border-radius:999px}
    .switch{display:flex;align-items:center;gap:10px}
    .switch input{
      width:44px;height:24px;appearance:none;background:rgba(255,255,255,.15);
      border-radius:999px;position:relative;outline:none;cursor:pointer;
      border:1px solid rgba(255,255,255,.18)
    }
    .switch input:checked{background:rgba(185,246,202,.25)}
    .switch input::after{
      content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;
      border-radius:999px;background:#fff;transition:transform .18s ease
    }
    .switch input:checked::after{transform:translateX(20px)}

    .grid{display:grid;grid-template-columns: 1.3fr .7fr;gap:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr; } }

    .card{border:1px solid var(--line);background:var(--card);border-radius:18px;padding:14px;box-shadow:var(--shadow)}

    /* å®‡å®™èƒŒæ™¯ï¼ˆç”»åƒå„ªå…ˆï¼‰ */
    .stage{
      position:relative;min-height:360px;overflow:hidden;border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        url("public/char/space_background.png") center / cover no-repeat,
        radial-gradient(900px 500px at 50% 20%, rgba(120,150,255,.18), transparent 55%),
        radial-gradient(700px 450px at 20% 70%, rgba(255,120,200,.12), transparent 55%),
        radial-gradient(700px 450px at 80% 80%, rgba(120,255,220,.10), transparent 55%),
        rgba(0,0,0,.10);
    }
    .stars{
      position:absolute;inset:0;opacity:.28;pointer-events:none;
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,.9), transparent 50%),
        radial-gradient(2px 2px at 120px 160px, rgba(255,255,255,.7), transparent 50%),
        radial-gradient(1px 1px at 240px 80px, rgba(255,255,255,.7), transparent 50%),
        radial-gradient(1px 1px at 320px 220px, rgba(255,255,255,.7), transparent 50%),
        radial-gradient(2px 2px at 520px 140px, rgba(255,255,255,.65), transparent 50%),
        radial-gradient(1px 1px at 640px 40px, rgba(255,255,255,.75), transparent 50%),
        radial-gradient(1px 1px at 740px 210px, rgba(255,255,255,.65), transparent 50%),
        radial-gradient(1px 1px at 860px 120px, rgba(255,255,255,.6), transparent 50%);
      filter:blur(.1px);
      animation: twinkle 5.6s ease-in-out infinite alternate;
    }
    @keyframes twinkle{ from{opacity:.22} to{opacity:.38} }

    .ground{
      position:absolute;left:-10%;right:-10%;bottom:-50px;height:140px;border-radius:50%;
      background:
        radial-gradient(900px 220px at 50% 20%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(700px 160px at 30% 30%, rgba(120,255,220,.10), transparent 55%),
        rgba(255,255,255,.05);
      filter: blur(.2px);
    }

    .bubble{
      position:absolute;left:16px;top:16px;max-width:72%;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);color:rgba(238,242,255,.92);
      font-size:13px;line-height:1.55;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(4px);
      min-height:42px;
    }

    /* ãƒã‚«ãƒ­ãƒ³ï¼ˆåµã®ä»£ã‚ã‚Šï¼‰ */
    .egg{
      position:absolute;left:50%;bottom:128px;transform:translateX(-50%);
      width:150px;height:150px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      display:grid;place-items:center;
      box-shadow: 0 18px 40px rgba(0,0,0,.28);
      animation: eggFloat 2.8s ease-in-out infinite;
      pointer-events:none;
      overflow:hidden;
    }
    .egg img{
      width:86%;height:86%;object-fit:contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      transition:opacity .25s ease, filter .25s ease;
    }
    @keyframes eggFloat{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-10px)}}
    .eggGlow{position:absolute;inset:-30px;border-radius:999px;background:radial-gradient(circle, rgba(185,246,202,.18), transparent 55%);filter:blur(1px);opacity:.9}
    .eggLift{transition: transform .6s ease}
    .eggLift.lift{transform:translateX(-50%) translateY(-46px)}

    /* ã‚­ãƒ£ãƒ©é…ç½®ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å¸¸ã«ã„ã‚‹ã€‚å­ã¯èª•ç”Ÿã¾ã§éš ã™ï¼‰ */
    .pair{position:absolute;left:0;right:0;bottom:58px;display:flex;justify-content:center;align-items:flex-end;gap:22px;pointer-events:none}
    .charWrap{display:flex;flex-direction:column;align-items:center;gap:10px;transition:opacity .6s ease, transform .6s ease}
    .charWrap.hidePet{opacity:0;transform:translateY(10px) scale(.98)}
    .sprite{
      width:148px;height:148px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 40px rgba(0,0,0,.28);
      position:relative;
    }
    .sprite.big{width:168px;height:168px}
    .sprite.small{width:132px;height:132px}
    .img{width:86%;height:86%;object-fit:contain;filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));}

    /* ç”»åƒãŒãªã„ã¨ãã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é¡” */
    .face{position:absolute;inset:0;display:grid;place-items:center;opacity:.95}
    .eyes{display:flex;gap:18px;transform:translateY(-6px)}
    .eye{width:16px;height:16px;border-radius:999px;background:#fff;opacity:.95}
    .mouth{width:34px;height:14px;border:3px solid rgba(255,255,255,.95);border-top:none;border-left:none;border-right:none;border-radius:0 0 999px 999px;opacity:.9;transform:translateY(14px)}
    .tear{position:absolute;right:52px;top:64px;width:10px;height:16px;border-radius:999px;background:rgba(160,210,255,.9);filter:blur(.1px);opacity:0}

    /* çŠ¶æ…‹ï¼ˆãƒ©ãƒ™ãƒ«ç„¡ã—ï¼‰ */
    .state-good{animation: bob 1.2s ease-in-out infinite;}
    @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .state-low{animation: sway 2.0s ease-in-out infinite;opacity:.92}
    @keyframes sway{0%,100%{transform:translateY(3px) rotate(-1deg)}50%{transform:translateY(6px) rotate(1deg)}}
    .state-cry{animation: tremble .22s ease-in-out infinite;opacity:.90}
    @keyframes tremble{0%,100%{transform:translateX(0)}50%{transform:translateX(2px)}}
    .state-cry .tear{opacity:1;animation: drip .9s ease-in-out infinite}
    @keyframes drip{0%{transform:translateY(0);opacity:0}20%{opacity:1}100%{transform:translateY(22px);opacity:0}}

    /* ğŸ’©ï¼ˆæ”¾ç½®ã§å¢—ãˆã‚‹ï¼‰ */
    .poops{position:absolute;left:0;right:0;bottom:88px;display:flex;justify-content:center;gap:18px;pointer-events:none}
    .poop{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 24px rgba(0,0,0,.24);
      opacity:0;
      transform:translateY(12px);
      transition:opacity .35s ease, transform .35s ease;
    }
    .poop.show{opacity:1;transform:translateY(0)}
    .stink{
      position:absolute;left:50%;bottom:246px;transform:translateX(-50%);
      font-size:18px;opacity:0;transition:opacity .25s ease;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.3));
      pointer-events:none;
    }
    .stink.on{opacity:.85;animation: stinkUp 1.6s ease-in-out infinite;}
    @keyframes stinkUp{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-10px)}}

    /* å³ãƒ‘ãƒãƒ« */
    .panelTitle{font-weight:900;margin:0 0 8px}
    .muted{color:var(--muted);font-size:12px;line-height:1.7}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .btn{
      border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);
      color:var(--text);border-radius:16px;padding:12px 10px;font-weight:900;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;min-height:46px;
    }
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .softBar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .softFill{height:100%;width:40%;background:rgba(185,246,202,.35)}
    .icons{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .tiny{font-size:12px;color:rgba(238,242,255,.78)}
    .heartRow{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .heart{opacity:.75}
    .heart.on{opacity:1}

    /* 2æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .modalBack.open{display:flex}
    .modal{
      width:min(620px, 100%);border-radius:18px;border:1px solid rgba(255,255,255,.14);
      background:rgba(12,16,40,.92);box-shadow:0 24px 70px rgba(0,0,0,.5);
      padding:14px;backdrop-filter: blur(8px);
    }
    .modal h2{margin:2px 0 10px;font-size:18px}
    .choiceRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .choice{
      border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);
      border-radius:16px;padding:14px;font-weight:900;cursor:pointer;min-height:62px;
      display:flex;flex-direction:column;gap:6px;justify-content:center;
    }
    .choice small{font-weight:600;color:rgba(238,242,255,.72)}
    .modalFoot{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:10px}
    .x{border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .miniArea{margin-top:10px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:12px;min-height:120px}
    .poopGameRow{display:flex;gap:10px;flex-wrap:wrap}
    .poopTarget{
      width:54px;height:54px;border-radius:16px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);display:grid;place-items:center;cursor:pointer;
      user-select:none;
    }
    .poopTarget:active{transform:scale(.98)}
    .hint{color:rgba(238,242,255,.72);font-size:12px;line-height:1.6}

    /* ãŠæ‰‹ç´™ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .letterBack{
      position:fixed;inset:0;background:rgba(0,0,0,.60);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:70;
    }
    .letterBack.open{display:flex}
    .letter{
      width:min(720px,100%);
      border-radius:18px;border:1px solid rgba(255,255,255,.14);
      background:rgba(12,16,40,.92);
      box-shadow:0 24px 70px rgba(0,0,0,.5);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .letterTitle{font-weight:900;margin:0 0 10px}
    .letterBody{
      white-space:pre-wrap;
      line-height:1.85;
      color:rgba(238,242,255,.92);
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px;
      min-height:170px;
    }
    .letterFoot{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
    .letterTiny{color:rgba(238,242,255,.68);font-size:12px;line-height:1.6}

    /* åˆå›ï¼šè‰²é¸æŠ */
    .setupBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
    .setupBack.open{display:flex}
    .setup{
      width:min(620px,100%);
      border-radius:18px;border:1px solid rgba(255,255,255,.14);
      background:rgba(12,16,40,.92);
      padding:14px;
      box-shadow:0 24px 70px rgba(0,0,0,.5)
    }
    .setup h2{margin:2px 0 10px;font-size:18px}
    .colors{display:flex;gap:10px;flex-wrap:wrap}
    .cbtn{border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#eef2ff;border-radius:16px;padding:12px 12px;font-weight:900;cursor:pointer}

    /* çµ‚äº† */
    .ending{
      position:fixed;inset:0;display:none;place-items:center;z-index:80;
      background:rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
    }
    .ending.show{display:grid}
    .thanks{
      font-size:40px;font-weight:900;letter-spacing:.08em;
      color:rgba(238,242,255,.96);
      text-shadow: 0 20px 60px rgba(0,0,0,.55);
    }

    @media (prefers-reduced-motion: reduce){
      *{animation:none !important;transition:none !important}
    }
  </style>
</head>
<body>
<main>
  <header>
    <div>
      <div class="title">3æ—¥é–“ã®ãŠä¸–è©±</div>
      <div class="sub" id="subLine"></div>
    </div>
    <div class="pill">
      <div class="switch">
        <span class="sub">ã‚·ãƒƒã‚¿ãƒ¼</span>
        <input id="sit" type="checkbox" aria-label="ã‚·ãƒƒã‚¿ãƒ¼">
      </div>
    </div>
  </header>

  <div class="grid">
    <div class="card stage" id="stage">
      <div class="stars"></div>
      <div class="bubble" id="bubble"></div>

      <div class="stink" id="stink">ã€°ï¸ã€°ï¸</div>

      <div class="egg eggLift" id="egg" aria-hidden="true">
        <div class="eggGlow"></div>
        <img id="eggImg" alt="" />
      </div>

      <div class="pair" id="pair">
        <div class="charWrap" id="playerWrap">
          <div class="sprite big state-good" id="playerSprite">
            <img class="img" id="playerImg" alt="" />
            <div class="face" id="playerFace">
              <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
              <div class="mouth"></div>
            </div>
          </div>
        </div>

        <div class="charWrap hidePet" id="petWrap">
          <div class="sprite small state-good" id="petSprite">
            <img class="img" id="petImg" alt="" />
            <div class="face" id="petFace">
              <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
              <div class="mouth"></div>
              <div class="tear"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="poops" id="poops">
        <div class="poop" id="poop1">ğŸ’©</div>
        <div class="poop" id="poop2">ğŸ’©</div>
        <div class="poop" id="poop3">ğŸ’©</div>
      </div>

      <div class="ground"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
        <div>
          <p class="panelTitle">ãŠä¸–è©±</p>
          <div class="muted">æ­£è§£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚é¸æŠã¨ãƒ­ã‚°ã ã‘ãŒæ®‹ã‚Šã¾ã™ã€‚</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="x" id="btnLetter" title="ãŠæ‰‹ç´™" style="display:none">ãŠæ‰‹ç´™</button>
          <button class="x" id="toLogs" title="ãƒ­ã‚°">ãƒ­ã‚°</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="tiny">é–¢ä¿‚ï¼ˆãƒãƒ¼ãƒˆï¼‰</div>
        <div class="heartRow" id="hearts"></div>
        <div class="tiny" id="nameLine" style="margin-top:6px"></div>
      </div>

      <div style="margin-top:12px">
        <div class="icons">
          <div class="tiny">ç©ºè…¹</div>
          <div class="tiny" id="hungerIcon">ğŸš</div>
        </div>
        <div class="softBar"><div class="softFill" id="hungerBar"></div></div>
      </div>

      <div style="margin-top:12px">
        <div class="icons">
          <div class="tiny">æ¸…æ½”</div>
          <div class="tiny" id="poopIcon">ğŸ’©</div>
        </div>
        <div class="softBar"><div class="softFill" id="poopBar"></div></div>
      </div>

      <div class="actions">
        <button class="btn" id="actFood">ğŸ™ ã”ã¯ã‚“</button>
        <button class="btn" id="actOut">ğŸšª ãŠã§ã‹ã‘</button>
        <button class="btn" id="actMini">ğŸ² 2æŠãƒŸãƒ‹</button>
        <button class="btn" id="actPoop">ğŸ§» ãã†ã˜</button>
        <button class="btn" id="actDrink">ğŸ¥¤ ãƒ‰ãƒªãƒ³ã‚¯</button>
        <button class="btn" id="actMacaron" disabled>ğŸ¬ ãƒã‚«ãƒ­ãƒ³</button>
      </div>

      <div class="muted" style="margin-top:10px" id="hintLine"></div>
    </div>
  </div>
</main>

<div class="modalBack" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h2 id="modalTitle"></h2>
    <div class="choiceRow" id="choiceRow"></div>
    <div class="miniArea" id="miniArea" style="display:none"></div>
    <div class="modalFoot">
      <div class="hint" id="modalHint"></div>
      <button class="x" id="modalClose">ã¨ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div class="letterBack" id="letterBack" aria-hidden="true">
  <div class="letter" role="dialog" aria-modal="true">
    <h2 class="letterTitle" id="letterTitle">ãŠæ‰‹ç´™</h2>
    <div class="letterBody" id="letterBody"></div>
    <div class="letterFoot">
      <div class="letterTiny">èª­ã‚€æ™‚é–“ã¯æ­¢ã¾ã‚Šã¾ã›ã‚“ã€‚æ­¢ã‚ãŸã„ã¨ãã¯ã‚·ãƒƒã‚¿ãƒ¼ã‚’ä½¿ãˆã¾ã™ã€‚</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="x" id="letterName" style="display:none">åå‰ã‚’ã¤ã‘ã‚‹</button>
        <button class="x" id="letterClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<div class="setupBack" id="setupBack" aria-hidden="true">
  <div class="setup" role="dialog" aria-modal="true">
    <h2>ã‚ãªãŸã®è‰²</h2>
    <div class="sub">æ°—åˆ†ã§é¸ã‚“ã§ãã ã•ã„ã€‚æ„å‘³ã¯èª¬æ˜ã—ã¾ã›ã‚“ã€‚</div>
    <div class="colors" style="margin-top:10px">
      <button class="cbtn" data-color="blue">blue</button>
      <button class="cbtn" data-color="green">green</button>
      <button class="cbtn" data-color="purple">purple</button>
      <button class="cbtn" data-color="pick">pick</button>
    </div>
  </div>
</div>

<div class="ending" id="ending">
  <div class="thanks">ã‚ã‚ŠãŒã¨ã†</div>
</div>

<script>
(() => {
  "use strict";

  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç°¡æ˜“ã‚²ãƒ¼ãƒˆï¼ˆé–‹ç™ºä¸­ã¯ ?dev=1 ã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  const SURVEY_DONE_KEY = "gift_survey_done";
  const devBypass = new URLSearchParams(location.search).get("dev") === "1";
  if(!devBypass && localStorage.getItem(SURVEY_DONE_KEY) !== "1"){
    location.replace("./survey.html");
    return;
  }

  // ä¿å­˜ã‚­ãƒ¼ï¼ˆlogs.html ã‚‚åŒã˜ã«ï¼‰
  const SAVE_KEY = "tosewa_save_v2";

  // æ™‚é–“
  const INCUBATION_MS = 3 * 60 * 1000;              // ç¾½åŒ–ã¾ã§3åˆ†
  const LIFE_MS       = 3 * 24 * 60 * 60 * 1000;    // èª•ç”Ÿå¾Œ3æ—¥
  const DAY_MS        = 24 * 60 * 60 * 1000;

  // ç¾½åŒ–å‰ã®ãŠæ‰‹ç´™è§£ç¦ï¼ˆ30ç§’ï¼‰
  const INTRO_LETTER_UNLOCK_MS = 30 * 1000;

  // é€²è¡Œï¼ˆ0-100ï¼‰
  const HUNGER_PER_HOUR = 12;
  const POOP_PER_HOUR   = 10;

  // ç”»åƒ
  const ASSETS = {
    blue:   { open:"public/char/blue/open.png",   closed:"public/char/blue_closed.png",   sleep:"public/char/blue/sleep.png" },
    green:  { open:"public/char/green/open.png",  closed:"public/char/green_closed.png",  sleep:"public/char/green/sleep.png" },
    purple: { open:"public/char/purple/open.png", closed:"public/char/purple_closed.png", sleep:"public/char/purple/sleep.png" },
    pick:   { open:"public/char/pick/open.png",   closed:"public/char/pick_closed.png",   sleep:"public/char/pick/sleep.png" },
    eggByColor: {
      blue:   "public/char/macaron_blue.png",
      green:  "public/char/macaron_green.png",
      purple: "public/char/macaron_purple.png",
      pick:   "public/char/macaron_pick.png",
    }
  };

  const ui = {
    subLine: document.getElementById("subLine"),
    bubble: document.getElementById("bubble"),
    sit: document.getElementById("sit"),

    egg: document.getElementById("egg"),
    eggImg: document.getElementById("eggImg"),

    playerWrap: document.getElementById("playerWrap"),
    petWrap: document.getElementById("petWrap"),

    stink: document.getElementById("stink"),
    poop1: document.getElementById("poop1"),
    poop2: document.getElementById("poop2"),
    poop3: document.getElementById("poop3"),

    playerSprite: document.getElementById("playerSprite"),
    petSprite: document.getElementById("petSprite"),
    playerImg: document.getElementById("playerImg"),
    petImg: document.getElementById("petImg"),
    playerFace: document.getElementById("playerFace"),
    petFace: document.getElementById("petFace"),

    hearts: document.getElementById("hearts"),
    nameLine: document.getElementById("nameLine"),
    hungerBar: document.getElementById("hungerBar"),
    poopBar: document.getElementById("poopBar"),
    hungerIcon: document.getElementById("hungerIcon"),
    poopIcon: document.getElementById("poopIcon"),
    hintLine: document.getElementById("hintLine"),

    btnLetter: document.getElementById("btnLetter"),
    toLogs: document.getElementById("toLogs"),

    actFood: document.getElementById("actFood"),
    actOut: document.getElementById("actOut"),
    actMini: document.getElementById("actMini"),
    actPoop: document.getElementById("actPoop"),
    actDrink: document.getElementById("actDrink"),
    actMacaron: document.getElementById("actMacaron"),

    modalBack: document.getElementById("modalBack"),
    modalTitle: document.getElementById("modalTitle"),
    choiceRow: document.getElementById("choiceRow"),
    miniArea: document.getElementById("miniArea"),
    modalHint: document.getElementById("modalHint"),
    modalClose: document.getElementById("modalClose"),

    letterBack: document.getElementById("letterBack"),
    letterTitle: document.getElementById("letterTitle"),
    letterBody: document.getElementById("letterBody"),
    letterClose: document.getElementById("letterClose"),
    letterName: document.getElementById("letterName"),

    setupBack: document.getElementById("setupBack"),
    ending: document.getElementById("ending"),
  };

  function defaultSave(){
    return {
      v:2,
      createdAt: Date.now(),

      playerColor: null,
      petColor: null,

      petName: "",

      stage: "egg",          // egg | alive | dead | revived | ended
      sitterOn: false,

      lastRealAt: Date.now(),
      accMs: 0,              // ã‚·ãƒƒã‚¿ãƒ¼OFFæ™‚ã®ã¿é€²ã‚€ã€Œã‚­ãƒ£ãƒ©æ™‚é–“ã€
      sitterMs: 0,

      bornAccMs: null,

      hunger: 15,
      poop: 10,
      health: 80,

      heart: 6,
      heartHistory: [],

      drinkUsed: 0,
      macaronUsed: 0,
      revivedUntilAccMs: null,

      // ãŠæ‰‹ç´™ã®è¡¨ç¤ºæ¸ˆã¿ç®¡ç†
      introLetterRead: false,
      letterShown: [false,false,false], // Day1-3

      // ãƒ­ã‚°ï¼ˆäº‹å®Ÿã ã‘ï¼‰
      events: [],
      day: [
        {food:[], out:[], mini:[], poop:[], heartStart:null, heartEnd:null, sitterMs:0, drink:0, macaron:0},
        {food:[], out:[], mini:[], poop:[], heartStart:null, heartEnd:null, sitterMs:0, drink:0, macaron:0},
        {food:[], out:[], mini:[], poop:[], heartStart:null, heartEnd:null, sitterMs:0, drink:0, macaron:0},
      ],
      endedAt: null,
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return defaultSave();
      const s = JSON.parse(raw);
      if(!s || typeof s !== "object") return defaultSave();
      const merged = Object.assign(defaultSave(), s);
      if(!Array.isArray(merged.letterShown) || merged.letterShown.length !== 3){
        merged.letterShown = [false,false,false];
      }
      return merged;
    }catch(_){
      return defaultSave();
    }
  }
  function save(){
    state.lastRealAt = Date.now();
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  }

  let state = load();

  function pickPetColor(playerColor){
    const colors = ["blue","green","purple","pick"].filter(c => c !== playerColor);
    return colors[Math.floor(Math.random()*colors.length)];
  }

  function setSprites(){
    const pc = state.playerColor || "blue";
    const kc = state.petColor || "green";

    ui.playerImg.style.display = "";
    ui.petImg.style.display = "";
    ui.playerFace.style.display = "none";
    ui.petFace.style.display = "none";

    ui.playerImg.src = ASSETS[pc]?.closed || "";
    ui.petImg.src = ASSETS[kc]?.closed || "";

    ui.playerImg.onerror = () => { ui.playerImg.style.display="none"; ui.playerFace.style.display="grid"; };
    ui.petImg.onerror = () => { ui.petImg.style.display="none"; ui.petFace.style.display="grid"; };

    ui.eggImg.style.display = "";
    ui.eggImg.src = ASSETS.eggByColor[kc] || "";
    ui.eggImg.onerror = () => { ui.eggImg.style.display = "none"; };
  }

  function liveMs(){
    if(state.bornAccMs == null) return 0;
    return Math.max(0, state.accMs - state.bornAccMs);
  }
  function dayIndex(){
    const d = Math.floor(liveMs() / DAY_MS);
    return Math.max(0, Math.min(2, d));
  }
  function ensureDayStart(){
    const di = dayIndex();
    const d = state.day[di];
    if(d.heartStart == null) d.heartStart = state.heart;
    if(d.heartEnd == null) d.heartEnd = state.heart;
  }

  function pushEvent(type, detail){
    const di = dayIndex();
    ensureDayStart();
    state.events.push({
      t: new Date().toISOString(),
      day: di+1,
      stage: state.stage,
      type,
      ...detail
    });
  }

  function addHeart(delta){
    const before = state.heart;
    state.heart = Math.max(0, Math.min(10, state.heart + delta));
    state.heartHistory.push({ t: Date.now(), v: state.heart });
    const di = dayIndex();
    ensureDayStart();
    state.day[di].heartEnd = state.heart;
    if(state.heart !== before) pushEvent("heart", {before, after: state.heart});
  }

  function mood(){
    const h = state.health;
    if(h >= 60) return "good";
    if(h >= 32) return "low";
    return "cry";
  }

  function applySpriteState(){
    const m = mood();
    const cls = { good:"state-good", low:"state-low", cry:"state-cry" }[m];

    ui.petSprite.classList.remove("state-good","state-low","state-cry");
    ui.petSprite.classList.add(cls);

    const c = state.petColor || "green";
    const img = ui.petImg;
    const map = ASSETS[c] || {};

    if(state.sitterOn){
      img.src = map.sleep || map.closed || img.src;
    }else{
      img.src = (m === "good" ? (map.open || map.closed) : (map.closed || map.open)) || img.src;
    }
  }

  function renderHearts(){
    ui.hearts.innerHTML = "";
    for(let i=0;i<10;i++){
      const s = document.createElement("span");
      s.className = "heart" + (i < state.heart ? " on" : "");
      s.textContent = "â¤";
      ui.hearts.appendChild(s);
    }
  }

  function setBar(el, v){
    const pct = Math.max(0, Math.min(100, v));
    el.style.width = pct + "%";
  }

  function renderPoops(){
    const p = state.poop;
    ui.poop1.classList.toggle("show", p >= 22);
    ui.poop2.classList.toggle("show", p >= 52);
    ui.poop3.classList.toggle("show", p >= 78);
    ui.stink.classList.toggle("on", p >= 62);
  }

  // åˆå›ï¼šè‰²é¸æŠ
  function openSetup(){
    ui.setupBack.classList.add("open");
    ui.setupBack.setAttribute("aria-hidden","false");
  }
  function closeSetup(){
    ui.setupBack.classList.remove("open");
    ui.setupBack.setAttribute("aria-hidden","true");
  }
  if(!state.playerColor){
    openSetup();
  }else{
    if(!state.petColor) state.petColor = pickPetColor(state.playerColor);
    setSprites();
    save();
  }
  ui.setupBack.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-color]");
    if(!btn) return;
    state.playerColor = btn.dataset.color;
    state.petColor = pickPetColor(state.playerColor);
    setSprites();
    ensureDayStart();
    closeSetup();
    pushEvent("pick_color", {player: state.playerColor, pet: state.petColor});
    save();
    render();
  });

  // 2æŠãƒ¢ãƒ¼ãƒ€ãƒ«
  let modalOnPick = null;
  function openModal(title, choices, hint, miniHTML){
    ui.modalTitle.textContent = title;
    ui.choiceRow.innerHTML = "";
    ui.modalHint.textContent = hint || "";
    ui.miniArea.style.display = miniHTML ? "block" : "none";
    ui.miniArea.innerHTML = miniHTML || "";

    choices.forEach((c, idx) => {
      const b = document.createElement("button");
      b.className = "choice";
      b.innerHTML = `<div>${c.label}</div>${c.sub ? `<small>${c.sub}</small>` : ""}`;
      b.addEventListener("click", () => modalOnPick?.(idx, c));
      ui.choiceRow.appendChild(b);
    });

    ui.modalBack.classList.add("open");
    ui.modalBack.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    ui.modalBack.classList.remove("open");
    ui.modalBack.setAttribute("aria-hidden","true");
    modalOnPick = null;
  }
  ui.modalClose.addEventListener("click", closeModal);
  ui.modalBack.addEventListener("click", (e) => { if(e.target === ui.modalBack) closeModal(); });

  // ãŠæ‰‹ç´™ï¼ˆç«¥è©±ï¼‰
  const LETTERS = {
    introTitle: "ãŠæ‰‹ç´™ï¼ˆã¯ã˜ã¾ã‚Šï¼‰",
    intro:
`è¦‹ã¤ã‘ã¦ãã‚ŒãŸã‚ãªãŸã¸

ã“ã‚“ã«ã¡ã¯ã€‚
ãƒã‚«ãƒ­ãƒ³æ˜Ÿã®ç©ºã‹ã‚‰ã€ã²ã‚‰ã‚Šã¨èˆã„é™ã‚Šã¦ã—ã¾ã£ãŸ
å°ã•ãªç”Ÿãã‚‚ã®ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚
ç”˜ã„æ®»ã€é£Ÿã¹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã„ã¾ã¯ã¾ã ã€æ®»ã®ä¸­ã§ã€ã“ã¡ã‚‰ã®ä¸–ç•Œã®æ¯ã¥ã‹ã„ã‚’èã„ã¦ã„ã¾ã™ã€‚

ãŠé¡˜ã„ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®å­ã‚’ã€ä¸‰æ—¥ã ã‘è‚²ã¦ã¦ãã ã•ã„ã€‚
ã”ã¯ã‚“ã‚’ã‚ã’ã¦ã‚‚ã„ã„ã—ã€å‡ºã‹ã‘ã¦ã‚‚ã„ã„ã—ã€
ã¨ãã©ãã€æ±šã‚Œã‚’ãã‚Œã„ã«ã—ã¦ã‚ã’ã¦ã€‚

ãã—ã¦ã€ã‚‚ã—ã‚ˆã‘ã‚Œã°ã€‚
åå‰ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚

ä¸‰æ—¥ãŸã£ãŸã‚‰ã€ã“ã®å­ã¯ãƒã‚«ãƒ­ãƒ³æ˜Ÿã¸å¸°ã‚Šã¾ã™ã€‚
å¸°ã‚Šæ–¹ã¯ã€èª°ã«ã‚‚ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚
ãã®ã‚ã„ã ã«èµ·ããŸã“ã¨ã¯ã€è¨˜éŒ²ã¨ã—ã¦æ®‹ã‚Šã¾ã™ã€‚
`,

    day1Title: "ãŠæ‰‹ç´™ï¼ˆDay 1ï¼‰",
    day1:
`è¦‹ã¤ã‘ã¦ãã‚ŒãŸã‚ãªãŸã¸

ä»Šæ—¥ã‹ã‚‰ã€ä¸‰æ—¥ã§ã™ã€‚
ã‚ãªãŸã¨éã”ã—ã¦ã„ãã†ã¡ã«ã€
æ€ã„å‡ºãŒ
æ˜Ÿããšã¿ãŸã„ã«ã€ãã£ã¨ç©ã‚‚ã£ã¦ã„ãã¾ã™ã€‚

`,

    day2Title: "ãŠæ‰‹ç´™ï¼ˆDay 2ï¼‰",
    day2:
`è¦‹ã¤ã‘ã¦ãã‚ŒãŸã‚ãªãŸã¸

ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã€‚
`,

    day3Title: "ãŠæ‰‹ç´™ï¼ˆDay 3ï¼‰",
    day3:
`è¦‹ã¤ã‘ã¦ãã‚ŒãŸã‚ãªãŸã¸

æœ€å¾Œã®æ—¥ã§ã™ã€‚

ãã®ç¬é–“ãŒæ¥ãŸã‚‰ã€ãƒã‚«ãƒ­ãƒ³æ˜Ÿã¸å¸°ã‚Šã¾ã™ã€‚

ã‚ãªãŸãŒã—ã¦ãã‚ŒãŸã“ã¨ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚
`
  };

  // ãŠæ‰‹ç´™ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
  let lastFocusEl = null;
  let currentLetterKind = null;

  function openLetter(title, body, kind){
    lastFocusEl = document.activeElement;
    currentLetterKind = kind || null;

    ui.letterTitle.textContent = title;
    ui.letterBody.textContent = body;

    // ã€Œåå‰ã‚’ã¤ã‘ã‚‹ã€ã¯ã€åå‰ãŒæœªè¨­å®šã®ã¨ãã ã‘å‡ºã™
    if(!state.petName){
      ui.letterName.style.display = "";
    }else{
      ui.letterName.style.display = "none";
    }

    ui.letterBack.classList.add("open");
    ui.letterBack.setAttribute("aria-hidden","false");
    setTimeout(()=> ui.letterClose.focus(), 0);
  }

  function closeLetter(){
    ui.letterBack.classList.remove("open");
    ui.letterBack.setAttribute("aria-hidden","true");
    const t = (lastFocusEl && typeof lastFocusEl.focus === "function") ? lastFocusEl : ui.actFood;
    t?.focus?.();
    currentLetterKind = null;
  }

  ui.letterClose.addEventListener("click", closeLetter);
  ui.letterBack.addEventListener("click", (e) => { if(e.target === ui.letterBack) closeLetter(); });
  window.addEventListener("keydown", (e) => {
    if(e.key === "Escape" && ui.letterBack.classList.contains("open")) closeLetter();
  });

  function setPetName(){
    const cur = state.petName || "";
    const n = prompt("åå‰ã‚’ã¤ã‘ã¦ãã ã•ã„ï¼ˆç©ºã§ã‚‚OKï¼‰", cur);
    if(n == null) return;
    const trimmed = String(n).trim().slice(0, 18);
    state.petName = trimmed;
    pushEvent("name", {name: state.petName});
    save();
    render();
  }

  ui.letterName.addEventListener("click", () => {
    setPetName();
    // ã¤ã‘ãŸã‚‰ãƒœã‚¿ãƒ³ã¯éš ã™
    if(state.petName) ui.letterName.style.display = "none";
  });

  function introLetterAvailable(){
    return state.stage === "egg" && state.accMs >= INTRO_LETTER_UNLOCK_MS;
  }

  // ãƒœã‚¿ãƒ³ï¼šç¾½åŒ–å‰ã®30ç§’ä»¥é™ã«èª­ã‚ã‚‹
  ui.btnLetter.addEventListener("click", () => {
    if(!introLetterAvailable()) return;
    if(!state.introLetterRead){
      state.introLetterRead = true;
      pushEvent("letter_intro_read", {});
      save();
    }
    openLetter(LETTERS.introTitle, LETTERS.intro, "intro");
  });

  // 1æ—¥ã”ã¨ã®ãŠæ‰‹ç´™ï¼ˆè‡ªå‹•ã§é–‹ãï¼‰
  function maybeShowDailyLetter(){
    if(state.stage !== "alive") return;
    const di = dayIndex(); // 0,1,2
    if(state.letterShown[di]) return;

    state.letterShown[di] = true;
    pushEvent("letter_day", {day: di+1});
    save();

    if(di === 0) openLetter(LETTERS.day1Title, LETTERS.day1, "day1");
    if(di === 1) openLetter(LETTERS.day2Title, LETTERS.day2, "day2");
    if(di === 2) openLetter(LETTERS.day3Title, LETTERS.day3, "day3");
  }

  // è¡Œå‹•ã®å¯å¦
  function canInteract(){
    if(state.stage === "egg") return false;
    if(state.stage === "dead") return false;
    if(state.stage === "ended") return false;
    if(state.sitterOn) return false;
    return true;
  }

  // ã”ã¯ã‚“
  function doFood(){
    if(!canInteract()) return;
    modalOnPick = (idx, c) => {
      if(idx === 0){
        state.hunger = Math.max(0, state.hunger - 25);
        state.poop   = Math.min(100, state.poop + 6);
        state.health = Math.min(100, state.health + 6);
        addHeart(0);
      }else{
        state.hunger = Math.max(0, state.hunger - 45);
        state.poop   = Math.min(100, state.poop + 14);
        state.health = Math.min(100, state.health + 10);
        addHeart(1);
      }
      state.day[dayIndex()].food.push(c.label);
      pushEvent("food", {choice: c.label});
      closeModal(); save(); render();
    };
    openModal("ã”ã¯ã‚“",
      [{label:"è»½ã„é£Ÿäº‹", sub:"ã™ãçµ‚ã‚ã‚‹"},{label:"ã—ã£ã‹ã‚Šã—ãŸé£Ÿäº‹", sub:"ã¡ã‚‡ã£ã¨é‡ã„"}],
      "ã©ã¡ã‚‰ã‚‚æ­£è§£ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
    );
  }

  // ãŠã§ã‹ã‘
  function doOut(){
    if(!canInteract()) return;
    modalOnPick = (idx, c) => {
      if(idx === 0){
        state.hunger = Math.min(100, state.hunger + 10);
        state.poop   = Math.min(100, state.poop + 10);
        state.health = Math.min(100, state.health + 8);
        addHeart(1);
      }else{
        state.hunger = Math.min(100, state.hunger + 4);
        state.poop   = Math.min(100, state.poop + 3);
        state.health = Math.min(100, state.health + 4);
        addHeart(0);
      }
      state.day[dayIndex()].out.push(c.label);
      pushEvent("out", {choice: c.label});
      closeModal(); save(); render();
    };
    openModal("ãŠã§ã‹ã‘",
      [{label:"å¤–ã«å‡ºã‚‹", sub:"æ°—åˆ†ãŒå¤‰ã‚ã‚‹"},{label:"å®¶ã§éã”ã™", sub:"é™ã‹ã«éãã‚‹"}],
      "é¸ã‚“ã ç—•è·¡ã ã‘ãŒæ®‹ã‚Šã¾ã™ã€‚"
    );
  }

  // ã¤ã¾ã‚‰ãªã„2æŠãƒŸãƒ‹
  function doMini(){
    if(!canInteract()) return;
    const pool = [
      ["ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™","æŠ¼ã•ãªã„"],
      ["ç›®ã‚’é–‰ã˜ã‚‹","ç›®ã‚’é–‹ã‘ãŸã¾ã¾"],
      ["ä¸€æ­©é€²ã‚€","ãã®ã¾ã¾"],
      ["ä¸Šã‚’è¦‹ã‚‹","ä¸‹ã‚’è¦‹ã‚‹"],
      ["æ‹æ‰‹ã™ã‚‹","ç„¡è¨€ã§ã„ã‚‹"],
    ];
    const q = pool[Math.floor(Math.random()*pool.length)];

    modalOnPick = (idx, c) => {
      const r = (Math.random() < .55) ? 1 : 0;
      if(idx === 0){
        state.health = Math.min(100, state.health + (r?6:2));
        addHeart(r);
      }else{
        state.health = Math.min(100, state.health + (r?2:4));
        addHeart(r?0:1);
      }
      state.day[dayIndex()].mini.push(c.label);
      pushEvent("mini", {choice: c.label, q: q.join(" / ")});
      closeModal(); save(); render();
    };

    openModal("2æŠãƒŸãƒ‹",
      [{label:q[0], sub:"â€¦"},{label:q[1], sub:"â€¦"}],
      "çµ‚ã‚ã£ãŸã‚‰ã€ä½•ã‚‚æ®‹ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ä»¥å¤–ã¯ã€‚"
    );
  }

  // ğŸ’©ãã†ã˜ï¼ˆçŸ­ã„ã‚¿ãƒƒãƒ—ã‚²ãƒ¼ãƒ ï¼‰
  function doPoopGame(){
    if(!canInteract()) return;

    const before = state.poop;
    const mini = `
      <div class="hint">ğŸ’©ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ¶ˆã—ã¦ãã ã•ã„ï¼ˆ10ç§’ï¼‰ã€‚</div>
      <div class="poopGameRow" id="poopRow" style="margin-top:10px"></div>
      <div class="hint" id="poopTimer" style="margin-top:10px">æ®‹ã‚Š 10</div>
    `;

    modalOnPick = (idx, c) => {
      const mode = idx === 0 ? "quick" : "careful";
      closeModal();

      ui.modalTitle.textContent = "ãã†ã˜";
      ui.choiceRow.innerHTML = "";
      ui.modalHint.textContent = "ã‚¿ãƒƒãƒ—ã§ããŸæ•°ã ã‘ã€å°‘ã—ã ã‘æˆ»ã‚Šã¾ã™ã€‚";
      ui.miniArea.style.display = "block";
      ui.miniArea.innerHTML = mini;
      ui.modalBack.classList.add("open");
      ui.modalBack.setAttribute("aria-hidden","false");

      const row = document.getElementById("poopRow");
      const timerEl = document.getElementById("poopTimer");

      let hit = 0;
      let left = 10;

      const n = Math.max(3, Math.min(9, Math.floor(state.poop/12)));
      for(let i=0;i<n;i++){
        const t = document.createElement("div");
        t.className = "poopTarget";
        t.textContent = "ğŸ’©";
        t.addEventListener("click", () => {
          if(t.dataset.dead) return;
          t.dataset.dead = "1";
          t.textContent = "âœ¨";
          hit++;
        });
        row.appendChild(t);
      }

      const tick = setInterval(() => {
        left--;
        timerEl.textContent = `æ®‹ã‚Š ${left}`;
        if(left <= 0){
          clearInterval(tick);

          const base = mode === "quick" ? 6 : 8;
          const reduce = Math.min(60, base + hit * (mode==="quick"?3:2));

          state.poop = Math.max(0, state.poop - reduce);
          state.health = Math.min(100, state.health + 10);
          addHeart(1);

          state.day[dayIndex()].poop.push(c.label + `ï¼ˆhit:${hit}ï¼‰`);
          pushEvent("poop", {choice: c.label, hit, poopBefore: before, poopAfter: state.poop});

          closeModal(); save(); render();
        }
      }, 1000);
    };

    openModal("ãã†ã˜",
      [{label:"ã‚µãƒƒã¨æ‹­ã", sub:"é€Ÿã„"},{label:"ä¸å¯§ã«ã‚„ã‚‹", sub:"é…ã„"}],
      "æ”¾ç½®ã™ã‚‹ã¨ã€ã‚†ã£ãã‚Šæ‚ªåŒ–ã—ã¾ã™ã€‚"
    );
  }

  // ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆç”Ÿå­˜ä¸­ï¼‰
  function doDrink(){
    if(state.stage !== "alive") return;
    if(state.sitterOn) return;

    modalOnPick = (idx, c) => {
      if(idx === 0){
        state.accMs = Math.max(0, state.accMs - (2*60*60*1000));
        state.hunger = Math.max(0, state.hunger - 18);
        state.poop   = Math.max(0, state.poop - 10);
        state.health = Math.min(100, state.health + 4);
      }else{
        state.hunger = Math.max(0, state.hunger - 10);
        state.poop   = Math.max(0, state.poop - 8);
        state.health = Math.min(100, state.health + 8);
      }
      state.drinkUsed++;
      state.day[dayIndex()].drink++;
      pushEvent("drink", {choice:c.label});
      closeModal(); save(); render();
    };

    openModal("ãƒ‰ãƒªãƒ³ã‚¯",
      [{label:"å°‘ã—å·»ãæˆ»ã™", sub:"ã¡ã‚‡ã£ã¨ã ã‘"},{label:"å°‘ã—æ•´ãˆã‚‹", sub:"ã¡ã‚‡ã£ã¨ã ã‘"}],
      "ãƒãƒƒãƒ”ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
    );
  }

  // ãƒã‚«ãƒ­ãƒ³ï¼ˆæ­»å¾Œã®ã¿ï¼‰
  function doMacaron(){
    if(state.stage !== "dead") return;

    modalOnPick = (idx, c) => {
      if(idx === 1){
        pushEvent("macaron_skip", {});
        closeModal(); save(); render();
        return;
      }
      state.macaronUsed++;
      state.day[Math.min(2, dayIndex())].macaron++;

      state.stage = "revived";
      state.revivedUntilAccMs = state.accMs + (10 * 60 * 1000);
      state.health = Math.min(100, Math.max(state.health, 38));
      state.hunger = Math.min(100, state.hunger + 6);
      state.poop   = Math.min(100, state.poop + 8);

      pushEvent("macaron", {choice:"ä½¿ã†"});
      closeModal(); save(); render();
    };

    openModal("ãƒã‚«ãƒ­ãƒ³",
      [{label:"ä½¿ã†", sub:"æˆ»ã£ã¦ãã‚‹"},{label:"ä½¿ã‚ãªã„", sub:"æˆ»ã‚‰ãªã„"}],
      "æˆ»ã£ã¦ãã¦ã‚‚ã€å‰ã¨åŒã˜ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚"
    );
  }

  ui.actFood.addEventListener("click", doFood);
  ui.actOut.addEventListener("click", doOut);
  ui.actMini.addEventListener("click", doMini);
  ui.actPoop.addEventListener("click", doPoopGame);
  ui.actDrink.addEventListener("click", doDrink);
  ui.actMacaron.addEventListener("click", doMacaron);

  ui.toLogs.addEventListener("click", () => location.href = "./logs.html");
  ui.ending.addEventListener("click", () => location.href = "./logs.html");

  // ã‚·ãƒƒã‚¿ãƒ¼ï¼ˆæ™‚é–“ãƒ»ç©ºè…¹ãƒ»ğŸ’©ãƒ»å¯¿å‘½ã™ã¹ã¦åœæ­¢ï¼‰
  ui.sit.checked = !!state.sitterOn;
  ui.sit.addEventListener("change", () => {
    state.sitterOn = ui.sit.checked;
    pushEvent("sitter", {on: state.sitterOn});
    save();
    render();
  });

  // åˆæœŸã®ãƒãƒ¼ãƒˆå±¥æ­´
  if(state.heartHistory.length === 0){
    state.heartHistory.push({t: Date.now(), v: state.heart});
    ensureDayStart();
    save();
  }

  function setDisabledAll(dis){
    [ui.actFood, ui.actOut, ui.actMini, ui.actPoop, ui.actDrink, ui.actMacaron, ui.sit].forEach(b => b.disabled = !!dis);
  }

  function render(){
    // ä¸Šã®ä¸€è¨€
    const lines = [];
    if(state.sitterOn) lines.push("æ™‚é–“ã¯æ­¢ã¾ã£ã¦ã„ã¾ã™ã€‚");
    if(state.stage === "egg") lines.push("ãƒã‚«ãƒ­ãƒ³ãŒã€å°‘ã—ãšã¤è–„ããªã‚‹ã€‚");
    if(state.stage === "alive") lines.push("è¨€è‘‰ã¯å¢—ãˆãªã„ã€‚");
    if(state.stage === "revived") lines.push("æˆ»ã£ã¦ããŸã‘ã©ã€å°‘ã—é•ã†ã€‚");
    if(state.stage === "dead") lines.push("â€¦â€¦");
    ui.subLine.textContent = lines.join(" ");

    // ç¾½åŒ–å‰30ç§’ã§ã€ŒãŠæ‰‹ç´™ã€è§£ç¦
    const canReadIntro = introLetterAvailable();
    ui.btnLetter.style.display = (canReadIntro ? "" : "none");

    if(state.stage === "egg"){
      ui.bubble.textContent = canReadIntro
        ? "ãŠæ‰‹ç´™ãŒå±Šã„ã¦ã„ã‚‹ã€‚èª­ã‚“ã§ã‚‚ã„ã„ã€‚"
        : "ã©ã‚“ãªå­ã‹ãªï¼Ÿã¡ã‚‡ã£ã¨å¾…ã£ã¦ã­ã€‚";
    }else{
      ui.bubble.textContent = " ";
    }

    // ãƒã‚«ãƒ­ãƒ³æ¼”å‡ºï¼ˆã˜ã‚ã˜ã‚è–„ãï¼‰
    const p = Math.max(0, Math.min(1, state.accMs / INCUBATION_MS));
    ui.egg.classList.toggle("lift", p > 0.72);
    const fade = 1 - Math.max(0, (p - 0.25) / 0.75);
    ui.eggImg.style.opacity = String(Math.max(0, Math.min(1, fade)));
    ui.eggImg.style.filter = `drop-shadow(0 10px 18px rgba(0,0,0,.25)) blur(${(1-fade)*0.8}px)`;

    ui.egg.style.display = (state.stage === "egg") ? "grid" : "none";
    ui.petWrap.classList.toggle("hidePet", (state.stage === "egg"));
    if(state.stage !== "egg") ui.petWrap.classList.remove("hidePet");

    // åå‰è¡¨ç¤ºï¼ˆãªã‘ã‚Œã°ç©ºï¼‰
    ui.nameLine.textContent = state.petName ? `ãªã¾ãˆï¼š${state.petName}` : "";

    // ãƒœã‚¿ãƒ³æ´»æ€§
    const interact = canInteract();
    ui.actFood.disabled = !interact;
    ui.actOut.disabled  = !interact;
    ui.actMini.disabled = !interact;
    ui.actPoop.disabled = !interact;

    ui.actDrink.disabled   = !(state.stage === "alive" && !state.sitterOn);
    ui.actMacaron.disabled = !(state.stage === "dead");

    // ãƒãƒ¼ï¼ˆæ•°å€¤ã¯è¡¨ç¤ºã—ãªã„ï¼‰
    setBar(ui.hungerBar, 100 - state.hunger);
    setBar(ui.poopBar,   100 - state.poop);

    ui.hungerIcon.textContent = state.hunger < 35 ? "ğŸ™" : state.hunger < 70 ? "ğŸš" : "ğŸ½ï¸";
    ui.poopIcon.textContent   = state.poop < 35 ? "ğŸ§¼" : state.poop < 70 ? "ğŸ’©" : "ğŸ« ";

    renderPoops();
    renderHearts();
    applySpriteState();

    const h = [];
    if(state.stage === "dead") h.push("ãƒã‚«ãƒ­ãƒ³ã¯ã€ã„ã¾ã ã‘ã€‚");
    if(state.sitterOn) h.push("ã‚·ãƒƒã‚¿ãƒ¼ä¸­ã¯ä½•ã‚‚é€²ã¾ãªã„ã€‚");
    if(state.poop > 60) h.push("â€¦â€¦åŒ‚ã„ãŒã™ã‚‹ã€‚");
    if(state.stage === "egg" && !canReadIntro) h.push("30ç§’ãŸã£ãŸã‚‰ã€ãŠæ‰‹ç´™ãŒèª­ã‚ã‚‹ã€‚");
    ui.hintLine.textContent = h.join(" ");
  }

  // 1ç§’ã”ã¨
  function tick(){
    const now = Date.now();
    const dt = Math.max(0, now - (state.lastRealAt || now));
    state.lastRealAt = now;

    if(state.stage === "ended"){
      save();
      return;
    }

    // ã‚·ãƒƒã‚¿ãƒ¼ONãªã‚‰å…¨éƒ¨åœæ­¢
    if(state.sitterOn){
      state.sitterMs += dt;
      const di = dayIndex();
      state.day[di].sitterMs += dt;
      save(); render();
      return;
    }

    // ã‚­ãƒ£ãƒ©æ™‚é–“ã‚’é€²ã‚ã‚‹
    state.accMs += dt;

    // ç¾½åŒ–
    if(state.stage === "egg" && state.accMs >= INCUBATION_MS){
      state.stage = "alive";
      state.bornAccMs = state.accMs;
      pushEvent("born", {});
      ensureDayStart();
      save();
      render();
      // Day1ã®ãŠæ‰‹ç´™ã¯èª•ç”Ÿç›´å¾Œã«
      maybeShowDailyLetter();
      return;
    }

    const aliveLike = (state.stage === "alive" || state.stage === "revived");

    // ãƒ‹ãƒ¼ã‚ºé€²è¡Œ
    if(aliveLike){
      const hours = dt / (60*60*1000);
      state.hunger = Math.min(100, state.hunger + HUNGER_PER_HOUR * hours);
      state.poop   = Math.min(100, state.poop + POOP_PER_HOUR * hours);

      // ğŸ’©ã¨ç©ºè…¹ã§ã€ã˜ã‚ã˜ã‚è¡¨æƒ…ãŒå´©ã‚Œã‚‹ï¼ˆç†ç”±ã¯è¨€ã‚ãªã„ï¼‰
      const penalty = (state.hunger*0.12 + state.poop*0.16) * hours;
      state.health = Math.max(0, state.health - penalty);
    }

    // 1æ—¥ã”ã¨ã®ãŠæ‰‹ç´™
    if(state.stage === "alive") maybeShowDailyLetter();

    // å¾©æ´»æœŸé™
    if(state.stage === "revived" && state.revivedUntilAccMs != null){
      if(state.accMs >= state.revivedUntilAccMs){
        state.stage = "dead";
        state.revivedUntilAccMs = null;
        pushEvent("revive_end", {});
      }
    }

    // å¯¿å‘½ï¼ˆèª•ç”Ÿå¾Œ3æ—¥ï¼‰
    if(state.stage === "alive" && liveMs() >= LIFE_MS){
      state.stage = "ended";
      state.endedAt = new Date().toISOString();
      pushEvent("end", {});
    }

    // çµ‚äº†
    if(state.stage === "ended"){
      save(); render();
      ui.ending.classList.add("show");
      setDisabledAll(true);
      return;
    }

    // è‚²ã¦æ–¹ã§æ­»ã¬ï¼ˆã‚†ã‚‹ãï¼‰
    if(aliveLike && state.health <= 2){
      state.stage = "dead";
      pushEvent("dead", {});
    }

    save();
    render();
  }

  render();
  setInterval(tick, 1000);
})();
</script>
</body>
</html>
