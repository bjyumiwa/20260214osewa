<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3日間のお世話ゲーム（stage1）</title>
  <style>
    :root{
      --bg:#eef8ff;
      --card:rgba(255,255,255,.78);
      --card2:rgba(255,255,255,.62);
      --text:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.12);

      --btn:#2dd4bf;
      --btnText:#042f2e;

      --btn2:#60a5fa;
      --danger:#fb7185;

      --shadow: 0 16px 38px rgba(15,23,42,.12);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Yu Gothic", "Meiryo", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(45,212,191,.26), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 900px at 45% 110%, rgba(167,243,208,.30), transparent 55%),
        linear-gradient(180deg, #f6fdff, #eef8ff 35%, #f7fbff);
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{ max-width:980px; margin:0 auto; padding:18px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background: var(--card2);
      border:1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .dot{
      width:12px; height:12px; border-radius:999px;
      background: linear-gradient(135deg, rgba(45,212,191,.95), rgba(96,165,250,.90));
      box-shadow: 0 0 18px rgba(45,212,191,.28);
    }
    .title{ font-weight:800; letter-spacing:.02em; font-size:14px; color:rgba(15,23,42,.92); }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      border:1px solid var(--line);
      font-size:12px;
      color: rgba(15,23,42,.85);
      user-select:none;
    }
    .pill small{ color:var(--muted); }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1.2fr .8fr;
      margin-top:14px;
    }
    @media (max-width: 880px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card .inner{ padding:14px; }
    .card h2{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      color:rgba(15,23,42,.92);
      font-weight:800;
    }
    .card p{
      margin:10px 0 0 0;
      font-size:13px;
      line-height:1.75;
      color: rgba(15,23,42,.80);
    }
    .muted{ color:var(--muted); }
    .tiny{ font-size:12px; color: rgba(15,23,42,.70); line-height:1.6; }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{ border:0; background:none; color:inherit; font:inherit; cursor:pointer; }
    .btn{
      padding:10px 12px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(45,212,191,.95), rgba(45,212,191,.78));
      color: var(--btnText);
      font-weight:800;
      box-shadow: 0 12px 24px rgba(45,212,191,.14);
      border:1px solid rgba(15,23,42,.10);
      transition: transform .06s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:hover{ filter: brightness(1.02); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.secondary{
      background: rgba(255,255,255,.62);
      color: rgba(15,23,42,.86);
      box-shadow:none;
    }
    .btn.blue{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(96,165,250,.75));
      color: #031a35;
      box-shadow: 0 12px 24px rgba(96,165,250,.12);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(251,113,133,.92), rgba(251,113,133,.70));
      color: #3a0413;
      box-shadow: 0 12px 24px rgba(251,113,133,.12);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .stage{
      height: 310px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(260px 260px at 50% 60%, rgba(255,255,255,.78), rgba(255,255,255,0) 70%),
        radial-gradient(380px 300px at 50% 50%, rgba(45,212,191,.13), rgba(96,165,250,.10) 60%, rgba(255,255,255,0) 72%);
      border-bottom:1px solid var(--line);
      position:relative;
      overflow:hidden;
    }
    .charWrap{ position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .charImg{ width: 210px; height:auto; filter: drop-shadow(0 18px 32px rgba(15,23,42,.18)); user-select:none; -webkit-user-drag:none; }
    .floaty{ animation: floaty 3.2s ease-in-out infinite; }
    @keyframes floaty{ 0%,100%{ transform: translateY(0px);} 50%{ transform: translateY(-8px);} }

    .bigStart{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      font-size:15px;
    }

    .formBlock{ margin-top:12px; padding:12px; border:1px solid var(--line); background: rgba(255,255,255,.62); border-radius:16px; }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      color: rgba(15,23,42,.9);
      outline:none;
      font-size:13px;
    }

    .choiceGrid{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px; }
    .choice{
      text-align:left;
      width:100%;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.62);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .choice:hover{ background: rgba(255,255,255,.78); }
    .choice:active{ transform: translateY(1px) scale(.995); }
    .choice.selected{ border-color: rgba(45,212,191,.55); box-shadow: 0 10px 22px rgba(45,212,191,.10); }
    .choice img{ width:54px; height:auto; }
    .ctext{ flex:1; }
    .cname{ font-weight:800; font-size:13px; }
    .cdesc{ font-size:12px; color: rgba(15,23,42,.70); margin-top:2px; }

    .stepRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .stepChip{ display:flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.60); border:1px solid var(--line); font-size:12px; color: rgba(15,23,42,.78); }
    .stepChip .num{ width:18px; height:18px; border-radius:999px; display:flex; align-items:center; justify-content:center; background: rgba(45,212,191,.22); color: rgba(4,47,46,.92); font-weight:800; }

    .mapGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:12px; }
    @media (max-width: 520px){ .mapGrid{ grid-template-columns: repeat(3, 1fr);} }
    .tile{
      height:72px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.62);
      position:relative;
      overflow:hidden;
      font-weight:700;
      color: rgba(15,23,42,.70);
    }
    .tile span{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    .tile .foundImg{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:0; transform: scale(.98); transition: opacity .2s ease, transform .2s ease; }
    .tile.revealed .foundImg{ opacity:.95; transform: scale(1); }
    .tile.found{ border-color: rgba(96,165,250,.55); box-shadow: 0 10px 22px rgba(96,165,250,.10); }

    .hatchRow{ display:flex; gap:10px; align-items:center; margin-top:10px; }
    .hatchBar{ flex:1; height:10px; border-radius:999px; background: rgba(15,23,42,.08); border:1px solid var(--line); overflow:hidden; }
    .hatchFill{ height:100%; width:0%; border-radius:999px; background: linear-gradient(90deg, rgba(45,212,191,.85), rgba(96,165,250,.78)); transition: width .35s ease; }
    .hatchTime{ font-size:12px; color: rgba(15,23,42,.70); min-width: 86px; text-align:right; font-variant-numeric: tabular-nums; letter-spacing:.02em; }

    /* 到着画面：マカロン中心＋気配（選んだキャラ）が周囲をうろうろ */
    .arrivalStage{ width:100%; height:100%; position:relative; display:flex; align-items:center; justify-content:center; }
    .macaronBtn{ border:0; background:transparent; padding:0; cursor:pointer; }
    .macaronBtn:active{ transform: translateY(1px) scale(.995); }
    .macaronImg{ width: 230px; height:auto; filter: drop-shadow(0 18px 32px rgba(15,23,42,.18)); }
    .orbit{
      position:absolute;
      width: 360px;
      height: 260px;
      animation: orbit 5.6s linear infinite;
      pointer-events:none;
    }
    .orbit .ghost{
      width: 120px;
      opacity:.33;
      filter: blur(.2px) drop-shadow(0 12px 22px rgba(15,23,42,.08));
      transform: translate(10px, 24px);
      animation: ghostBob 2.6s ease-in-out infinite;
    }
    @keyframes orbit{ from{ transform: rotate(0deg);} to{ transform: rotate(360deg);} }
    @keyframes ghostBob{ 0%,100%{ transform: translate(10px, 24px);} 50%{ transform: translate(10px, 16px);} }

    .hearts{ display:flex; gap:6px; align-items:center; }
    .heart{ width:18px; height:18px; transform: rotate(45deg); background: rgba(251,113,133,.28); border-radius: 4px; position:relative; }
    .heart::before, .heart::after{ content:""; width:18px; height:18px; position:absolute; background: inherit; border-radius: 999px; }
    .heart::before{ left:-9px; top:0; }
    .heart::after{ left:0; top:-9px; }
    .heart.on{ background: rgba(251,113,133,.88); }

    .toggle{ width:42px; height:22px; border-radius:999px; background: rgba(15,23,42,.08); border:1px solid var(--line); position:relative; flex:0 0 auto; }
    .toggle::after{ content:""; width:18px; height:18px; border-radius:999px; position:absolute; top:1px; left:1px; background: rgba(15,23,42,.45); transition: left .18s ease, background .18s ease; }
    .toggle.on{ background: rgba(45,212,191,.22); border-color: rgba(45,212,191,.28); }
    .toggle.on::after{ left:21px; background: rgba(45,212,191,.92); }

    .linkBox{ display:flex; align-items:center; gap:10px; margin-top:12px; padding:10px; border:1px solid var(--line); background: rgba(255,255,255,.62); border-radius:16px; }
    .linkBox input{ flex:1; }

    .lifeRow{ margin-top:10px; padding:10px; border:1px solid var(--line); background: rgba(255,255,255,.62); border-radius:16px; }
    .lifeTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .lifeText{ font-size:12px; color: rgba(15,23,42,.76); font-variant-numeric: tabular-nums; }
    .lifeBar{ height:10px; border-radius:999px; background: rgba(15,23,42,.08); border:1px solid var(--line); overflow:hidden; margin-top:8px; }
    .lifeFill{ height:100%; width:0%; border-radius:999px; background: linear-gradient(90deg, rgba(96,165,250,.78), rgba(45,212,191,.75)); transition: width .35s ease; }

    .thanks{ height: 68vh; display:flex; align-items:center; justify-content:center; text-align:center; }
    .word{ font-size: 34px; letter-spacing: .18em; font-weight: 900; color: rgba(15,23,42,.86); }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .tab{ padding:8px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(255,255,255,.62); font-size:12px; font-weight:800; color: rgba(15,23,42,.78); }
    .tab.on{ border-color: rgba(45,212,191,.55); box-shadow: 0 10px 22px rgba(45,212,191,.10); }

    .logBox{ margin-top:10px; padding:12px; border-radius:16px; border:1px solid var(--line); background: rgba(255,255,255,.62); }
    .logLine{ font-size:12px; color: rgba(15,23,42,.78); line-height:1.7; padding:4px 0; border-bottom:1px dashed rgba(15,23,42,.12); }
    .logLine:last-child{ border-bottom:0; }

    .overlay{ position:fixed; inset:0; background: rgba(15,23,42,.22); display:none; align-items:center; justify-content:center; padding:18px; z-index:50; }
    .overlay.on{ display:flex; }
    .modal{ width:min(720px, 96vw); background: rgba(255,255,255,.92); border:1px solid rgba(15,23,42,.12); border-radius: 18px; box-shadow: 0 28px 64px rgba(15,23,42,.22); overflow:hidden; }
    .mhead{ padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid rgba(15,23,42,.10); }
    .mtitle{ font-weight:900; letter-spacing:.02em; }
    .mbody{ padding:14px; }
    .mnote{ font-size:13px; color: rgba(15,23,42,.80); line-height:1.75; }
    .mnote p{ margin:0 0 10px 0; }
    .mnote .small{ font-size:12px; color: rgba(15,23,42,.70); }

    .fade{ opacity:.92; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title" id="ui_title">3日間のお世話ゲーム</div>
          <div class="sub" id="subline">記録だけが残る</div>
        </div>
      </div>
      <div class="pill" id="modePill">
        <span id="modeLabel">プレイ</span>
        <small id="modeMeta">ローカル保存</small>
      </div>
    </div>

    <!-- 0: スタート -->
    <div class="screen active" id="scr_start">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_start">スタート</h2>
            <p class="fade" id="p_start">
              3日間だけ。<br>
              正解はない。評価もしない。<br>
              残るのは、選んだことの記録だけ。
            </p>
            <div class="btnrow">
              <button class="btn bigStart" id="btn_go_menu">スタート</button>
              <button class="btn secondary" id="btn_reset_all">最初から</button>
            </div>
            <p class="tiny" id="p_start_hint" style="margin-top:10px;">
              途中で閉じても、ローカルに記録が残ります。
            </p>
          </div>
        </div>
        <div class="card">
          <div class="stage">
            <div class="charWrap">
              <img id="startVisual" class="charImg floaty" alt="macaron" />
            </div>
          </div>
          <div class="inner">
            <h2 id="t_start_side">かけら</h2>
            <p class="muted" id="p_start_side">まだ、開けない。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 1: 準備（研究/言語/時間設定） -->
    <div class="screen" id="scr_menu">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_menu">準備</h2>
            <p class="fade" id="p_menu">
              まずは、いくつか決める。<br>
              そのあと「次へ」で始まります。
            </p>

            <div class="btnrow">
              <button class="btn secondary" id="btn_about">研究について</button>
              <button class="btn secondary" id="btn_lang">言語</button>
              <button class="btn" id="btn_menu_next">次へ</button>
            </div>

            <div class="formBlock">
              <div class="tiny" id="t_time_setting" style="margin-bottom:6px;">時間設定</div>

              <div class="tiny" id="t_life_setting" style="margin-top:6px;">3日間の長さ（テスト用に短くできます）</div>
              <select id="lifePreset" aria-label="life preset">
                <option value="real3d">リアル3日</option>
                <option value="12h">12時間</option>
                <option value="3h">3時間</option>
                <option value="30m">30分</option>
                <option value="10m">10分</option>
                <option value="3m">3分</option>
              </select>

              <div class="tiny" id="t_hatch_setting" style="margin-top:10px;">タネになるまで</div>
              <select id="hatchPreset" aria-label="hatch preset">
                <option value="3m">3分</option>
                <option value="60s">60秒</option>
                <option value="30s">30秒</option>
                <option value="12s">12秒（テスト）</option>
              </select>

              <p class="tiny" id="p_menu_lock" style="margin-top:10px; display:none;">進行中は、時間設定を変更できません。</p>
            </div>

            <p class="tiny" id="p_menu_note" style="margin-top:10px;">
              ここで変えるのは、あなたの端末の中の時間だけです。
            </p>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="charWrap">
              <img id="menuVisual" class="charImg floaty" alt="macaron" />
            </div>
          </div>
          <div class="inner">
            <h2 id="t_menu_side">言語</h2>
            <p class="muted" id="p_menu_side">日本語 / English / 中文</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 2: ユーザーの準備（名前とキャラ） -->
    <div class="screen" id="scr_profile">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_profile">あなたの準備</h2>

            <p class="fade" id="p_profile">
              呼ばれたい名前と、相棒を決める。
            </p>

            <div class="stepRow" aria-label="手順">
              <div class="stepChip"><span class="num">1</span><span id="s1">呼ばれたい名前</span></div>
              <div class="stepChip"><span class="num">2</span><span id="s2">自分のキャラ</span></div>
              <div class="stepChip"><span class="num">3</span><span id="s3">探しに行く</span></div>
            </div>

            <div class="formBlock">
              <div class="tiny" id="t_name" style="margin-bottom:6px;">呼ばれたい名前</div>
              <input id="playerName" placeholder="○○（例：ポー）" autocomplete="nickname">
              <p class="tiny" id="profileNeed" style="margin-top:8px;"></p>
            </div>

            <div class="btnrow" style="margin-top:12px;">
              <button class="btn secondary" id="btn_profile_back">戻る</button>
              <button class="btn" id="btn_profile_next" disabled>探しに行く</button>
              <button class="btn secondary" id="btn_profile_reset" title="保存を消します">最初から</button>
            </div>

            <p class="tiny" id="p_profile_note" style="margin-top:10px;">
              入力は、この端末の中だけに保存されます。
            </p>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="charWrap">
              <img id="charPreview" class="charImg floaty" alt="character preview" />
            </div>
          </div>
          <div class="inner">
            <h2 id="t_buddy">自分のキャラ</h2>
            <p class="muted" id="p_buddy">クリックして選ぶ。迷ったら、しばらく眺めてもいい。</p>
            <div class="choiceGrid" id="charChoices"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3: 探す -->
    <div class="screen" id="scr_search">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_search">探す</h2>
            <p id="p_search">
              地図が届いた。宝探しみたいに、印をたどる。
            </p>
            <p class="muted" id="p_search2">どこかに、マカロンの形をしたものがある。見つけたら持ち帰る。</p>
            <div class="mapGrid" id="mapGrid"></div>
            <div class="btnrow">
              <button class="btn secondary" id="btn_back_profile">設定へ戻る</button>
              <button class="btn" id="btn_hint">少しだけ目を慣らす</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="inner">
            <h2 id="t_presence">気配</h2>
            <p class="muted" id="searchNote">まだ、何も見つからない。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 4: 到着（マカロン＋誕生待ち。触れると早まる） -->
    <div class="screen" id="scr_arrival">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_arrival">到着</h2>
            <p id="arrivalText">
              地図の印の場所で、マカロンを見つけた。<br>
              持ち帰ると、しばらくしてふわりと浮かび上がるらしい。
            </p>

            <p class="muted" id="arrivalThanks">見つけてくれてありがとう。3分後に、お楽しみに。</p>
            <div class="hatchRow" aria-label="誕生までの待ち時間">
              <div class="hatchBar"><div class="hatchFill" id="hatchFill"></div></div>
              <div class="hatchTime" id="hatchTime">あと 3:00</div>
            </div>

            <p class="tiny" id="arrivalTouchHint" style="margin-top:10px;">マカロンに触れると、いま開く。</p>

            <div class="btnrow">
              <button class="btn secondary" id="btn_back_search">もう一度探す</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="arrivalStage">
              <div class="orbit" aria-hidden="true">
                <img id="orbitChar" class="ghost" alt="ghost" />
              </div>
              <button class="macaronBtn" id="btn_touch_macaron" aria-label="touch macaron">
                <img id="arrivalMacaron" class="macaronImg floaty" alt="macaron" />
              </button>
            </div>
          </div>
          <div class="inner">
            <h2 id="t_watch">見守り</h2>
            <p class="muted" id="p_watch">近くで、気配がうろうろしている。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 5: お世話 -->
    <div class="screen" id="scr_care">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <h2 id="careTitle">いま</h2>
              <div class="hearts" title="関係の雰囲気">
                <div class="heart" id="h1"></div>
                <div class="heart" id="h2"></div>
                <div class="heart" id="h3"></div>
                <div class="heart" id="h4"></div>
                <div class="heart" id="h5"></div>
              </div>
            </div>

            <p class="muted" id="careHint">言葉ではわからない。表情と動きだけが変わる。</p>

            <div class="lifeRow" id="lifeRow">
              <div class="lifeTop">
                <div class="lifeText" id="lifeText">Day 1/3</div>
                <div class="lifeText" id="lifeRemain">残り 2日</div>
              </div>
              <div class="lifeBar"><div class="lifeFill" id="lifeFill"></div></div>
            </div>

            <div class="btnrow" style="margin-top:10px;">
              <button class="btn" id="btn_food">食事</button>
              <button class="btn" id="btn_outing">お出かけ</button>
              <button class="btn" id="btn_mini">2択ミニゲーム</button>
              <button class="btn" id="btn_clean">排泄除去</button>
              <button class="btn blue" id="btn_drink">ドリンク</button>
              <button class="btn danger" id="btn_macaron">マカロン</button>
              <button class="btn secondary" id="btn_logs">ログ</button>
            </div>

            <div class="linkBox" style="margin-top:12px;">
              <div class="tiny" id="t_sitter">シッター</div>
              <div style="display:flex; align-items:center; gap:10px; flex:1;">
                <div class="toggle" id="toggle_sitter" role="switch" aria-checked="false" tabindex="0"></div>
                <div class="tiny" id="sitterNote">時間は止まる</div>
              </div>
            </div>

            <div class="linkBox" id="shareBox" style="display:none;">
              <div class="tiny" id="t_share">共有URL（観察用）</div>
              <input id="shareUrl" readonly>
              <button class="btn secondary" id="btn_copy_share">コピー</button>
            </div>

            <p class="tiny" id="endNote" style="margin-top:10px; display:none;">ここから先は、操作できない。記録だけが残る。</p>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="charWrap" id="charWrap">
              <img id="charImg" class="charImg" alt="character" />
            </div>
          </div>
          <div class="inner">
            <h2 id="t_state">きょう</h2>
            <p class="muted" id="stateHint">何かが変わる。理由は表示されない。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 6: エンディング -->
    <div class="screen" id="scr_end">
      <div class="card">
        <div class="thanks">
          <div>
            <div class="word fade">ありがとう</div>
            <div class="btnrow" style="justify-content:center; margin-top:16px;">
              <button class="btn secondary" id="btn_end_logs">ログを見る</button>
              <button class="btn secondary" id="btn_end_share">共有URL</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 7: ログ -->
    <div class="screen" id="scr_logs">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_logs">ログ</h2>
            <p class="muted" id="p_logs">評価はしない。起きたことだけ。</p>

            <canvas id="heartChart" width="640" height="180" style="margin-top:10px; border:1px solid var(--line); border-radius:16px; background: rgba(255,255,255,.70);"></canvas>

            <div class="tabs" id="dayTabs"></div>
            <div class="logBox" id="logBox"></div>

            <div class="btnrow">
              <button class="btn secondary" id="btn_back_care">戻る</button>
              <button class="btn secondary" id="btn_logs_share">共有URL</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <h2 id="t_share2">共有</h2>
            <p class="muted" id="p_share2">このURLを開いた人は、ログとハート推移だけを見られます。操作はできません。</p>
            <div class="linkBox" style="margin-top:12px;">
              <input id="shareUrl2" readonly>
              <button class="btn secondary" id="btn_copy_share2">コピー</button>
            </div>
            <p class="tiny" id="p_share3">URLには観察用の情報が入ります。公開範囲に注意してください。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 8: 観察用 -->
    <div class="screen" id="scr_observe">
      <div class="grid">
        <div class="card">
          <div class="inner">
            <h2 id="t_observe">観察用ログ</h2>
            <p class="muted" id="p_observe">ここでは操作できません。ログとハート推移のみ。</p>
            <canvas id="heartChartObs" width="640" height="180" style="margin-top:10px; border:1px solid var(--line); border-radius:16px; background: rgba(255,255,255,.70);"></canvas>

            <div class="tabs" id="dayTabsObs"></div>
            <div class="logBox" id="logBoxObs"></div>

            <div class="btnrow">
              <button class="btn secondary" id="btn_obs_back">閉じる</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="stage">
            <div class="charWrap">
              <img id="charImgObs" class="charImg floaty" alt="character" />
            </div>
          </div>
          <div class="inner">
            <h2 id="t_observe_side">観察</h2>
            <p class="muted" id="p_observe_side">操作はできない。</p>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="mhead">
        <div class="mtitle" id="modalTitle">お知らせ</div>
        <button class="btn secondary" id="btn_close_modal">閉じる</button>
      </div>
      <div class="mbody" id="modalBody">
        <div class="mnote" id="modalNote"></div>
        <div class="btnrow" id="modalBtns" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const APP_KEY = "care3days_save_stage1_v3";

  const ASSETS = {
    // すべて stage1 フォルダに入っている前提
    char: {
      green: { closed: "stage1/green_closed.png", open: "stage1/green_open.png" },
      blue:  { closed: "stage1/blue_closed.png",  open: "stage1/blue_open.png"  },
      pink:  { closed: "stage1/pink_closed.png",  open: "stage1/pink_open.png"  },
      purple:{ closed: "stage1/purple_closed.png",open: "stage1/purple_open.png" }
    },
    macaron: {
      green: "stage1/macaron_green.png",
      blue:  "stage1/macaron_blue.png",
      pink:  "stage1/macaron_pink.png",
      purple:"stage1/macaron_purple.png"
    }
  };

  const url = new URL(location.href);
  const FAST = url.searchParams.get("fast") === "1";
  const isObserveMode = !!url.searchParams.get("observe") && !!url.searchParams.get("data");

  const $ = (id) => document.getElementById(id);
  const screens = {
    start: $("scr_start"),
    menu: $("scr_menu"),
    profile: $("scr_profile"),
    search: $("scr_search"),
    arrival: $("scr_arrival"),
    care: $("scr_care"),
    end: $("scr_end"),
    logs: $("scr_logs"),
    observe: $("scr_observe")
  };

  const modeLabel = $("modeLabel");
  const modeMeta = $("modeMeta");
  const subline = $("subline");

  const overlay = $("overlay");
  const modalTitle = $("modalTitle");
  const modalNote = $("modalNote");
  const modalBtns = $("modalBtns");

  let save = null;
  let tickTimer = null;

  // 翻訳（最低限の範囲。足りないところは後で足せます）
  const I18N = {
    ja: {
      startTitle: "スタート",
      startBtn: "スタート",
      reset: "最初から",
      menuTitle: "準備",
      about: "研究について",
      language: "言語",
      next: "次へ",
      back: "戻る",
      goSearch: "探しに行く",
      profileTitle: "あなたの準備",
      nameLabel: "呼ばれたい名前",
      buddyLabel: "自分のキャラ",
      searchTitle: "探す",
      arrivalTitle: "到着",
      touchHint: "マカロンに触れると、いま開く。",
      careNow: "いま",
      sitter: "シッター",
      share: "共有URL（観察用）",
      logs: "ログ",
      thanks: "ありがとう",
      close: "閉じる",
      timeSetting: "時間設定",
      lifeSetting: "3日間の長さ（テスト用に短くできます）",
      hatchSetting: "タネになるまで",
      lifeLocked: "進行中は、時間設定を変更できません。",
      remain: "残り",
      day: "Day",
      observe: "観察",
      observeOnly: "操作不可",
      play: "プレイ",
      local: "ローカル保存",

      aboutTitle: "研究に協力のお願い",
      aboutTabs: { ja:"日本語", en:"English", zh:"中文" },
      aboutText: {
        ja: "このゲームは研究目的で制作されています。\n\n記録されるのは、選択の回数、選んだ内容、ハートの推移、シッターの使用時間、アイテム使用の有無などです。これらは基本的にあなたの端末内（localStorage）に保存されます。\n\n共有URLを発行すると、第三者は『観察用ログ画面』で、ログとハート推移のみを閲覧できます。\n\n個人を特定できる情報は入力しないでください。途中でいつでもやめられます。",
        en: "This game is created for research purposes.\n\nIt records only in-game traces such as choices, counts, heart changes, sitter usage time, and item usage. These records are stored locally in your device (localStorage).\n\nIf you share the generated URL, others can view only the observation log and the heart trend. They cannot operate the game.\n\nPlease do not enter personally identifying information. You may stop at any time.",
        zh: "本游戏用于研究目的。\n\n记录内容仅包括游戏内的选择、次数、爱心变化、保姆功能使用时间、道具使用等痕迹，并保存在你的设备本地（localStorage）。\n\n如果你分享生成的链接，第三方只能查看观察日志与爱心变化，无法进行任何操作。\n\n请不要输入可识别个人身份的信息。你可以随时停止。"
      }
    },
    en: {
      startTitle: "Start",
      startBtn: "Start",
      reset: "Reset",
      menuTitle: "Setup",
      about: "About the study",
      language: "Language",
      next: "Next",
      back: "Back",
      goSearch: "Go search",
      profileTitle: "Your setup",
      nameLabel: "Name you want",
      buddyLabel: "Your character",
      searchTitle: "Search",
      arrivalTitle: "Arrival",
      touchHint: "Touch the macaron to open it now.",
      careNow: "Now",
      sitter: "Sitter",
      share: "Share URL (observe)",
      logs: "Log",
      thanks: "Thank you",
      close: "Close",
      timeSetting: "Time settings",
      lifeSetting: "Length of the 3 days (you can shorten for testing)",
      hatchSetting: "Time to hatch",
      lifeLocked: "You can't change time settings while playing.",
      remain: "Remaining",
      day: "Day",
      observe: "Observe",
      observeOnly: "Read-only",
      play: "Play",
      local: "Local save",

      aboutTitle: "Request for research cooperation",
      aboutTabs: { ja:"日本語", en:"English", zh:"中文" },
      aboutText: { // 英語UIでも3言語出す
        ja: "このゲームは研究目的で制作されています。\n\n記録されるのは、選択の回数、選んだ内容、ハートの推移、シッターの使用時間、アイテム使用の有無などです。これらは基本的にあなたの端末内（localStorage）に保存されます。\n\n共有URLを発行すると、第三者は『観察用ログ画面』で、ログとハート推移のみを閲覧できます。\n\n個人を特定できる情報は入力しないでください。途中でいつでもやめられます。",
        en: "This game is created for research purposes.\n\nIt records only in-game traces such as choices, counts, heart changes, sitter usage time, and item usage. These records are stored locally in your device (localStorage).\n\nIf you share the generated URL, others can view only the observation log and the heart trend. They cannot operate the game.\n\nPlease do not enter personally identifying information. You may stop at any time.",
        zh: "本游戏用于研究目的。\n\n记录内容仅包括游戏内的选择、次数、爱心变化、保姆功能使用时间、道具使用等痕迹，并保存在你的设备本地（localStorage）。\n\n如果你分享生成的链接，第三方只能查看观察日志与爱心变化，无法进行任何操作。\n\n请不要输入可识别个人身份的信息。你可以随时停止。"
      }
    },
    zh: {
      startTitle: "开始",
      startBtn: "开始",
      reset: "重置",
      menuTitle: "准备",
      about: "关于研究",
      language: "语言",
      next: "下一步",
      back: "返回",
      goSearch: "去寻找",
      profileTitle: "你的准备",
      nameLabel: "希望被称呼的名字",
      buddyLabel: "你的角色",
      searchTitle: "寻找",
      arrivalTitle: "到达",
      touchHint: "触碰马卡龙即可立刻打开。",
      careNow: "现在",
      sitter: "保姆",
      share: "分享链接（观察）",
      logs: "记录",
      thanks: "谢谢",
      close: "关闭",
      timeSetting: "时间设置",
      lifeSetting: "3天的长度（可用于测试缩短）",
      hatchSetting: "孵化时间",
      lifeLocked: "游戏进行中无法更改时间设置。",
      remain: "剩余",
      day: "Day",
      observe: "观察",
      observeOnly: "只读",
      play: "游玩",
      local: "本地保存",

      aboutTitle: "研究协助说明",
      aboutTabs: { ja:"日本語", en:"English", zh:"中文" },
      aboutText: {
        ja: "このゲームは研究目的で制作されています。\n\n記録されるのは、選択の回数、選んだ内容、ハートの推移、シッターの使用時間、アイテム使用の有無などです。これらは基本的にあなたの端末内（localStorage）に保存されます。\n\n共有URLを発行すると、第三者は『観察用ログ画面』で、ログとハート推移のみを閲覧できます。\n\n個人を特定できる情報は入力しないでください。途中でいつでもやめられます。",
        en: "This game is created for research purposes.\n\nIt records only in-game traces such as choices, counts, heart changes, sitter usage time, and item usage. These records are stored locally in your device (localStorage).\n\nIf you share the generated URL, others can view only the observation log and the heart trend. They cannot operate the game.\n\nPlease do not enter personally identifying information. You may stop at any time.",
        zh: "本游戏用于研究目的。\n\n记录内容仅包括游戏内的选择、次数、爱心变化、保姆功能使用时间、道具使用等痕迹，并保存在你的设备本地（localStorage）。\n\n如果你分享生成的链接，第三方只能查看观察日志与爱心变化，无法进行任何操作。\n\n请不要输入可识别个人身份的信息。你可以随时停止。"
      }
    }
  };

  function t(key){
    const lang = (save && save.settings && save.settings.lang) ? save.settings.lang : "ja";
    const dict = I18N[lang] || I18N.ja;
    return dict[key] ?? (I18N.ja[key] ?? key);
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function rnd(a,b){ return a + Math.random()*(b-a); }
  function nowMs(){ return Date.now(); }

  function showScreen(name){
    Object.values(screens).filter(Boolean).forEach(el => el.classList.remove("active"));
    (screens[name] || null) && screens[name].classList.add("active");
  }

  function safeJSONParse(str, fallback){
    try{ return JSON.parse(str); }catch(e){ return fallback; }
  }

  function genId(){
    return "p" + Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
  }

  function emptyDay(d){
    return {
      day: d,
      heartStart: null,
      heartEnd: null,
      sitterMs: 0,
      careCounts: { food:0, outing:0, mini:0, clean:0, drink:0, macaron:0 },
      choices: { food:[], outing:[], mini:[], clean:[] }
    };
  }

  function defaultLifeMsFromPreset(p){
    const DAY = 24*60*60*1000;
    if(p === "real3d") return 3*DAY;
    if(p === "12h") return 12*60*60*1000;
    if(p === "3h") return 3*60*60*1000;
    if(p === "30m") return 30*60*1000;
    if(p === "10m") return 10*60*1000;
    if(p === "3m") return 3*60*1000;
    return 3*DAY;
  }

  function defaultHatchMsFromPreset(p){
    if(p === "3m") return 3*60*1000;
    if(p === "60s") return 60*1000;
    if(p === "30s") return 30*1000;
    if(p === "12s") return 12*1000;
    return 3*60*1000;
  }

  function newSave(){
    const id = genId();
    const t0 = nowMs();

    // fast=1 の時はデフォルトを短縮（ただし、後からメニューで変更可能）
    const lifeMs = FAST ? 90*1000 : defaultLifeMsFromPreset("real3d");
    const hatchMs = FAST ? 12*1000 : defaultHatchMsFromPreset("3m");

    return {
      v: 3,
      id,
      startedAt: t0,
      playerName: "",
      flow: { screen: "start" },
      settings: {
        lang: "ja",
        lifePreset: FAST ? "3m" : "real3d",
        lifeMs,
        hatchPreset: FAST ? "12s" : "3m",
        hatchMs
      },
      story: {
        chosenColor: null,
        foundAt: null,
        arrivalAt: null,
        hatchAt: null,
        hatched: false,
        hatchedByTouch: false,
        _targetTile: null,
        _revealed: []
      },
      life: {
        bornAt: null,
        deathAt: null,
        endedAt: null,
        isEnded: false,
        revivedUntil: null,
        uncanny: false,
        _handledEnd: false
      },
      stats: {
        hunger: 30,
        waste: 20,
        mood: 70,
        hearts: 55
      },
      sitter: {
        on: false,
        onSince: null,
        pausedTotal: 0,
        usedTotal: 0
      },
      items: {
        drink: 2,
        macaron: 1
      },
      logs: {
        day: { "1": emptyDay(1), "2": emptyDay(2), "3": emptyDay(3) },
        events: []
      },
      _lastEff: t0,
      _prevDay: 0
    };
  }

  function loadSave(){
    const raw = localStorage.getItem(APP_KEY);
    if(raw){
      const parsed = safeJSONParse(raw, null);
      if(parsed && parsed.v === 3) return parsed;
    }
    return newSave();
  }

  function saveNow(){ localStorage.setItem(APP_KEY, JSON.stringify(save)); }
  function resetAll(){ localStorage.removeItem(APP_KEY); save = newSave(); saveNow(); }

  // シッター中は時間が停止する（内部時間だけ止める）
  function effectiveNow(s){
    if(!s) return nowMs();
    const baseNow = nowMs();
    const pauseExtra = s.sitter.on ? (baseNow - s.sitter.onSince) : 0;
    return baseNow - s.sitter.pausedTotal - pauseExtra;
  }

  function getDayMs(){
    const lifeMs = (save && save.settings && save.settings.lifeMs) ? save.settings.lifeMs : (3*24*60*60*1000);
    return Math.max(1000, Math.floor(lifeMs / 3));
  }

  function dayIndex(s){
    if(!s || !s.life.bornAt) return 0;
    const t = effectiveNow(s) - s.life.bornAt;
    const dayMs = getDayMs();
    const d = Math.floor(t / dayMs) + 1;
    return clamp(d, 1, 3);
  }

  function prettyColor(c){
    if(c==="green") return "みどり";
    if(c==="blue") return "あお";
    if(c==="pink") return "もも";
    if(c==="purple") return "むらさき";
    return c;
  }

  function setModePill(){
    if(isObserveMode){
      modeLabel.textContent = t("observe");
      modeMeta.textContent = t("observeOnly");
      subline.textContent = "ログとハート推移のみ";
    }else{
      modeLabel.textContent = t("play");
      modeMeta.textContent = t("local");
      subline.textContent = "記録だけが残る";
    }
  }

    function applyI18nStatic(){
    const lang = (save && save.settings && save.settings.lang) ? save.settings.lang : "ja";

    const UI = {
      ja: {
        p_start: "3日間だけ。<br>正解はない。評価もしない。<br>残るのは、選んだことの記録だけ。",
        p_start_hint: "途中で閉じても、ローカルに記録が残ります。",
        t_start_side: "かけら",
        p_start_side: "まだ、開けない。",

        p_menu: "まずは、いくつか決める。<br>そのあと『次へ』で始まります。",
        p_menu_note: "ここで変えるのは、あなたの端末の中の時間だけです。",
        t_menu_side: "言語",
        p_menu_side: "日本語 / English / 中文",

        p_profile: "呼ばれたい名前と、相棒を決める。",
        p_profile_note: "入力は、この端末の中だけに保存されます。",
        p_buddy: "クリックして選ぶ。迷ったら、しばらく眺めてもいい。",

        p_search: "地図が届いた。宝探しみたいに、印をたどる。",
        p_search2: "どこかに、マカロンの形をしたものがある。見つけたら持ち帰る。",
        t_presence: "気配",
        searchNote: "まだ、何も見つからない。",
        btn_hint: "少しだけ目を慣らす",
        btn_back_profile: "設定へ戻る",

        arrivalText: "地図の印の場所で、マカロンを見つけた。<br>持ち帰ると、しばらくしてふわりと浮かび上がるらしい。",
        arrivalThanks: "見つけてくれてありがとう。3分後に、お楽しみに。",
        btn_back_search: "もう一度探す",
        t_watch: "見守り",
        p_watch: "近くで、気配がうろうろしている。",

        careHint: "言葉ではわからない。表情と動きだけが変わる。",
        stateHint: "何かが変わる。理由は表示されない。",

        btn_food: "食事",
        btn_outing: "お出かけ",
        btn_mini: "2択ミニゲーム",
        btn_clean: "排泄除去",
        btn_drink: "ドリンク",
        btn_macaron: "マカロン",
        btn_logs: "ログ",
        sitterOff: "時間は止まる",
        sitterOn: "時間が止まっている",

        t_logs: "ログ",
        p_logs: "評価はしない。起きたことだけ。",
        btn_back_care: "戻る",
        t_share2: "共有",
        p_share2: "このURLを開いた人は、ログとハート推移だけを見られます。操作はできません。",
        btn_copy: "コピー",
        btn_share_url: "共有URL",

        t_observe: "観察用ログ",
        p_observe: "ここでは操作できません。ログとハート推移のみ。",
        btn_obs_back: "閉じる",
        t_observe_side: "観察",
        p_observe_side: "操作はできない。"
      },
      en: {
        p_start: "Only 3 days.<br>No right answer. No grading.<br>Only the trace of your choices remains.",
        p_start_hint: "Even if you close it, the record stays on this device.",
        t_start_side: "Fragment",
        p_start_side: "Not yet.",

        p_menu: "Decide a few things first.<br>Then press Next to begin.",
        p_menu_note: "These settings affect only time inside this device.",
        t_menu_side: "Language",
        p_menu_side: "日本語 / English / 中文",

        p_profile: "Choose a name and your buddy.",
        p_profile_note: "Your input is saved only on this device.",
        p_buddy: "Click to choose. If unsure, you can just watch for a moment.",

        p_search: "A map arrived. Like a treasure hunt, follow the marks.",
        p_search2: "Somewhere, there is something shaped like a macaron. If you find it, bring it back.",
        t_presence: "Presence",
        searchNote: "Nothing found yet.",
        btn_hint: "Let your eyes adjust",
        btn_back_profile: "Back to setup",

        arrivalText: "You found a macaron at the mark on the map.<br>When you bring it back, it will float up after a while.",
        arrivalThanks: "Thank you for finding it. Please wait.",
        btn_back_search: "Search again",
        t_watch: "Watching",
        p_watch: "A presence is wandering nearby.",

        careHint: "No words. Only expressions and movement change.",
        stateHint: "Something changes. The reason is not shown.",

        btn_food: "Meal",
        btn_outing: "Outing",
        btn_mini: "Two-choice mini",
        btn_clean: "Clean",
        btn_drink: "Drink",
        btn_macaron: "Macaron",
        btn_logs: "Log",
        sitterOff: "Time can stop",
        sitterOn: "Time is stopped",

        t_logs: "Log",
        p_logs: "No grading. Just what happened.",
        btn_back_care: "Back",
        t_share2: "Share",
        p_share2: "People opening this URL can view only the log and heart trend. They cannot operate the game.",
        btn_copy: "Copy",
        btn_share_url: "Share URL",

        t_observe: "Observation log",
        p_observe: "Read-only. Log and heart trend only.",
        btn_obs_back: "Close",
        t_observe_side: "Observe",
        p_observe_side: "No operation."
      },
      zh: {
        p_start: "只有3天。<br>没有正确答案，也不会被评价。<br>留下的只有你做过的选择记录。",
        p_start_hint: "即使关闭，记录也会保存在本设备中。",
        t_start_side: "碎片",
        p_start_side: "还不能打开。",

        p_menu: "先决定一些事项。<br>然后点击“下一步”开始。",
        p_menu_note: "这些设置只影响你设备里的时间。",
        t_menu_side: "语言",
        p_menu_side: "日本語 / English / 中文",

        p_profile: "选择名字和你的伙伴。",
        p_profile_note: "输入内容仅保存在本设备中。",
        p_buddy: "点击选择。若犹豫，可以先看一会儿。",

        p_search: "地图到了。像寻宝一样，沿着标记前进。",
        p_search2: "某处有马卡龙形状的东西。找到后把它带回来。",
        t_presence: "气配",
        searchNote: "还没有找到。",
        btn_hint: "让眼睛适应一下",
        btn_back_profile: "返回设置",

        arrivalText: "你在地图标记处找到了马卡龙。<br>带回去后，过一会儿它会轻轻浮起。",
        arrivalThanks: "谢谢你找到了它。请稍等。",
        btn_back_search: "再找一次",
        t_watch: "守望",
        p_watch: "附近有某种气配在徘徊。",

        careHint: "没有文字。只有表情和动作会变化。",
        stateHint: "会发生变化，但不会显示原因。",

        btn_food: "喂食",
        btn_outing: "外出",
        btn_mini: "二选小游戏",
        btn_clean: "清理",
        btn_drink: "饮料",
        btn_macaron: "马卡龙",
        btn_logs: "记录",
        sitterOff: "时间可以暂停",
        sitterOn: "时间已暂停",

        t_logs: "记录",
        p_logs: "不评价，只记录发生的事。",
        btn_back_care: "返回",
        t_share2: "分享",
        p_share2: "打开此链接的人只能查看记录与爱心变化，无法进行任何操作。",
        btn_copy: "复制",
        btn_share_url: "分享链接",

        t_observe: "观察记录",
        p_observe: "只读：仅显示记录与爱心变化。",
        btn_obs_back: "关闭",
        t_observe_side: "观察",
        p_observe_side: "无法操作。"
      }
    };

    const u = UI[lang] || UI.ja;

    // 基本ラベル
    $("t_start").textContent = t("startTitle");
    $("btn_go_menu").textContent = t("startBtn");
    $("btn_reset_all").textContent = t("reset");

    $("t_menu").textContent = t("menuTitle");
    $("btn_about").textContent = t("about");
    $("btn_lang").textContent = t("language");
    $("btn_menu_next").textContent = t("next");
    $("t_time_setting").textContent = t("timeSetting");
    $("t_life_setting").textContent = t("lifeSetting");
    $("t_hatch_setting").textContent = t("hatchSetting");

    $("t_profile").textContent = t("profileTitle");
    $("t_name").textContent = t("nameLabel");
    $("t_buddy").textContent = t("buddyLabel");
    $("btn_profile_back").textContent = t("back");
    $("btn_profile_next").textContent = t("goSearch");
    $("btn_profile_reset").textContent = t("reset");

    $("t_search").textContent = t("searchTitle");

    $("t_arrival").textContent = t("arrivalTitle");
    $("arrivalTouchHint").textContent = t("touchHint");

    $("careTitle").textContent = t("careNow");
    $("t_sitter").textContent = t("sitter");
    $("t_share").textContent = t("share");

    $("btn_end_logs").textContent = t("logs");
    $("btn_end_share").textContent = t("share");
    $("btn_close_modal").textContent = t("close");

    // 文章・補助ラベル
    $("p_start").innerHTML = u.p_start;
    $("p_start_hint").textContent = u.p_start_hint;
    $("t_start_side").textContent = u.t_start_side;
    $("p_start_side").textContent = u.p_start_side;

    $("p_menu").innerHTML = u.p_menu;
    $("p_menu_note").textContent = u.p_menu_note;
    $("t_menu_side").textContent = u.t_menu_side;
    $("p_menu_side").textContent = u.p_menu_side;

    $("p_profile").textContent = u.p_profile;
    $("p_profile_note").textContent = u.p_profile_note;
    $("p_buddy").textContent = u.p_buddy;

    $("p_search").textContent = u.p_search;
    $("p_search2").textContent = u.p_search2;
    $("t_presence").textContent = u.t_presence;
    if(!save.story.foundAt) $("searchNote").textContent = u.searchNote;
    $("btn_hint").textContent = u.btn_hint;
    $("btn_back_profile").textContent = u.btn_back_profile;

    $("arrivalText").innerHTML = u.arrivalText;
    if(!save.story.hatched) $("arrivalThanks").textContent = u.arrivalThanks;
    $("btn_back_search").textContent = u.btn_back_search;
    $("t_watch").textContent = u.t_watch;
    $("p_watch").textContent = u.p_watch;

    $("sitterNote").textContent = (save.sitter.on ? u.sitterOn : u.sitterOff);

    $("careHint").textContent = u.careHint;
    $("stateHint").textContent = u.stateHint;
    $("btn_food").textContent = u.btn_food;
    $("btn_outing").textContent = u.btn_outing;
    $("btn_mini").textContent = u.btn_mini;
    $("btn_clean").textContent = u.btn_clean;
    $("btn_drink").textContent = u.btn_drink;
    $("btn_macaron").textContent = u.btn_macaron;
    $("btn_logs").textContent = u.btn_logs;

    $("t_logs").textContent = u.t_logs;
    $("p_logs").textContent = u.p_logs;
    $("btn_back_care").textContent = u.btn_back_care;
    $("t_share2").textContent = u.t_share2;
    $("p_share2").textContent = u.p_share2;
    $("btn_copy_share").textContent = u.btn_copy;
    $("btn_copy_share2").textContent = u.btn_copy;
    $("btn_logs_share").textContent = u.btn_share_url;

    $("t_observe").textContent = u.t_observe;
    $("p_observe").textContent = u.p_observe;
    $("btn_obs_back").textContent = u.btn_obs_back;
    $("t_observe_side").textContent = u.t_observe_side;
    $("p_observe_side").textContent = u.p_observe_side;

    // 終了画面の語
    const word = document.querySelector(".word");
    if(word) word.textContent = t("thanks");
  }

  function openModal(title, html, buttons){
    modalTitle.textContent = title;
    modalNote.innerHTML = html;
    modalBtns.innerHTML = "";
    (buttons || []).forEach(b => {
      const el = document.createElement("button");
      el.className = "btn " + (b.style || "secondary");
      el.textContent = b.label;
      el.addEventListener("click", () => {
        closeModal();
        b.onClick && b.onClick();
      });
      modalBtns.appendChild(el);
    });
    overlay.classList.add("on");
  }
  function closeModal(){ overlay.classList.remove("on"); }

  function openLanguageModal(){
    const lang = save.settings.lang;
    const html = `
      <p class="small">日本語 / English / 中文</p>
    `;
    openModal(t("language"), html, [
      { label:"日本語", style: (lang==="ja"?"":"secondary"), onClick: () => setLang("ja") },
      { label:"English", style: (lang==="en"?"":"secondary"), onClick: () => setLang("en") },
      { label:"中文", style: (lang==="zh"?"":"secondary"), onClick: () => setLang("zh") }
    ]);
  }

  function openAboutModal(){
    const dict = I18N[save.settings.lang] || I18N.ja;
    const tabs = dict.aboutTabs;
    const text = dict.aboutText;

    const render = (active) => {
      const tabHtml = `
        <div class="tabs" style="margin-top:0;">
          <button class="tab ${active==='ja'?'on':''}" data-tab="ja">${tabs.ja}</button>
          <button class="tab ${active==='en'?'on':''}" data-tab="en">${tabs.en}</button>
          <button class="tab ${active==='zh'?'on':''}" data-tab="zh">${tabs.zh}</button>
        </div>
        <div style="margin-top:10px; white-space:pre-line;">${escapeHtml(text[active] || "")}</div>
      `;
      openModal(dict.aboutTitle, tabHtml, [
        { label: t("close"), style: "secondary" }
      ]);

      // タブのクリック（モーダルの中なので、ここで付け直す）
      [...modalNote.querySelectorAll(".tab")].forEach(btn => {
        btn.addEventListener("click", () => render(btn.dataset.tab));
      });
    };

    render(save.settings.lang === "zh" ? "zh" : (save.settings.lang === "en" ? "en" : "ja"));
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setLang(lang){
    save.settings.lang = lang;
    saveNow();
    applyI18nStatic();
    setModePill();
  }

  function addEvent(type, detail){
    const t0 = effectiveNow(save);
    const d = dayIndex(save) || 1;
    save.logs.events.push({ t: t0, day:d, type, detail });

    const dayObj = save.logs.day[String(d)] || null;
    if(dayObj){
      if(type === "food"){ dayObj.careCounts.food++; dayObj.choices.food.push(detail.choice); }
      if(type === "outing"){ dayObj.careCounts.outing++; dayObj.choices.outing.push(detail.choice); }
      if(type === "mini"){ dayObj.careCounts.mini++; dayObj.choices.mini.push(detail.choice); }
      if(type === "clean"){ dayObj.careCounts.clean++; dayObj.choices.clean.push(detail.choice); }
      if(type === "drink"){ dayObj.careCounts.drink++; }
      if(type === "macaron"){ dayObj.careCounts.macaron++; }
    }
  }

  function ensureDayHearts(){
    if(!save.life.bornAt) return;
    const d = dayIndex(save);
    const dayObj = save.logs.day[String(d)];
    if(dayObj && dayObj.heartStart == null){
      dayObj.heartStart = save.stats.hearts;
    }
  }

  function finalizeDayIfNeeded(prevDay, nextDay){
    if(prevDay === 0 || prevDay === nextDay) return;
    const prevObj = save.logs.day[String(prevDay)];
    if(prevObj && prevObj.heartEnd == null){
      prevObj.heartEnd = save.stats.hearts;
    }
    const nextObj = save.logs.day[String(nextDay)];
    if(nextObj && nextObj.heartStart == null){
      nextObj.heartStart = save.stats.hearts;
    }
  }

  function finalizeAllDaysAtEnd(){
    for(let d=1; d<=3; d++){
      const obj = save.logs.day[String(d)];
      if(obj.heartStart == null && d===1) obj.heartStart = save.stats.hearts;
      if(obj.heartEnd == null) obj.heartEnd = save.stats.hearts;
    }
  }

  // 観察URL（ログとハート推移だけ）
  function buildSharePayload(s){
    const out = {
      v: 3,
      id: s.id,
      createdAt: nowMs(),
      lang: s.settings.lang,
      chosenColor: s.story.chosenColor,
      lifeMs: s.settings.lifeMs,
      hatchMs: s.settings.hatchMs,
      endedAt: s.life.endedAt || null,
      days: []
    };
    for(let d=1; d<=3; d++){
      const obj = s.logs.day[String(d)];
      const heartStart = obj.heartStart;
      const heartEnd = (obj.heartEnd != null) ? obj.heartEnd : ((d===dayIndex(s)) ? s.stats.hearts : null);
      out.days.push({
        day: d,
        heartStart,
        heartEnd,
        heartDelta: (heartStart!=null && heartEnd!=null) ? (heartEnd-heartStart) : null,
        sitterMs: obj.sitterMs,
        careCounts: obj.careCounts,
        choices: obj.choices,
        events: s.logs.events.filter(e => e.day===d).slice(0,120).map(e => ({ t:e.t, type:e.type, detail:e.detail }))
      });
    }
    return out;
  }
  function encodeShare(payload){
    const json = JSON.stringify(payload);
    return btoa(unescape(encodeURIComponent(json)));
  }
  function decodeShare(b64){
    const json = decodeURIComponent(escape(atob(b64)));
    return safeJSONParse(json, null);
  }
  function shareUrlForCurrentSave(){
    const payload = buildSharePayload(save);
    const data = encodeShare(payload);
    const u = new URL(location.href);
    u.searchParams.set("observe", payload.id);
    u.searchParams.set("data", data);
    u.searchParams.delete("fast");
    return u.toString();
  }

  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).catch(()=>fallbackCopy(text));
    }else{
      fallbackCopy(text);
    }
  }
  function fallbackCopy(text){
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position="fixed";
    ta.style.opacity="0";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{ document.execCommand("copy"); }catch(e){}
    document.body.removeChild(ta);
  }

  // 画面レンダリング
  function renderStart(){
    // 見た目用：ピンクマカロンを出す（まだ選択前なので固定）
    $("startVisual").src = ASSETS.macaron.pink;
    save.flow.screen = "start";
    saveNow();
    showScreen("start");
  }

  function renderMenu(){
    $("menuVisual").src = ASSETS.macaron.green;

    // 進行中は時間設定をロック
    const locked = !!(save.life.bornAt || save.story.arrivalAt);
    $("lifePreset").disabled = locked;
    $("hatchPreset").disabled = locked;
    $("p_menu_lock").style.display = locked ? "block" : "none";

    // 現在の設定を反映
    $("lifePreset").value = save.settings.lifePreset;
    $("hatchPreset").value = save.settings.hatchPreset;

    save.flow.screen = "menu";
    saveNow();
    showScreen("menu");
  }

  function renderProfile(){
    const box = $("charChoices");
    const preview = $("charPreview");

    box.innerHTML = "";
    const colors = ["green","blue","pink","purple"];
    const descJa = {
      green: "風が通るみたいに、軽い。",
      blue: "静かな場所で、目が合う。",
      pink: "少しだけ、あたたかい。",
      purple: "夢の端っこに触れる。"
    };

    const selected = save.story.chosenColor || "";
    const fallback = selected || "green";
    preview.src = ASSETS.char[fallback].open;

    colors.forEach(c => {
      const btn = document.createElement("button");
      btn.className = "choice" + (c === selected ? " selected" : "");
      btn.type = "button";
      btn.innerHTML = `
        <img src="${ASSETS.char[c].open}" alt="${c}">
        <div class="ctext">
          <div class="cname">${prettyColor(c)}</div>
          <div class="cdesc">${descJa[c]}</div>
        </div>
      `;

      btn.addEventListener("mouseenter", () => { preview.src = ASSETS.char[c].open; });
      btn.addEventListener("mouseleave", () => {
        const cur = save.story.chosenColor || fallback;
        preview.src = ASSETS.char[cur].open;
      });

      btn.addEventListener("click", () => {
        save.story.chosenColor = c;
        saveNow();
        [...box.querySelectorAll(".choice")].forEach(el => el.classList.remove("selected"));
        btn.classList.add("selected");
        preview.src = ASSETS.char[c].open;
        updateProfileNext();
      });

      box.appendChild(btn);
    });

    // 名前を反映
    const pn = $("playerName");
    pn.value = save.playerName || pn.value || "";

    updateProfileNext();
    save.flow.screen = "profile";
    saveNow();
    showScreen("profile");
  }

  function updateProfileNext(){
    const name = ($("playerName").value || "").trim();
    const hasName = name.length > 0;
    const hasChar = !!save.story.chosenColor;

    $("btn_profile_next").disabled = !(hasName && hasChar);

    const tip = $("profileNeed");
    if(hasName && hasChar) tip.textContent = "";
    else if(!hasName && !hasChar) tip.textContent = "名前とキャラを決めると、探しに行けます。";
    else if(!hasName) tip.textContent = "名前を入れると、探しに行けます。";
    else tip.textContent = "キャラを選ぶと、探しに行けます。";
  }

  function startNewRunFromProfile(){
    const name = ($("playerName").value || "").trim();
    const chosen = save.story.chosenColor;
    if(!name || !chosen) return;

    // 設定と言語だけ残してリスタート
    const keep = { settings: {...save.settings} };
    resetAll();
    save.settings = keep.settings;
    save.playerName = name;
    save.story.chosenColor = chosen;

    resetSearch();
    buildMap();

    subline.textContent = name ? `○○（${name}）の記録` : "記録だけが残る";
    save.flow.screen = "search";
    saveNow();
    showScreen("search");
  }

  function resetSearch(){
    save.story.foundAt = null;
    save.story.arrivalAt = null;
    save.story.hatchAt = null;
    save.story.hatched = false;
    save.story.hatchedByTouch = false;
    save.story._targetTile = null;
    save.story._revealed = [];
    saveNow();
  }

  function buildMap(){
    const grid = $("mapGrid");
    grid.innerHTML = "";
    const N = 12;

    if(!save.story._targetTile){
      save.story._targetTile = Math.floor(Math.random()*N);
      save.story._revealed = [];
      saveNow();
    }

    const chosen = save.story.chosenColor || "blue";
    const macImg = ASSETS.macaron[chosen];

    for(let i=0;i<N;i++){
      const tile = document.createElement("button");
      tile.className = "tile";
      tile.type = "button";
      tile.innerHTML = `<span>……</span><img class="foundImg" alt="macaron">`;
      const img = tile.querySelector(".foundImg");
      img.src = macImg;

      if(save.story._revealed.includes(i)){
        tile.classList.add("revealed");
        tile.querySelector("span").textContent = " ";
        if(i === save.story._targetTile) tile.classList.add("found");
      }

      tile.addEventListener("click", () => {
        if(save.story.foundAt) return;

        if(!save.story._revealed.includes(i)) save.story._revealed.push(i);
        tile.classList.add("revealed");
        tile.querySelector("span").textContent = " ";

        if(i === save.story._targetTile){
          tile.classList.add("found");
          save.story.foundAt = nowMs();

          // 見つけた瞬間に「到着」。そこから hatchMs 後に誕生（ただし触れると早まる）
          save.story.arrivalAt = effectiveNow(save);
          save.story.hatchAt = save.story.arrivalAt + save.settings.hatchMs;
          save.story.hatched = false;
          save.story.hatchedByTouch = false;

          $("searchNote").textContent = "見つかった。近づくと、温かい。";
          addEvent("found", { where: i, color: save.story.chosenColor });
          saveNow();

          setTimeout(() => showArrival(), 600);
        }else{
          $("searchNote").textContent = "そこには、光の粒だけが残っている。";
          saveNow();
        }
      });

      grid.appendChild(tile);
    }
  }

  function fmtMMSS(ms){
    const s = Math.max(0, Math.ceil(ms/1000));
    const mm = String(Math.floor(s/60));
    const ss = String(s%60).padStart(2,"0");
    return `${mm}:${ss}`;
  }

  function updateArrivalCountdown(){
    const elTime = $("hatchTime");
    const elFill = $("hatchFill");
    const elThanks = $("arrivalThanks");
    if(!elTime || !elFill || !elThanks) return;
    if(!save.story.hatchAt) return;

    const remain = save.story.hatchAt - effectiveNow(save);
    const clampedMs = Math.max(0, remain);
    const total = save.settings.hatchMs;
    const prog = clamp(1 - (clampedMs/total), 0, 1);

    elFill.style.width = (prog*100).toFixed(1) + "%";

    if(clampedMs <= 0){
      elTime.textContent = "いま";
      elThanks.textContent = "見つけてくれてありがとう。いま、ふわりと。";
    }else{
      elTime.textContent = "あと " + fmtMMSS(clampedMs);
      const sec = Math.ceil(clampedMs/1000);
      if(sec > 60) elThanks.textContent = "見つけてくれてありがとう。もうすこし。";
      else elThanks.textContent = "見つけてくれてありがとう。もうすぐ。";
    }
  }

  function showArrival(){
    showScreen("arrival");
    save.flow.screen = "arrival";
    saveNow();

    const c = save.story.chosenColor || "green";
    $("arrivalMacaron").src = ASSETS.macaron[c];
    $("orbitChar").src = ASSETS.char[c].closed;

    updateArrivalCountdown();
  }

  function hatchNow(byTouch){
    if(save.story.hatched) return;

    save.story.hatched = true;
    save.story.hatchedByTouch = !!byTouch;

    const bornAt = effectiveNow(save);
    save.life.bornAt = bornAt;
    save.life.deathAt = bornAt + save.settings.lifeMs;
    save.life.isEnded = false;
    save.life.endedAt = null;
    save.life.revivedUntil = null;
    save.life.uncanny = false;
    save.life._handledEnd = false;

    // ログ初期化
    save.logs.day["1"] = emptyDay(1);
    save.logs.day["2"] = emptyDay(2);
    save.logs.day["3"] = emptyDay(3);
    save.logs.events = [];
    save.logs.day["1"].heartStart = save.stats.hearts;

    addEvent("hatch", { color: save.story.chosenColor, byTouch: !!byTouch });
    saveNow();
    showCare();
  }

  function maybeHatch(){
    if(save.story.hatched) return;
    if(!save.story.hatchAt) return;

    const t0 = effectiveNow(save);
    if(t0 >= save.story.hatchAt){
      hatchNow(false);
    }
  }

  // 状態変化（時間経過）
  function stepByTime(dtMs){
    const dayMs = getDayMs();

    // 1日（= life/3）で、空腹は約12時間相当、排泄は約8時間相当で100に近づく
    const hungerAdd = dtMs * (200 / dayMs); // dayMs/2 で 100
    const wasteAdd  = dtMs * (300 / dayMs); // dayMs/3 で 100

    save.stats.hunger = clamp(save.stats.hunger + hungerAdd, 0, 100);
    save.stats.waste  = clamp(save.stats.waste  + wasteAdd, 0, 100);

    // 放置のじわじわ
    let moodDrop = 0;
    let heartDrop = 0;

    if(save.stats.hunger > 75) moodDrop += (dtMs/dayMs) * 28;
    if(save.stats.waste  > 70) moodDrop += (dtMs/dayMs) * 30;
    if(save.stats.waste  > 70) heartDrop += (dtMs/dayMs) * 9;

    if(save.stats.hunger < 30 && save.stats.waste < 35) moodDrop -= (dtMs/dayMs) * 8;

    // 不気味な復活後は上限を抑える
    const moodCap = save.life.uncanny ? 60 : 100;
    save.stats.mood = clamp(save.stats.mood - moodDrop, 0, moodCap);

    const heartCap = save.life.uncanny ? Math.min(save.stats.hearts, 70) : 100;
    save.stats.hearts = clamp(save.stats.hearts - heartDrop, 0, heartCap);

    // 日跨ぎのシッター記録などは tick 側で処理
  }

  function applySoftImpact({ hunger=0, waste=0, mood=0, hearts=0 }){
    save.stats.hunger = clamp(save.stats.hunger + hunger, 0, 100);
    save.stats.waste  = clamp(save.stats.waste  + waste, 0, 100);

    const moodCap = save.life.uncanny ? 60 : 100;
    save.stats.mood = clamp(save.stats.mood + mood, 0, moodCap);

    const heartCap = save.life.uncanny ? Math.min(save.stats.hearts, 70) : 100;
    save.stats.hearts = clamp(save.stats.hearts + hearts, 0, heartCap);
  }

  function blockedByEnd(){ return save.life.isEnded; }

  // お世話（2択）
  function actFood(){
    if(blockedByEnd()) return;
    openModal("食事", "<p>軽くするか、しっかりにするか。理由は表示されない。</p>", [
      { label:"軽い食事", style:"secondary", onClick: () => {
        applySoftImpact({ hunger: -18 + rnd(-2,2), waste: +10 + rnd(-2,2), mood: +4 + rnd(-1,1), hearts: +1 });
        addEvent("food", { choice: "light" });
        saveNow();
      }},
      { label:"しっかりした食事", style:"", onClick: () => {
        applySoftImpact({ hunger: -30 + rnd(-3,3), waste: +16 + rnd(-3,3), mood: +2 + rnd(-2,2), hearts: +1 });
        addEvent("food", { choice: "hearty" });
        saveNow();
      }}
    ]);
  }

  function actOuting(){
    if(blockedByEnd()) return;
    openModal("お出かけ", "<p>外へ出るか、家で過ごすか。</p>", [
      { label:"外に出る", style:"", onClick: () => {
        applySoftImpact({ hunger: +8 + rnd(-2,2), waste: +8 + rnd(-2,2), mood: +10 + rnd(-2,2), hearts: +2 });
        addEvent("outing", { choice: "outside" });
        saveNow();
      }},
      { label:"家で過ごす", style:"secondary", onClick: () => {
        applySoftImpact({ hunger: +4 + rnd(-2,2), waste: +4 + rnd(-2,2), mood: +6 + rnd(-2,2), hearts: +1 });
        addEvent("outing", { choice: "home" });
        saveNow();
      }}
    ]);
  }

  function actMini(){
    if(blockedByEnd()) return;
    const prompts = [
      { q:"光の粒を、集める？ 眺める？", a:"集める", b:"眺める", ka:"collect", kb:"watch" },
      { q:"近づく？ 少し離れる？", a:"近づく", b:"離れる", ka:"near", kb:"far" },
      { q:"触れる？ 見守る？", a:"触れる", b:"見守る", ka:"touch", kb:"watch2" }
    ];
    const p = prompts[Math.floor(Math.random()*prompts.length)];
    openModal("2択ミニゲーム", `<p>${escapeHtml(p.q)}</p>`, [
      { label:p.a, style:"", onClick: () => {
        applySoftImpact({ mood: +6 + rnd(-3,3), hearts: +1 });
        addEvent("mini", { choice: p.ka });
        saveNow();
      }},
      { label:p.b, style:"secondary", onClick: () => {
        applySoftImpact({ mood: +5 + rnd(-3,3), hearts: +1 });
        addEvent("mini", { choice: p.kb });
        saveNow();
      }}
    ]);
  }

  function actClean(){
    if(blockedByEnd()) return;
    openModal("排泄除去", "<p>放置するとゆっくり悪化。やると少し改善。</p>", [
      { label:"やる", style:"", onClick: () => {
        applySoftImpact({ waste: -28 + rnd(-4,4), mood: +5 + rnd(-2,2), hearts: +1 });
        addEvent("clean", { choice: "done" });
        saveNow();
      }},
      { label:"今はやらない", style:"secondary", onClick: () => {
        applySoftImpact({ mood: -1 + rnd(-1,1), hearts: 0 });
        addEvent("clean", { choice: "partial" });
        saveNow();
      }}
    ]);
  }

  function actDrink(){
    if(blockedByEnd()) return;
    if(save.items.drink <= 0){
      openModal("ドリンク", "<p>もう、残っていない。</p>", [{ label:t("close"), style:"secondary" }]);
      return;
    }

    save.items.drink -= 1;

    // 生存時間を少し戻す／延ばす（1/12日分 ≒ 2時間相当）
    const addMs = Math.floor(getDayMs() / 12);
    save.life.deathAt += addMs;

    applySoftImpact({ hunger: -10 + rnd(-2,2), mood: +4 + rnd(-2,2), hearts: +1 });
    addEvent("drink", { addMs });
    saveNow();
  }

  function actMacaron(){
    // 死後のみ使用可。復活はどこか違和感。
    if(!save.life.isEnded){
      openModal("マカロン", "<p>まだ。ここでは使えない。</p>", [{ label:t("close"), style:"secondary" }]);
      return;
    }
    if(save.items.macaron <= 0){
      openModal("マカロン", "<p>もう、残っていない。</p>", [{ label:t("close"), style:"secondary" }]);
      return;
    }

    save.items.macaron -= 1;

    // 一時的に復活（1/2日分 ≒ 12時間相当）
    const reviveMs = Math.floor(getDayMs() / 2);
    save.life.isEnded = false;
    save.life.revivedUntil = effectiveNow(save) + reviveMs;
    save.life.uncanny = true;
    save.life._handledEnd = false;

    applySoftImpact({ hunger: +8, waste: +5, mood: +2, hearts: 0 });
    addEvent("macaron", { reviveMs });
    saveNow();

    showCare();
  }

  // シッター
  function toggleSitter(){
    if(blockedByEnd()) return;

    const t0 = nowMs();
    if(!save.sitter.on){
      save.sitter.on = true;
      save.sitter.onSince = t0;
      addEvent("sitterOn", {});
      saveNow();
    }else{
      save.sitter.on = false;
      const used = t0 - save.sitter.onSince;
      save.sitter.pausedTotal += used;
      save.sitter.usedTotal += used;
      save.sitter.onSince = null;

      // dayの集計
      const d = dayIndex(save) || 1;
      save.logs.day[String(d)].sitterMs += used;

      addEvent("sitterOff", { used });
      saveNow();
    }
    renderCare();
  }

  // 終了判定
  function getEndAt(){
    // 復活中なら復活終了が先
    if(save.life.revivedUntil) return save.life.revivedUntil;
    return save.life.deathAt;
  }

  function maybeEnd(){
    if(save.life.isEnded) return;
    if(!save.life.bornAt) return;

    const t0 = effectiveNow(save);
    const endAt = getEndAt();
    if(endAt && t0 >= endAt){
      if(!save.life._handledEnd){
        save.life._handledEnd = true;
        save.life.isEnded = true;
        save.life.endedAt = t0;
        save.life.revivedUntil = null;
        finalizeAllDaysAtEnd();
        addEvent("end", {});
        saveNow();
        showEnd();
      }
    }
  }

  // 表情や見た目（ラベルは出さない）
  function decideFace(){
    // 0:元気, 1:元気がない, 2:泣いてる
    const h = save.stats.hunger;
    const w = save.stats.waste;
    const m = save.stats.mood;

    if(save.life.uncanny){
      if(h>75 || w>70) return 2;
      if(m<35) return 1;
      return 1;
    }

    if(h>82 || w>78) return 2;
    if(m<35 || h>65 || w>60) return 1;
    return 0;
  }

  function renderHearts(){
    const v = clamp(save.stats.hearts, 0, 100);
    const on = Math.round(v/20);
    for(let i=1; i<=5; i++){
      const el = $("h"+i);
      el.classList.toggle("on", i<=on);
    }
  }

  function fmtRemain(ms){
    if(ms <= 0) return "0:00";

    const totalSec = Math.floor(ms/1000);
    const d = Math.floor(totalSec / (24*3600));
    const h = Math.floor((totalSec % (24*3600)) / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;

    // lifeMs が短い時は hh:mm:ss に寄せる
    if(save.settings.lifeMs <= 6*60*60*1000){
      const hh = String(Math.floor(totalSec/3600)).padStart(2,"0");
      const mm = String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
      const ss = String(totalSec%60).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    if(d > 0) return `${d}日 ${h}時間${m}分`;
    if(h > 0) return `${h}時間${m}分`;
    return `${m}分${s}秒`;
  }

  function renderLifeMeter(){
    const total = save.settings.lifeMs;
    const endAt = getEndAt();
    const remain = Math.max(0, endAt - effectiveNow(save));
    const spent = clamp(1 - (remain/Math.max(1,total)), 0, 1);

    const d = dayIndex(save) || 1;
    $("lifeText").textContent = `${t("day")} ${d}/3`;
    $("lifeRemain").textContent = `${t("remain")} ${fmtRemain(remain)}`;
    $("lifeFill").style.width = (spent*100).toFixed(1) + "%";
  }


  function sitterNoteText(on){
    const lang = (save && save.settings && save.settings.lang) ? save.settings.lang : "ja";
    const map = {
      ja: { on: "時間が止まっている", off: "時間は止まる" },
      en: { on: "Time is stopped", off: "Time can stop" },
      zh: { on: "时间已暂停", off: "时间可以暂停" }
    };
    const m = map[lang] || map.ja;
    return on ? m.on : m.off;
  }

  function renderCare(){
    renderHearts();
    renderLifeMeter();

    // シッター表示
    const tgl = $("toggle_sitter");
    tgl.classList.toggle("on", !!save.sitter.on);
    tgl.setAttribute("aria-checked", save.sitter.on ? "true" : "false");
    $("sitterNote").textContent = sitterNoteText(!!save.sitter.on);

    // キャラ画像（状態ラベルなし）
    const c = save.story.chosenColor || "green";
    const face = decideFace();
    const img = $("charImg");

    if(face === 0) img.src = ASSETS.char[c].open;
    else img.src = ASSETS.char[c].closed;

    // 状態の雰囲気で、ほんの少し動きを変える
    if(face === 2){
      img.classList.add("floaty");
      img.style.transform = "translateY(2px) scale(.995)";
    }else{
      img.classList.add("floaty");
      img.style.transform = "";
    }

    // 共有URL
    const shareUrl = shareUrlForCurrentSave();
    $("shareUrl").value = shareUrl;
    $("shareUrl2").value = shareUrl;
    $("shareBox").style.display = "flex";
  }

  function showCare(){
    showScreen("care");
    save.flow.screen = "care";
    saveNow();
    renderCare();
  }

  function showEnd(){
    showScreen("end");
    save.flow.screen = "end";
    saveNow();

    const shareUrl = shareUrlForCurrentSave();
    $("shareUrl").value = shareUrl;
    $("shareUrl2").value = shareUrl;
  }

  function showLogs(){
    showScreen("logs");
    save.flow.screen = "logs";
    saveNow();

    const series = buildHeartSeriesFromSave(save);
    drawHeartChart($("heartChart"), series);

    renderLogTabs(save, $("dayTabs"), $("logBox"));
  }

  function showObserve(payload){
    showScreen("observe");

    const c = payload.chosenColor || "green";
    $("charImgObs").src = ASSETS.char[c].open;

    const series = buildHeartSeriesFromPayload(payload);
    drawHeartChart($("heartChartObs"), series);

    renderObserveTabs(payload, $("dayTabsObs"), $("logBoxObs"));
  }

  function buildHeartSeriesFromSave(s){
    const arr = [];
    for(let d=1; d<=3; d++){
      const obj = s.logs.day[String(d)];
      const start = (obj && obj.heartStart!=null) ? obj.heartStart : null;
      const end = (obj && obj.heartEnd!=null) ? obj.heartEnd : ((d===dayIndex(s)) ? s.stats.hearts : null);
      if(end!=null) arr.push({ x:d, y:end });
      else if(start!=null) arr.push({ x:d, y:start });
      else arr.push({ x:d, y:null });
    }
    return arr;
  }

  function buildHeartSeriesFromPayload(p){
    const arr = [];
    for(const d of (p.days || [])){
      if(d.heartEnd!=null) arr.push({ x:d.day, y:d.heartEnd });
      else if(d.heartStart!=null) arr.push({ x:d.day, y:d.heartStart });
      else arr.push({ x:d.day, y:null });
    }
    // 念のため 1..3 を補完
    const byDay = new Map(arr.map(a => [a.x, a]));
    const out = [];
    for(let i=1;i<=3;i++) out.push(byDay.get(i) || {x:i,y:null});
    return out;
  }

  function drawHeartChart(canvas, series){
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    ctx.globalAlpha = 1;
    ctx.strokeStyle = "rgba(15,23,42,.18)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(36, 18);
    ctx.lineTo(36, H-28);
    ctx.lineTo(W-14, H-28);
    ctx.stroke();

    ctx.fillStyle = "rgba(15,23,42,.70)";
    ctx.font = "12px system-ui, sans-serif";
    for(let d=1; d<=3; d++){
      const x = mapX(d);
      ctx.fillText("D"+d, x-8, H-10);
    }

    const pts = series.filter(p => p.y!=null).map(p => ({ x:mapX(p.x), y:mapY(p.y) }));
    if(pts.length>=2){
      ctx.strokeStyle = "rgba(251,113,133,.88)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
      ctx.stroke();
    }
    pts.forEach(p => {
      ctx.fillStyle = "rgba(251,113,133,.92)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
      ctx.fill();
    });

    function mapX(day){
      const left = 36, right = W-14;
      return left + (right-left)*( (day-1)/2 );
    }
    function mapY(val){
      const top = 18, bottom = H-28;
      const y = clamp(val,0,100);
      return bottom - (bottom-top)*(y/100);
    }
  }

  function foodLabel(k){ return k==="light" ? "軽い" : (k==="hearty" ? "しっかり" : k); }
  function outingLabel(k){ return k==="outside" ? "外" : (k==="home" ? "家" : k); }
  function miniLabel(k){
    const m = { collect:"集める", watch:"眺める", near:"近づく", far:"離れる", touch:"触れる", watch2:"見守る" };
    return m[k] || k;
  }
  function cleanLabel(k){ return k==="done" ? "完了" : (k==="partial" ? "途中" : k); }

  function eventToText(e){
    const t0 = e.type;
    if(t0==="found") return "見つけた";
    if(t0==="hatch") return e.detail && e.detail.byTouch ? "触れて誕生した" : "誕生した";
    if(t0==="food") return `食事（${foodLabel(e.detail.choice)}）`;
    if(t0==="outing") return `お出かけ（${outingLabel(e.detail.choice)}）`;
    if(t0==="mini") return `ミニ（${miniLabel(e.detail.choice)}）`;
    if(t0==="clean") return `排泄除去（${cleanLabel(e.detail.choice)}）`;
    if(t0==="drink") return "ドリンク";
    if(t0==="macaron") return "マカロン";
    if(t0==="sitterOn") return "シッターON";
    if(t0==="sitterOff") return "シッターOFF";
    if(t0==="end") return "終わった";
    return t0;
  }

  function msToHuman(ms){
    if(!ms || ms<=0) return "0分";
    const m = Math.round(ms/60000);
    if(m < 60) return `${m}分`;
    const h = Math.floor(m/60);
    const mm = m%60;
    return `${h}時間${mm}分`;
  }

  function renderLogTabs(s, tabsEl, boxEl){
    tabsEl.innerHTML = "";
    for(let d=1; d<=3; d++){
      const b = document.createElement("button");
      b.className = "tab" + (d===1 ? " on" : "");
      b.textContent = "Day " + d;
      b.addEventListener("click", () => {
        [...tabsEl.querySelectorAll(".tab")].forEach(x=>x.classList.remove("on"));
        b.classList.add("on");
        renderDayLog(s, d, boxEl);
      });
      tabsEl.appendChild(b);
    }
    renderDayLog(s, 1, boxEl);

    // 共有欄を更新
    const shareUrl = shareUrlForCurrentSave();
    $("shareUrl").value = shareUrl;
    $("shareUrl2").value = shareUrl;
  }

  function renderObserveTabs(p, tabsEl, boxEl){
    tabsEl.innerHTML = "";
    for(let d=1; d<=3; d++){
      const b = document.createElement("button");
      b.className = "tab" + (d===1 ? " on" : "");
      b.textContent = "Day " + d;
      b.addEventListener("click", () => {
        [...tabsEl.querySelectorAll(".tab")].forEach(x=>x.classList.remove("on"));
        b.classList.add("on");
        renderDayLogPayload(p, d, boxEl);
      });
      tabsEl.appendChild(b);
    }
    renderDayLogPayload(p, 1, boxEl);
  }

  function renderDayLog(s, d, boxEl){
    const obj = s.logs.day[String(d)];
    const lines = [];

    lines.push(`Day ${d}`);

    if(obj.heartStart!=null) lines.push(`ハート: ${obj.heartStart} → ${(obj.heartEnd!=null?obj.heartEnd:(d===dayIndex(s)?s.stats.hearts:"…"))}`);
    lines.push(`シッター: ${msToHuman(obj.sitterMs)}`);

    const c = obj.careCounts;
    lines.push(`回数: 食事${c.food} / お出かけ${c.outing} / ミニ${c.mini} / 排泄除去${c.clean} / ドリンク${c.drink} / マカロン${c.macaron}`);

    const ev = s.logs.events.filter(e => e.day===d);
    if(ev.length){
      lines.push("出来事:");
      ev.slice(0,120).forEach(e => lines.push("・" + eventToText(e)));
    }

    boxEl.innerHTML = lines.map(x => `<div class="logLine">${escapeHtml(x)}</div>`).join("");
  }

  function renderDayLogPayload(p, d, boxEl){
    const obj = (p.days || []).find(x => x.day===d);
    const lines = [];
    lines.push(`Day ${d}`);
    if(!obj){
      lines.push("記録なし");
      boxEl.innerHTML = lines.map(x => `<div class="logLine">${escapeHtml(x)}</div>`).join("");
      return;
    }

    if(obj.heartStart!=null && obj.heartEnd!=null) lines.push(`ハート: ${obj.heartStart} → ${obj.heartEnd}（${obj.heartDelta>=0?"+":""}${obj.heartDelta}）`);
    lines.push(`シッター: ${msToHuman(obj.sitterMs)}`);

    const c = obj.careCounts;
    lines.push(`回数: 食事${c.food} / お出かけ${c.outing} / ミニ${c.mini} / 排泄除去${c.clean} / ドリンク${c.drink} / マカロン${c.macaron}`);

    const ev = (obj.events || []);
    if(ev.length){
      lines.push("出来事:");
      ev.slice(0,120).forEach(e => lines.push("・" + (e.type || "")));
    }

    boxEl.innerHTML = lines.map(x => `<div class="logLine">${escapeHtml(x)}</div>`).join("");
  }

  function tick(){
    if(!save) return;

    // まだ誕生前（到着待ち）
    if(save.story.arrivalAt && !save.story.hatched){
      updateArrivalCountdown();
      maybeHatch();
      saveNow();
      return;
    }

    if(save.life.bornAt){
      const prevDay = save._prevDay || dayIndex(save);
      const curDay = dayIndex(save);
      finalizeDayIfNeeded(prevDay, curDay);
      save._prevDay = curDay;

      const effNow = effectiveNow(save);
      const last = save._lastEff || effNow;
      const dt = effNow - last;

      if(dt > 0 && !save.sitter.on && !save.life.isEnded){
        stepByTime(dt);
      }
      save._lastEff = effNow;

      ensureDayHearts();
      maybeEnd();

      if(screens.care.classList.contains("active")){
        renderCare();
      }
      saveNow();
    }
  }

  // 進行復元
  function initPlay(){
    setModePill();
    save = loadSave();

    // 表示
    if(save.playerName){
      subline.textContent = save.playerName ? `○○（${save.playerName}）の記録` : "記録だけが残る";
    }

    applyI18nStatic();

    // 画像
    $("startVisual").src = ASSETS.macaron.pink;
    $("menuVisual").src = ASSETS.macaron.green;

    // 復元
    if(save.life.isEnded){
      showEnd();
    }else if(save.life.bornAt){
      showCare();
    }else if(save.story.arrivalAt){
      showArrival();
    }else if(save.playerName && save.story.chosenColor){
      buildMap();
      showScreen("search");
    }else{
      // まだ始めていない
      const scr = save.flow && save.flow.screen ? save.flow.screen : "start";
      if(scr === "menu") renderMenu();
      else if(scr === "profile") renderProfile();
      else renderStart();
    }

    // スタート
    $("btn_go_menu").addEventListener("click", () => {
      renderMenu();
    });

    // 全リセット
    $("btn_reset_all").addEventListener("click", () => {
      resetAll();
      applyI18nStatic();
      renderStart();
    });
    $("btn_profile_reset").addEventListener("click", () => {
      resetAll();
      applyI18nStatic();
      renderStart();
    });

    // メニュー操作
    $("btn_about").addEventListener("click", openAboutModal);
    $("btn_lang").addEventListener("click", openLanguageModal);

    $("lifePreset").addEventListener("change", () => {
      const p = $("lifePreset").value;
      save.settings.lifePreset = p;
      save.settings.lifeMs = defaultLifeMsFromPreset(p);
      saveNow();
    });
    $("hatchPreset").addEventListener("change", () => {
      const p = $("hatchPreset").value;
      save.settings.hatchPreset = p;
      save.settings.hatchMs = defaultHatchMsFromPreset(p);
      saveNow();
    });

    $("btn_menu_next").addEventListener("click", () => {
      renderProfile();
    });

    // プロフィール
    $("btn_profile_back").addEventListener("click", () => {
      renderMenu();
    });

    $("playerName").addEventListener("input", () => {
      save.playerName = $("playerName").value;
      saveNow();
      updateProfileNext();
    });

    $("btn_profile_next").addEventListener("click", () => startNewRunFromProfile());

    // 探す
    $("btn_back_profile").addEventListener("click", () => {
      // 進行中なら確認
      if(save.story.arrivalAt || save.life.bornAt){
        openModal("戻る", "<p>設定へ戻ると、探し直しになります。</p>", [
          { label:"戻る", style:"", onClick: () => renderProfile() },
          { label:"やめる", style:"secondary" }
        ]);
      }else{
        renderProfile();
      }
    });

    $("btn_hint").addEventListener("click", () => {
      if(save.story.foundAt) return;
      const N = 12;
      const i = Math.floor(Math.random()*N);
      if(!save.story._revealed.includes(i)) save.story._revealed.push(i);
      saveNow();
      buildMap();
      $("searchNote").textContent = "光の粒が、少しだけ道を示した。";
    });

    // 到着
    $("btn_back_search").addEventListener("click", () => {
      resetSearch();
      buildMap();
      showScreen("search");
      $("searchNote").textContent = "まだ、何も見つからない。";
    });

    // 触れて早める
    $("btn_touch_macaron").addEventListener("click", () => {
      if(save.story.hatched) return;
      hatchNow(true);
    });

    // お世話
    $("btn_food").addEventListener("click", actFood);
    $("btn_outing").addEventListener("click", actOuting);
    $("btn_mini").addEventListener("click", actMini);
    $("btn_clean").addEventListener("click", actClean);
    $("btn_drink").addEventListener("click", actDrink);
    $("btn_macaron").addEventListener("click", actMacaron);

    // ログ
    $("btn_logs").addEventListener("click", showLogs);
    $("btn_end_logs").addEventListener("click", showLogs);

    // 共有
    $("btn_copy_share").addEventListener("click", () => copyToClipboard($("shareUrl").value));
    $("btn_copy_share2").addEventListener("click", () => copyToClipboard($("shareUrl2").value));
    $("btn_logs_share").addEventListener("click", () => copyToClipboard($("shareUrl2").value));
    $("btn_end_share").addEventListener("click", () => copyToClipboard(shareUrlForCurrentSave()));

    // 戻る
    $("btn_back_care").addEventListener("click", () => {
      if(save.life.isEnded) showEnd();
      else showCare();
    });

    // シッター
    const tgl = $("toggle_sitter");
    tgl.addEventListener("click", toggleSitter);
    tgl.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleSitter();
      }
    });

    // モーダル
    $("btn_close_modal").addEventListener("click", () => overlay.classList.remove("on"));
    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) overlay.classList.remove("on");
    });

    // 観察モード
    if(isObserveMode){
      const data = url.searchParams.get("data");
      const payload = decodeShare(data);
      if(payload){
        showObserve(payload);
        $("btn_obs_back").addEventListener("click", () => {
          // 観察画面は閉じる＝トップへ
          location.href = location.pathname;
        });
      }
    }

    if(tickTimer) clearInterval(tickTimer);
    tickTimer = setInterval(tick, 400);
  }

  initPlay();
})();
</script>
</body>
</html>
