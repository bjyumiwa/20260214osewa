<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3日間のお世話ゲーム（プロトタイプ）</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --btn:#2f6fed; --btn2:#111827; --danger:#e11d48; --good:#10b981;
      --shadow: 0 10px 30px rgba(17,24,39,.10);

      /* ここが「生まれてきた子の大きさ」です（半分くらいに） */
      --pet-size: 132px;     /* 以前が260前後なら、だいたい半分 */
      --egg-size: 160px;
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Yu Gothic", "Meiryo", sans-serif;
      background: radial-gradient(1200px 500px at 50% 0%, #ffffff 0%, var(--bg) 60%, #eef2ff 100%);
      color:var(--text);
    }

    .wrap{ max-width: 980px; margin:0 auto; padding: 18px; }
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding: 14px 16px; border:1px solid var(--line); background: rgba(255,255,255,.75);
      backdrop-filter: blur(8px);
      border-radius: var(--radius); box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 5;
    }
    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .title .small{ color:var(--muted); font-size: 12px; }
    .hearts{
      display:flex; align-items:center; gap:10px;
    }
    .heartRow{ display:flex; gap:4px; align-items:center; }
    .h{
      width: 12px; height: 12px; transform: rotate(45deg);
      background: #fca5a5; border-radius: 2px; position: relative; opacity:.40;
    }
    .h::before,.h::after{
      content:""; position:absolute; width: 12px; height:12px; background: inherit; border-radius: 50%;
    }
    .h::before{ left:-6px; top:0; }
    .h::after{ top:-6px; left:0; }
    .h.on{ opacity: .95; background:#fb7185; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px; border:1px solid var(--line);
      background: rgba(255,255,255,.8);
      font-size: 12px; color: var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(16,185,129,.15);
    }
    .dot.pause{ background:#f59e0b; box-shadow: 0 0 0 4px rgba(245,158,11,.15); }

    .grid{
      margin-top: 14px;
      display:grid; grid-template-columns: 1.2fr .8fr; gap: 12px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
      gap: 12px;
    }
    .cardHead .sub{ color:var(--muted); font-size: 12px; }
    .cardBody{ padding: 16px; }

    .stage{
      min-height: 420px;
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden;
    }
    .stage::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(600px 260px at 50% 30%, rgba(99,102,241,.12), transparent 60%),
        radial-gradient(420px 260px at 35% 80%, rgba(236,72,153,.08), transparent 60%),
        radial-gradient(420px 260px at 65% 80%, rgba(59,130,246,.08), transparent 60%);
      pointer-events:none;
    }

    .eggWrap{
      width: var(--egg-size);
      height: var(--egg-size);
      display:flex; align-items:center; justify-content:center;
      position: relative;
      filter: drop-shadow(0 18px 22px rgba(17,24,39,.18));
      animation: floaty 3.2s ease-in-out infinite;
      z-index: 1;
    }
    .eggWrap.hatching{
      animation: lift 1.6s ease-in-out infinite;
    }
    .eggImg{
      width: 100%;
      height: auto;
      image-rendering:auto;
      user-select:none;
      -webkit-user-drag:none;
    }

    /* 生まれた子：2人を横並びにして、重ならないように */
    .petRow{
      display:flex;
      align-items:flex-end;
      justify-content:center;
      gap: 22px;
      z-index: 1;
      padding: 10px 0;
    }
    .petSlot{
      width: var(--pet-size);
      height: var(--pet-size);
      display:flex; align-items:center; justify-content:center;
      position: relative;
      filter: drop-shadow(0 18px 22px rgba(17,24,39,.18));
      user-select:none;
      -webkit-user-drag:none;
    }
    .petImg{
      width: 100%;
      height: auto;
      user-select:none;
      -webkit-user-drag:none;
      transform-origin: 50% 100%;
    }

    /* 状態はラベルで言わず、動きだけで示す */
    .mood-good .petImg{ animation: bop 1.6s ease-in-out infinite; }
    .mood-low  .petImg{ animation: sway 3.2s ease-in-out infinite; opacity:.95; }
    .mood-cry  .petImg{ animation: tremble .28s ease-in-out infinite; opacity:.90; }

    /* 泣き（涙の雰囲気だけ） */
    .mood-cry .petSlot::after{
      content:"";
      position:absolute;
      width: 10px; height: 14px;
      right: 18%;
      top: 48%;
      background: rgba(59,130,246,.55);
      border-radius: 8px 8px 10px 10px;
      transform: rotate(10deg);
      filter: blur(.2px);
      animation: drip 1.3s ease-in-out infinite;
    }

    /* 復活時の違和感（軽いグリッチ） */
    .weird{
      animation: glitch 2.2s steps(2,end) infinite;
    }

    @keyframes floaty{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-10px); }
    }
    @keyframes lift{
      0%,100%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-18px) scale(1.02); }
    }
    @keyframes bop{
      0%,100%{ transform: translateY(0) scale(1); }
      50%{ transform: translateY(-10px) scale(1.02); }
    }
    @keyframes sway{
      0%,100%{ transform: translateX(0) rotate(0deg); }
      50%{ transform: translateX(3px) rotate(1.4deg); }
    }
    @keyframes tremble{
      0%,100%{ transform: translateX(0) rotate(0deg); }
      50%{ transform: translateX(2px) rotate(-.8deg); }
    }
    @keyframes drip{
      0%,100%{ transform: translateY(0) rotate(10deg); opacity:.55; }
      60%{ transform: translateY(8px) rotate(10deg); opacity:.25; }
    }
    @keyframes glitch{
      0%{ filter: hue-rotate(0deg) saturate(1); transform: translate(0,0); }
      10%{ filter: hue-rotate(12deg) saturate(1.1); transform: translate(1px,-1px); }
      20%{ filter: hue-rotate(0deg) saturate(1); transform: translate(-1px,1px); }
      30%{ filter: hue-rotate(-10deg) saturate(1.15); transform: translate(1px,0); }
      40%{ filter: hue-rotate(0deg) saturate(1); transform: translate(0,0); }
      100%{ filter: hue-rotate(0deg) saturate(1); transform: translate(0,0); }
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btn{
      border:1px solid var(--line);
      background: #ffffff;
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .2s ease;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
      user-select:none;
    }
    .btn:hover{ box-shadow: 0 10px 22px rgba(17,24,39,.10); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(47,111,237,1) 0%, rgba(37,99,235,1) 100%);
      border-color: rgba(37,99,235,.55);
      color:#fff;
    }
    .btn.dark{
      background: #111827;
      border-color: rgba(17,24,39,.7);
      color:#fff;
    }
    .btn.danger{
      background: #fff1f2;
      border-color: rgba(225,29,72,.25);
      color: #9f1239;
    }
    .btn.small{
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow:none;
    }
    .btnRow{ display:flex; gap: 8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .logBox{
      border:1px dashed rgba(107,114,128,.35);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,.6);
      max-height: 340px;
      overflow:auto;
      font-size: 12px;
      color: #111827;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .muted{ color: var(--muted); }

    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(17,24,39,.45);
      backdrop-filter: blur(6px);
      z-index: 20;
      padding: 18px;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border-radius: 18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(229,231,235,.9);
      box-shadow: 0 24px 60px rgba(17,24,39,.22);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .modalHead .cap{ font-weight: 650; }
    .modalBody{ padding: 14px 16px; }
    .choices{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .modalFoot{
      padding: 12px 16px;
      border-top: 1px solid var(--line);
      display:flex; justify-content:flex-end; gap: 10px;
    }

    .cleanGame{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .poop{
      width: 100%; aspect-ratio: 1 / 1;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.9);
      background: rgba(17,24,39,.06);
      cursor:pointer;
      position: relative;
      overflow:hidden;
    }
    .poop::after{
      content:"";
      position:absolute; inset: 18%;
      border-radius: 14px;
      background: rgba(120,53,15,.35);
      transform: rotate(18deg);
      filter: blur(.2px);
    }
    .poop.clean{
      background: rgba(16,185,129,.10);
      cursor: default;
    }
    .poop.clean::after{ display:none; }

    .thanks{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index: 10;
      background: rgba(255,255,255,.80);
      backdrop-filter: blur(6px);
    }
    .thanks.show{ display:flex; }
    .thanks .word{
      font-size: 38px;
      letter-spacing: .08em;
      color: #111827;
    }

    .shareBox{
      display:flex; gap: 10px; align-items:center; flex-wrap:wrap;
      margin-top: 10px;
    }
    input[type="text"]{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div style="font-weight:700;">3日間のお世話ゲーム</div>
        <div class="small" id="modeLabel">記録は静かに残ります</div>
      </div>

      <div class="hearts">
        <div class="pill" id="sitterPill" title="シッターONで時間停止">
          <span class="dot" id="sitterDot"></span>
          <span id="sitterText">進行中</span>
        </div>
        <div class="heartRow" id="heartRow" aria-label="ハート"></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHead">
          <div>
            <div style="font-weight:650;">いま</div>
            <div class="sub" id="subHint">状態は言葉にしません</div>
          </div>
          <div class="btnRow">
            <button class="btn small" id="btnSitter">シッター</button>
            <button class="btn small" id="btnShare">共有</button>
            <button class="btn small danger" id="btnReset">リセット</button>
          </div>
        </div>

        <div class="stage" id="stage">
          <div class="thanks" id="thanks">
            <div class="word">ありがとう</div>
          </div>

          <!-- 卵 -->
          <div class="eggWrap" id="eggWrap" style="display:none;">
            <img class="eggImg" id="eggImg" alt="たまご" />
          </div>

          <!-- 生まれた子（2人横並び） -->
          <div class="petRow" id="petRow" style="display:none;">
            <div class="petSlot" id="petA">
              <img class="petImg" id="petImgA" alt="キャラクターA" />
            </div>
            <div class="petSlot" id="petB">
              <img class="petImg" id="petImgB" alt="キャラクターB" />
            </div>
          </div>
        </div>

        <div class="cardBody">
          <div class="actions" id="actions">
            <button class="btn" id="actFood"><span>食事</span><span class="muted">2択</span></button>
            <button class="btn" id="actOut"><span>お出かけ</span><span class="muted">2択</span></button>
            <button class="btn" id="actMini"><span>ミニゲーム</span><span class="muted">2択</span></button>
            <button class="btn" id="actClean"><span>おそうじ</span><span class="muted">2択</span></button>
          </div>

          <div style="display:flex; gap:10px; margin-top: 12px; flex-wrap:wrap;">
            <!-- マカロン/ドリンクは「絵」を出さず、テキストだけ -->
            <button class="btn small dark" id="useDrink">ドリンク</button>
            <button class="btn small dark" id="useMacaron">マカロン</button>
            <div class="pill" title="明示的な残り時間表示はしません">
              <span class="muted">時間は内側で進みます</span>
            </div>
          </div>

          <div class="muted" style="margin-top:10px; font-size:12px;">
            正解や評価は出しません。選んだことだけが残ります。
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <div style="font-weight:650;">ログ</div>
            <div class="sub">日ごとの事実</div>
          </div>
          <div class="btnRow">
            <button class="btn small" id="btnShowLog">表示更新</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="logBox" id="logBox"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- モーダル -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <div class="cap" id="modalTitle">選択</div>
        <button class="btn small" id="modalClose">閉じる</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot" style="display:none;"></div>
    </div>
  </div>

<script>
/* =========================
   画像差し替えポイント
   public/ から始まるパスにしてください
   ========================= */
const ASSETS = {
  egg: "public/char/egg.png",

  /* 生まれた2人（横並び） */
  babyA: "public/char/baby_blue.png",
  babyB: "public/char/baby_pink.png",

  /* もし将来、成長段階を増やすならここに追加できます */
};

const CFG = {
  hatchMs: 3 * 60 * 1000,         // 卵→誕生：3分
  lifeMs:  3 * 24 * 60 * 60 * 1000, // 寿命：3日（リアル時間基準）
  reviveMs: 20 * 60 * 1000,       // マカロンで一時復活（違和感あり）
  drinkExtendMs: 2 * 60 * 60 * 1000, // ドリンクで少し延命
  tickMs: 1000,

  /* 状態進行（内部パラメータ） */
  hungerRatePerHour: 12,   // 1時間あたり
  wasteRatePerHour:  10,
};

/* localStorageキー */
const LS_KEY = "tmd_care_v1";

/* DOM */
const $ = (id)=>document.getElementById(id);
const eggWrap = $("eggWrap");
const eggImg  = $("eggImg");
const petRow  = $("petRow");
const petA    = $("petA");
const petB    = $("petB");
const petImgA = $("petImgA");
const petImgB = $("petImgB");
const thanks  = $("thanks");

const heartRow = $("heartRow");
const logBox = $("logBox");
const modeLabel = $("modeLabel");
const actions = $("actions");

const sitterDot = $("sitterDot");
const sitterText = $("sitterText");
const sitterPill = $("sitterPill");

/* overlay */
const overlay = $("overlay");
const modalTitle = $("modalTitle");
const modalBody = $("modalBody");
const modalFoot = $("modalFoot");
$("modalClose").addEventListener("click", ()=>hideModal());

/* URLモード */
const url = new URL(location.href);
const isObserve = url.searchParams.has("observe");

/* 状態 */
let state = loadState();

/* 観察モード */
if (isObserve) {
  modeLabel.textContent = "観察用ログ（操作できません）";
  actions.style.display = "none";
  $("btnSitter").style.display = "none";
  $("btnReset").style.display = "none";
  $("useDrink").style.display = "none";
  $("useMacaron").style.display = "none";
  $("btnShare").style.display = "none";
  $("subHint").textContent = "操作はできません";
  $("btnShowLog").textContent = "ログを表示";
} else {
  modeLabel.textContent = "あなたの選択が残ります";
}

/* 画像セット（マカロン画像はスタートに出しません） */
eggImg.src = ASSETS.egg;
petImgA.src = ASSETS.babyA;
petImgB.src = ASSETS.babyB;

/* 画像が無いときの保険 */
[eggImg, petImgA, petImgB].forEach(img=>{
  img.addEventListener("error", ()=>{
    img.style.display = "none";
    const ph = document.createElement("div");
    ph.style.width = "100%";
    ph.style.height = "100%";
    ph.style.borderRadius = "22px";
    ph.style.border = "1px solid rgba(229,231,235,.9)";
    ph.style.background = "rgba(17,24,39,.06)";
    ph.style.display = "flex";
    ph.style.alignItems = "center";
    ph.style.justifyContent = "center";
    ph.style.color = "rgba(107,114,128,.85)";
    ph.style.fontSize = "12px";
    ph.textContent = "画像を差し替えてください";
    img.parentElement.appendChild(ph);
  });
});

/* 初期化 */
if (!state) state = freshState();
saveState();

/* 観察URLの場合、hashにデータが入っていれば読み込む */
if (isObserve) {
  const imported = tryImportFromHash();
  if (imported) {
    state = imported;
  }
}

/* UIイベント */
$("btnShowLog").addEventListener("click", ()=>renderLog());
$("btnShare").addEventListener("click", ()=>openShare());
$("btnReset").addEventListener("click", ()=>{
  if (!confirm("本当にリセットしますか？ログも消えます。")) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
});

$("btnSitter").addEventListener("click", ()=>{
  if (isObserve) return;
  toggleSitter();
});

$("actFood").addEventListener("click", ()=>openTwoChoice("食事", [
  {label:"軽い食事",  key:"food_light"},
  {label:"しっかり食事", key:"food_heavy"},
], (choiceKey)=>applyCare("food", choiceKey)));

$("actOut").addEventListener("click", ()=>openTwoChoice("お出かけ", [
  {label:"外に出る", key:"out_go"},
  {label:"家で過ごす", key:"out_home"},
], (choiceKey)=>applyCare("outing", choiceKey)));

$("actMini").addEventListener("click", ()=>openTwoChoice("ミニゲーム", [
  {label:"左の箱を選ぶ", key:"mini_left"},
  {label:"右の箱を選ぶ", key:"mini_right"},
], (choiceKey)=>applyCare("mini", choiceKey)));

$("actClean").addEventListener("click", ()=>openTwoChoice("おそうじ", [
  {label:"今すぐやる", key:"clean_now"},
  {label:"あとで", key:"clean_later"},
], (choiceKey)=>{
  if (choiceKey === "clean_now") {
    openCleanGame();
  } else {
    applyCare("clean", choiceKey);
    hideModal();
  }
}));

$("useDrink").addEventListener("click", ()=>{
  if (isObserve) return;
  if (!isAliveVirtual()) return; // 生存中のみ
  applyItem("drink");
});

$("useMacaron").addEventListener("click", ()=>{
  if (isObserve) return;
  if (isAliveVirtual()) return; // 死後のみ
  applyItem("macaron");
});

/* ループ */
renderAll();
renderLog();
setInterval(()=>tick(), CFG.tickMs);

/* =========================
   時間（シッター停止に対応）
   ========================= */
function realNow(){ return Date.now(); }

/* 仮想時間（シッター中は止まる） */
function virtualNow(){
  if (state.sitter.on) return state.sitter.frozenVirtualMs;
  return realNow() - state.sitter.pausedTotalMs;
}

function toggleSitter(){
  if (!state.sitter.on) {
    state.sitter.on = true;
    state.sitter.startedRealMs = realNow();
    state.sitter.frozenVirtualMs = virtualNow();
    logSitterStart();
  } else {
    const used = realNow() - state.sitter.startedRealMs;
    state.sitter.pausedTotalMs += used;
    state.sitter.on = false;
    state.sitter.startedRealMs = null;
    logSitterStop(used);
  }
  saveState();
  renderTop();
}

function logSitterStart(){
  const d = dayIndex();
  ensureDay(d);
  state.log.days[d].sitterEvents.push({type:"on", at: isoNow()});
}

function logSitterStop(ms){
  const d = dayIndex();
  ensureDay(d);
  state.log.days[d].sitterMs += ms;
  state.log.days[d].sitterEvents.push({type:"off", at: isoNow(), ms});
}

/* =========================
   ゲーム状態判定
   ========================= */
function arrivalMs(){ return state.time.arrivalVirtualMs; }
function hatchMs(){ return state.time.hatchVirtualMs; }
function deathMs(){ return state.time.deathVirtualMs; }

function isHatchedVirtual(){
  return virtualNow() >= hatchMs();
}

function isAliveVirtual(){
  const v = virtualNow();
  const aliveByLife = v < deathMs();
  const revived = (state.time.reviveUntilVirtualMs && v < state.time.reviveUntilVirtualMs);
  return aliveByLife || revived;
}

function isDeadVirtual(){
  return !isAliveVirtual();
}

function dayIndex(){
  const v = virtualNow();
  const d = Math.floor((v - arrivalMs()) / (24*60*60*1000)) + 1;
  return Math.max(1, Math.min(3, d));
}

/* =========================
   tick：内部パラメータ進行
   ========================= */
function tick(){
  if (!state) return;

  /* 終了後は固定 */
  if (state.flags.ended) {
    renderTop();
    return;
  }

  /* 死後（かつ復活していない）→ありがとう */
  if (isDeadVirtual()) {
    state.flags.ended = true;
    saveState();
    renderAll();
    renderLog();
    return;
  }

  const v = virtualNow();
  const dt = Math.max(0, v - state.time.lastTickVirtualMs);
  state.time.lastTickVirtualMs = v;

  /* まだ誕生前 */
  if (!isHatchedVirtual()) {
    const remain = hatchMs() - v;
    eggWrap.classList.toggle("hatching", remain <= 15000); // 15秒前から少し浮く
    saveState();
    renderAll();
    return;
  }

  /* 生存中の内部変化 */
  const hour = dt / (60*60*1000);
  state.needs.hunger = clamp01(state.needs.hunger + (CFG.hungerRatePerHour/100) * hour);
  state.needs.waste  = clamp01(state.needs.waste  + (CFG.wasteRatePerHour/100)  * hour);

  /* 気分：空腹と排泄でゆっくり悪化（ラベルは出さない） */
  const bad = Math.max(state.needs.hunger, state.needs.waste);
  state.mood = (bad < 0.45) ? "good" : (bad < 0.75 ? "low" : "cry");

  saveState();
  renderAll();
}

/* =========================
   お世話とアイテム
   ========================= */
function applyCare(type, choiceKey){
  if (!isHatchedVirtual()) return;
  if (!isAliveVirtual()) return;
  if (state.sitter.on) return; // 時間停止中は操作できない（設計上、止めたまま触ると混乱しやすいので）

  const d = dayIndex();
  ensureDay(d);

  /* 影響は説明しない。ここでは微妙に変化だけつける */
  let heartDelta = 0;

  if (type === "food") {
    state.needs.hunger = clamp01(state.needs.hunger - (choiceKey === "food_heavy" ? 0.38 : 0.22));
    heartDelta = (choiceKey === "food_heavy") ? +2 : +1;
  }
  if (type === "outing") {
    state.needs.hunger = clamp01(state.needs.hunger + 0.06); // 出かけると少しお腹が減る感じ
    state.needs.waste  = clamp01(state.needs.waste  + 0.05);
    heartDelta = (choiceKey === "out_go") ? +2 : +1;
  }
  if (type === "mini") {
    heartDelta = (Math.random() < 0.5) ? +1 : +2;
    state.needs.hunger = clamp01(state.needs.hunger + 0.03);
  }
  if (type === "clean") {
    /* あとで を選ぶと、排泄が進むだけ */
    heartDelta = 0;
    state.needs.waste = clamp01(state.needs.waste + 0.08);
  }

  /* 反映 */
  state.hearts = clampInt(state.hearts + heartDelta, 0, 10);

  /* ログ（事実だけ） */
  const day = state.log.days[d];
  day.actions[type] = (day.actions[type] || 0) + 1;
  day.choices.push({at: isoNow(), type, choice: choiceKey});
  day.heartDelta += heartDelta;

  saveState();
  renderAll();
  renderLog();
  hideModal();
}

function applyItem(item){
  const d = dayIndex();
  ensureDay(d);

  if (item === "drink") {
    if (state.items.drinkUsed >= 3) return;
    state.items.drinkUsed += 1;

    /* 少し戻す／延ばす（説明しないが実際には延命+ needs軽減） */
    state.time.deathVirtualMs += CFG.drinkExtendMs;
    state.needs.hunger = clamp01(state.needs.hunger - 0.18);
    state.needs.waste  = clamp01(state.needs.waste  - 0.12);
    state.hearts = clampInt(state.hearts + 1, 0, 10);

    const day = state.log.days[d];
    day.actions.drink = (day.actions.drink || 0) + 1;
    day.choices.push({at: isoNow(), type:"drink", choice:"use"});
    day.heartDelta += 1;
  }

  if (item === "macaron") {
    if (state.items.macaronUsed >= 2) return;
    /* 死後のみ */
    if (!isDeadVirtual()) return;

    state.items.macaronUsed += 1;
    state.time.reviveUntilVirtualMs = virtualNow() + CFG.reviveMs;
    state.flags.weirdRevive = true;

    /* 回復しすぎない */
    state.needs.hunger = clamp01(Math.max(state.needs.hunger, 0.55));
    state.needs.waste  = clamp01(Math.max(state.needs.waste,  0.45));

    const day = state.log.days[d];
    day.actions.macaron = (day.actions.macaron || 0) + 1;
    day.choices.push({at: isoNow(), type:"macaron", choice:"use"});
  }

  saveState();
  renderAll();
  renderLog();
}

/* おそうじミニゲーム（今すぐ） */
function openCleanGame(){
  if (!isHatchedVirtual()) return;
  if (!isAliveVirtual()) return;

  showModal("おそうじ（小さなゲーム）", "");
  modalFoot.style.display = "none";

  const p = document.createElement("div");
  p.className = "muted";
  p.style.fontSize = "12px";
  p.textContent = "全部タップしたら終わりです（理由は言いません）";
  modalBody.appendChild(p);

  const grid = document.createElement("div");
  grid.className = "cleanGame";
  modalBody.appendChild(grid);

  let cleaned = 0;
  const total = 6;

  for (let i=0;i<total;i++){
    const cell = document.createElement("div");
    cell.className = "poop";
    cell.addEventListener("click", ()=>{
      if (cell.classList.contains("clean")) return;
      cell.classList.add("clean");
      cleaned++;
      if (cleaned >= total){
        finishCleanGame();
      }
    });
    grid.appendChild(cell);
  }

  function finishCleanGame(){
    const d = dayIndex();
    ensureDay(d);

    state.needs.waste = clamp01(state.needs.waste - 0.42);
    state.hearts = clampInt(state.hearts + 1, 0, 10);

    const day = state.log.days[d];
    day.actions.clean = (day.actions.clean || 0) + 1;
    day.choices.push({at: isoNow(), type:"clean", choice:"clean_game"});
    day.heartDelta += 1;

    saveState();
    renderAll();
    renderLog();
    hideModal();
  }
}

/* =========================
   モーダル
   ========================= */
function openTwoChoice(title, options, onPick){
  if (isObserve) return;
  if (!isHatchedVirtual()) return;     // 誕生前は操作なし
  if (!isAliveVirtual()) return;       // 終了後は操作なし
  if (state.sitter.on) return;         // シッター中は止める

  showModal(title, "");
  const wrap = document.createElement("div");
  wrap.className = "choices";

  options.forEach(opt=>{
    const b = document.createElement("button");
    b.className = "btn";
    b.innerHTML = `<span>${escapeHtml(opt.label)}</span><span class="muted">選ぶ</span>`;
    b.addEventListener("click", ()=>onPick(opt.key));
    wrap.appendChild(b);
  });

  modalBody.appendChild(wrap);
}

function showModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html || "";
  overlay.classList.add("show");
}
function hideModal(){
  overlay.classList.remove("show");
  modalBody.innerHTML = "";
  modalFoot.style.display = "none";
}

/* =========================
   共有（観察用ログURL）
   静的サイトのため、URLにデータを埋め込みます
   ========================= */
function openShare(){
  const shareUrl = buildShareURL();
  showModal("共有（観察用）", `
    <div class="muted" style="font-size:12px; line-height:1.6;">
      このURLを開いた人は、ログとハート推移だけを見られます（操作はできません）。
    </div>
    <div class="shareBox">
      <input type="text" value="${escapeAttr(shareUrl)}" readonly id="shareInput">
      <button class="btn primary" id="copyBtn"><span>コピー</span><span>⧉</span></button>
    </div>
    <div class="muted" style="font-size:12px; margin-top:8px;">
      ※ サーバーは使っていないので、ログはURLに含まれます。
    </div>
  `);

  setTimeout(()=>{
    const inp = $("shareInput");
    const btn = $("copyBtn");
    if (!inp || !btn) return;
    btn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(inp.value);
        btn.innerHTML = `<span>コピーしました</span><span>✓</span>`;
      }catch(e){
        inp.select();
        document.execCommand("copy");
      }
    });
  },0);
}

function buildShareURL(){
  const payload = {
    v: 1,
    time: state.time,
    hearts: state.hearts,
    log: state.log,
    items: state.items,
  };
  const packed = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  const base = location.origin + location.pathname;
  const id = state.playerId;
  return `${base}?observe=${encodeURIComponent(id)}#data=${encodeURIComponent(packed)}`;
}

function tryImportFromHash(){
  const h = location.hash || "";
  const m = h.match(/data=([^&]+)/);
  if (!m) return null;
  try{
    const json = decodeURIComponent(escape(atob(decodeURIComponent(m[1]))));
    const payload = JSON.parse(json);
    if (!payload || payload.v !== 1) return null;

    const s = freshState();
    s.playerId = url.searchParams.get("observe") || s.playerId;
    s.time = payload.time || s.time;
    s.hearts = payload.hearts ?? s.hearts;
    s.log = payload.log || s.log;
    s.items = payload.items || s.items;

    /* 観察用なので進行は止める */
    s.sitter = {on:true, frozenVirtualMs: s.time.lastTickVirtualMs || s.time.arrivalVirtualMs, pausedTotalMs: 0, startedRealMs: null};
    s.flags.ended = true; // 観察は固定表示
    return s;
  }catch(e){
    return null;
  }
}

/* =========================
   描画
   ========================= */
function renderAll(){
  renderStage();
  renderTop();
}

function renderTop(){
  /* ハート表示（強調しすぎない） */
  heartRow.innerHTML = "";
  const n = clampInt(state.hearts, 0, 10);
  for (let i=0;i<10;i++){
    const d = document.createElement("div");
    d.className = "h" + (i < n ? " on" : "");
    heartRow.appendChild(d);
  }

  /* シッター表示 */
  if (state.sitter.on) {
    sitterDot.classList.add("pause");
    sitterText.textContent = "停止中";
  } else {
    sitterDot.classList.remove("pause");
    sitterText.textContent = "進行中";
  }
}

function renderStage(){
  /* ありがとう（終了） */
  thanks.classList.toggle("show", !!state.flags.ended);

  /* 誕生前 */
  if (!isHatchedVirtual()){
    eggWrap.style.display = "";
    petRow.style.display = "none";
    /* 15秒前から少し浮くのは tick() 側 */
    setMoodClass(null);
    setWeird(false);
    return;
  }

  /* 誕生後 */
  eggWrap.style.display = "none";
  petRow.style.display = "";

  /* 気分（ラベル無し、動きだけ） */
  setMoodClass(state.mood);

  /* 復活の違和感 */
  setWeird(!!state.flags.weirdRevive && !state.flags.ended);
}

function setMoodClass(mood){
  const moods = ["mood-good","mood-low","mood-cry"];
  [petA, petB].forEach(el=>{
    moods.forEach(c=>el.classList.remove(c));
    if (mood === "good") el.classList.add("mood-good");
    if (mood === "low")  el.classList.add("mood-low");
    if (mood === "cry")  el.classList.add("mood-cry");
  });
}

function setWeird(on){
  [petA, petB].forEach(el=>{
    el.classList.toggle("weird", on);
  });
}

/* ログ表示 */
function renderLog(){
  const lines = [];
  lines.push(`ID: ${state.playerId}`);
  lines.push(``);

  for (let d=1; d<=3; d++){
    ensureDay(d);
    const day = state.log.days[d];
    lines.push(`Day ${d}`);
    lines.push(`  お世話回数`);
    lines.push(`    食事: ${day.actions.food || 0}`);
    lines.push(`    お出かけ: ${day.actions.outing || 0}`);
    lines.push(`    ミニゲーム: ${day.actions.mini || 0}`);
    lines.push(`    おそうじ: ${day.actions.clean || 0}`);
    lines.push(`  アイテム`);
    lines.push(`    ドリンク: ${day.actions.drink || 0}`);
    lines.push(`    マカロン: ${day.actions.macaron || 0}`);
    lines.push(`  ハート変化: ${signed(day.heartDelta || 0)}`);
    lines.push(`  シッター: ${msToShort(day.sitterMs || 0)}`);
    lines.push(`  選択`);
    if (!day.choices.length){
      lines.push(`    （なし）`);
    } else {
      day.choices.slice(-18).forEach(c=>{
        lines.push(`    - ${c.at} / ${c.type} / ${c.choice}`);
      });
      if (day.choices.length > 18) lines.push(`    …（省略）`);
    }
    lines.push(``);
  }

  lines.push(`累計`);
  lines.push(`  ドリンク使用: ${state.items.drinkUsed}/3`);
  lines.push(`  マカロン使用: ${state.items.macaronUsed}/2`);

  logBox.textContent = lines.join("\n");
}

/* =========================
   保存・読み込み
   ========================= */
function loadState(){
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

function freshState(){
  const vNow = realNow(); // 初回は仮想=実時間
  const pid = makeId();

  return {
    playerId: pid,

    time: {
      arrivalVirtualMs: vNow,
      hatchVirtualMs: vNow + CFG.hatchMs,
      deathVirtualMs: vNow + CFG.lifeMs,
      reviveUntilVirtualMs: null,
      lastTickVirtualMs: vNow,
    },

    sitter: {
      on: false,
      pausedTotalMs: 0,
      startedRealMs: null,
      frozenVirtualMs: null,
    },

    needs: {
      hunger: 0.15,
      waste:  0.12,
    },

    mood: "good",
    hearts: 3,

    items: {
      drinkUsed: 0,
      macaronUsed: 0,
    },

    flags: {
      ended: false,
      weirdRevive: false,
    },

    log: {
      days: {
        1: blankDay(),
        2: blankDay(),
        3: blankDay(),
      }
    }
  };
}

function blankDay(){
  return {
    actions: { food:0, outing:0, mini:0, clean:0, drink:0, macaron:0 },
    choices: [],
    heartDelta: 0,
    sitterMs: 0,
    sitterEvents: [],
  };
}

function ensureDay(d){
  if (!state.log.days) state.log.days = {};
  if (!state.log.days[d]) state.log.days[d] = blankDay();
}

/* =========================
   ユーティリティ
   ========================= */
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function clampInt(x, a, b){ x = Math.round(x); return Math.max(a, Math.min(b, x)); }
function isoNow(){
  const dt = new Date();
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  const hh = String(dt.getHours()).padStart(2,"0");
  const mm = String(dt.getMinutes()).padStart(2,"0");
  const ss = String(dt.getSeconds()).padStart(2,"0");
  return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
}
function signed(n){ return (n>0?`+${n}`:`${n}`); }
function msToShort(ms){
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  if (h<=0 && m<=0) return "0m";
  if (h<=0) return `${m}m`;
  return `${h}h ${m}m`;
}
function makeId(){
  return "p" + Math.random().toString(36).slice(2,8) + "-" + Math.random().toString(36).slice(2,6);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){
  return escapeHtml(s).replace(/"/g,"&quot;");
}
</script>
</body>
</html>
