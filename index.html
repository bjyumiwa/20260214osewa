<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3Êó•Èñì„ÅÆ„Åä‰∏ñË©±„Ç≤„Éº„É†Ôºà2DÔºâ</title>
  <style>
    :root{
      --bg0:#050816;
      --bg1:#0b1028;
      --card:rgba(255,255,255,.08);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.72);
      --line:rgba(255,255,255,.14);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background:
        linear-gradient(180deg, rgba(5,8,22,.55), rgba(11,16,40,.70)),
        url("public/char/space_background.png") center/cover no-repeat fixed;
      min-height:100vh;
      overflow-x:hidden;
    }

    .wrap{max-width: 1100px; margin:0 auto; padding: 18px 14px 40px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 10px;
      backdrop-filter: blur(10px);
      z-index: 20;
      flex-wrap: wrap;
    }
    .brand{display:flex; gap:10px; align-items:center;}
    .brand .dot{
      width:12px;height:12px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.1)),
                  linear-gradient(180deg, #c4b5fd, #93c5fd);
      box-shadow: 0 0 18px rgba(196,181,253,.35);
    }
    .brand .title{font-weight: 750; letter-spacing:.02em; font-size: 14px; line-height: 1.2;}
    .brand .sub{font-size: 12px; color: var(--muted); margin-top: 2px;}
    .statusRow{display:flex; gap: 10px; align-items:center; justify-content:flex-end; flex: 1; flex-wrap: wrap;}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      min-height: 34px;
      position: relative;
    }
    .pill small{color: var(--muted);}

    .heartIcon{
      width:16px;height:16px; display:inline-block;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.1)),
                  linear-gradient(180deg, rgba(251,113,133,.95), rgba(196,181,253,.85));
      clip-path: path("M8 14s6-3.3 6-7.2C14 4.6 12.8 3 10.8 3 9.6 3 8.7 3.7 8 4.6 7.3 3.7 6.4 3 5.2 3 3.2 3 2 4.6 2 6.8 2 10.7 8 14 8 14Z");
      opacity:.95;
    }
    .hearts{
      width: 140px; height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      overflow:hidden;
    }
    .hearts > i{
      display:block; height:100%; width:50%;
      background: linear-gradient(90deg, rgba(196,181,253,.95), rgba(147,197,253,.95));
      box-shadow: 0 0 14px rgba(147,197,253,.25);
    }

    .langSel{
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(238,242,255,.92);
      border-radius: 12px;
      padding: 8px 28px 8px 10px;
      font-weight: 700;
      cursor: pointer;
      outline: none;
      line-height: 1;
    }
    .langSel option{background:#0b1028; color:#eef2ff;}
    .pill[title="Language"]::after{
      content:"‚ñæ";
      position:absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(238,242,255,.72);
      pointer-events:none;
      font-size: 12px;
    }

    .toggle{display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;}
    .switch{
      width:42px;height:24px;border-radius:999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      position: relative;
      transition: .18s ease;
    }
    .switch::after{
      content:"";
      width:18px;height:18px;border-radius:999px;
      position:absolute; top:2px; left:2px;
      background: rgba(255,255,255,.85);
      box-shadow: 0 8px 14px rgba(0,0,0,.25);
      transition: .18s ease;
    }
    .toggle[data-on="true"] .switch{
      background: rgba(154,230,180,.18);
      border-color: rgba(154,230,180,.28);
    }
    .toggle[data-on="true"] .switch::after{
      left: 20px;
      background: rgba(154,230,180,.95);
    }

    .main{margin-top: 14px; display:grid; grid-template-columns: 1.5fr 1fr; gap: 14px; align-items:start;}
    .card{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      flex-wrap: wrap;
    }
    .cardHeader .h{font-weight: 800; font-size: 14px;}
    .cardHeader .hint{font-size:12px;color:var(--muted); margin-top: 2px;}
    .btnRow{display:flex; gap: 10px; flex-wrap: wrap;}

    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 10px;
      cursor:pointer;
      font-weight: 650;
      letter-spacing:.01em;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      transition: transform .08s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22);}
    button:active{transform: translateY(0px) scale(.99);}
    button[disabled]{opacity:.45; cursor:not-allowed; transform:none;}
    .btnGhost{background: rgba(255,255,255,.03); padding: 10px 10px;}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap: 10px;}

    .stage{
      position: relative;
      min-height: 520px;
      padding: 14px;
    }
    .sky{position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 60% 10%, rgba(196,181,253,.10), transparent 60%),
        radial-gradient(900px 600px at 15% 80%, rgba(147,197,253,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0));
    }
    .stars{
      position:absolute; inset:0; pointer-events:none; opacity:.55;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.8) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 70%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 30%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 85% 75%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 25% 50%, rgba(255,255,255,.55) 0 1px, transparent 2px);
      background-size: 420px 260px;
      filter: blur(.2px);
      animation: drift 18s linear infinite;
    }
    @keyframes drift{
      0%{transform: translate3d(0,0,0);}
      100%{transform: translate3d(-80px, 50px, 0);}
    }
    .center{
      position:absolute;
      left:50%;
      top: 55%;
      transform: translate(-50%,-50%);
      width: 100%;
      max-width: 560px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      padding: 12px;
    }
    .entity{
      width: 280px;
      height: 280px;
      display:grid;
      place-items:center;
      position: relative;
    }
    .floaty{animation: floaty 2.6s ease-in-out infinite;}
    @keyframes floaty{
      0%,100%{transform: translateY(0);}
      50%{transform: translateY(-10px);}
    }

    .macaronWrap{width: 260px; height: 260px; display:grid; place-items:center; position: relative;}
    .macaronImg{
      width: 210px; height: 210px; object-fit: contain;
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.35));
      opacity: .98;
    }
    .hatchLift{animation: hatchLift 1.6s ease-in-out 1 forwards;}
    @keyframes hatchLift{
      0%{transform: translateY(0) scale(1); opacity: 1;}
      60%{transform: translateY(-26px) scale(1.02); opacity: 1;}
      100%{transform: translateY(-60px) scale(.95); opacity: 0;}
    }

    .charWrap{
      width: 260px; height: 260px;
      display:grid; place-items:center;
      position: relative;
      filter: drop-shadow(0 18px 26px rgba(0,0,0,.35));
    }
    .charScaleBox{
      width: 100%;
      height: 100%;
      display:grid;
      place-items:center;
      transform-origin: 50% 55%;
      transition: transform .25s ease;
    }
    .charImg{
      width: 230px; height: 230px; object-fit: contain; opacity: .98; transition: .18s ease;
    }
    .charWrap.lively{animation: livelyBounce 1.4s ease-in-out infinite;}
    @keyframes livelyBounce{
      0%,100%{transform: translateY(0) rotate(0deg);}
      50%{transform: translateY(-7px) rotate(.6deg);}
    }
    .charWrap.low .charImg{filter: saturate(.75) brightness(.95); transform: translateY(2px);}
    .charWrap.cry .charImg{filter: saturate(.65) brightness(.9); animation: cryShake .18s steps(2) infinite;}
    @keyframes cryShake{
      0%{transform: translate(0,0);}
      50%{transform: translate(2px,-1px);}
      100%{transform: translate(-1px,1px);}
    }

    .charWrap.sleep{animation: sleepBreath 2.8s ease-in-out infinite;}
    .charWrap.sleep .charImg{filter: saturate(.9) brightness(.96); transform: translateY(3px);}
    @keyframes sleepBreath{
      0%,100%{transform: translateY(2px);}
      50%{transform: translateY(-4px);}
    }

    .tears{position:absolute; inset:0; pointer-events:none; opacity:0; transition:.18s ease;}
    .charWrap.cry .tears{opacity:1;}
    .tear{
      position:absolute;
      width: 10px; height: 18px;
      border-radius: 999px;
      background: rgba(147,197,253,.72);
      left: 92px; top: 130px;
      transform: rotate(10deg);
      animation: tearDrop 1.2s ease-in-out infinite;
      filter: blur(.1px);
    }
    .tear:nth-child(2){
      left: 150px; top: 132px;
      transform: rotate(-8deg);
      animation-delay: .22s;
      opacity:.9;
    }
    @keyframes tearDrop{
      0%{transform: translateY(0) scale(1) rotate(10deg); opacity:.0;}
      35%{opacity:.75;}
      100%{transform: translateY(26px) scale(.95) rotate(10deg); opacity:0;}
    }

    .poops{
      position:absolute;
      left: 18px;
      bottom: 18px;
      display:flex;
      gap: 8px;
      align-items:center;
      opacity:.95;
    }
    .poop{
      width: 18px; height: 18px;
      border-radius: 6px;
      background: linear-gradient(180deg, rgba(251,146,60,.92), rgba(234,179,8,.82));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 16px rgba(0,0,0,.25);
      transform: rotate(-8deg);
      opacity:.0;
      transition: .18s ease;
    }
    .poop.on{opacity:.95;}
    .poop:nth-child(2){transform: rotate(9deg) translateY(-2px);}
    .poop:nth-child(3){transform: rotate(-4deg) translateY(1px);}

    .stageNote{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      opacity:.95;
      line-height: 1.6;
      white-space: pre-wrap;
      min-height: 42px;
    }

    .rightPane{display:flex; flex-direction:column; gap: 14px;}
    .actions{padding: 12px; display:flex; flex-direction:column; gap: 10px;}
    .logPane{padding: 12px;}
    .mini{font-size: 12px; color: var(--muted); line-height: 1.6;}
    .logList{margin-top: 10px; display:flex; flex-direction:column; gap: 8px; max-height: 290px; overflow:auto; padding-right: 6px;}
    .logItem{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 12px;
      line-height: 1.5;
    }
    .logItem b{font-size:12px;}
    .logItem .t{color: var(--muted); margin-top: 2px; font-size: 11px;}

    .centerOverlay{
      position:absolute; inset:0;
      display:none; place-items:center;
      z-index: 10;
      pointer-events:none;
    }
    .centerOverlay.show{display:grid;}
    .thanks{font-weight: 900; font-size: 44px; letter-spacing: .06em; text-shadow: 0 18px 48px rgba(0,0,0,.45); opacity:.98;}

    .screen{display:none;}
    .screen.show{display:block;}

    .modalBack{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; place-items:center;
      z-index: 99; padding: 18px;
    }
    .modalBack.show{display:grid;}
    .modal{
      width: min(560px, 96vw);
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(16,18,34,.88);
      border-radius: 18px;
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modalHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .modalHead .h{font-weight: 850; font-size: 14px; letter-spacing:.02em;}
    .modalBody{padding: 12px;}
    .modalFoot{
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex; gap: 10px; justify-content:flex-end; flex-wrap: wrap;
    }
    .two{display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;}
    .choice{
      text-align:left;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition: .18s ease;
      min-height: 96px;
      display:flex; flex-direction:column; gap: 6px; justify-content:center;
    }
    .choice:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.22); transform: translateY(-1px);}
    .choice .cTitle{font-weight: 800; font-size: 13px; display:flex; align-items:center; gap: 8px;}
    .choice .cSub{font-size: 12px; color: var(--muted); line-height:1.5;}
    .cIcon{
      width: 26px; height: 26px;
      border-radius: 10px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      font-size: 16px;
      line-height: 1;
      flex: 0 0 auto;
    }

    .observeWrap{padding: 12px;}
    .observeHeader{display:flex; gap: 10px; align-items:flex-start; justify-content:space-between; flex-wrap: wrap;}
    .observeHeader .h{font-weight: 900; font-size: 16px; letter-spacing:.02em;}
    .observeHeader .p{margin-top: 4px; font-size: 12px; color: var(--muted); line-height:1.6;}
    .chartBox{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px;
    }
    canvas{width:100%; height:160px; display:block;}
    .days{margin-top: 12px; display:flex; flex-direction:column; gap: 10px;}
    .dayCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px;
    }
    .dayCard .dh{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom: 8px;}
    .dayCard .dh b{font-size: 13px;}
    .dayCard .dh small{color: var(--muted);}
    .kvs{display:grid; grid-template-columns: 1fr 1fr; gap: 8px 10px; font-size: 12px; color: rgba(238,242,255,.88); line-height:1.6;}
    .kvs span{color: var(--muted);}
    .choices{
      margin-top: 8px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 8px;
      font-size: 12px;
      color: rgba(238,242,255,.88);
      line-height:1.7;
      white-space: pre-wrap;
    }

    .letterSlot{display:none;}
    .letterSlot.show{
      display:block;
      animation: letterAppear .9s ease-out both;
    }
    .letterSlot.vanish{
      display:block;
      animation: letterVanish .65s ease-in both;
      pointer-events:none;
    }
    @keyframes letterAppear{
      0%{opacity:0; transform: translateY(8px) scale(.98); filter: blur(10px);}
      100%{opacity:1; transform: translateY(0) scale(1); filter: blur(0);}
    }
    @keyframes letterVanish{
      0%{opacity:1; transform: translateY(0) scale(1); filter: blur(0);}
      100%{opacity:0; transform: translateY(10px) scale(.98); filter: blur(10px);}
    }
    .letterBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      animation: letterFloat 3.4s ease-in-out infinite;
    }
    @keyframes letterFloat{
      0%,100%{transform: translateY(0);}
      50%{transform: translateY(-3px);}
    }
    .letterIcon{
      font-size: 18px;
      line-height: 1;
      opacity:.95;
    }
    .letterHint{
      font-size: 12px;
      color: rgba(238,242,255,.86);
      letter-spacing: .02em;
    }
    .letterBtn::before,
    .letterBtn::after{
      content:"";
      position:absolute;
      inset:-25%;
      background:
        radial-gradient(circle at 25% 60%, rgba(255,255,255,.20), transparent 55%),
        radial-gradient(circle at 65% 40%, rgba(255,255,255,.14), transparent 58%),
        radial-gradient(circle at 40% 20%, rgba(255,255,255,.10), transparent 55%);
      filter: blur(12px);
      opacity: 0;
      transform: scale(.98);
      pointer-events:none;
    }
    .letterSlot.show .letterBtn::before{animation: smokePulse 2.6s ease-in-out infinite;}
    .letterSlot.show .letterBtn::after{animation: smokePulse 2.6s ease-in-out infinite .8s;}
    @keyframes smokePulse{
      0%{opacity:0; transform: scale(.98) translateY(8px);}
      35%{opacity:1; transform: scale(1.02) translateY(0);}
      100%{opacity:0; transform: scale(1.05) translateY(-12px);}
    }

    .letterSlot.show.drop{
      animation: letterDrop .95s ease-out both;
    }
    @keyframes letterDrop{
      0%{opacity:0; transform: translateY(-46px) scale(.98); filter: blur(10px);}
      65%{opacity:1; transform: translateY(6px) scale(1.00); filter: blur(0);}
      100%{opacity:1; transform: translateY(0) scale(1.00); filter: blur(0);}
    }

    .letterModal{
      position: fixed;
      inset: 0;
      display:none;
      place-items:center;
      padding: 18px;
      background: rgba(0,0,0,.40);
      z-index: 120;
    }
    .letterModal.open{display:grid; animation: modalIn .25s ease-out both;}
    .letterModal.closing{display:grid; animation: modalOut .22s ease-in both;}
    @keyframes modalIn{from{opacity:0;}to{opacity:1;}}
    @keyframes modalOut{from{opacity:1;}to{opacity:0;}}

    .letterPaper{
      width: min(560px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(16,18,34,.88);
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position: relative;
      animation: paperIn .55s ease-out both;
    }
    .letterModal.closing .letterPaper{animation: paperOut .25s ease-in both;}
    @keyframes paperIn{
      0%{opacity:0; transform: translateY(12px) scale(.98); filter: blur(14px);}
      100%{opacity:1; transform: translateY(0) scale(1); filter: blur(0);}
    }
    @keyframes paperOut{
      0%{opacity:1; transform: translateY(0) scale(1); filter: blur(0);}
      100%{opacity:0; transform: translateY(10px) scale(.98); filter: blur(12px);}
    }
    .letterPaper::before{
      content:"";
      position:absolute;
      inset:-30%;
      background:
        radial-gradient(circle at 30% 70%, rgba(255,255,255,.18), transparent 58%),
        radial-gradient(circle at 70% 35%, rgba(255,255,255,.12), transparent 62%);
      filter: blur(14px);
      opacity: .55;
      pointer-events:none;
      animation: paperSmoke 3.6s ease-in-out infinite;
    }
    @keyframes paperSmoke{
      0%,100%{transform: translateY(0); opacity: .45;}
      50%{transform: translateY(-10px); opacity: .68;}
    }
    .letterHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .letterHead b{
      font-size: 14px;
      letter-spacing:.02em;
    }
    .letterBody{
      padding: 12px;
    }
    .letterText{
      font-size: 13px;
      line-height: 1.85;
      color: rgba(238,242,255,.92);
      white-space: pre-wrap;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .letterFoot{
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:flex-end;
      gap: 10px;
    }

    @media (max-width: 860px){
      .main{grid-template-columns: 1fr;}
      .hearts{width: 120px;}
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title" id="txtGameTitle">3Êó•Èñì„ÅÆ„Åä‰∏ñË©±„Ç≤„Éº„É†Ôºà2DÔºâ</div>
          <div class="sub" id="subline">„É≠„Ç∞Ë®òÈå≤</div>
        </div>
      </div>

      <div class="statusRow">
        <div class="pill" title="Èñ¢‰øÇÊÄß„ÅÆÊåáÊ®ô">
          <span class="heartIcon" aria-hidden="true"></span>
          <div class="hearts" aria-hidden="true"><i id="heartFill"></i></div>
          <small id="heartLabel"></small>
        </div>

        <div class="pill" title="Language">
          <small id="txtLangLabel">Ë®ÄË™û</small>
          <select id="langSel" class="langSel" aria-label="Language">
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="en">English</option>
            <option value="zh">‰∏≠Êñá</option>
          </select>
        </div>

        <div class="pill toggle" id="sitterToggle" data-on="false" title="„Ç∑„ÉÉ„Çø„ÉºON„ÅßÊôÇÈñì„ÅåÊ≠¢„Åæ„Çä„Åæ„ÅôÔºàÂØøÂëΩ„ÉªÁ©∫ËÖπ„ÉªÊéíÊ≥Ñ„ÉªÁä∂ÊÖãÂ§âÂåñ„Åô„Åπ„Å¶ÂÅúÊ≠¢Ôºâ">
          <small id="txtSitter">„Ç∑„ÉÉ„Çø„Éº</small>
          <div class="switch" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <div id="screenGame" class="screen show">
      <div class="main">
        <div class="card">
          <div class="cardHeader">
            <div>
              <div class="h" id="txtStageHeader">„Çπ„ÉÜ„Éº„Ç∏</div>
              <div class="hint" id="stageHint"></div>
            </div>
            <div class="btnRow">
              <button class="btnGhost" id="btnShare">Ë¶≥ÂØüÁî®URL</button>
              <button class="btnGhost" id="btnLogs">„É≠„Ç∞</button>
              <button class="btnGhost" id="btnName">ÂêçÂâç</button>
              <button class="btnGhost" id="btnReset">„ÅØ„Åò„ÇÅ„Åã„Çâ</button>
            </div>
          </div>

          <div class="stage">
            <div class="sky"></div>
            <div class="stars"></div>

            <div class="center">
              <div class="entity">
                <div id="macaronArea" class="macaronWrap floaty" style="display:none;">
                  <img id="macaronImg" class="macaronImg" alt="" src="" />
                </div>

                <div id="charArea" class="charWrap floaty" style="display:none;">
                  <div id="charScaleBox" class="charScaleBox">
                    <img id="charImg" class="charImg" alt="" src="" />
                  </div>
                  <div class="tears" aria-hidden="true">
                    <div class="tear"></div>
                    <div class="tear"></div>
                  </div>
                </div>
              </div>

              <div class="poops" aria-hidden="true">
                <div class="poop" id="poop1"></div>
                <div class="poop" id="poop2"></div>
                <div class="poop" id="poop3"></div>
              </div>

              <div class="stageNote" id="stageNote"></div>
            </div>

            <div class="centerOverlay" id="thanksOverlay" aria-hidden="true">
              <div class="thanks" id="txtThanks">„ÅÇ„Çä„Åå„Å®„ÅÜ</div>
            </div>
          </div>
        </div>

        <div class="rightPane">
          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="h" id="txtCareHeader">„Åä‰∏ñË©±</div>
                <div class="hint" id="txtCareHint">Â•Ω„Åç„Å™Êñπ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
              </div>
            </div>

            <div class="actions">
              <div id="letterSlot" class="letterSlot" aria-label="„ÅäÊâãÁ¥ô">
                <button id="letterBtn" class="letterBtn" type="button" aria-label="„ÅäÊâãÁ¥ô„ÇíË™≠„ÇÄ">
                  <span class="letterIcon">‚úâ</span>
                  <span class="letterHint" id="txtLetterBtn">„ÅäÊâãÁ¥ô</span>
                </button>
              </div>

              <div class="grid">
                <button id="btnFood">üçΩ È£ü‰∫ã</button>
                <button id="btnOut">üöÄ „Åä„Åß„Åã„Åë</button>
                <button id="btnStyle">‚ú® „Åä„Åó„ÇÉ„Çå</button>
                <button id="btnClean">üßº ÊéíÊ≥ÑÈô§Âéª</button>
              </div>
              <div class="grid">
                <button id="btnDrink">ü•§ „Éâ„É™„É≥„ÇØ</button>
                <button id="btnMacaron" disabled>üç¨ „Éû„Ç´„É≠„É≥</button>
              </div>
              <div class="mini" id="assetHint"></div>
            </div>
          </div>

          <div class="card">
            <div class="cardHeader">
              <div>
                <div class="h" id="txtLogHeader">„É≠„Ç∞</div>
                <div class="hint" id="txtLogHint">CSV„Åß‰øùÂ≠ò„Åß„Åç„Åæ„Åô</div>
              </div>
              <div class="btnRow">
                <button id="btnCsv" class="btnGhost">CSV</button>
              </div>
            </div>
            <div class="logPane">
              <div class="mini" id="txtMiniInfo">Ë°®ÊÉÖ„ÇÑÂãï„Åç„Å†„Åë„ÅßÁä∂ÊÖã„ÅåÂ§â„Çè„Çä„Åæ„Åô„ÄÇ</div>
              <div class="logList" id="liveLog"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="screenObserve" class="screen">
      <div class="card">
        <div class="cardHeader">
          <div>
            <div class="h" id="txtObserveHeader">Ë¶≥ÂØüÁî®„É≠„Ç∞</div>
            <div class="hint" id="txtObserveHint">Êìç‰Ωú„ÅØ„Åß„Åç„Åæ„Åõ„ÇìÔºà„É≠„Ç∞„Å®„Éè„Éº„ÉàÊé®Áßª„ÅÆ„ÅøÔºâ</div>
          </div>
          <div class="btnRow">
            <button id="btnBackToGame" class="btnGhost">Êàª„Çã</button>
          </div>
        </div>

        <div class="observeWrap">
          <div class="observeHeader">
            <div>
              <div class="h" id="obsTitle"></div>
              <div class="p" id="obsSub"></div>
            </div>
          </div>

          <div class="chartBox">
            <canvas id="heartChart" width="900" height="220"></canvas>
          </div>

          <div class="days" id="obsDays"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="h" id="modalTitle"></div>
          <div class="hint" id="modalHint"></div>
        </div>
        <button id="modalX" class="btnGhost" style="padding:8px 10px;">Èñâ„Åò„Çã</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

  <div class="letterModal" id="letterModal" aria-hidden="true" inert>
    <div class="letterPaper" role="dialog" aria-modal="true">
      <div class="letterHead">
        <b id="txtLetterTitle">„ÅäÊâãÁ¥ô</b>
        <button id="letterX" class="btnGhost" style="padding:8px 10px;">Èñâ„Åò„Çã</button>
      </div>
      <div class="letterBody">
        <div class="letterText" id="letterText"></div>
      </div>
      <div class="letterFoot">
        <button id="letterClose" class="btnGhost">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const ASSET_BASE = "public/char/";

  const url = new URL(location.href);
  const FAST = url.searchParams.get("fast") === "1";

  const SAVE_KEY = "osewa_save_2d_char_v3";
  const ARCHIVE_KEY = "osewa_archives_2d_char_v3";

  const DAY_MS  = 24 * 60 * 60 * 1000;
  const LIFE_MS = 3 * DAY_MS;

  const HATCH_MS = FAST ? 12 * 1000 : 3 * 60 * 1000;
  const LETTER_DELAY_MS = FAST ? 2500 : 30 * 1000;

  const MACARON_REVIVE_MS = FAST ? 18 * 1000 : 10 * 60 * 1000;
  const DRINK_EXTEND_MS   = FAST ? 20 * 1000 : 60 * 60 * 1000;
  const DRINK_BACK_MS     = FAST ?  8 * 1000 : 30 * 60 * 1000;

  const SLEEP_MS = FAST ? 10 * 1000 : 2 * 60 * 1000;

  const HUNGER_PER_MIN = 0.25;
  const DIRT_PER_MIN   = 0.18;

  const COLORS = ["blue","green","pink","purple"];

  // ÊåáÂÆö„ÅÆ sleep „Éë„Çπ„Çí„Äå„Åù„ÅÆ„Åæ„Åæ„Äç‰ΩøÁî®
  // public/char/blue_sleep.png
  // public/char/green_sleep.png
  // public/char/purple_sleep.png
  // public/char/pick_sleep.pngÔºàpinkÁî®Ôºâ
  const FILES = {
    macaron: {
      blue:   "macaron_blue.png",
      green:  "macaron_green.png",
      pink:   "macaron_pink.png",
      purple: "macaron_purple.png",
    },
    char: {
      blue:   { closed:"blue_closed.png",   open:"blue_open.png",   sleep:"blue_sleep.png" },
      green:  { closed:"green_closed.png",  open:"green_open.png",  sleep:"green_sleep.png" },
      purple: { closed:"purple_closed.png", open:"purple_open.png", sleep:"purple_sleep.png" },
      pink:   { closed:"pink_closed.png",   open:"pink_open.png",   sleep:"pick_sleep.png" },
    }
  };

  const LANG_KEY = "osewa_lang_v3";
  function getLang(){
    const v = localStorage.getItem(LANG_KEY);
    return (v === "en" || v === "zh" || v === "ja") ? v : "ja";
  }
  let LANG = getLang();

  const I18N = {
    ja: {
      docTitle: "3Êó•Èñì„ÅÆ„Åä‰∏ñË©±„Ç≤„Éº„É†Ôºà2DÔºâ",
      gameTitle: "3Êó•Èñì„ÅÆ„Åä‰∏ñË©±„Ç≤„Éº„É†Ôºà2DÔºâ",
      langLabel: "Ë®ÄË™û",
      sitter: "„Ç∑„ÉÉ„Çø„Éº",
      stageHeader: "„Çπ„ÉÜ„Éº„Ç∏",
      careHeader: "„Åä‰∏ñË©±",
      careHint: "Â•Ω„Åç„Å™Êñπ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ",
      letter: "„ÅäÊâãÁ¥ô",
      observeHeader: "Ë¶≥ÂØüÁî®„É≠„Ç∞",
      observeHint: "Êìç‰Ωú„ÅØ„Åß„Åç„Åæ„Åõ„ÇìÔºà„É≠„Ç∞„Å®„Éè„Éº„ÉàÊé®Áßª„ÅÆ„ÅøÔºâ",
      btnShare: "Ë¶≥ÂØüÁî®URL",
      btnLogs: "„É≠„Ç∞",
      btnName: "ÂêçÂâç",
      btnReset: "„ÅØ„Åò„ÇÅ„Åã„Çâ",
      btnBack: "Êàª„Çã",
      btnClose: "Èñâ„Åò„Çã",
      btnCancel: "„ÇÑ„ÇÅ„Çã",
      btnCopy: "„Ç≥„Éî„Éº",
      btnLater: "„ÅÇ„Å®„Åß",
      btnDecide: "Ê±∫ÂÆö",
      btnFood: "È£ü‰∫ã",
      btnOut: "„Åä„Åß„Åã„Åë",
      btnStyle: "„Åä„Åó„ÇÉ„Çå",
      btnClean: "ÊéíÊ≥ÑÈô§Âéª",
      btnDrink: "„Éâ„É™„É≥„ÇØ",
      btnMacaron: "„Éû„Ç´„É≠„É≥",
      twoChoice: "2Êäû",
      timeStopped: "ÊôÇÈñì„ÅåÊ≠¢„Åæ„Å£„Å¶„ÅÑ„Çã„ÄÇ",
      waitNote: "„Å©„Çì„Å™Â≠ê„Åã„Å™Ôºü„Å°„Çá„Å£„Å®ÂæÖ„Å£„Å¶„Å≠",
      sleepNote: "„Åô„ÇÑ„Åô„ÇÑ‚Ä¶",
      subRunning: "„É≠„Ç∞Ë®òÈå≤",
      subEnded: "Êìç‰Ωú„ÅØÂÅúÊ≠¢„Åó„Åæ„Åô",
      thanks: "„ÅÇ„Çä„Åå„Å®„ÅÜ",
      miniInfo: "Ë°®ÊÉÖ„ÇÑÂãï„Åç„Å†„Åë„ÅßÁä∂ÊÖã„ÅåÂ§â„Çè„Çä„Åæ„Åô„ÄÇ",
      assetHint: "ÁîªÂÉè„Éë„Çπ",
      shareTitle: "Ë¶≥ÂØüÁî®URL",
      shareHint: "ÂÖ±Êúâ„Åô„Çã„Å®„É≠„Ç∞„Å†„ÅëË¶ã„Çâ„Çå„Åæ„Åô",
      shareText: "„Åì„ÅÆURL„ÇíÂÖ±Êúâ„Åô„Çã„Å®„ÄÅÁ¨¨‰∏âËÄÖ„ÅØ„ÄåË¶≥ÂØüÁî®„É≠„Ç∞ÁîªÈù¢„Äç„Å†„Åë„ÇíÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇ\nÊìç‰Ωú„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇË¶ã„Åà„Çã„ÅÆ„ÅØ„É≠„Ç∞„Å®„Éè„Éº„ÉàÊé®Áßª„ÅÆ„Åø„Åß„Åô„ÄÇ",
      shareCopied: "URL„Çí„Ç≥„Éî„Éº„Åó„Åü„ÄÇ",
      letterLines: [
        "„ÅÇ„Å™„Åü„ÅØ„ÄÅÂ§úÁ©∫„Åã„Çâ„Åì„Åº„ÇåËêΩ„Å°„Åü„Äå„Éû„Ç´„É≠„É≥Êòü„ÅÆ„Åü„Åæ„Åî„Äç„ÇíË¶ã„Å§„Åë„Åæ„Åó„Åü„ÄÇ",
        "ÊÆª„ÅÆ‰∏≠„Åß„ÅØ„ÄÅÁîò„ÅÑ„Å≤„Åã„Çä„Åå„Åì„Çç„Åì„ÇçÊè∫„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
        "„Åì„ÅÆÂ≠ê„ÅØ„ÄÅ„Åü„Å£„ÅüÔºìÊó•„Å†„Åë„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„Åù„Å∞„Å´„ÅÑ„Çâ„Çå„Åæ„Åô„ÄÇ",
        "ÔºìÊó•„Åü„Å£„Åü„Çâ„ÄÅ„Éû„Ç´„É≠„É≥Êòü„Å∏Â∏∞„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åô„ÄÇ",
        "„Åß„ÇÇ„ÄÅ„Å®„Åç„Å©„Åç„Åì„Åì„ÅßÈùô„Åã„Å´Áú†„Å£„Å¶„Åó„Åæ„ÅÜ„Åì„Å®„ÇÇ„ÅÇ„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ",
        "„Å†„Åã„Çâ„Åì„Åù„ÄÅ„ÅÑ„Åæ„Å†„Åë„ÅØ„ÄÇ„ÇÑ„Åï„Åó„ÅèËÇ≤„Å¶„Å¶„Å≠„ÄÇ"
      ],
      psName: "ËøΩ‰º∏Ôºö„Çà„Åã„Å£„Åü„Çâ„ÄÅ„Åì„ÅÆÂ≠ê„Å´ÂêçÂâç„Çí„Å§„Åë„Å¶„ÅÇ„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
      nameTitle: "ÂêçÂâç",
      nameHintInit: "„Åì„ÅÆÂ≠ê„Å´ÂêçÂâç„Çí„Å§„Åë„Å¶„Å≠",
      nameHintEdit: " ",
      nameStoryEdit: "„Åì„ÅÆÂ≠ê„ÅÆÂêçÂâç„Çí„ÄÅ„Åù„Å£„Å®Â§â„Åà„Å¶„Åø„ÇãÔºü",
      namePlaceholder: "ÂêçÂâçÔºà12ÊñáÂ≠ó„Åæ„ÅßÔºâ",
      nameNote: "„ÅÇ„Å®„Åß„ÄåÂêçÂâç„Äç„Éú„Çø„É≥„Åã„ÇâÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ",
      resetTitle: "„ÅØ„Åò„ÇÅ„Åã„Çâ",
      resetText: "„ÅØ„Åò„ÇÅ„Åã„ÇâÈÅä„Åπ„Åæ„Åô„ÄÇ\n„É≠„Ç∞„ÅØÁóïË∑°„Å®„Åó„Å¶ÊÆã„Åô„Åã„ÄÅÊ∂à„Åô„ÅãÈÅ∏„Åπ„Åæ„Åô„ÄÇ",
      resetKeep: "„É≠„Ç∞„ÇíÊÆã„Åó„Å¶„ÅØ„Åò„ÇÅ„Çã",
      resetKeepSub: "ÈÅéÂéª„ÅÆÁóïË∑°„ÅØ„Ç¢„Éº„Ç´„Ç§„Éñ„Å∏„ÄÇ",
      resetWipe: "„É≠„Ç∞„ÇíÊ∂à„Åó„Å¶„ÅØ„Åò„ÇÅ„Çã",
      resetWipeSub: "„Åì„ÅÆÁ´ØÊú´„ÅÆË®òÈå≤„ÇíÊ∂à„Åó„Åæ„Åô„ÄÇ",
      logArrived: "Âà∞ÁùÄ„Åó„Åü„ÄÇ",
      logHatched: "ÊµÆ„Åã„Å≥‰∏ä„Åå„Å£„Å¶„ÄÅË™ïÁîü„Åó„Åü„ÄÇ",
      logDayChanged: "Êó•„ÅåÂ§â„Çè„Å£„Åü„ÄÇ",
      logQuiet: "Èùô„Åã„Å´„Å™„Å£„Åü„ÄÇ",
      logGone: "„ÅÑ„Å™„Åè„Å™„Å£„Åü„ÄÇ",
      logOff: "„Å©„Åì„Åã„Ç∫„É¨„Åü„Åæ„Åæ„ÄÅ„Åæ„ÅüÈùô„Åã„Å´„Å™„Å£„Åü„ÄÇ",
      logReadLetter: "ÊâãÁ¥ô„ÇíË™≠„Çì„Å†„ÄÇ",
      logNamed: "ÂêçÂâç„Çí„Å§„Åë„ÅüÔºö",
      logSitterOn: "È†ê„Åë„Åü„ÄÇ",
      logSitterOff: "Êàª„Å£„Åü„ÄÇ",
      cleaned: "„Åç„Çå„ÅÑ„Å´„Åó„Åü„ÄÇ",
      usedDrink: "„Éâ„É™„É≥„ÇØ„Çí‰Ωø„Å£„Åü„ÄÇ",
      returned: "Êàª„Å£„Å¶„Åç„Åü„ÄÇ",
      grown: "Â∞ë„ÅóÂ§ß„Åç„Åè„Å™„Å£„Åü„ÄÇ"
    },
    en: {
      docTitle: "3-Day Care Game (2D)",
      gameTitle: "3-Day Care Game (2D)",
      langLabel: "Language",
      sitter: "Sitter",
      stageHeader: "Stage",
      careHeader: "Care",
      careHint: "Choose whichever you like",
      letter: "Letter",
      observeHeader: "Observer Log",
      observeHint: "No controls (logs and heart trend only)",
      btnShare: "Observer URL",
      btnLogs: "Logs",
      btnName: "Name",
      btnReset: "Restart",
      btnBack: "Back",
      btnClose: "Close",
      btnCancel: "Cancel",
      btnCopy: "Copy",
      btnLater: "Later",
      btnDecide: "OK",
      btnFood: "Food",
      btnOut: "Go out",
      btnStyle: "Style",
      btnClean: "Clean",
      btnDrink: "Drink",
      btnMacaron: "Macaron",
      twoChoice: "Two choices",
      timeStopped: "Time is paused.",
      waitNote: "What kind of child will it be? Please wait a moment.",
      sleepNote: "Zzz‚Ä¶",
      subRunning: "Logging",
      subEnded: "Controls disabled",
      thanks: "Thanks",
      miniInfo: "Status changes from expressions and motion.",
      assetHint: "Asset path",
      shareTitle: "Observer URL",
      shareHint: "Shareable (log only)",
      shareText: "Sharing this URL lets others view only the observer log screen.\nThey cannot play. Only logs and heart trend are visible.",
      shareCopied: "URL copied.",
      letterLines: [
        "You found a ‚Äòmacaron-star egg‚Äô that slipped from the night sky.",
        "Inside the shell, a sweet light gently rolls around.",
        "This child can stay with you for only three days.",
        "After three days, it will return to the macaron star.",
        "Sometimes, it may quietly fall asleep here as well.",
        "That‚Äôs why‚Äîjust for now‚Äîplease care for it gently."
      ],
      psName: "P.S. If you‚Äôd like, please give this child a name.",
      nameTitle: "Name",
      nameHintInit: "Please name this child",
      nameHintEdit: " ",
      nameStoryEdit: "Want to quietly change the name?",
      namePlaceholder: "Name (up to 12 chars)",
      nameNote: "You can change it later with the Name button.",
      resetTitle: "Restart",
      resetText: "You can start over.\nChoose whether to keep traces (archive) or erase them.",
      resetKeep: "Restart (keep logs)",
      resetKeepSub: "Past traces go to archive.",
      resetWipe: "Restart (erase logs)",
      resetWipeSub: "Erase records on this device.",
      logArrived: "Arrived.",
      logHatched: "It rose and was born.",
      logDayChanged: "A new day began.",
      logQuiet: "It became quiet.",
      logGone: "It is gone.",
      logOff: "It returned‚Ä¶ but slightly off, and became quiet again.",
      logReadLetter: "Read the letter.",
      logNamed: "Named: ",
      logSitterOn: "Paused (sitter).",
      logSitterOff: "Resumed.",
      cleaned: "Cleaned.",
      usedDrink: "Used a drink.",
      returned: "It came back.",
      grown: "It grew a little."
    },
    zh: {
      docTitle: "‰∏âÂ§©ÁÖßÊä§Ê∏∏ÊàèÔºà2DÔºâ",
      gameTitle: "‰∏âÂ§©ÁÖßÊä§Ê∏∏ÊàèÔºà2DÔºâ",
      langLabel: "ËØ≠Ë®Ä",
      sitter: "ÊâòÁÆ°",
      stageHeader: "ËàûÂè∞",
      careHeader: "ÁÖßÊä§",
      careHint: "ËØ∑ÈÄâÊã©‰Ω†ÂñúÊ¨¢ÁöÑ‰∏Ä‰∏™",
      letter: "‰ø°",
      observeHeader: "ËßÇÂØüËÆ∞ÂΩï",
      observeHint: "Êó†Ê≥ïÊìç‰ΩúÔºà‰ªÖÊòæÁ§∫ËÆ∞ÂΩï‰∏éÂøÉÂÄºË∂ãÂäøÔºâ",
      btnShare: "ËßÇÂØüÈìæÊé•",
      btnLogs: "ËÆ∞ÂΩï",
      btnName: "ÂêçÂ≠ó",
      btnReset: "ÈáçÊñ∞ÂºÄÂßã",
      btnBack: "ËøîÂõû",
      btnClose: "ÂÖ≥Èó≠",
      btnCancel: "ÂèñÊ∂à",
      btnCopy: "Â§çÂà∂",
      btnLater: "Á®çÂêé",
      btnDecide: "Á°ÆÂÆö",
      btnFood: "ÂêÉÈ•≠",
      btnOut: "Â§ñÂá∫",
      btnStyle: "ÊâìÊâÆ",
      btnClean: "Ê∏ÖÁêÜ",
      btnDrink: "È•ÆÊñô",
      btnMacaron: "È©¨Âç°Èæô",
      twoChoice: "‰∫åÈÄâ‰∏Ä",
      timeStopped: "Êó∂Èó¥Â∑≤ÊöÇÂÅú„ÄÇ",
      waitNote: "‰ºöÊòØ‰ªÄ‰πàÊ†∑ÁöÑÂ≠©Â≠êÂë¢ÔºüÁ®çÁ≠â‰∏Ä‰∏ãÂì¶„ÄÇ",
      sleepNote: "ÂëºÂôú‚Ä¶",
      subRunning: "ËÆ∞ÂΩï‰∏≠",
      subEnded: "Â∑≤ÂÅúÊ≠¢Êìç‰Ωú",
      thanks: "Ë∞¢Ë∞¢",
      miniInfo: "Ë°®ÊÉÖ‰∏éÂä®‰Ωú‰ºöÂΩ±ÂìçÁä∂ÊÄÅ„ÄÇ",
      assetHint: "ËµÑÊ∫êË∑ØÂæÑ",
      shareTitle: "ËßÇÂØüÈìæÊé•",
      shareHint: "ÂàÜ‰∫´Âêé‰ªÖÂèØÁúãËÆ∞ÂΩï",
      shareText: "ÂàÜ‰∫´Ê≠§ÈìæÊé•ÂêéÔºåÂà´‰∫∫Âè™ËÉΩÊü•Áúã‚ÄúËßÇÂØüËÆ∞ÂΩï‚ÄùÁîªÈù¢„ÄÇ\n‰∏çËÉΩËøõË°åÊ∏∏ÊàèÊìç‰ΩúÔºåÂè™ËÉΩÁúãÂà∞ËÆ∞ÂΩï‰∏éÂøÉÂÄºË∂ãÂäø„ÄÇ",
      shareCopied: "Â∑≤Â§çÂà∂ÈìæÊé•„ÄÇ",
      letterLines: [
        "‰Ω†Êç°Âà∞‰∫Ü‰∏ÄÊûö‰ªéÂ§úÁ©∫‰∏≠ËêΩ‰∏ãÁöÑ‚ÄúÈ©¨Âç°ÈæôÊòü‰πãËõã‚Äù„ÄÇ",
        "ËõãÂ£≥ÈáåÔºåÁîúÁîúÁöÑÂÖâÂú®ËΩªËΩªÊªöÂä®„ÄÇ",
        "Ëøô‰∏™Â≠©Â≠êÂè™ËÉΩÈô™‰Ω†‰∏âÂ§©„ÄÇ",
        "‰∏âÂ§©ÂêéÔºåÂÆÉ‰ºöÂõûÂà∞È©¨Âç°ÈæôÊòü„ÄÇ",
        "‰∏çËøáÔºåÊúâÊó∂ÂÆÉ‰πüÂèØËÉΩÂú®ËøôÈáåÈùôÈùôÁù°Âéª„ÄÇ",
        "ÊâÄ‰ª•‚Äî‚ÄîÂ∞±Âú®Ê≠§Âàª‚Äî‚ÄîËØ∑Ê∏©ÊüîÂú∞ÁÖßÈ°æÂÆÉ„ÄÇ"
      ],
      psName: "ÈôÑË®ÄÔºöÂ¶ÇÊûúÊÑøÊÑèÔºåËØ∑ÁªôËøô‰∏™Â≠©Â≠êÂèñ‰∏™ÂêçÂ≠ó„ÄÇ",
      nameTitle: "ÂêçÂ≠ó",
      nameHintInit: "ËØ∑ÁªôÂÆÉÂèñ‰∏™ÂêçÂ≠ó",
      nameHintEdit: " ",
      nameStoryEdit: "ÊÉ≥ÊÇÑÊÇÑÊîπ‰∏Ä‰∏ãÂêçÂ≠óÂêóÔºü",
      namePlaceholder: "ÂêçÂ≠óÔºàÊúÄÂ§ö12Â≠óÔºâ",
      nameNote: "‰πãÂêé‰πüÂèØ‰ª•Áî®‚ÄúÂêçÂ≠ó‚ÄùÊåâÈíÆ‰øÆÊîπ„ÄÇ",
      resetTitle: "ÈáçÊñ∞ÂºÄÂßã",
      resetText: "ÂèØ‰ª•‰ªéÂ§¥ÂºÄÂßã„ÄÇ\nËØ∑ÈÄâÊã©‰øùÁïôÁóïËøπÔºàÂΩíÊ°£ÔºâÊàñÊ∏ÖÈô§ËÆ∞ÂΩï„ÄÇ",
      resetKeep: "‰øùÁïôËÆ∞ÂΩïÈáçÊñ∞ÂºÄÂßã",
      resetKeepSub: "ËøáÂéªÁóïËøπ‰ºöÂΩíÊ°£„ÄÇ",
      resetWipe: "Ê∏ÖÈô§ËÆ∞ÂΩïÈáçÊñ∞ÂºÄÂßã",
      resetWipeSub: "Ê∏ÖÈô§Êú¨ËÆæÂ§áËÆ∞ÂΩï„ÄÇ",
      logArrived: "Â∑≤Âà∞Ëææ„ÄÇ",
      logHatched: "ÂÆÉÊµÆËµ∑Âπ∂ËØûÁîü‰∫Ü„ÄÇ",
      logDayChanged: "Êñ∞ÁöÑ‰∏ÄÂ§©ÂºÄÂßã‰∫Ü„ÄÇ",
      logQuiet: "ÂÆÉÂÆâÈùô‰∏ãÊù•‰∫Ü„ÄÇ",
      logGone: "ÂÆÉÁ¶ªÂºÄ‰∫Ü„ÄÇ",
      logOff: "ÂÆÉÂõûÊù•‰∫Ü‚Ä¶‰ΩÜÊúâÁÇπ‰∏ç‰∏ÄÊ†∑ÔºåÂèàÂÆâÈùô‰∫Ü„ÄÇ",
      logReadLetter: "ËØª‰∫Ü‰ø°„ÄÇ",
      logNamed: "ÂèñÂêçÔºö",
      logSitterOn: "Â∑≤ÊâòÁÆ°ÔºàÊöÇÂÅúÔºâ„ÄÇ",
      logSitterOff: "Â∑≤ÊÅ¢Â§ç„ÄÇ",
      cleaned: "Â∑≤Ê∏ÖÁêÜ„ÄÇ",
      usedDrink: "‰ΩøÁî®‰∫ÜÈ•ÆÊñô„ÄÇ",
      returned: "ÂÆÉÂõûÊù•‰∫Ü„ÄÇ",
      grown: "ÂÆÉÁ®çÂæÆÂèòÂ§ß‰∫Ü„ÄÇ"
    }
  };

  function t(key){
    return (I18N[LANG] && I18N[LANG][key]) || I18N.ja[key] || key;
  }
  function getLetterBody(){
    const lines = t("letterLines");
    const arr = Array.isArray(lines) ? lines : I18N.ja.letterLines;
    return arr.join("\n") + "\n\n" + t("psName");
  }
  function getIntroText(){
    const lines = t("letterLines");
    const arr = Array.isArray(lines) ? lines : I18N.ja.letterLines;
    return arr.join("\n");
  }
  function setLang(lang){
    LANG = (lang === "en" || lang === "zh" || lang === "ja") ? lang : "ja";
    localStorage.setItem(LANG_KEY, LANG);
    applyLangToUI();
    if(ui.letterText) ui.letterText.textContent = getLetterBody();
  }

  function makeOpt(icon, title, sub, extra){
    return Object.assign({ icon, t:title, sub }, extra || {});
  }
  function makePrompt(q, a, b){
    return { q, a, b };
  }

  const TWOCHOICE = {
    ja: {
      food: [
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üçô","„Åä„Å´„Åé„Çä","„Åé„ÇÖ„Å£„Å®„ÄÇ"), makeOpt("ü•ê","„Å±„Çì","„Åµ„Çè„Å£„Å®„ÄÇ")),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("ü•§","„Ç∏„É•„Éº„Çπ","Êòé„Çã„ÅÑÁîò„Åï„ÄÇ"), makeOpt("üç∂","„Åä„Åï„Åë","Èùô„Åã„Å™ÁÜ±„ÄÇ")),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üçú","„É©„Éº„É°„É≥","„ÅÇ„Å£„Åü„Åã„ÅÑ„ÄÇ"), makeOpt("ü•ó","„Çµ„É©„ÉÄ","„Åï„Å£„Å±„Çä„ÄÇ")),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üç™","„ÇØ„ÉÉ„Ç≠„Éº","„Åª„Çç„Åª„Çç„ÄÇ"), makeOpt("üç´","„ÉÅ„Éß„Ç≥","„Åó„Å£„Å®„Çä„ÄÇ")),
      ],
      out: [
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üå≥","„Åì„ÅÜ„Åà„Çì","È¢®„Åå„ÅÇ„Çã„ÄÇ",{ wild:true }), makeOpt("üé¨","„Åà„ÅÑ„Åå","Êöó„Åè„Å¶ÂÆâÂøÉ„ÄÇ",{ wild:false })),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üåä","„ÅÜ„Åø","Â¢ÉÁïå„Åå„ÇÜ„Çå„Çã„ÄÇ",{ wild:true }), makeOpt("üèîÔ∏è","„ÇÑ„Åæ","Â¢ÉÁïå„ÅåÂõ∫„ÅÑ„ÄÇ",{ wild:true })),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üöÉ","„Åß„Çì„Åó„ÇÉ","ÊôØËâ≤„ÅåÊµÅ„Çå„Çã„ÄÇ",{ wild:false }), makeOpt("üö∂","„Åï„Çì„ÅΩ","ËÄÉ„Åà„Åå‰∏¶„Å∂„ÄÇ",{ wild:true })),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üß∏","„Å¨„ÅÑ„Åê„Çã„ÅøÂ±ã","Êä±„Åç„ÇÑ„Åô„ÅÑ„ÄÇ",{ wild:false }), makeOpt("üìö","„Åª„Çì„ÇÑ","ËÉåË°®Á¥ô„ÅÆÊ£Æ„ÄÇ",{ wild:false })),
      ],
      style: [
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("‚ú®","„Åç„Çâ„Åç„Çâ","ÁõÆ„ÅåËøΩ„ÅÜ„ÄÇ"), makeOpt("ü™®","„Åó„Å∂„ÅÑ","Âæå„Åã„ÇâÂäπ„Åè„ÄÇ")),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üéÄ","„Çä„Åº„Çì","Áµê„Å≥ÁõÆ„ÅåÊÆã„Çã„ÄÇ"), makeOpt("üé©","„Åº„ÅÜ„Åó","ÂΩ±„ÅåÂ¢ó„Åà„Çã„ÄÇ")),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üï∂Ô∏è","„Çµ„É≥„Ç∞„É©„Çπ","Âº∑„ÅèË¶ã„Åà„Çã„ÄÇ"), makeOpt("üëì","„ÇÅ„Åå„Å≠","Ë≥¢„ÅèË¶ã„Åà„Çã„ÄÇ")),
        makePrompt("„Å©„Å£„Å°„Å´„Åô„ÇãÔºü", makeOpt("üëü","„Çπ„Éã„Éº„Ç´„Éº","ËªΩ„ÅÑÈü≥„ÄÇ"), makeOpt("üë¢","„Éñ„Éº„ÉÑ","Èáç„ÅÑÈü≥„ÄÇ")),
      ]
    },
    en: {
      food: [
        makePrompt("Pick one?", makeOpt("üçô","Rice ball","Tight and warm."), makeOpt("ü•ê","Bread","Soft and fluffy.")),
        makePrompt("Pick one?", makeOpt("ü•§","Juice","Bright sweetness."), makeOpt("üç∂","Sake","Quiet warmth.")),
        makePrompt("Pick one?", makeOpt("üçú","Ramen","Nice and hot."), makeOpt("ü•ó","Salad","Fresh and light.")),
        makePrompt("Pick one?", makeOpt("üç™","Cookie","Crumbly."), makeOpt("üç´","Chocolate","Rich.")),
      ],
      out: [
        makePrompt("Pick one?", makeOpt("üå≥","Park","With wind.",{ wild:true }), makeOpt("üé¨","Cinema","Safe in the dark.",{ wild:false })),
        makePrompt("Pick one?", makeOpt("üåä","Sea","Borders wobble.",{ wild:true }), makeOpt("üèîÔ∏è","Mountain","Borders feel solid.",{ wild:true })),
        makePrompt("Pick one?", makeOpt("üöÉ","Train","Scenery flows.",{ wild:false }), makeOpt("üö∂","Walk","Thoughts align.",{ wild:true })),
        makePrompt("Pick one?", makeOpt("üß∏","Plush shop","Easy to hug.",{ wild:false }), makeOpt("üìö","Bookstore","A forest of spines.",{ wild:false })),
      ],
      style: [
        makePrompt("Pick one?", makeOpt("‚ú®","Sparkly","Eyes will follow."), makeOpt("ü™®","Muted","Hits later.")),
        makePrompt("Pick one?", makeOpt("üéÄ","Ribbon","A knot remains."), makeOpt("üé©","Hat","More shadow.")),
        makePrompt("Pick one?", makeOpt("üï∂Ô∏è","Sunglasses","Looks strong."), makeOpt("üëì","Glasses","Looks smart.")),
        makePrompt("Pick one?", makeOpt("üëü","Sneakers","Light sounds."), makeOpt("üë¢","Boots","Heavy sounds.")),
      ]
    },
    zh: {
      food: [
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üçô","È•≠Âõ¢","ÊöñÊöñÁöÑ„ÄÇ"), makeOpt("ü•ê","Èù¢ÂåÖ","ËΩØËΩØÁöÑ„ÄÇ")),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("ü•§","ÊûúÊ±Å","ÁîúÁîúÁöÑ„ÄÇ"), makeOpt("üç∂","ÈÖí","ÈùôÈùôÁöÑÁÉ≠„ÄÇ")),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üçú","ÊãâÈù¢","ÁÉ≠‰πé‰πé„ÄÇ"), makeOpt("ü•ó","Ê≤ôÊãâ","Ê∏ÖÁàΩ„ÄÇ")),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üç™","È•ºÂπ≤","ÈÖ•ÈÖ•ÁöÑ„ÄÇ"), makeOpt("üç´","Â∑ßÂÖãÂäõ","ÊµìÊµìÁöÑ„ÄÇ")),
      ],
      out: [
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üå≥","ÂÖ¨Âõ≠","ÊúâÈ£é„ÄÇ",{ wild:true }), makeOpt("üé¨","ÁîµÂΩ±Èô¢","ÈªëÊöó‰πüÂÆâÂøÉ„ÄÇ",{ wild:false })),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üåä","Êµ∑Ëæπ","ËæπÁïåÊëáÊôÉ„ÄÇ",{ wild:true }), makeOpt("üèîÔ∏è","Â±±Èáå","ËæπÁïåÂùöÂõ∫„ÄÇ",{ wild:true })),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üöÉ","ÁîµËΩ¶","ÊôØËâ≤ÊµÅÂä®„ÄÇ",{ wild:false }), makeOpt("üö∂","Êï£Ê≠•","ÊÉ≥Ê≥ïÂπ∂ÊéíËµ∞„ÄÇ",{ wild:true })),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üß∏","Áé©ÂÅ∂Â∫ó","ÂæàÂ•ΩÊä±„ÄÇ",{ wild:false }), makeOpt("üìö","‰π¶Â∫ó","‰π¶ËÑäÂÉèÊ£ÆÊûó„ÄÇ",{ wild:false })),
      ],
      style: [
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("‚ú®","Èó™Èó™","ÁúºÁùõ‰ºöËøΩ„ÄÇ"), makeOpt("ü™®","‰ΩéË∞É","ÂêéÂä≤Êõ¥Âº∫„ÄÇ")),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üéÄ","Ëù¥Ëù∂Áªì","Áªì‰ºöÁïô‰∏ã„ÄÇ"), makeOpt("üé©","Â∏ΩÂ≠ê","ÂΩ±Â≠êÊõ¥Â§ö„ÄÇ")),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üï∂Ô∏è","Â¢®Èïú","ÁúãËµ∑Êù•Êõ¥Âº∫„ÄÇ"), makeOpt("üëì","ÁúºÈïú","ÁúãËµ∑Êù•Êõ¥ËÅ™Êòé„ÄÇ")),
        makePrompt("ÈÄâÂì™‰∏™Ôºü", makeOpt("üëü","ËøêÂä®Èûã","Â£∞Èü≥ËΩª„ÄÇ"), makeOpt("üë¢","Èù¥Â≠ê","Â£∞Èü≥Èáç„ÄÇ")),
      ]
    }
  };

  const el = (id) => document.getElementById(id);

  const ui = {
    subline: el("subline"),
    heartFill: el("heartFill"),
    heartLabel: el("heartLabel"),

    sitterToggle: el("sitterToggle"),
    txtSitter: el("txtSitter"),

    stageHint: el("stageHint"),
    stageNote: el("stageNote"),

    macaronArea: el("macaronArea"),
    macaronImg: el("macaronImg"),

    charArea: el("charArea"),
    charScaleBox: el("charScaleBox"),
    charImg: el("charImg"),

    thanksOverlay: el("thanksOverlay"),
    txtThanks: el("txtThanks"),

    poop1: el("poop1"),
    poop2: el("poop2"),
    poop3: el("poop3"),

    btnFood: el("btnFood"),
    btnOut: el("btnOut"),
    btnStyle: el("btnStyle"),
    btnClean: el("btnClean"),
    btnDrink: el("btnDrink"),
    btnMacaron: el("btnMacaron"),
    btnShare: el("btnShare"),
    btnLogs: el("btnLogs"),
    btnName: el("btnName"),
    btnReset: el("btnReset"),
    btnCsv: el("btnCsv"),

    assetHint: el("assetHint"),
    txtMiniInfo: el("txtMiniInfo"),

    liveLog: el("liveLog"),

    modalBack: el("modalBack"),
    modalTitle: el("modalTitle"),
    modalHint: el("modalHint"),
    modalBody: el("modalBody"),
    modalFoot: el("modalFoot"),
    modalX: el("modalX"),

    screenGame: el("screenGame"),
    screenObserve: el("screenObserve"),
    obsTitle: el("obsTitle"),
    obsSub: el("obsSub"),
    obsDays: el("obsDays"),
    btnBackToGame: el("btnBackToGame"),
    heartChart: el("heartChart"),

    letterSlot: el("letterSlot"),
    letterBtn: el("letterBtn"),
    letterModal: el("letterModal"),
    letterText: el("letterText"),
    letterClose: el("letterClose"),
    letterX: el("letterX"),

    langSel: el("langSel"),
    txtLangLabel: el("txtLangLabel"),

    txtGameTitle: el("txtGameTitle"),
    txtStageHeader: el("txtStageHeader"),
    txtCareHeader: el("txtCareHeader"),
    txtCareHint: el("txtCareHint"),
    txtLetterBtn: el("txtLetterBtn"),
    txtLetterTitle: el("txtLetterTitle"),
    txtObserveHeader: el("txtObserveHeader"),
    txtObserveHint: el("txtObserveHint"),
    txtLogHeader: el("txtLogHeader"),
    txtLogHint: el("txtLogHint"),
  };

  function applyLangToUI(){
    document.documentElement.lang = LANG;
    document.title = t("docTitle");

    ui.txtGameTitle.textContent = t("gameTitle");
    ui.txtLangLabel.textContent = t("langLabel");
    ui.txtSitter.textContent = t("sitter");

    ui.txtStageHeader.textContent = t("stageHeader");
    ui.txtCareHeader.textContent = t("careHeader");
    ui.txtCareHint.textContent = t("careHint");

    ui.txtObserveHeader.textContent = t("observeHeader");
    ui.txtObserveHint.textContent = t("observeHint");

    ui.btnShare.textContent = t("btnShare");
    ui.btnLogs.textContent = t("btnLogs");
    ui.btnName.textContent = t("btnName");
    ui.btnReset.textContent = t("btnReset");

    ui.btnFood.textContent = `üçΩ ${t("btnFood")}`;
    ui.btnOut.textContent  = `üöÄ ${t("btnOut")}`;
    ui.btnStyle.textContent= `‚ú® ${t("btnStyle")}`;
    ui.btnClean.textContent= `üßº ${t("btnClean")}`;
    ui.btnDrink.textContent= `ü•§ ${t("btnDrink")}`;
    ui.btnMacaron.textContent = `üç¨ ${t("btnMacaron")}`;

    ui.modalX.textContent = t("btnClose");
    ui.letterX.textContent = t("btnClose");
    ui.letterClose.textContent = t("btnClose");

    ui.txtThanks.textContent = t("thanks");
    ui.txtMiniInfo.textContent = t("miniInfo");

    // Ë°®Á§∫Áî®„Éí„É≥„ÉàÔºàÂÆüÈöõ„ÅÆsleep„ÅØ blue_sleep.png Á≠âÔºâ
    ui.assetHint.textContent =
      `${t("assetHint")}: ${ASSET_BASE}Ôºàsleep: ${ASSET_BASE}blue_sleep.png „Å™„Å©Ôºâ`;

    ui.txtLogHeader.textContent = t("btnLogs");
    ui.txtLogHint.textContent = (LANG==="en") ? "Download as CSV" : (LANG==="zh" ? "ÂèØ‰∏ãËΩΩCSV" : "CSV„Åß‰øùÂ≠ò„Åß„Åç„Åæ„Åô");
    ui.btnCsv.textContent = "CSV";

    // ÊâãÁ¥ôÊú¨Êñá„ÅØ openLetter „ÅßÈÉΩÂ∫¶„Çª„ÉÉ„Éà„Åô„Çã„Åå„ÄÅÂàùÊúüÂÄ§„ÇÇÂÖ•„Çå„Å¶„Åä„Åè
    ui.txtLetterTitle.textContent = t("letter");
    ui.letterText.textContent = getLetterBody();
    ui.txtLetterBtn.textContent = t("letter");
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function now(){ return Date.now(); }
  function safeJsonParse(s){ try{ return JSON.parse(s); }catch(_){ return null; } }

  function uid(){
    try{
      const a = new Uint32Array(4);
      crypto.getRandomValues(a);
      return [...a].map(x => x.toString(16).padStart(8,"0")).join("");
    }catch(_){
      return "id_" + Math.random().toString(16).slice(2) + "_" + now().toString(16);
    }
  }

  function normalizeName(s){
    const tt = String(s || "").trim();
    if(!tt) return "";
    return tt.replace(/[\r\n\t]/g, "").slice(0, 12);
  }

  function loadSave(){
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return null;
    const obj = safeJsonParse(raw);
    if(!obj || obj.version !== 1) return null;
    normalizeSave(obj);
    return obj;
  }
  function saveSave(obj){ localStorage.setItem(SAVE_KEY, JSON.stringify(obj)); }

  function loadArchives(){
    const raw = localStorage.getItem(ARCHIVE_KEY);
    const arr = raw ? safeJsonParse(raw) : null;
    return Array.isArray(arr) ? arr : [];
  }
  function saveArchives(arr){ localStorage.setItem(ARCHIVE_KEY, JSON.stringify(arr)); }

  function assetPath(file){ return ASSET_BASE + file; }

  function calcElapsedMs(save, tNow){
    const baseNow = save.pausedSince ? save.pausedSince : tNow;
    return Math.max(0, baseNow - save.startedAt - save.totalPausedMs);
  }

  function dayIndex(elapsed){
    return clamp(Math.floor(elapsed / DAY_MS) + 1, 1, 3);
  }

  function ensureDay(save, d){
    if(!save.days) save.days = {};
    if(!save.days[d]){
      save.days[d] = {
        day: d,
        careCounts: { food:0, out:0, style:0, clean:0 },
        choices: [],
        heartChange: 0,
        sitterMs: 0,
        items: { drink:0, macaron:0 },
        heartStart: save.heart,
        heartEnd: save.heart
      };
    }else{
      const dd = save.days[d];
      if(!dd.careCounts) dd.careCounts = { food:0, out:0, style:0, clean:0 };
      dd.careCounts.food = dd.careCounts.food ?? 0;
      dd.careCounts.out = dd.careCounts.out ?? 0;
      dd.careCounts.clean = dd.careCounts.clean ?? 0;
      dd.careCounts.style = dd.careCounts.style ?? 0;
      if(!Array.isArray(dd.choices)) dd.choices = [];
      if(!dd.items) dd.items = { drink:0, macaron:0 };
      dd.items.drink = dd.items.drink ?? 0;
      dd.items.macaron = dd.items.macaron ?? 0;
      dd.heartChange = dd.heartChange ?? 0;
      dd.sitterMs = dd.sitterMs ?? 0;
      dd.heartStart = dd.heartStart ?? save.heart;
      dd.heartEnd = dd.heartEnd ?? save.heart;
    }
    return save.days[d];
  }

  function normalizeSave(save){
    save.totalPausedMs = save.totalPausedMs ?? 0;
    save.pausedSince = save.pausedSince ?? null;

    save.lifeExtensionMs = save.lifeExtensionMs ?? 0;

    save.petName = save.petName ?? "";

    save.heart = clamp(save.heart ?? 50, 0, 100);
    save.hunger = clamp(save.hunger ?? 20, 0, 100);
    save.dirt = clamp(save.dirt ?? 10, 0, 100);
    save.mood = clamp(save.mood ?? 70, 0, 100);
    save.poop = clamp(save.poop ?? 0, 0, 3);

    save.lastSimElapsed = save.lastSimElapsed ?? 0;
    save.currentDay = save.currentDay ?? 1;

    save.sleepUntilElapsed = save.sleepUntilElapsed ?? null;
    save.lastSleepAtElapsed = save.lastSleepAtElapsed ?? 0;

    save.letterShown = save.letterShown ?? false;

    // Êó•Êõø„Çè„ÇäÊâãÁ¥ôÔºà2Êó•ÁõÆ„Éª3Êó•ÁõÆÔºâ
    save.dayLetterSeen = save.dayLetterSeen ?? { 2:false, 3:false };
    save.pendingLetter = save.pendingLetter ?? null; // {kind:"day", day:2|3}
    save.letterPulse = save.letterPulse ?? 0;        // „Éâ„É≠„ÉÉ„ÉóÊºîÂá∫Áî®

    // ÊàêÈï∑Áî®
    save.pickCount = save.pickCount ?? 0;     // „Éü„ÉãÈÅ∏Êäû„ÅÆÂõûÊï∞ÔºàÈ£ü‰∫ã/„Åä„Åß„Åã„Åë/„Åä„Åó„ÇÉ„ÇåÔºâ
    save.growLevel = save.growLevel ?? 0;     // 20Âõû„Åî„Å®„Å´+1

    if(!Array.isArray(save.live)) save.live = [];
    if(!Array.isArray(save.events)) save.events = []; // ÂÖ®Â±•Ê≠¥ÔºàCSVÁî®Ôºâ
    if(!save.days) save.days = {};
    ensureDay(save, 1);

    save.bags = save.bags ?? { food:[], out:[], style:[] };
    save.bags.food = Array.isArray(save.bags.food) ? save.bags.food : [];
    save.bags.out = Array.isArray(save.bags.out) ? save.bags.out : [];
    save.bags.style = Array.isArray(save.bags.style) ? save.bags.style : [];
  }

  function pushEvent(save, type, text, extra){
    const stamp = now();
    save.events.push(Object.assign({
      t: stamp,
      type,
      text,
      day: save.currentDay || 1,
      heart: save.heart,
      hunger: save.hunger,
      dirt: save.dirt,
      mood: save.mood,
      poop: save.poop,
      elapsed: calcElapsedMs(save, stamp)
    }, extra || {}));
    if(save.events.length > 4000) save.events.splice(0, save.events.length - 4000);
  }

  function pushLiveLog(save, text){
    const stamp = now();
    save.live.unshift({ t: stamp, text });
    if(save.live.length > 30) save.live.length = 30;
    pushEvent(save, "event", text);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function addChoice(save, category, choiceLabel){
    const d = ensureDay(save, save.currentDay);
    const row = { t: now(), category, choice: choiceLabel };
    d.choices.push(row);
    pushEvent(save, "choice", `${category}: ${choiceLabel}`, { category, choice: choiceLabel });
  }

  function applyHeart(save, delta){
    const d = ensureDay(save, save.currentDay);
    const before = save.heart;
    save.heart = clamp(save.heart + delta, 0, 100);
    const realDelta = save.heart - before;
    d.heartChange += realDelta;
    d.heartEnd = save.heart;
  }

  function heartDeltaRandom(){
    const r = Math.random();
    if(r < 0.15) return -2;
    if(r < 0.50) return 0;
    if(r < 0.85) return 2;
    return 3;
  }

  function createNewSave(){
    const t0 = now();
    const playerId = uid();

    const macaronColor = COLORS[Math.floor(Math.random() * COLORS.length)];
    const charColor = macaronColor;

    const s = {
      version: 1,
      playerId,
      startedAt: t0,
      totalPausedMs: 0,
      pausedSince: null,

      macaronColor,
      charColor,

      petName: "",

      hatched: false,
      hatchAnim: false,

      ended: false,
      endedAt: null,

      macaronActive: false,
      macaronEndsAtElapsed: null,

      lifeExtensionMs: 0,

      heart: 50,
      hunger: 20,
      dirt: 10,
      mood: 70,
      poop: 0,

      sleepUntilElapsed: null,
      lastSleepAtElapsed: 0,

      lastSimElapsed: 0,
      currentDay: 1,

      letterShown: false,

      // Êó•Êõø„Çè„ÇäÊâãÁ¥ô
      dayLetterSeen: { 2:false, 3:false },
      pendingLetter: null,
      letterPulse: 0,

      pickCount: 0,
      growLevel: 0,

      bags: { food:[], out:[], style:[] },

      days: {},
      live: [],
      events: []
    };

    ensureDay(s, 1);
    pushLiveLog(s, t("logArrived"));
    return s;
  }

  function isAlive(save, elapsed){
    const deadline = LIFE_MS + (save.lifeExtensionMs || 0);
    if(save.macaronActive) return true;
    return (elapsed < deadline) && !save.ended;
  }

  function canInteract(save, elapsed){
    if(save.pausedSince) return true;
    if(save.macaronActive) return true;
    if(save.ended) return false;
    if(!save.hatched) return false;
    return isAlive(save, elapsed);
  }

  function updatePoop(save){
    const desired = clamp(Math.floor((save.dirt - 50) / 20), 0, 3);
    save.poop = Math.max(save.poop, desired);
  }

  function isSleeping(save, elapsed){
    if(save.pausedSince) return true;
    if(save.sleepUntilElapsed == null) return false;
    return elapsed < save.sleepUntilElapsed;
  }

  function maybeStartSleep(save, elapsed){
    if(isSleeping(save, elapsed)) return;

    const since = elapsed - (save.lastSleepAtElapsed || 0);
    const cool = FAST ? 7 * 1000 : 4 * 60 * 1000;
    if(since < cool) return;

    save.sleepUntilElapsed = elapsed + SLEEP_MS;
    save.lastSleepAtElapsed = elapsed;

    pushLiveLog(save, t("logQuiet"));
  }

  function applyTimeSimulation(save, elapsed){
    const prev = save.lastSimElapsed || 0;
    const deltaMs = Math.max(0, elapsed - prev);
    if(deltaMs <= 0) return;

    const minutes = deltaMs / 60000;

    save.hunger = clamp(save.hunger + minutes * HUNGER_PER_MIN, 0, 100);
    save.dirt   = clamp(save.dirt   + minutes * DIRT_PER_MIN,   0, 100);

    updatePoop(save);

    let moodDelta = 0;
    const stress =
      (save.hunger > 70 ? (save.hunger - 70) / 30 : 0) +
      (save.dirt   > 70 ? (save.dirt   - 70) / 30 : 0);

    moodDelta -= minutes * 0.35 * stress;
    if(save.poop > 0) moodDelta -= minutes * 0.12 * save.poop;

    if(save.hunger < 35 && save.dirt < 35 && save.poop === 0){
      moodDelta += minutes * 0.10;
    }

    if(isSleeping(save, elapsed)){
      moodDelta += minutes * 0.12;
    }

    save.mood = clamp(save.mood + moodDelta, 0, 100);

    const calm = (save.mood > 72 && save.hunger < 55 && save.dirt < 55 && save.poop === 0);
    if(calm){
      const p = minutes * 0.05;
      if(Math.random() < p){
        maybeStartSleep(save, elapsed);
      }
    }
  }

  // Êó•„ÅåÂ§â„Çè„Å£„Åü„Å®„Åç„ÄÅ2Êó•ÁõÆ„Éª3Êó•ÁõÆ„Å´„ÄåÊó•Êõø„Çè„Çä„ÅÆ„ÅäÊâãÁ¥ô„Äç„Çí1ÈÄö„Åö„Å§Âá∫„Åô
  function updateDayBoundary(save, elapsed){
    const d = dayIndex(elapsed);
    if(!save.currentDay) save.currentDay = d;

    if(d !== save.currentDay){
      const prev = ensureDay(save, save.currentDay);
      prev.heartEnd = save.heart;

      save.currentDay = d;
      const next = ensureDay(save, d);
      next.heartStart = save.heart;

      pushLiveLog(save, t("logDayChanged"));

      if((d === 2 || d === 3) && !save.dayLetterSeen?.[d]){
        save.pendingLetter = { kind:"day", day:d };
        save.letterPulse = (save.letterPulse || 0) + 1;
      }
    }
    ensureDay(save, save.currentDay);
  }

  function maybeHatch(save, elapsed){
    if(save.hatched) return;
    if(elapsed >= HATCH_MS){
      save.hatchAnim = true;
      setTimeout(() => {
        const s = loadSave();
        if(!s || s.hatched) return;
        s.hatched = true;
        s.hatchAnim = false;
        pushLiveLog(s, t("logHatched"));
        saveSave(s);
        openNameModal(true);
      }, 700);
    }
  }

  function archiveRun(save){
    const arr = loadArchives();
    const exp = exportObservationData(save);
    const exist = arr.some(x => x && x.playerId === exp.playerId && x.startedAt === exp.startedAt);
    if(exist) return;
    arr.unshift(exp);
    if(arr.length > 20) arr.length = 20;
    saveArchives(arr);
  }

  function maybeEnd(save, elapsed){
    if(save.macaronActive) return;
    const deadline = LIFE_MS + (save.lifeExtensionMs || 0);
    if(!save.ended && elapsed >= deadline){
      save.ended = true;
      save.endedAt = now();
      pushLiveLog(save, t("logGone"));
      archiveRun(save);
    }
  }

  function updateMacaronTimer(save, elapsed){
    if(!save.macaronActive) return;
    if(save.macaronEndsAtElapsed == null) return;
    if(elapsed >= save.macaronEndsAtElapsed){
      save.macaronActive = false;
      save.macaronEndsAtElapsed = null;
      save.ended = true;
      save.endedAt = now();
      pushLiveLog(save, t("logOff"));
      archiveRun(save);
    }
  }

  function stateClass(save){
    if(save.mood < 25 || save.hunger > 85 || save.dirt > 85 || save.poop >= 3) return "cry";
    if(save.mood < 45 || save.hunger > 70 || save.dirt > 70 || save.poop >= 2) return "low";
    if(save.mood > 70 && save.hunger < 55 && save.dirt < 55 && save.poop === 0) return "lively";
    return "";
  }

  function setInteractable(enabled){
    [ui.btnFood, ui.btnOut, ui.btnStyle, ui.btnClean, ui.btnDrink].forEach(b => b.disabled = !enabled);
  }

  function applyVisualImages(save){
    const mc = FILES.macaron[save.macaronColor] ? save.macaronColor : "blue";
    ui.macaronImg.src = assetPath(FILES.macaron[mc]);

    const cc = FILES.char[save.charColor] ? save.charColor : "blue";
    const elapsed = calcElapsedMs(save, now());
    const sleeping = isSleeping(save, elapsed);

    let charFile = FILES.char[cc].closed;
    if(sleeping){
      charFile = FILES.char[cc].sleep;
    }else{
      const sc = stateClass(save);
      const wantOpen = (sc === "lively");
      charFile = wantOpen ? FILES.char[cc].open : FILES.char[cc].closed;
    }
    ui.charImg.src = assetPath(charFile);
  }

  function applyGrowthScale(save){
    const base = 1.00;
    const step = 0.035; // 20Âõû„Åî„Å®„Å´Â∞ë„Åó„Åö„Å§
    const max = 1.35;
    const sc = Math.min(max, base + (save.growLevel || 0) * step);
    ui.charScaleBox.style.transform = `scale(${sc.toFixed(3)})`;
  }

  function updatePoopUI(save){
    ui.poop1.classList.toggle("on", save.poop >= 1);
    ui.poop2.classList.toggle("on", save.poop >= 2);
    ui.poop3.classList.toggle("on", save.poop >= 3);
  }

  function updateHeartUI(save){
    ui.heartFill.style.width = `${clamp(save.heart,0,100)}%`;
    ui.heartLabel.textContent = `${Math.round(save.heart)}%`;
  }

  function showLetterSlot(){
    ui.letterSlot.classList.remove("vanish");
    if(!ui.letterSlot.classList.contains("show")){
      ui.letterSlot.classList.add("show");
    }
    if(ui.letterSlot.dataset.dropped !== "1"){
      ui.letterSlot.dataset.dropped = "1";
      ui.letterSlot.classList.add("drop");
      setTimeout(() => ui.letterSlot.classList.remove("drop"), 980);
    }
  }

  function renderLiveLog(save){
    ui.liveLog.innerHTML = "";
    const items = save.live || [];
    for(const it of items){
      const d = new Date(it.t);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<b>${escapeHtml(it.text)}</b><div class="t">${hh}:${mm}</div>`;
      ui.liveLog.appendChild(div);
    }
  }

  function openModal(title, hint, bodyNode, footButtons){
    ui.modalTitle.textContent = title || "";
    ui.modalHint.textContent = hint || "";
    ui.modalBody.innerHTML = "";
    ui.modalBody.appendChild(bodyNode);

    ui.modalFoot.innerHTML = "";
    footButtons.forEach(btn => ui.modalFoot.appendChild(btn));

    ui.modalBack.classList.add("show");
    ui.modalBack.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    ui.modalBack.classList.remove("show");
    ui.modalBack.setAttribute("aria-hidden","true");
  }
  ui.modalX.addEventListener("click", closeModal);
  ui.modalBack.addEventListener("click", (e) => { if(e.target === ui.modalBack) closeModal(); });
  window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });

  function mkBtn(text, cls, onClick){
    const b = document.createElement("button");
    b.textContent = text;
    if(cls) b.className = cls;
    b.addEventListener("click", onClick);
    return b;
  }

  function mkChoice(icon, title, sub, onPick){
    const div = document.createElement("div");
    div.className = "choice";
    div.innerHTML = `
      <div class="cTitle"><span class="cIcon">${escapeHtml(icon || "‚ùì")}</span>${escapeHtml(title)}</div>
      <div class="cSub">${escapeHtml(sub)}</div>
    `;
    div.addEventListener("click", onPick);
    return div;
  }

  function shuffleInPlace(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function listForLang(key){
    const pack = TWOCHOICE[LANG] || TWOCHOICE.ja;
    const list = pack[key] || (TWOCHOICE.ja[key] || []);
    return list;
  }

  function pickFromBag(save, key){
    const list = listForLang(key);
    if(!list || !list.length) return null;

    if(!save.bags) save.bags = { food:[], out:[], style:[] };
    if(!Array.isArray(save.bags[key])) save.bags[key] = [];
    if(save.bags[key].some(i => i >= list.length)) save.bags[key] = [];

    if(save.bags[key].length === 0){
      save.bags[key] = shuffleInPlace([...Array(list.length)].map((_,i)=>i));
    }
    const idx = save.bags[key].pop();
    return list[idx];
  }

  function applyAfterChoiceMaybeSleep(save){
    const elapsed = calcElapsedMs(save, now());
    if(Math.random() < 0.18){
      maybeStartSleep(save, elapsed);
    }
  }

  function bumpPickAndGrowth(save){
    save.pickCount = (save.pickCount || 0) + 1;
    if(save.pickCount % 20 === 0){
      save.growLevel = (save.growLevel || 0) + 1;
      pushLiveLog(save, t("grown"));
    }
  }

  function openNameModal(initial){
    const save = loadSave(); if(!save) return;

    const body = document.createElement("div");

    const story = document.createElement("div");
    story.style.fontSize = "12px";
    story.style.color = "rgba(238,242,255,.78)";
    story.style.lineHeight = "1.85";
    story.style.whiteSpace = "pre-wrap";
    story.style.marginBottom = "10px";
    story.textContent = initial ? getIntroText() : t("nameStoryEdit");

    const input = document.createElement("input");
    input.type = "text";
    input.maxLength = 12;
    input.placeholder = t("namePlaceholder");
    input.value = save.petName || "";
    input.style.width = "100%";
    input.style.padding = "12px 12px";
    input.style.borderRadius = "14px";
    input.style.border = "1px solid rgba(255,255,255,.16)";
    input.style.background = "rgba(255,255,255,.06)";
    input.style.color = "rgba(238,242,255,.95)";
    input.style.outline = "none";

    const note = document.createElement("div");
    note.style.fontSize = "11px";
    note.style.color = "rgba(238,242,255,.62)";
    note.style.lineHeight = "1.7";
    note.style.marginTop = "8px";
    note.textContent = t("nameNote");

    body.appendChild(story);
    body.appendChild(input);
    body.appendChild(note);

    const commit = () => {
      const s = loadSave(); if(!s) return;
      const name = normalizeName(input.value);
      s.petName = name || "ÔºüÔºüÔºü";
      addChoice(s, "Name", s.petName);
      pushLiveLog(s, `${t("logNamed")}${s.petName}`);
      saveSave(s);
      closeModal();
    };

    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        commit();
      }
    });

    openModal(
      t("nameTitle"),
      initial ? t("nameHintInit") : t("nameHintEdit"),
      body,
      [
        mkBtn(t("btnLater"), "btnGhost", closeModal),
        mkBtn(t("btnDecide"), "", commit)
      ]
    );

    setTimeout(() => input.focus(), 0);
  }

  function actTwoPick(kindKey, kindLabel){
    const save = loadSave(); if(!save) return;
    const elapsed = calcElapsedMs(save, now());
    if(!canInteract(save, elapsed)) return;

    const p = pickFromBag(save, kindKey);
    if(!p) return;
    saveSave(save);

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7">
      ${escapeHtml(p.q)}
    </div>`;
    const two = document.createElement("div");
    two.className = "two";

    const pick = (opt) => {
      const s = loadSave(); if(!s) return;
      const e = calcElapsedMs(s, now());
      if(!canInteract(s, e)) return;

      const d = ensureDay(s, s.currentDay);
      if(kindKey === "food") d.careCounts.food++;
      if(kindKey === "out") d.careCounts.out++;
      if(kindKey === "style") d.careCounts.style++;

      const label = `${opt.icon} ${opt.t}`;
      addChoice(s, kindLabel, label);

      if(kindKey === "food"){
        s.hunger = clamp(s.hunger - 21 + (Math.random()*6 - 3), 0, 100);
        s.mood   = clamp(s.mood   +  4 + (Math.random()*6 - 3), 0, 100);
      }
      if(kindKey === "out"){
        const wild = !!opt.wild;
        s.mood = clamp(s.mood + (wild ? 10 : 7) + (Math.random()*6 - 3), 0, 100);
        s.dirt = clamp(s.dirt + (wild ?  7 : 4) + (Math.random()*4 - 2), 0, 100);
      }
      if(kindKey === "style"){
        s.mood = clamp(s.mood + 8 + (Math.random()*8 - 4), 0, 100);
        s.dirt = clamp(s.dirt + (Math.random()*8 - 4), 0, 100);
      }

      bumpPickAndGrowth(s);
      applyHeart(s, heartDeltaRandom());
      pushLiveLog(s, label);
      applyAfterChoiceMaybeSleep(s);

      saveSave(s);
      closeModal();
    };

    two.appendChild(mkChoice(p.a.icon, p.a.t, p.a.sub, () => pick(p.a)));
    two.appendChild(mkChoice(p.b.icon, p.b.t, p.b.sub, () => pick(p.b)));
    body.appendChild(two);

    openModal(kindLabel, t("twoChoice"), body, [ mkBtn(t("btnCancel"), "btnGhost", closeModal) ]);
  }

  function actFood(){ actTwoPick("food", t("btnFood")); }
  function actOut(){ actTwoPick("out", t("btnOut")); }
  function actStyle(){ actTwoPick("style", t("btnStyle")); }

  // üí©üí©„Éü„Éã„Ç≤„Éº„É†ÔºàÊéíÊ≥ÑÈô§ÂéªÔºâ
  function actClean(){
    const save = loadSave(); if(!save) return;
    const elapsed = calcElapsedMs(save, now());
    if(!canInteract(save, elapsed)) return;

    // üí©„ÅåÁÑ°„ÅÑ„Å®„Åç„ÅØËªΩ„ÅèÊï¥„Åà„Çã„Å†„Åë
    if((save.poop || 0) <= 0){
      const s = loadSave(); if(!s) return;
      const d = ensureDay(s, s.currentDay);
      d.careCounts.clean++;
      addChoice(s, t("btnClean"), "no-poop");
      s.dirt = clamp(s.dirt - 10 + (Math.random()*4 - 2), 0, 100);
      s.mood = clamp(s.mood + 3 + (Math.random()*4 - 2), 0, 100);
      applyHeart(s, heartDeltaRandom());
      pushLiveLog(s, t("cleaned"));
      saveSave(s);
      return;
    }

    // üí©„ÅÆÈáè„Å´Âøú„Åò„Å¶Âá∫ÁèæÊï∞„ÇíÂ¢ó„ÇÑ„Åô
    const n = clamp((save.poop || 1) * 2, 2, 8);
    const DURATION = FAST ? 4500 : 12000;

    const body = document.createElement("div");

    const info = document.createElement("div");
    info.style.fontSize = "12px";
    info.style.color = "rgba(238,242,255,.78)";
    info.style.lineHeight = "1.7";
    info.style.whiteSpace = "pre-wrap";
    info.textContent =
      (LANG==="en") ? "Tap the üí©.\nNo score. Only traces." :
      (LANG==="zh") ? "ÁÇπÊéâüí©„ÄÇ\n‰∏çËÆ°ÂàÜÔºåÂè™Áïô‰∏ãÁóïËøπ„ÄÇ" :
      "üí©„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ê∂à„Åó„Åæ„Åô„ÄÇ\nÁÇπÊï∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁóïË∑°„Å†„ÅëÊÆã„Çä„Åæ„Åô„ÄÇ";

    const barWrap = document.createElement("div");
    barWrap.style.marginTop = "10px";
    barWrap.style.height = "8px";
    barWrap.style.borderRadius = "999px";
    barWrap.style.border = "1px solid rgba(255,255,255,.16)";
    barWrap.style.background = "rgba(255,255,255,.06)";
    barWrap.style.overflow = "hidden";

    const bar = document.createElement("div");
    bar.style.height = "100%";
    bar.style.width = "100%";
    bar.style.background = "linear-gradient(90deg, rgba(196,181,253,.95), rgba(147,197,253,.95))";
    barWrap.appendChild(bar);

    const area = document.createElement("div");
    area.style.position = "relative";
    area.style.marginTop = "10px";
    area.style.height = "200px";
    area.style.borderRadius = "16px";
    area.style.border = "1px solid rgba(255,255,255,.12)";
    area.style.background = "rgba(255,255,255,.03)";
    area.style.overflow = "hidden";

    body.appendChild(info);
    body.appendChild(barWrap);
    body.appendChild(area);

    let removed = 0;
    let finished = false;

    function spawnPoop(){
      const p = document.createElement("button");
      p.type = "button";
      p.textContent = "üí©";
      p.style.position = "absolute";
      p.style.left = `${Math.random()*82 + 6}%`;
      p.style.top  = `${Math.random()*72 + 10}%`;

      const rot = (Math.random()*40 - 20);
      const sc = (Math.random()*0.25 + 0.95);
      p.style.transform = `rotate(${rot.toFixed(1)}deg) scale(${sc.toFixed(2)})`;
      p.style.fontSize = `${Math.floor(Math.random()*10 + 22)}px`;
      p.style.padding = "8px 10px";
      p.style.borderRadius = "16px";
      p.style.border = "1px solid rgba(255,255,255,.14)";
      p.style.background = "rgba(255,255,255,.05)";
      p.style.boxShadow = "0 12px 26px rgba(0,0,0,.22)";
      p.style.cursor = "pointer";

      // „Åµ„Çè„Å£„Å®ÊºÇ„ÅÜ
      const driftX = (Math.random()*22 - 11);
      const driftY = (Math.random()*18 - 9);
      const dur = (Math.random()*0.9 + 1.8) * 1000;
      p.animate([
        { transform: p.style.transform + ` translate(0px,0px)` },
        { transform: p.style.transform + ` translate(${driftX}px,${driftY}px)` },
        { transform: p.style.transform + ` translate(0px,0px)` },
      ], { duration: dur, iterations: Infinity, easing: "ease-in-out" });

      p.addEventListener("click", () => {
        if(finished) return;
        p.disabled = true;
        p.style.opacity = "0.0";
        setTimeout(() => p.remove(), 120);

        removed++;
        const ratio = Math.max(0, 1 - removed / n);
        bar.style.width = `${Math.round(ratio*100)}%`;

        if(removed >= n) finish(true);
      });

      area.appendChild(p);
    }

    function finish(all){
      if(finished) return;
      finished = true;

      const s = loadSave(); if(!s) { closeModal(); return; }
      const e = calcElapsedMs(s, now());
      if(!canInteract(s, e)) { closeModal(); return; }

      const d = ensureDay(s, s.currentDay);
      d.careCounts.clean++;

      const cleaned = clamp(removed, 0, n);

      // Ê∂à„Åõ„ÅüÂàÜ„Å†„ÅëÂ∞ë„ÅóÊîπÂñÑÔºàÁêÜÁî±„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºâ
      s.poop = clamp((s.poop || 0) - Math.ceil(cleaned / 2), 0, 3);
      s.dirt = clamp(s.dirt - (10 + cleaned*4) + (Math.random()*4 - 2), 0, 100);
      s.mood = clamp(s.mood + (2 + cleaned*2) + (Math.random()*4 - 2), 0, 100);

      updatePoop(s);
      applyHeart(s, heartDeltaRandom());

      addChoice(s, t("btnClean"), `poop_${cleaned}/${n}_${all ? "all" : "part"}`);
      pushLiveLog(s, t("cleaned"));

      saveSave(s);
      closeModal();
    }

    for(let i=0; i<n; i++) spawnPoop();

    // ÊôÇÈñìÁµåÈÅéÔºàÊï∞Â≠ó„ÅØÂá∫„Åï„Å™„ÅÑÔºâ
    const t0 = performance.now();
    function frame(){
      if(finished) return;
      const dt = performance.now() - t0;
      const ratio = clamp(1 - dt / DURATION, 0, 1);
      bar.style.width = `${Math.round(ratio*100)}%`;
      if(dt >= DURATION){
        finish(false);
        return;
      }
      requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);

    openModal(t("btnClean"), "", body, [ mkBtn(t("btnCancel"), "btnGhost", closeModal) ]);
  }

  function actDrink(){
    const save = loadSave(); if(!save) return;
    if(!save.hatched) return;
    if(save.ended || save.macaronActive) return;

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml((LANG==="en") ? "Use a drink?\nIt may slightly restore/extend time or status.\nYour choice will be logged."
: (LANG==="zh") ? "Ë¶Å‰ΩøÁî®È•ÆÊñôÂêóÔºü\nÂèØËÉΩ‰ºöÁ®çÂæÆÊÅ¢Â§ç/Âª∂ÈïøÊó∂Èó¥ÊàñÁä∂ÊÄÅ„ÄÇ\n‰Ω†ÁöÑÈÄâÊã©‰ºöË¢´ËÆ∞ÂΩï„ÄÇ"
: "„Éâ„É™„É≥„ÇØ„Çí‰Ωø„ÅÜÔºü\nÂ∞ë„Åó„Å†„ÅëÊôÇÈñì„ÇÑÁä∂ÊÖã„ÅåÊàª„ÇãÔºèÂª∂„Å≥„Çã„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n‰ΩøÁî®„ÅØ„É≠„Ç∞„Å´ÊÆã„Çä„Åæ„Åô„ÄÇ")}
    </div>`;

    const two = document.createElement("div");
    two.className = "two";

    const use = () => {
      const s = loadSave(); if(!s) return;
      if(s.ended || s.macaronActive) return;

      const d = ensureDay(s, s.currentDay);
      d.items.drink++;
      addChoice(s, t("btnDrink"), "ü•§ Use");

      s.hunger = clamp(s.hunger - 12 + (Math.random()*4 - 2), 0, 100);
      s.dirt   = clamp(s.dirt   - 10 + (Math.random()*4 - 2), 0, 100);
      s.mood   = clamp(s.mood   +  8 + (Math.random()*4 - 2), 0, 100);

      s.lifeExtensionMs = (s.lifeExtensionMs || 0) + DRINK_EXTEND_MS;
      s.startedAt += DRINK_BACK_MS;

      pushLiveLog(s, t("usedDrink"));
      applyAfterChoiceMaybeSleep(s);

      saveSave(s);
      closeModal();
    };

    two.appendChild(mkChoice("ü•§", (LANG==="en"?"Use":(LANG==="zh"?"‰ΩøÁî®":"‰Ωø„ÅÜ")), (LANG==="en"?"Just a little.":(LANG==="zh"?"Âè™ÊòØ‰∏ÄÁÇπÁÇπ„ÄÇ":"„Åª„Çì„ÅÆÂ∞ë„Åó„ÄÇ")), use));
    two.appendChild(mkChoice("ü§≤", (LANG==="en"?"Not now":(LANG==="zh"?"ÊöÇ‰∏ç":"‰Ωø„Çè„Å™„ÅÑ")), (LANG==="en"?"Maybe later.":(LANG==="zh"?"‰ª•ÂêéÂÜçËØ¥„ÄÇ":"‰ªäÂõû„ÅØË¶ãÈÄÅ„Çã„ÄÇ")), closeModal));
    body.appendChild(two);

    openModal(t("btnDrink"), "", body, [ mkBtn(t("btnClose"), "btnGhost", closeModal) ]);
  }

  function actMacaron(){
    const save = loadSave(); if(!save) return;
    if(!save.ended || save.macaronActive) return;

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml((LANG==="en") ? "Use a macaron?\nIt may bring it back briefly, but not perfectly.\nYour choice will be logged."
: (LANG==="zh") ? "Ë¶Å‰ΩøÁî®È©¨Âç°ÈæôÂêóÔºü\nÂèØËÉΩ‰ºöÁü≠ÊöÇÂõûÊù•Ôºå‰ΩÜ‰∏ç‰ºöÂÆåÁæé„ÄÇ\n‰Ω†ÁöÑÈÄâÊã©‰ºöË¢´ËÆ∞ÂΩï„ÄÇ"
: "„Éû„Ç´„É≠„É≥„Çí‰Ωø„ÅÜÔºü\n‰∏ÄÊôÇÁöÑ„Å´Êàª„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„Åå„ÄÅÂÆåÂÖ®„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n‰ΩøÁî®„ÅØ„É≠„Ç∞„Å´ÊÆã„Çä„Åæ„Åô„ÄÇ")}
    </div>`;

    const two = document.createElement("div");
    two.className = "two";

    const use = () => {
      const s = loadSave(); if(!s) return;
      if(!s.ended || s.macaronActive) return;

      const e = calcElapsedMs(s, now());
      const d = ensureDay(s, s.currentDay);
      d.items.macaron++;

      addChoice(s, t("btnMacaron"), "üç¨ Use");

      s.macaronActive = true;
      s.macaronEndsAtElapsed = e + MACARON_REVIVE_MS;

      // „Åª„Çì„ÅÆÂ∞ë„ÅóÊàª„Çã
      s.hunger = clamp(s.hunger - 8, 0, 100);
      s.dirt   = clamp(s.dirt - 6, 0, 100);
      s.mood   = clamp(s.mood + 10, 0, 100);
      s.heart  = clamp(s.heart + 4, 0, 100);

      pushLiveLog(s, t("returned"));
      saveSave(s);
      closeModal();
    };

    two.appendChild(mkChoice("üç¨", (LANG==="en"?"Use":(LANG==="zh"?"‰ΩøÁî®":"‰Ωø„ÅÜ")), (LANG==="en"?"Briefly.":(LANG==="zh"?"Áü≠ÊöÇ„ÄÇ":"Â∞ë„Åó„Å†„Åë„ÄÇ")), use));
    two.appendChild(mkChoice("ü§≤", (LANG==="en"?"Not now":(LANG==="zh"?"ÊöÇ‰∏ç":"‰Ωø„Çè„Å™„ÅÑ")), (LANG==="en"?"Maybe later.":(LANG==="zh"?"‰ª•ÂêéÂÜçËØ¥„ÄÇ":"‰ªäÂõû„ÅØË¶ãÈÄÅ„Çã„ÄÇ")), closeModal));
    body.appendChild(two);

    openModal(t("btnMacaron"), "", body, [ mkBtn(t("btnClose"), "btnGhost", closeModal) ]);
  }

  function exportObservationData(save){
    const elapsed = calcElapsedMs(save, now());
    const d = {
      version: 1,
      playerId: save.playerId,
      startedAt: save.startedAt,
      endedAt: save.endedAt,
      elapsedMs: elapsed,
      petName: save.petName,
      macaronColor: save.macaronColor,
      charColor: save.charColor,
      growLevel: save.growLevel || 0,
      pickCount: save.pickCount || 0,
      days: save.days || {},
      events: save.events || [],
      heart: save.heart
    };
    return d;
  }

  function encodeObs(obj){
    const json = JSON.stringify(obj);
    const b64 = btoa(unescape(encodeURIComponent(json)));
    return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }

  function decodeObs(s){
    try{
      const b64 = s.replace(/-/g,"+").replace(/_/g,"/");
      const pad = "=".repeat((4 - (b64.length % 4)) % 4);
      const json = decodeURIComponent(escape(atob(b64 + pad)));
      return JSON.parse(json);
    }catch(_){
      return null;
    }
  }

  function drawHeartChartFromEvents(canvas, events){
    const ctx = canvas.getContext("2d");
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    const pts = (events || [])
      .filter(e => typeof e.heart === "number" && typeof e.elapsed === "number")
      .sort((a,b)=>a.elapsed-b.elapsed);

    if(pts.length < 2){
      ctx.globalAlpha = 0.75;
      ctx.font = "14px system-ui";
      ctx.fillText("No data", 12, 24);
      return;
    }

    const minX = pts[0].elapsed;
    const maxX = pts[pts.length-1].elapsed;
    const minY = 0, maxY = 100;

    function xOf(x){
      const tt = (x - minX) / Math.max(1, (maxX - minX));
      return 20 + tt * (w - 40);
    }
    function yOf(y){
      const tt = (y - minY) / (maxY - minY);
      return (h - 18) - tt * (h - 36);
    }

    ctx.globalAlpha = 0.35;
    ctx.beginPath();
    ctx.moveTo(20, yOf(50));
    ctx.lineTo(w-20, yOf(50));
    ctx.stroke();

    ctx.globalAlpha = 0.95;
    ctx.beginPath();
    ctx.moveTo(xOf(pts[0].elapsed), yOf(pts[0].heart));
    for(const p of pts){
      ctx.lineTo(xOf(p.elapsed), yOf(p.heart));
    }
    ctx.stroke();

    ctx.globalAlpha = 0.65;
    ctx.font = "12px system-ui";
    ctx.fillText("0", 6, h-18);
    ctx.fillText("100", 0, 16);
  }

  function showObserveFromData(data){
    ui.screenGame.classList.remove("show");
    ui.screenObserve.classList.add("show");

    const name = data.petName ? `„Äå${data.petName}„Äç` : "";
    ui.obsTitle.textContent = (LANG==="en") ? `Observer Log ${name}` : (LANG==="zh" ? `ËßÇÂØüËÆ∞ÂΩï ${name}` : `Ë¶≥ÂØüÁî®„É≠„Ç∞ ${name}`);

    const started = new Date(data.startedAt);
    ui.obsSub.textContent =
      (LANG==="en") ? `Started: ${started.toLocaleString()}`
      : (LANG==="zh") ? `ÂºÄÂßãÔºö${started.toLocaleString()}`
      : `ÈñãÂßãÔºö${started.toLocaleString()}`;

    drawHeartChartFromEvents(ui.heartChart, data.events || []);

    ui.obsDays.innerHTML = "";
    const days = data.days || {};
    for(let d=1; d<=3; d++){
      const one = days[d];
      const card = document.createElement("div");
      card.className = "dayCard";

      if(!one){
        card.innerHTML = `<div class="dh"><b>Day ${d}</b><small> </small></div>
          <div class="mini">${escapeHtml((LANG==="en")?"No data.":(LANG==="zh"?"Êó†Êï∞ÊçÆ„ÄÇ":"„Éá„Éº„Çø„Å™„Åó„ÄÇ"))}</div>`;
        ui.obsDays.appendChild(card);
        continue;
      }

      const cc = one.careCounts || {};
      const items = one.items || {};
      const choiceLines = (one.choices || []).map(c => {
        const dt = new Date(c.t);
        const hm = `${String(dt.getHours()).padStart(2,"0")}:${String(dt.getMinutes()).padStart(2,"0")}`;
        return `${hm}  ${c.category}  ${c.choice}`;
      });

      card.innerHTML = `
        <div class="dh"><b>Day ${d}</b><small>heart ${Math.round(one.heartEnd ?? 0)}%</small></div>
        <div class="kvs">
          <div><span>Food</span> ${cc.food ?? 0}</div>
          <div><span>Out</span> ${cc.out ?? 0}</div>
          <div><span>Style</span> ${cc.style ?? 0}</div>
          <div><span>Clean</span> ${cc.clean ?? 0}</div>
          <div><span>Drink</span> ${items.drink ?? 0}</div>
          <div><span>Macaron</span> ${items.macaron ?? 0}</div>
        </div>
        <div class="choices">${escapeHtml(choiceLines.join("\n"))}</div>
      `;
      ui.obsDays.appendChild(card);
    }
  }

  function showGameScreen(){
    ui.screenObserve.classList.remove("show");
    ui.screenGame.classList.add("show");
  }

  function downloadCSV(save){
    const rows = [];
    rows.push([
      "timestamp_iso","type","day","category","detail",
      "heart","hunger","dirt","mood","poop","elapsed_ms",
      "player_id","pet_name","macaron_color","char_color","grow_level","pick_count"
    ]);

    const events = (save.events || []).slice().sort((a,b)=>a.t-b.t);
    for(const e of events){
      const iso = new Date(e.t).toISOString();
      rows.push([
        iso,
        e.type || "",
        String(e.day ?? ""),
        String(e.category ?? ""),
        String(e.choice ?? e.text ?? ""),
        String(e.heart ?? ""),
        String(e.hunger ?? ""),
        String(e.dirt ?? ""),
        String(e.mood ?? ""),
        String(e.poop ?? ""),
        String(e.elapsed ?? ""),
        save.playerId || "",
        save.petName || "",
        save.macaronColor || "",
        save.charColor || "",
        String(save.growLevel ?? 0),
        String(save.pickCount ?? 0),
      ]);
    }

    function csvEscape(v){
      const s = String(v ?? "");
      if(/[,"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    const stamp = new Date().toISOString().replace(/[:.]/g,"-");
    a.href = URL.createObjectURL(blob);
    a.download = `osewa_log_${stamp}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  function openLogsModal(){
    const save = loadSave(); if(!save) return;

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml((LANG==="en") ? "You can download logs as CSV.\nThis is saved locally."
: (LANG==="zh") ? "ÂèØ‰ª•‰∏ãËΩΩCSV„ÄÇ\n‰øùÂ≠òÂú®Êú¨Âú∞„ÄÇ"
: "CSV„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô„ÄÇ\n„É≠„Éº„Ç´„É´‰øùÂ≠ò„Åß„Åô„ÄÇ")}
    </div>`;

    const list = document.createElement("div");
    list.style.marginTop = "10px";
    list.style.display = "flex";
    list.style.flexDirection = "column";
    list.style.gap = "8px";
    list.style.maxHeight = "320px";
    list.style.overflow = "auto";

    const recent = (save.events || []).slice(-60).reverse();
    for(const e of recent){
      const dt = new Date(e.t);
      const hm = `${String(dt.getHours()).padStart(2,"0")}:${String(dt.getMinutes()).padStart(2,"0")}`;
      const item = document.createElement("div");
      item.className = "logItem";
      const text = (e.type === "choice" && e.category)
        ? `${e.category}  ${e.choice || ""}`
        : (e.text || "");
      item.innerHTML = `<b>${escapeHtml(text)}</b><div class="t">${hm} / day ${e.day ?? ""}</div>`;
      list.appendChild(item);
    }
    body.appendChild(list);

    openModal(
      t("btnLogs"),
      "",
      body,
      [
        mkBtn("CSV", "", () => { const s = loadSave(); if(s) downloadCSV(s); }),
        mkBtn(t("btnClose"), "btnGhost", closeModal)
      ]
    );
  }

  function openResetModal(){
    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml(t("resetText"))}
    </div>`;

    const two = document.createElement("div");
    two.className = "two";

    const keep = () => {
      const s = loadSave();
      if(s) archiveRun(s);
      const ns = createNewSave();
      saveSave(ns);
      closeModal();
    };
    const wipe = () => {
      localStorage.removeItem(SAVE_KEY);
      const ns = createNewSave();
      saveSave(ns);
      closeModal();
    };

    two.appendChild(mkChoice("üß∑", t("resetKeep"), t("resetKeepSub"), keep));
    two.appendChild(mkChoice("üßº", t("resetWipe"), t("resetWipeSub"), wipe));
    body.appendChild(two);

    openModal(t("resetTitle"), "", body, [ mkBtn(t("btnClose"), "btnGhost", closeModal) ]);
  }

  function openShareModal(){
    const save = loadSave(); if(!save) return;
    const data = exportObservationData(save);
    const token = encodeObs(data);
    const u = new URL(location.href);
    u.searchParams.set("observe","1");
    u.hash = "obs=" + token;

    const body = document.createElement("div");
    body.innerHTML = `<div style="font-size:12px;color:rgba(238,242,255,.78);line-height:1.7; white-space:pre-wrap">
${escapeHtml(t("shareText"))}

${escapeHtml(u.toString())}
    </div>`;

    const copy = async () => {
      try{
        await navigator.clipboard.writeText(u.toString());
        const s = loadSave(); if(s) { pushLiveLog(s, t("shareCopied")); saveSave(s); }
      }catch(_){
      }
      closeModal();
    };

    openModal(
      t("shareTitle"),
      t("shareHint"),
      body,
      [
        mkBtn(t("btnCopy"), "", copy),
        mkBtn(t("btnClose"), "btnGhost", closeModal)
      ]
    );
  }

  // ÊâãÁ¥ô„É¢„Éº„ÉÄ„É´
  let lastFocusEl = null;

  // „Å©„ÅÆÊâãÁ¥ô„ÇíË™≠„ÇÄ„ÅãÔºàÂ∫èÁ´† or Êó•Êõø„Çè„ÇäÔºâ
  function getLetterPacket(save){
    if(save && save.pendingLetter && save.pendingLetter.kind === "day"){
      const d = save.pendingLetter.day;
      const title = (LANG==="en") ? `Letter (Day ${d})` : (LANG==="zh") ? `‰ø°ÔºàÁ¨¨${d}Â§©Ôºâ` : `„ÅäÊâãÁ¥ôÔºà${d}Êó•ÁõÆÔºâ`;

      const bodyJa = (d === 2)
        ? [
            "ÔºíÊó•ÁõÆ„ÄÇ",
            "Êò®Êó•„ÅÆÈÅ∏Êäû„ÅØ„ÄÅË¶ã„Åà„Å™„ÅÑ„Å®„Åì„Çç„Å´ËñÑ„ÅèÊÆã„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
            "Áú†„Å£„Å¶„ÅÑ„ÇãÊôÇÈñì„ÅåÂ¢ó„Åà„Å¶„ÇÇ„ÄÅ„Åì„Åì„Å´„ÅÑ„Åæ„Åô„ÄÇ",
            "‰ªäÊó•„ÇÇ„ÄÅ„ÅÇ„Å™„Åü„ÅÆÈÅ∏„Çì„Å†„ÇÇ„ÅÆ„ÅåÁóïË∑°„Å´„Å™„Çä„Åæ„Åô„ÄÇ"
          ].join("\n")
        : [
            "ÔºìÊó•ÁõÆ„ÄÇ",
            "Â∏∞„ÇäÈÅì„ÅåËøë„ÅÑÊ∞ó„Åå„Åó„Åæ„Åô„ÄÇ",
            "Èùô„Åã„Åß„ÇÇ„ÄÅ„Å®„Å™„Çä„Å´ÁΩÆ„ÅÑ„Å¶„Åä„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
            "Áü≠„ÅÑÊúüÈñì„Å†„Åë„Çå„Å©„ÄÅÊÄù„ÅÑÂá∫„ÅØ„ÅÑ„Å£„Å±„ÅÑ"
          ].join("\n");

      const bodyEn = (d === 2)
        ? [
            "Day 2.",
            "Yesterday‚Äôs choices remain faintly, somewhere you can‚Äôt see.",
            "Even if it sleeps more, it is still here.",
            "Today‚Äôs picks will also leave traces."
          ].join("\n")
        : [
            "Day 3.",
            "The way back feels close.",
            "Even if it stays quiet, keep it near.",
            "It was a short time, but there are a lot of memories."
          ].join("\n");

      const bodyZh = (d === 2)
        ? [
            "Á¨¨2Â§©„ÄÇ",
            "Êò®Â§©ÁöÑÈÄâÊã©Âú®Áúã‰∏çËßÅÁöÑÂú∞ÊñπÊ∑°Ê∑°Áïô‰∏ã„ÄÇ",
            "Â∞±ÁÆóÁù°ÂæóÊõ¥Â§öÔºåÂÆÉ‰πüËøòÂú®ËøôÈáå„ÄÇ",
            "‰ªäÂ§©ÁöÑÈÄâÊã©‰πü‰ºöÂèòÊàêÁóïËøπ„ÄÇ"
          ].join("\n")
        : [
            "Á¨¨3Â§©„ÄÇ",
            "ÂõûÂéªÁöÑË∑ØÂ•ΩÂÉèÂæàËøë„ÄÇ",
            "Â∞±ÁÆóÂæàÂÆâÈùôÔºå‰πüËØ∑ÊîæÂú®Ë∫´Ëæπ„ÄÇ",
            "ËôΩÁÑ∂Êó∂Èó¥Áü≠ÊöÇÔºåÂç¥Áïô‰∏ã‰∫ÜËÆ∏Â§öÂõûÂøÜ„ÄÇ"
          ].join("\n");

      const body = (LANG==="en") ? bodyEn : (LANG==="zh") ? bodyZh : bodyJa;
      return { title, body, tag: `day${d}` };
    }
    return { title: t("letter"), body: getLetterBody(), tag: "intro" };
  }

  function openLetter(){
    lastFocusEl = document.activeElement;

    ui.letterModal.classList.remove("closing");
    ui.letterModal.classList.add("open");
    ui.letterModal.removeAttribute("aria-hidden");
    ui.letterModal.removeAttribute("inert");

    const s0 = loadSave();
    const pack = getLetterPacket(s0);

    ui.txtLetterTitle.textContent = pack.title;
    ui.letterText.textContent = pack.body;

    setTimeout(() => {
      (ui.letterClose || ui.letterX || ui.letterBtn).focus?.();
    }, 0);

    const s = loadSave();
    if(s){
      addChoice(s, "Letter", pack.tag);

      // Êó•Êõø„Çè„ÇäÊâãÁ¥ô„ÇíË™≠„Çì„Å†„ÇâÊó¢Ë™≠„Å´„Åó„Å¶Ê∂à„Åô
      if(s.pendingLetter && s.pendingLetter.kind === "day"){
        const d = s.pendingLetter.day;
        if(!s.dayLetterSeen) s.dayLetterSeen = {2:false,3:false};
        s.dayLetterSeen[d] = true;
        s.pendingLetter = null;
      }

      pushLiveLog(s, t("logReadLetter"));
      saveSave(s);
    }
  }

  function closeLetter(){
    if(!ui.letterModal.classList.contains("open")) return;

    const target = (lastFocusEl && typeof lastFocusEl.focus === "function")
      ? lastFocusEl
      : ui.letterBtn;
    target?.focus?.();

    ui.letterModal.classList.add("closing");
    ui.letterModal.setAttribute("inert","");

    setTimeout(() => {
      ui.letterModal.classList.remove("open","closing");
      ui.letterModal.setAttribute("aria-hidden","true");
    }, 240);
  }

  function initOrLoad(){
    const observe = url.searchParams.get("observe") === "1" || location.hash.startsWith("#obs=");
    if(observe){
      const hash = location.hash || "";
      const m = hash.match(/obs=([A-Za-z0-9\-_]+)/);
      const token = m ? m[1] : "";
      const data = token ? decodeObs(token) : null;
      if(data){
        setLang(getLang());
        applyLangToUI();
        showObserveFromData(data);
        return;
      }
    }

    let save = loadSave();
    if(!save){
      save = createNewSave();
      saveSave(save);
    }
    return save;
  }

  function setStageText(save){
    const elapsed = calcElapsedMs(save, now());
    const remaining = Math.max(0, (LIFE_MS + (save.lifeExtensionMs||0)) - elapsed);
    const mm = Math.floor(remaining/60000);
    const ss = Math.floor((remaining%60000)/1000);
    const remTxt = `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;

    if(save.pausedSince){
      ui.stageHint.textContent = t("timeStopped");
    }else if(!save.hatched){
      const left = Math.max(0, HATCH_MS - elapsed);
      const s = Math.ceil(left/1000);
      ui.stageHint.textContent = (LANG==="en") ? `Hatching in ~${s}s` : (LANG==="zh" ? `Á∫¶${s}ÁßíÂêéÂá∫Áé∞` : `„ÅÇ„Å®${s}Áßí„Åè„Çâ„ÅÑ‚Ä¶`);
    }else if(save.ended && !save.macaronActive){
      ui.stageHint.textContent = (LANG==="en") ? "Ended" : (LANG==="zh" ? "ÁªìÊùü" : "ÁµÇ‰∫Ü");
    }else{
      ui.stageHint.textContent = (LANG==="en") ? `Time left ~${remTxt}` : (LANG==="zh" ? `Ââ©‰Ωô ~${remTxt}` : `ÊÆã„Çä ~${remTxt}`);
    }

    if(!save.hatched){
      ui.stageNote.textContent = t("waitNote");
      return;
    }

    if(isSleeping(save, elapsed)){
      ui.stageNote.textContent = t("sleepNote");
      return;
    }

    const name = save.petName ? `„Äå${save.petName}„Äç` : "";
    const mood = stateClass(save);
    const face =
      mood==="cry" ? (LANG==="en"?"Crying":(LANG==="zh"?"Âú®Âì≠":"Ê≥£„ÅÑ„Å¶„Çã")) :
      mood==="low" ? (LANG==="en"?"Low":(LANG==="zh"?"Ê≤°Á≤æÁ•û":"ÂÖÉÊ∞ó„Åå„Å™„ÅÑ")) :
      mood==="lively" ? (LANG==="en"?"Lively":(LANG==="zh"?"ÂæàÁ≤æÁ•û":"„Åî„Åç„Åí„Çì")) :
      (LANG==="en"?"Normal":(LANG==="zh"?"ÊôÆÈÄö":"„Åµ„Å§„ÅÜ"));

    const poop = save.poop>0 ? (LANG==="en"?"Needs clean":(LANG==="zh"?"ÈúÄË¶ÅÊ∏ÖÁêÜ":"ÊéÉÈô§„Åó„Åü„ÅÑ")) : (LANG==="en"?"Clean":(LANG==="zh"?"Âπ≤ÂáÄ":"„Åç„Çå„ÅÑ"));
    ui.stageNote.textContent =
      (LANG==="en") ? `${name}  ${face}\nHunger ${Math.round(save.hunger)} / Dirt ${Math.round(save.dirt)} / ${poop}\nPicks ${save.pickCount || 0} (grow ${save.growLevel || 0})`
      : (LANG==="zh") ? `${name}  ${face}\nÈ••È•ø ${Math.round(save.hunger)} / ËÑè ${Math.round(save.dirt)} / ${poop}\nÈÄâÊã© ${save.pickCount || 0}ÔºàÊàêÈïø ${save.growLevel || 0}Ôºâ`
      : `${name}  ${face}\nÁ©∫ËÖπ ${Math.round(save.hunger)} / Ê±ö„Çå ${Math.round(save.dirt)} / ${poop}\nÈÅ∏Êäû ${save.pickCount || 0}ÔºàÊàêÈï∑ ${save.growLevel || 0}Ôºâ`;
  }

  function render(save){
    const elapsed = calcElapsedMs(save, now());

    ui.macaronArea.style.display = save.hatched ? "none" : "grid";
    ui.charArea.style.display = save.hatched ? "grid" : "none";

    ui.thanksOverlay.classList.toggle("show", save.ended && !save.macaronActive);

    ui.macaronImg.classList.toggle("hatchLift", !!save.hatchAnim);

    const st = stateClass(save);
    ui.charArea.classList.remove("low","cry","lively","sleep");
    if(st) ui.charArea.classList.add(st);
    if(save.hatched && isSleeping(save, elapsed)) ui.charArea.classList.add("sleep");

    applyVisualImages(save);
    applyGrowthScale(save);

    updateHeartUI(save);
    updatePoopUI(save);
    setStageText(save);

    const inter = canInteract(save, elapsed);
    setInteractable(inter);

    ui.btnMacaron.disabled = !(save.ended && !save.macaronActive);

    // Â∫èÁ´†ÊâãÁ¥ôÔºö‰∏ÄÂÆöÊôÇÈñì„ÅßÂá∫Áèæ
    if(!save.letterShown && elapsed >= LETTER_DELAY_MS){
      save.letterShown = true;
      saveSave(save);
    }

    // Êó•Êõø„Çè„ÇäÊâãÁ¥ô„ÅåÊù•„Åü„Çâ„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éâ„É≠„ÉÉ„ÉóÊºîÂá∫
    if(ui.letterSlot){
      const pulse = String(save.letterPulse || 0);
      if(ui.letterSlot.dataset.pulse !== pulse){
        ui.letterSlot.dataset.pulse = pulse;
        ui.letterSlot.dataset.dropped = "0";
      }
    }

    // ÊâãÁ¥ô„Çπ„É≠„ÉÉ„ÉàË°®Á§∫Êù°‰ª∂ÔºöÂ∫èÁ´† or Êó•Êõø„Çè„Çä
    if(save.letterShown || save.pendingLetter){
      showLetterSlot();

      if(save.pendingLetter && save.pendingLetter.kind === "day"){
        const d = save.pendingLetter.day;
        ui.txtLetterBtn.textContent = (LANG==="en") ? `Letter (Day ${d})` : (LANG==="zh" ? `‰ø°ÔºàÁ¨¨${d}Â§©Ôºâ` : `„ÅäÊâãÁ¥ôÔºà${d}Êó•ÁõÆÔºâ`);
      }else{
        ui.txtLetterBtn.textContent = t("letter");
      }
    }

    renderLiveLog(save);
    ui.subline.textContent = save.ended && !save.macaronActive ? t("subEnded") : t("subRunning");
  }

  function tick(){
    const save = loadSave();
    if(!save) return;

    const tNow = now();
    const elapsed = calcElapsedMs(save, tNow);

    if(!save.pausedSince && !save.ended){
      applyTimeSimulation(save, elapsed);
      updateDayBoundary(save, elapsed);
      maybeHatch(save, elapsed);
      maybeEnd(save, elapsed);
    }

    updateMacaronTimer(save, elapsed);

    save.lastSimElapsed = elapsed;
    saveSave(save);
    render(save);

    requestAnimationFrame(tick);
  }

  function toggleSitter(){
    const s = loadSave(); if(!s) return;

    if(!s.pausedSince){
      s.pausedSince = now();
      pushLiveLog(s, t("logSitterOn"));
      ui.sitterToggle.dataset.on = "true";
    }else{
      const paused = now() - s.pausedSince;
      s.totalPausedMs += paused;
      ensureDay(s, s.currentDay).sitterMs += paused;
      s.pausedSince = null;
      pushLiveLog(s, t("logSitterOff"));
      ui.sitterToggle.dataset.on = "false";
    }
    saveSave(s);
  }

  ui.langSel.value = LANG;
  ui.langSel.addEventListener("change", () => setLang(ui.langSel.value));

  ui.sitterToggle.addEventListener("click", toggleSitter);

  ui.btnFood.addEventListener("click", actFood);
  ui.btnOut.addEventListener("click", actOut);
  ui.btnStyle.addEventListener("click", actStyle);
  ui.btnClean.addEventListener("click", actClean);
  ui.btnDrink.addEventListener("click", actDrink);
  ui.btnMacaron.addEventListener("click", actMacaron);

  ui.btnName.addEventListener("click", () => openNameModal(false));
  ui.btnReset.addEventListener("click", openResetModal);
  ui.btnShare.addEventListener("click", openShareModal);
  ui.btnLogs.addEventListener("click", openLogsModal);
  ui.btnCsv.addEventListener("click", () => { const s = loadSave(); if(s) downloadCSV(s); });

  ui.letterBtn.addEventListener("click", openLetter);
  ui.letterX.addEventListener("click", closeLetter);
  ui.letterClose.addEventListener("click", closeLetter);
  ui.letterModal.addEventListener("click", (e) => { if(e.target === ui.letterModal) closeLetter(); });
  window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeLetter(); });

  ui.btnBackToGame.addEventListener("click", () => {
    const u = new URL(location.href);
    u.searchParams.delete("observe");
    u.hash = "";
    history.replaceState({}, "", u.toString());
    showGameScreen();
  });

  // Ëµ∑Âãï
  setLang(getLang());
  applyLangToUI();

  const save = initOrLoad();
  if(save){
    ui.sitterToggle.dataset.on = save.pausedSince ? "true" : "false";
    render(save);
    requestAnimationFrame(tick);
  }
})();
</script>
</body>
</html>
