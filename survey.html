<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>アンケート → ゲーム</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;background:#0b1028;color:#eef2ff;}
    main{max-width:820px;margin:0 auto;padding:22px;}
    .card{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);border-radius:18px;padding:16px;margin:12px 0;}
    button{border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#eef2ff;border-radius:14px;padding:12px 12px;font-weight:800;cursor:pointer;}
    button:active{transform:translateY(1px)}
    small{color:rgba(238,242,255,.72);line-height:1.7;display:block;}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px;word-break:break-all;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .ok{color:#b9f6ca;font-weight:900}
    .warn{color:#ffd6a5;font-weight:900}
    .hide{display:none !important}
  </style>
</head>
<body>
<main>
  <h1>アンケート</h1>

  <div class="card">
    <small>
      個人が特定される情報（氏名・メール・住所など）は入力しないでください。<br>
      先にGoogleフォームへ回答し、送信完了後にこのページへ戻るとゲームが解放されます。
    </small>
  </div>

  <div class="card">
    <div>参加者ID（匿名）: <code id="pid"></code></div>
    <small>フォーム側にこのIDが自動入力されるようにできます。</small>
  </div>

  <div class="card">
    <div class="row">
      <button id="btnOpenForm">Googleフォームを開く</button>
      <span id="status" class="warn">未回答</span>
    </div>
    <small style="margin-top:8px;">
      別タブで開きます。送信が終わったら「送信完了画面」にある戻りリンクから戻ってください。
    </small>
  </div>

  <div class="card" id="returnBox">
    <small>
      Googleフォームの「確認メッセージ（送信完了画面の文章）」に、次のURLを貼ってください。<br>
      そこから戻ってきたときだけ、ゲームが解放されます。
    </small>
    <div style="margin-top:10px;">
      戻りURL: <code id="returnUrl"></code>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="btnCopy">戻りURLをコピー</button>
    </div>
    <small style="margin-top:8px;">
      例）「送信ありがとうございました。ゲームに戻る：上のURL」
    </small>
  </div>

  <div class="card hide" id="gameBox">
    <div class="ok">回答確認：OK</div>
    <div style="margin-top:10px;">
      <button id="btnGoGame">ゲームへ進む</button>
    </div>
    <small style="margin-top:8px;">
      この端末のこのブラウザでのみ有効になります（研究運用の簡易ゲートです）。
    </small>
  </div>

  <div class="card">
    <small>
      開発用：ゲートをやり直したいときだけ使ってください。
    </small>
    <div class="row" style="margin-top:10px;">
      <button id="btnReset">ゲートをリセット</button>
    </div>
  </div>
</main>

<script>
(() => {
  "use strict";

  // ゲームと共通のキー
  const SURVEY_DONE_KEY = "gift_survey_done";
  const SURVEY_DONE_AT  = "gift_survey_done_at";
  const SURVEY_PID_KEY  = "gift_pid";

  // あなたのGoogleフォームURLに差し替え
  const FORM_URL_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSdKcqLBRLcGALdwYhWQFD1tuZtbqXyLpTBxfZZ9Or2pug16Rg/viewform";

  // フォームで「参加者ID」を受け取る質問の entry 番号に差し替え
  // 例: entry.1234567890
  const ENTRY_PID = "entry.1425663825";

  function uid(){
    try{
      const a = new Uint32Array(4);
      crypto.getRandomValues(a);
      return [...a].map(x => x.toString(16).padStart(8,"0")).join("");
    }catch(_){
      return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
  }

  function pid(){
    let v = localStorage.getItem(SURVEY_PID_KEY);
    if(!v){
      v = "p_" + uid();
      localStorage.setItem(SURVEY_PID_KEY, v);
    }
    return v;
  }

  function setDone(){
    localStorage.setItem(SURVEY_DONE_KEY, "1");
    localStorage.setItem(SURVEY_DONE_AT, new Date().toISOString());
  }
  function isDone(){ return localStorage.getItem(SURVEY_DONE_KEY) === "1"; }

  const pidEl = document.getElementById("pid");
  const btnOpen = document.getElementById("btnOpenForm");
  const statusEl = document.getElementById("status");
  const returnUrlEl = document.getElementById("returnUrl");
  const btnCopy = document.getElementById("btnCopy");
  const returnBox = document.getElementById("returnBox");
  const gameBox = document.getElementById("gameBox");
  const btnGo = document.getElementById("btnGoGame");
  const btnReset = document.getElementById("btnReset");

  pidEl.textContent = pid();

  function formUrl(){
    const u = new URL(FORM_URL_BASE);
    u.searchParams.set("usp","pp_url");
    u.searchParams.set(ENTRY_PID, pid());
    return u.toString();
  }

  // 送信完了画面から戻ってくる用のURL（survey.html?done=1）
  function buildReturnUrl(){
    const u = new URL(location.href);
    u.searchParams.set("done","1");
    return u.toString();
  }

  function render(){
    const done = isDone();
    if(done){
      statusEl.textContent = "回答済み";
      statusEl.className = "ok";
      returnBox.classList.add("hide");
      gameBox.classList.remove("hide");
    }else{
      statusEl.textContent = "未回答";
      statusEl.className = "warn";
      returnBox.classList.remove("hide");
      gameBox.classList.add("hide");
    }
  }

  // done=1 のときだけゲート解除する（チェックボックスを無くす）
  const qs = new URLSearchParams(location.search);
  if(qs.get("done") === "1"){
    setDone();
    qs.delete("done");
    const newUrl = location.pathname + (qs.toString() ? "?" + qs.toString() : "");
    history.replaceState(null, "", newUrl);
  }

  returnUrlEl.textContent = buildReturnUrl();

  btnOpen.addEventListener("click", () => {
    window.open(formUrl(), "_blank", "noopener");
  });

  btnCopy.addEventListener("click", async () => {
    const txt = buildReturnUrl();
    try{
      await navigator.clipboard.writeText(txt);
      btnCopy.textContent = "コピーしました";
      setTimeout(()=> btnCopy.textContent = "戻りURLをコピー", 900);
    }catch(_){
      prompt("このURLをコピーしてください", txt);
    }
  });

  btnGo.addEventListener("click", () => {
    location.href = "./index.html";
  });

  btnReset.addEventListener("click", () => {
    localStorage.removeItem(SURVEY_DONE_KEY);
    localStorage.removeItem(SURVEY_DONE_AT);
    render();
  });

  render();
})();
</script>
</body>
</html>
